/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/core/format/DateFormat","sap/ui/unified/calendar/CalendarDate","sap/ui/unified/calendar/CalendarUtils","sap/ui/unified/DateTypeRange","sap/ui/unified/library","sap/ui/core/LocaleData","sap/ui/core/Locale","sap/ui/core/delegate/ItemNavigation","sap/ui/core/dnd/DragDropInfo","sap/ui/core/CustomData","sap/ui/events/KeyCodes","sap/base/Log","sap/ui/core/Core","./Link","./library","./PlanningCalendarLegend","./SinglePlanningCalendarMonthGridRenderer","sap/ui/thirdparty/jquery","sap/ui/core/InvisibleMessage","sap/ui/core/library","sap/ui/core/date/CalendarWeekNumbering","sap/ui/core/date/CalendarUtils","sap/ui/core/Configuration","sap/ui/core/date/UI5Date","sap/ui/unified/DateRange"],function(e,t,a,n,i,r,o,s,l,g,p,u,d,c,h,f,D,m,jQuery,_,v,y,S,C,A,M){"use strict";var b=1.5625;var R=1.5;var I=2.125;var T=1.75;var P=v.InvisibleMessageMode;var L=f.SinglePlanningCalendarSelectionMode;var k=e.extend("sap.m.SinglePlanningCalendarMonthGrid",{metadata:{library:"sap.m",properties:{startDate:{type:"object",group:"Data"},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:false},firstDayOfWeek:{type:"int",group:"Appearance",defaultValue:-1},calendarWeekNumbering:{type:"sap.ui.core.date.CalendarWeekNumbering",group:"Appearance",defaultValue:null},dateSelectionMode:{type:"sap.m.SinglePlanningCalendarSelectionMode",group:"Behavior",defaultValue:L.SingleSelect}},aggregations:{appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment",dnd:{draggable:true}},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:true,singularName:"specialDate"},_appsPlaceholders:{type:"sap.m.SinglePlanningCalendarMonthGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}},selectedDates:{type:"sap.ui.unified.DateRange",multiple:true,singularName:"selectedDate"}},dnd:true,associations:{legend:{type:"sap.m.PlanningCalendarLegend",multiple:false}},events:{cellPress:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}},moreLinkPress:{parameters:{date:{type:"object"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}},appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},appointments:{type:"sap.ui.unified.CalendarAppointment[]"}}}}},renderer:m});k.prototype.init=function(){this._aLinks=[];this._handleMorePress=this._handleMorePress.bind(this);this._oDateFormat=t.getDateTimeInstance({pattern:"YYYYMMdd"});this._oFormatAriaApp=t.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY 'at' "+this._getCoreLocaleData().getTimePattern("medium")});this._oFormatAriaFullDayCell=t.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY"});this.setStartDate(A.getInstance());this._configureAppointmentsDragAndDrop();this._oUnifiedRB=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified")};k.prototype.exit=function(){if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation}for(var e=0;e<this._aLinks.length;e++){if(this._aLinks[e]){this._aLinks[e].destroy()}}delete this._aLinks};k.prototype.onBeforeRendering=function(){var e=this.getStartDate();this._oAppointmentsToRender=this._calculateAppointmentsNodes(e);this._createAppointmentsDndPlaceholders(e);this._oInvisibleMessage=_.getInstance();if(this.getFirstDayOfWeek()!==-1&&this.getCalendarWeekNumbering()){d.warning("Both properties firstDayOfWeek and calendarWeekNumbering should not be used at the same time!")}};k.prototype._checkDateSelected=function(e){var t=this.getAggregation("selectedDates");if(!t){return}var a=e.toUTCJSDate().getTime();var i=A.getInstance(Date.UTC(0,0,1));for(var r=0;r<t.length;r++){var o=t[r];var s=o.getStartDate();var l=n.MAX_MILLISECONDS;if(s){i.setUTCFullYear(s.getFullYear(),s.getMonth(),s.getDate());l=i.getTime()}var g=o.getEndDate();var p=-n.MAX_MILLISECONDS;if(g){i.setUTCFullYear(g.getFullYear(),g.getMonth(),g.getDate());p=i.getTime()}if(a===l&&!g||a>=l&&a<=p){return true}}return false};k.prototype.onAfterRendering=function(){this._initItemNavigation()};k.prototype._getColumns=function(){return 7};k.prototype._getRows=function(){return 6};k.prototype._getDateFormatter=function(){return this._oDateFormat};k.prototype._getAppointmetsForADay=function(e){return this._oAppointmentsToRender.filter(function(t){return t.start.valueOf()===e.valueOf()})};k.prototype._getPreviousAppointmetsForADay=function(e){return this._oAppointmentsToRender.filter(function(t){return t.start.valueOf()<e.valueOf()&&t.end.valueOf()>=e.valueOf()}).map(function(t){var a={data:t.data,start:t.start,end:t.end,len:t.len,level:t.level,width:t.width};a.width-=n._daysBetween(e,t.start);a.hasPrevious=true;return a},this)};k.prototype.ontap=function(e){var t=L.MultiSelect===this.getDateSelectionMode();if(!t&&!(e.metaKey||e.ctrlKey)){this.removeAllSelectedDates()}this._bMultiDateSelect=true;this._fireSelectionEvent(e)};k.prototype._rangeSelection=function(e){var t=A.getInstance(a.fromLocalJSDate(e));var n;var i;var r;var o=false;for(r=0;r<7;r++){n=e.getDate()+r;t.setDate(n);if(!this._checkDateSelected(a.fromLocalJSDate(t))){o=true;break}}t=A.getInstance(a.fromLocalJSDate(e));for(r=0;r<7;r++){n=e.getDate()+r;t.setDate(n);i=document.querySelector('[sap-ui-date="'+t.getTime()+'"]');if(o&&i&&i.classList.contains("sapMSPCMonthDaySelected")){continue}this._toggleMarkCell(i,t)}};k.prototype.removeAllSelectedDates=function(){this.removeAllAggregation("selectedDates")};k.prototype.onkeydown=function(e){var t=L.MultiSelect===this.getDateSelectionMode();if(e.which===u.SPACE||e.which===u.ENTER||e.which===u.ARROW_UP||e.which===u.ARROW_DOWN||e.which===u.ARROW_LEFT||e.which===u.ARROW_RIGHT){if(e.which===u.SPACE&&!e.shiftKey&&t){this._bMultiDateSelect=true}else if(e.which===u.SPACE&&e.shiftKey&&t){this._bCurrentWeekSelection=true}else if((e.which===u.ARROW_UP||e.which===u.ARROW_DOWN||e.which===u.ARROW_LEFT||e.which===u.ARROW_RIGHT)&&e.shiftKey&&t){this._bMultiDateSelectWithArrow=true}this._fireSelectionEvent(e);var a=this._findSrcControl(e);if(a&&a.isA("sap.ui.unified.CalendarAppointment")){var n=a.getSelected()?"APPOINTMENT_SELECTED":"APPOINTMENT_UNSELECTED";this._oInvisibleMessage.announce(this._oUnifiedRB.getText(n),P.Polite)}e.preventDefault()}};k.prototype._findSrcControl=function(e){var t=e.target,a=t.parentElement,n;if(!a||a.classList.contains("sapMSPCMonthDays")){return e.srcControl}else if(a.classList.contains("sapUiCalendarRowApps")){n=a.getAttribute("data-sap-ui-related")||a.id}else{n=t.getAttribute("data-sap-ui-related")||t.id}return this.getAppointments().find(function(e){return e.sId===n})};k.prototype._handelMultiDateSelection=function(e,t,n,i){if(this._bMultiDateSelect){this._bMultiDateSelect=false;this._toggleMarkCell(e,t)}else if(this._bMultiDateSelectWithArrow){this._bMultiDateSelectWithArrow=false;var r=A.getInstance(a.fromLocalJSDate(t));switch(i.which){case u.ARROW_UP:r.setDate(r.getDate()-7);break;case u.ARROW_DOWN:r.setDate(r.getDate()+7);break;case u.ARROW_LEFT:r.setDate(r.getDate()-1);break;case u.ARROW_RIGHT:r.setDate(r.getDate()+1);break;default:break}e=document.querySelector('[sap-ui-date="'+r.getTime()+'"]');t=A.getInstance(r.getTime());t=A.getInstance(r.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate());this._toggleMarkCell(e,t)}else if(this._bCurrentWeekSelection&&this.getAggregation("selectedDates")){this._bCurrentWeekSelection=false;var o;var l=S.getWeekConfigurationValues(this.getCalendarWeekNumbering(),new s(C.getFormatSettings().getFormatLocale().toString()));var g=this.getFirstDayOfWeek();if(g<0||g>6){if(l){o=l.firstDayOfWeek}else{var p=this._getCoreLocaleData();o=p.getFirstDayOfWeek()}}else{o=g}t.setDate(t.getDate()-t.getDay()+o);n.setDate(t.getDate()+6);this._rangeSelection(t,n)}};k.prototype._fireSelectionEvent=function(e){var t=this._findSrcControl(e),a=e.target,n=a&&a.classList.contains("sapMSPCMonthDay"),i=a&&a.classList.contains("sapMLnk"),r,o,s;if(t&&t.isA("sap.m.SinglePlanningCalendarMonthGrid")&&n&&!i){r=parseInt(a.getAttribute("sap-ui-date"));o=A.getInstance(r);o=A.getInstance(o.getUTCFullYear(),o.getUTCMonth(),o.getUTCDate());s=A.getInstance(o);s.setDate(s.getDate()+1);if(this._bMultiDateSelect||this._bCurrentWeekSelection||this._bMultiDateSelectWithArrow){this._handelMultiDateSelection(a,o,s,e);this.fireEvent("selectDate",{startDate:o,endDate:s})}this.fireEvent("cellPress",{startDate:o,endDate:s});this.fireAppointmentSelect({appointment:undefined,appointments:this._toggleAppointmentSelection(undefined,true)})}else if(t&&t.isA("sap.ui.unified.CalendarAppointment")){if(a.parentElement&&a.parentElement.getAttribute("id")){var l=a.parentElement.getAttribute("id");var g=a.parentElement.getAttribute("data-sap-ui-related");var p=l.replace(g+"-","");t._setAppointmentPartSuffix(p)}this.fireAppointmentSelect({appointment:t,appointments:this._toggleAppointmentSelection(t,!(e.ctrlKey||e.metaKey))})}};k.prototype._toggleMarkCell=function(e,t){var a=A.getInstance(Date.UTC(0,0,1));a.setUTCFullYear(t.getFullYear(),t.getMonth(),t.getDate());a.setMinutes(0,0,0);if(e&&!e.classList.contains("sapMSPCMonthDaySelected")){this.addAggregation("selectedDates",new M({startDate:a}))}else{var n=this.getAggregation("selectedDates");if(!n){return this}for(var i=0;i<n.length;i++){var r=A.getInstance(Date.UTC(0,0,1));var o=n[i].getStartDate();r.setUTCFullYear(o.getFullYear(),o.getMonth(),o.getDate());if(r.getTime()===a.getTime()){this.removeAggregation("selectedDates",i);break}}}};k.prototype._toggleAppointmentSelection=function(e,t){var a=[],n=e&&e.getDomRef(),i,r,o;if(t){i=this.getAppointments();for(o=0,r=i.length;o<r;o++){if((!e||i[o].getId()!==e.getId())&&i[o].getSelected()){i[o].setProperty("selected",false);a.push(i[o])}}}if(e){e.setProperty("selected",!e.getSelected());a.push(e);this._sSelectedAppointment=e.getSelected()&&n?e:undefined}else{this._sSelectedAppointment=undefined}return a};k.prototype._getMoreLink=function(e,t,a){var n=c.getLibraryResourceBundle("sap.m").getText("SPC_MORE_LINK",[e.toString()]),i=new h({text:n,press:this._handleMorePress}).addCustomData(new p({key:"date",value:t.valueOf().toString(),writeToDom:true}));if(this._aLinks[a]){this._aLinks[a].destroy()}this._aLinks[a]=i;return i};k.prototype._handleMorePress=function(e){var t=parseInt(e.getSource().getCustomData()[0].getValue()),a=A.getInstance(t);a=A.getInstance(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate());this.fireEvent("moreLinkPress",{date:a})};k.prototype._getCoreLocaleData=function(){var e=c.getConfiguration().getFormatSettings().getFormatLocale().toString(),t=new s(e);return o.getInstance(t)};k.prototype._getCells=function(){return this._getVisibleDays(this.getStartDate())};k.prototype._getVerticalLabels=function(){var e=this._getVisibleDays(this.getStartDate()),a=this._getColumns(),n=[],i=c.getConfiguration().getFormatLocale().toString();for(var r=0;r<this._getRows();r++){var o=t.getInstance({pattern:"w",calendarType:"Gregorian",calendarWeekNumbering:this.getCalendarWeekNumbering()},new s(i));var l=Number(o.format(e[r*a].toUTCJSDate(),true));n.push(l)}return n};k.prototype._getVisibleDays=function(e){var t,n,i,r,o,l,g,p=[];if(!e){return p}t=a.fromLocalJSDate(e);n=this.getFirstDayOfWeek();if(n<0||n>6){var u=S.getWeekConfigurationValues(this.getCalendarWeekNumbering(),new s(C.getFormatSettings().getFormatLocale().toString()));if(u){g=u.firstDayOfWeek}else{var d=this._getCoreLocaleData();g=d.getFirstDayOfWeek()}}l=new a(t);l.setDate(1);o=l.getDay()-g;if(o<0){o=7+o}if(o>0){l.setDate(1-o)}i=new a(l);for(var c=0;c<this._getColumns()*this._getRows();c++){r=new a(i);p.push(r);i.setDate(i.getDate()+1)}return p};k.prototype._getAppointmentsToRender=function(){return this._oAppointmentsToRender};k.prototype._calculateAppointmentsNodes=function(e){var t=this._getVisibleDays(e),i=t[0],r=t[t.length-1],o=this.getAppointments().filter(function(e){var t=e.getStartDate()&&e.getEndDate();if(!t){d.warning("Appointment "+e.getId()+" has no start or no end date. It is ignored.")}return t}).map(function(e){var t=a.fromLocalJSDate(e.getStartDate()),i=a.fromLocalJSDate(e.getEndDate());return{data:e,start:t,end:i,len:n._daysBetween(i,t)}}).filter(function(e){return n._isBetween(e.start,i,r,true)||n._isBetween(e.end,i,r,true)||n._isBetween(i,e.start,r,true)&&n._isBetween(r,i,e.end,true)}).sort(function e(t,a){return t.start.valueOf()-a.start.valueOf()}),s=[],l,g,p,u,c,h,f;for(c=0;c<t.length;c++){s.push([])}for(c=0;c<o.length;c++){l=o[c];g=n._daysBetween(l.start,t[0]);p=g+l.len;g=g>0?g:0;p=p<t.length?p:t.length-1;l.width=l.len+1;u=s[g].indexOf(true);if(u===-1){u=s[g].length}l.level=u;for(h=g;h<=p;h++){s[h][u]=false;for(f=0;f<u;f++){if(s[h][f]===undefined){s[h][f]=true}}}}this._aAppsLevelsPerDay=s;return o};k.prototype._getMoreCountPerCell=function(e){var t=this._aAppsLevelsPerDay[e];var a=this._getMaxAppointments();var n=0;if(t.length<a){return 0}for(var i=a-1;i<t.length;i++){if(!t[i]){n++}}return n};k.prototype._configureAppointmentsDragAndDrop=function(){this.addDragDropConfig(new g({sourceAggregation:"appointments",targetAggregation:"_appsPlaceholders",dragStart:function(e){if(!this.getEnableAppointmentsDragAndDrop()){e.preventDefault();return false}var t=function(){var e=jQuery(".sapMSinglePCOverlay");setTimeout(function(){e.addClass("sapMSinglePCOverlayDragging")});jQuery(document).one("dragend",function(){e.removeClass("sapMSinglePCOverlayDragging")})};t()}.bind(this),dragEnter:function(e){var t=e.getParameter("dragSession"),a=function(){var e=jQuery(t.getIndicator());e.css("min-height",t.getDropControl().$().outerHeight());e.css("min-width",t.getDropControl().$().outerWidth())};if(!t.getIndicator()){setTimeout(a,0)}else{a()}},drop:function(e){var t=e.getParameter("dragSession"),i=t.getDragControl(),r=t.getDropControl(),o=r.getDate(),s=a.fromLocalJSDate(i.getStartDate()),l=a.fromLocalJSDate(i.getEndDate()),g=n._daysBetween(o,s),p=new a(s),u=new a(l),d=e.getParameter("browserEvent"),c=d.metaKey||d.ctrlKey;p.setDate(p.getDate()+g);u.setDate(u.getDate()+g);this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(s.valueOf()===o.valueOf()){return}this.fireAppointmentDrop({appointment:i,startDate:p.toLocalJSDate(),endDate:u.toLocalJSDate(),copy:c})}.bind(this)}))};k.prototype._initItemNavigation=function(){var e=this.getDomRef();this._aGridCells=this.$().find(".sapMSPCMonthDay").toArray();if(!this._oItemNavigation){this._oItemNavigation=new l;this.addDelegate(this._oItemNavigation);this._oItemNavigation.attachEvent(l.Events.BorderReached,this._itemNavigationBorderReached,this)}this._oItemNavigation.setRootDomRef(e);this._oItemNavigation.setItemDomRefs(this._aGridCells);this._oItemNavigation.setCycling(false);this._oItemNavigation.setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"],saphome:["alt","meta"],sapend:["meta"]});this._oItemNavigation.setTableMode(false).setColumns(this._getColumns(),true);this._oItemNavigation.setPageSize(this._aGridCells.length)};k.prototype._itemNavigationBorderReached=function(e){var t,a,n=e.getParameter("event"),i;if(n.target.classList.contains("sapMSPCMonthDay")){t=n.target;a=parseInt(t.getAttribute("sap-ui-date"));switch(n.keyCode){case u.ARROW_LEFT:i=-1;break;case u.ARROW_UP:i=-this._getColumns();break;case u.ARROW_RIGHT:i=1;break;case u.ARROW_DOWN:i=this._getColumns();break;default:break}this.fireEvent("borderReached",{startDate:a,offset:i})}};k.prototype._createAppointmentsDndPlaceholders=function(e){var t=this._getVisibleDays(e);this.destroyAggregation("_appsPlaceholders");for(var a=0;a<t.length;a++){var n=new E({date:t[a]});this.addAggregation("_appsPlaceholders",n,true)}};var E=e.extend("sap.m.SinglePlanningCalendarMonthGrid._internal.IntervalPlaceholder",{metadata:{properties:{date:{type:"object",group:"Data"}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t).class("sapMSinglePCPlaceholder").openEnd().close("div")}}});k.prototype._getCellStartInfo=function(e){var t=c.getLibraryResourceBundle("sap.ui.unified").getText("CALENDAR_START_TIME");return t+": "+this._oFormatAriaFullDayCell.format(e)+"; "};k.prototype._getAppointmentAnnouncementInfo=function(e){var t=c.getLibraryResourceBundle("sap.ui.unified"),a=t.getText("CALENDAR_START_TIME"),n=t.getText("CALENDAR_END_TIME"),i=this._oFormatAriaApp.format(e.getStartDate()),r=this._oFormatAriaApp.format(e.getEndDate()),o=a+": "+i+"; "+n+": "+r;return o+"; "+D.findLegendItemForItem(c.byId(this._sLegendId),e)};k.prototype._getMaxAppointments=function(){return this._isCompact()?4:3};k.prototype._getDensitySizes=function(){return this._isCompact()?{appHeight:b,cellHeaderHeight:R}:{appHeight:I,cellHeaderHeight:T}};k.prototype._isCompact=function(){var e=this.getDomRef()||(this.getParent()&&this.getParent().getDomRef&&this.getParent().getDomRef()||this.getParent()&&this.getParent().getRootNode&&this.getParent().getRootNode());while(e&&e.classList){if(e.classList.contains("sapUiSizeCompact")){return true}e=e.parentNode}return false};k.prototype._getSpecialDates=function(){var e=this.getSpecialDates();for(var t=0;t<e.length;t++){var a=e[t].getSecondaryType()===r.CalendarDayType.NonWorking&&e[t].getType()!==r.CalendarDayType.NonWorking;if(a){var n=new i;n.setType(r.CalendarDayType.NonWorking);n.setStartDate(e[t].getStartDate());if(e[t].getEndDate()){n.setEndDate(e[t].getEndDate())}e.push(n)}}return e};k.prototype.applyFocusInfo=function(){this._sSelectedAppointment&&this._sSelectedAppointment.focus();return this};return k});
//# sourceMappingURL=SinglePlanningCalendarMonthGrid.js.map