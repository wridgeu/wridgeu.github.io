/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/ResponsivePopover","sap/m/List","sap/m/StandardListItem","sap/m/Button","sap/m/Title","sap/m/VBox","sap/m/Toolbar","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/m/ScrollContainer","sap/m/table/ColumnMenuRenderer","sap/m/library","sap/ui/core/Control","sap/ui/core/Core","sap/ui/thirdparty/jquery","sap/base/strings/capitalize","sap/m/p13n/AbstractContainerItem","sap/ui/core/Element","sap/m/p13n/Container"],function(t,e,i,o,n,s,r,a,c,g,u,p,l,h,f,_,d,m,v){"use strict";var C=l.extend("sap.m.table.ColumnMenu",{metadata:{library:"sap.m",aggregations:{quickActions:{type:"sap.m.table.QuickActionBase"},items:{type:"sap.m.table.ItemBase"},_quickActions:{type:"sap.m.table.QuickActionBase",visibility:"hidden"},_items:{type:"sap.m.table.ItemBase",visibility:"hidden"}}}});var I="$default";C.prototype.applySettings=function(t){if(t){this._addAllToPrivateAggregation(t,"_quickActions");this._addAllToPrivateAggregation(t,"_items")}l.prototype.applySettings.apply(this,arguments)};C.prototype.openBy=function(t){if(!this._oPopover){this._createPopover()}if(!this._oItemsContainer){this._initItemsContainer()}this._oPopover.openBy(t)};C.prototype.close=function(){this._previousView=null;if(this._oPopover){this._oPopover.close()}};C.prototype.exit=function(){l.prototype.exit.apply(this,arguments);if(this._oPopover){delete this._oPopover}if(this._oItemsContainer){delete this._oItemsContainer}};C.prototype._addAllToPrivateAggregation=function(t,e){if(t[e]){t[e].forEach(function(t){this.addAggregation(e,t)}.bind(this));delete t[e]}};C.prototype._createPopover=function(){if(!this._oPopover){this._oPopover=new t({showArrow:false,showHeader:false,placement:p.PlacementType.Bottom,content:new y({control:this,height:true}),contentWidth:"500px",horizontalScrolling:false,verticalScrolling:false});this.addDependent(this._oPopover);this._oPopover.attachAfterClose(function(){this.close()}.bind(this));this._focusDelegate={onAfterRendering:this._focusItem};this._oPopover.addEventDelegate(this._focusDelegate,this);if(this.getItems().length==0&&!this.getAggregation("_items")){this._oPopover.attachAfterOpen(this._focusInitialQuickAction.bind(this))}}return this._oPopover};C.prototype._initItemsContainer=function(){var t=(this.getAggregation("_items")||[]).reduce(function(t,e){return t.concat(e.getEffectiveItems())},[]);var e=this.getItems().reduce(function(t,e){return t.concat(e.getEffectiveItems())},[]);if(!this._oItemsContainer){this._createItemsContainer()}t.forEach(function(t,e){this._addView(t);e==0&&this._oItemsContainer.addSeparator()}.bind(this));e.forEach(function(t,e){this._addView(t);e==0&&this._oItemsContainer.addSeparator()}.bind(this))};var y=l.extend("sap.m.table.AssociativeControl",{metadata:{final:true,properties:{height:{type:"boolean",defaultValue:false}},associations:{control:{type:"sap.ui.core.Control"}}},renderer:{apiVersion:2,render:function(t,e){t.openStart("div",e);e.getHeight()&&t.style("height","100%");t.openEnd();t.renderControl(sap.ui.getCore().byId(e.getControl()));t.close("div")}}});C.prototype._addView=function(t){var e=new d({content:new y({control:t.getContent(),height:true}),key:t.getId(),text:t.getLabel(),icon:t.getIcon()});this._oItemsContainer.addView(e);this._setItemVisibility(t,t.getVisible())};C.prototype._createItemsContainer=function(){var t=this;this._oBtnCancel=new o({text:this._getResourceText("table.COLUMNMENU_CANCEL"),press:function(){var e=t._oItemsContainer.getCurrentViewKey();if(t._fireEvent(h.byId(e),"cancel")){t.close();t.exit()}}});this._oBtnOk=new o({text:this._getResourceText("table.COLUMNMENU_CONFIRM"),press:function(){var e=t._oItemsContainer.getCurrentViewKey();if(t._fireEvent(h.byId(e),"confirm")){t.close()}}});t._oItemsContainer=new v({listLayout:true,defaultView:I,footer:new r({content:[new c,this._oBtnOk,this._oBtnCancel]}),beforeViewSwitch:function(e){var i=e.getParameters();if(i.target!=="$default"){var o=t._oItemsContainer.getView(i.target);var n=t._getItemFromContainerItem(o);if(n&&n.firePress&&!t._fireEvent(n,"press")){e.preventDefault();return}}},afterViewSwitch:function(e){var i=e.getParameters();this.oLayout.setShowFooter(i.target!=="$default");t._previousView=i.source;if(i.target!=="$default"){var o=t._oItemsContainer.getView(i.target);if(o){var n=t._getItemFromContainerItem(o);t._updateButtonState(n)}else{var o=t._oItemsContainer.getView(i.target);var n=t._getItemFromContainerItem(o);n&&n.focus();this._oPopover&&this._oPopover.invalidate()}}}});t._oItemsContainer.getHeader().addContentRight(new o({text:this._getResourceText("table.COLUMNMENU_RESET"),press:function(){t._fireEvent(h.byId(t._oItemsContainer.getCurrentViewKey()),"reset",false)}}));this._oPopover.addDependent(t._oItemsContainer);t.addDependent(t._oItemsContainer)};C.prototype._fireEvent=function(t,e,i){var o=t["on"+_(e)];if(i!==false){var n=f.Event(e);o.call(t,n);return!n.isDefaultPrevented()}else{o.call(t);return true}};C.prototype._getResourceText=function(t,e){this.oResourceBundle=this.oResourceBundle?this.oResourceBundle:sap.ui.getCore().getLibraryResourceBundle("sap.m");return t?this.oResourceBundle.getText(t,e):this.oResourceBundle};C.prototype._getItemFromContainerItem=function(t){var e=this.getAggregation("_items")&&this.getAggregation("_items").find(function(e){return e.getId()==t.getKey()});if(!e){e=this.getAggregation("items")&&this.getAggregation("items").find(function(e){return e.getId()==t.getKey()})}return e};C.prototype._updateButtonState=function(t){this._oItemsContainer.getHeader().getContentRight()[0].setEnabled(t.getButtonSettings()["reset"]["enabled"]);this._oItemsContainer.getHeader().getContentRight()[0].setVisible(t.getButtonSettings()["reset"]["visible"]);this._oBtnOk.setVisible(t.getButtonSettings()["confirm"]["visible"]);this._oBtnCancel.setVisible(t.getButtonSettings()["cancel"]["visible"])};C.prototype._focusItem=function(){if(this._previousView==I){this._oItemsContainer._getNavBackBtn().focus()}else{var t=this._oItemsContainer._getNavigationList().getItems().find(function(t){return t.getVisible()&&t._key===this._previousView}.bind(this));t&&t.focus()}};C.prototype._focusInitialQuickAction=function(){if(this.getItems().length==0&&!this.getAggregation("_items")){var t=[];if(this.getAggregation("_quickActions")){t=this.getAggregation("_quickActions")[0].getEffectiveQuickActions()}else if(this.getQuickActions().length>0){t=this.getQuickActions()[0].getEffectiveQuickActions()}t.length>0&&t[0].getContent().focus()}};C.prototype._setItemVisibility=function(t,e){var i=this._oItemsContainer._getNavigationList().getItems();var o=i.find(function(e){return e._key==t.getId()});o&&o.setVisible(e)};return C});