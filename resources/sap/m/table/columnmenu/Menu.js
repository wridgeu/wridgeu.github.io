/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/ResponsivePopover","sap/m/Button","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/library","sap/ui/Device","sap/ui/base/Object","sap/ui/core/Control","sap/ui/core/Core","sap/ui/core/library","sap/ui/core/UIArea","sap/ui/thirdparty/jquery","sap/ui/dom/containsOrEquals","sap/ui/events/ControlEvents","sap/base/strings/capitalize","sap/m/p13n/AbstractContainerItem","sap/m/p13n/Container","sap/m/table/columnmenu/MenuRenderer","sap/ui/layout/form/Form","sap/ui/layout/GridData","sap/ui/layout/form/ResponsiveGridLayout","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement","sap/m/Label"],function(e,t,i,o,n,r,s,a,u,l,c,p,f,h,g,d,m,_,v,y,C,I,b,A){"use strict";var E=l.aria.HasPopup;var w=l.VerticalAlign;var P=n.table.columnmenu.Category;var B=a.extend("sap.m.table.columnmenu.Menu",{metadata:{library:"sap.m",interfaces:["sap.ui.core.IColumnHeaderMenu"],aggregations:{quickActions:{type:"sap.m.table.columnmenu.QuickActionBase"},items:{type:"sap.m.table.columnmenu.ItemBase"},_quickActions:{type:"sap.m.table.columnmenu.QuickActionBase",visibility:"hidden"},_items:{type:"sap.m.table.columnmenu.ItemBase",visibility:"hidden"}},events:{beforeOpen:{parameters:{openBy:{type:"sap.ui.core.Element"}}}}},renderer:_});var L="$default";var k=E.Dialog;B.prototype.init=function(){this.fAnyEventHandlerProxy=p.proxy(function(e){if(!this.isOpen()||!this.getDomRef()||e.type!="mousedown"&&e.type!="touchstart"){return}this.handleOuterEvent(this.getId(),e)},this)};B.prototype.applySettings=function(e){if(e){this._addAllToPrivateAggregation(e,"_quickActions");this._addAllToPrivateAggregation(e,"_items")}a.prototype.applySettings.apply(this,arguments)};B.prototype.openBy=function(e){if(this.isOpen()){return}if(!this.getParent()){c.registry.get(u.getStaticAreaRef().id).addContent(this,true)}var t=e;if(!s.isA(e,"sap.ui.core.Element")){t=p(e).control(0,true)}this.fireBeforeOpen({openBy:t});this._initPopover();this._createQuickActionGrids();if(this._oItemsContainer){this._oItemsContainer.destroy();this._oItemsContainer=null}this._initItemsContainer();this._oPopover.openBy(e);h.bindAnyEvent(this.fAnyEventHandlerProxy)};B.prototype.getAriaHasPopupType=function(){return k};B.prototype.isOpen=function(){return this._oPopover&&this._oPopover.isOpen()};B.prototype.close=function(){this._previousView=null;if(this._oPopover){this._oPopover.close()}h.unbindAnyEvent(this.fAnyEventHandlerProxy)};B.prototype.exit=function(){a.prototype.exit.apply(this,arguments);if(this._oPopover){delete this._oPopover}if(this._oItemsContainer){delete this._oItemsContainer}h.unbindAnyEvent(this.fAnyEventHandlerProxy)};B.prototype._addAllToPrivateAggregation=function(e,t){if(e[t]){e[t].forEach(function(e){this.addAggregation(t,e)}.bind(this));delete e[t]}};B.prototype._initPopover=function(){if(this._oPopover){return}this._oPopover=new e({title:this._getResourceText("table.COLUMNMENU_TITLE"),ariaLabelledBy:this.getId()+"-menuDescription",showArrow:false,showHeader:r.system.phone,placement:n.PlacementType.Bottom,content:new V({control:this,height:true}),horizontalScrolling:false,verticalScrolling:false,afterClose:[this.close,this]});this.addDependent(this._oPopover);this._oPopover.addStyleClass("sapMTCMenuPopup");this._oPopover.addEventDelegate({onAfterRendering:this._focusItem},this);if(this._getAllEffectiveItems().length===0){this._oPopover.attachAfterOpen(this._focusInitialQuickAction.bind(this))}else{this._oPopover.attachAfterOpen(function(){var e=this._oItemsContainer._getNavigationList().getItems().find(function(e){return e.getVisible()});e&&e.focus()}.bind(this))}this._oPopover._oControl.oPopup.setAutoClose(false)};B.prototype.onsapfocusleave=function(e){if(!this.isOpen()){return}this.handleOuterEvent(this.getId(),e)};B.prototype.handleOuterEvent=function(e,t){var i=false,o=r.support.touch||r.system.combi;if(t.type=="mousedown"||t.type=="touchstart"){if(o&&(t.isMarked("delayedMouseEvent")||t.isMarked("cancelAutoClose"))){return}if(f(this.getDomRef(),t.target)||f(u.getStaticAreaRef(),t.target)||S(this,u.byId(t.target.id))){i=true}}else if(t.type=="sapfocusleave"){if(o){return}if(t.relatedControlId){if(f(this.getDomRef(),p(document.getElementById(t.relatedControlId)).get(0))||S(this,u.byId(t.relatedControlId))){i=true}}}if(!i){this.close()}};function S(e,t){if(!e||!t){return false}var i=t.getParent();if(!i){return false}else if(i===e){return true}return S(e,i)}B.prototype._initItemsContainer=function(){var e=this._getAllEffectiveItems();var t=this._hasQuickActions();var i=this._hasItems();if(!this._oItemsContainer){this._createItemsContainer()}e.forEach(function(e,o){this._addView(e);if(t&&i&&o===0){this._oItemsContainer.addSeparator()}}.bind(this))};var V=a.extend("sap.m.table.columnmenu.AssociativeControl",{metadata:{final:true,properties:{height:{type:"boolean",defaultValue:false}},associations:{control:{type:"sap.ui.core.Control"}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);t.getHeight()&&e.style("height","100%");e.openEnd();e.renderControl(sap.ui.getCore().byId(t.getControl()));e.close("div")}}});B.prototype._addView=function(e){var t=new d({content:new V({control:e.getContent(),height:true}),key:e.getId(),text:e.getLabel(),icon:e.getIcon()});this._oItemsContainer.addView(t);this._setItemVisibility(e,e.getVisible())};B.prototype._createItemsContainer=function(){var e=this;this._oBtnCancel=new t({text:this._getResourceText("table.COLUMNMENU_CANCEL"),press:function(){var t=e._oItemsContainer.getCurrentViewKey();if(e._fireEvent(u.byId(t),"cancel")){e.close()}}});this._oBtnOk=new t({text:this._getResourceText("table.COLUMNMENU_CONFIRM"),type:n.ButtonType.Emphasized,press:function(){var t=e._oItemsContainer.getCurrentViewKey();if(e._fireEvent(u.byId(t),"confirm")){e.close()}}});e._oItemsContainer=new m({listLayout:true,defaultView:L,footer:new i({content:[new o,this._oBtnOk,this._oBtnCancel]}),beforeViewSwitch:function(t){var i=t.getParameters();if(i.target!=="$default"){var o=e._oItemsContainer.getView(i.target);var n=e._getItemFromContainerItem(o);if(n&&!e._fireEvent(n,"press")){t.preventDefault()}}},afterViewSwitch:function(t){var i=t.getParameters();this.oLayout.setShowFooter(i.target!=="$default");e._previousView=i.source;if(i.target!=="$default"){var o=e._oItemsContainer.getView(i.target);if(o){var n=e._getItemFromContainerItem(o);e._updateButtonState(n);e._focusItem()}}else{e._focusItem();this._oPopover&&this._oPopover.invalidate()}}});e._oItemsContainer.getHeader().addContentRight(new t({text:this._getResourceText("table.COLUMNMENU_RESET"),press:function(){e._fireEvent(u.byId(e._oItemsContainer.getCurrentViewKey()),"reset",false)}}));this._oPopover.addDependent(e._oItemsContainer);e.addDependent(e._oItemsContainer)};B.prototype._fireEvent=function(e,t,i){var o=e["on"+g(t)];if(i!==false){var n=p.Event(t);o.call(e,n);return!n.isDefaultPrevented()}else{o.call(e);return true}};B.prototype._getResourceText=function(e,t){this.oResourceBundle=this.oResourceBundle?this.oResourceBundle:sap.ui.getCore().getLibraryResourceBundle("sap.m");return e?this.oResourceBundle.getText(e,t):this.oResourceBundle};var M={};M[P.Sort]=0;M[P.Filter]=1;M[P.Group]=2;M[P.Aggregate]=3;M[P.Generic]=4;B.prototype._getAllEffectiveQuickActions=function(e){var t=(this.getAggregation("_quickActions")||[]).concat(this.getQuickActions());t=t.reduce(function(e,t){return e.concat(t?t.getEffectiveQuickActions():[])},[]);if(!e){t.sort(function(e,t){return M[e.getCategory()]-M[t.getCategory()]})}return t};B.prototype._hasQuickActions=function(){return this._getAllEffectiveQuickActions(true).length>0};B.prototype._getAllEffectiveItems=function(){var e=(this.getAggregation("_items")||[]).concat(this.getItems());return e.reduce(function(e,t){return e.concat(t.getEffectiveItems())},[]).filter(function(e){return e.getVisible()})};B.prototype._hasItems=function(){return this._getAllEffectiveItems().length>0};B.prototype._getItemFromContainerItem=function(e){return this._getAllEffectiveItems().find(function(t){return t.getId()===e.getKey()})};B.prototype._updateButtonState=function(e){if(!this._oItemsContainer){return}if(this._oItemsContainer.getCurrentViewKey()===L){return}this._oItemsContainer.getHeader().getContentRight()[0].setVisible(e.getButtonSettings()["reset"]["visible"]);this._oItemsContainer.getHeader().getContentRight()[0].setEnabled(e.getButtonSettings()["reset"]["enabled"]);this._oBtnOk.setVisible(e.getButtonSettings()["confirm"]["visible"]);this._oBtnCancel.setVisible(e.getButtonSettings()["cancel"]["visible"])};B.prototype._focusItem=function(){if(this._previousView==L){this._oItemsContainer._getNavBackBtn().focus()}else{var e=this._oItemsContainer._getNavigationList().getItems().find(function(e){return e.getVisible()&&e._key===this._previousView}.bind(this));e&&e.focus()}};B.prototype._focusInitialQuickAction=function(){var e=[];if(this.getAggregation("_quickActions")){e=this.getAggregation("_quickActions")[0].getEffectiveQuickActions()}else if(this.getQuickActions().length>0){e=this.getQuickActions()[0].getEffectiveQuickActions()}e.length>0&&e[0].getContent()[0].focus()};B.prototype._setItemVisibility=function(e,t){var i=this._oItemsContainer._getNavigationList().getItems();var o=i.find(function(t){return t._key==e.getId()});o&&o.setVisible(t)};B.prototype._createQuickActionGrids=function(){var e;if(this._oForm){e=this._oForm.getFormContainers()[0];e.destroyFormElements()}else{e=new I;this._oForm=new v({layout:new C({breakpointM:600,labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,columnsL:1,columnsM:1,adjustLabelSpan:false}),editable:true,formContainers:e});this._oForm.addStyleClass("sapMTCMenuQAForm");this._oForm.addEventDelegate({onAfterRendering:function(){this.getDomRef().classList.remove("sapUiFormLblColon")}},this._oForm)}this._getAllEffectiveQuickActions().forEach(function(t){if(!t.getVisible()){return}var i=new y({span:"XL4 L4 M4 S12"});var o=t.getLabel();var n=new A({text:o,layoutData:i,vAlign:w.Middle,wrapping:true,width:"100%",showColon:o!==""&&!(t.getParent()&&t.getParent().isA("sap.m.table.columnmenu.QuickSortItem"))&&t._bHideLabelColon!==true});n.addStyleClass("sapMTCMenuQALabel");var r=[];var s=t.getContent();s.forEach(function(e,t){var i,o,a,u;if(e.getLayoutData()){i=e.getLayoutData().clone()}else{o="L8 M8 S12";a="";if(t>0||t==0&&s.length>1){o="L4 M4 S6";if(t!=0&&(t+1)%2>0){a="L4 M4 S0"}}i=new y({span:o,indent:a})}e.removeAllAssociation("ariaLabelledBy");e.addAssociation("ariaLabelledBy",n.getId());u=new V({control:e.setWidth("100%")});u.setLayoutData(i);r.push(u)},this);e.addFormElement(new b({label:n,fields:r}))},this);this.addDependent(this._oForm)};return B});