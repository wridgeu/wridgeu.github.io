/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/array/diff","sap/ui/base/Object","sap/base/util/merge","sap/base/util/deepEqual","sap/ui/model/json/JSONModel","sap/m/p13n/SelectionPanel","sap/m/p13n/modules/xConfigAPI"],function(e,t,n,i,o,r,a){"use strict";var s=t.extend("sap.m.p13n.SelectionController",{constructor:function(e){t.call(this);this._sTargetAggregation=e.targetAggregation;this._fSelector=e.selector;this._oAdaptationControl=e.control;this._oP13nData=null;this._bLiveMode=false;this._bResetEnabled=false}});s.prototype.getAdaptationControl=function(){return this._oAdaptationControl};s.prototype.getTargetAggregation=function(){return this._sTargetAggregation};s.prototype.getChangeOperations=function(){return{add:"addItem",remove:"removeItem",move:"moveItem"}};s.prototype.getSelectorForReset=function(){return this._oAdaptationControl};s.prototype.sanityCheck=function(e){return e};s.prototype.initAdaptationUI=function(e){var t=this.mixInfoAndState(e);return this.retrieveUI(t).then(function(e){this._oPanel=e;return Promise.resolve(e)}.bind(this))};s.prototype.retrieveUI=function(e){var t=new r({showHeader:true,enableCount:true});t.setP13nData(e.items);return Promise.resolve(t)};s.prototype.getCurrentState=function(){var e=[],t=this.getAdaptationControl().getAggregation(this.getTargetAggregation())||[];t.forEach(function(t,n){var i=this._fSelector?this._fSelector({key:t.getId()}):t.getVisible();if(i){e.push({key:t.getId()})}}.bind(this));var n=a.readConfig(this.getAdaptationControl())||{};var i=n.hasOwnProperty("aggregations")?n.aggregations[this._sTargetAggregation]:{};for(var o in i){var r=e.map(function(e){return e.key});var s=r.indexOf(o);var p=i[o].position;if(i[o].visible===true&&s===-1){e.push({key:o})}if(p!==undefined&&e.length>0){var l=e.splice(s,1)[0];e.splice(p,0,l);s=p}if(i[o].visible===false&&s>-1){e.splice(s,1)}}return e};s.prototype.getStateKey=function(){return"items"};s.prototype.getDelta=function(e){var t=this._getPresenceAttribute(e.externalAppliance);var n;var o=function(e){return e.hasOwnProperty(t)&&e[t]===false?false:true};n=e.applyAbsolute?e.changedState.filter(o):this._getFilledArray(e.existingState,e.changedState,t).filter(o);e.changedState=n;if(i(e.existingState,n)){return[]}else{return this.getArrayDeltaChanges(e)}};s.prototype.getArrayDeltaChanges=function(t){var n=t.existingState;var i=t.changedState;var o=t.control;var r=t.changeOperations.add;var a=t.changeOperations.remove;var s=t.changeOperations.move;var p=t.generator;var l=t.deltaAttributes||[];var u=function(e){var t="";l.forEach(function(n){t=t+e[n]});return t};var g=e(n,i,u);var c=function(e,t){return t.filter(function(t){return t&&t.key===e.key})[0]};var d=[];var f=n.slice(0);g.forEach(function(e){if(e.type==="delete"&&f[e.index]===undefined){f.splice(e.index,1);return}var t,n,u;if(e.type==="insert"){n=c(i[e.index],f);if(n){n.index=f.indexOf(n);f.splice(n.index,1,undefined);d=d.concat(this._createAddRemoveChange(o,a,this._getChangeContent(n,l),p))}}t=e.type==="delete"?f[e.index]:i[e.index];t.index=e.index;if(e.type==="delete"){f.splice(t.index,1)}else{f.splice(t.index,0,t)}if(s){u=d.length;if(u){n=d[u-1];n=n?n.changeSpecificData.content:undefined}if(n&&n.key===t.key&&e.index!=n.index){d.pop();d=d.concat(this._createMoveChange(n.id,n.key,e.index,s,o,s!=="moveSort",p));return}}d=d.concat(this._createAddRemoveChange(o,e.type==="delete"?a:r,this._getChangeContent(t,l),p))}.bind(this));return d};s.prototype._getChangeContent=function(e,t){var n={};if(e.index>=0){n.index=e.index}t.forEach(function(t){if(e.hasOwnProperty(t)){n[t]=e[t]}});return n};s.prototype._createAddRemoveChange=function(e,t,n){var i={selectorElement:e,changeSpecificData:{changeType:t,content:{key:n.key,targetAggregation:this.getTargetAggregation(),index:n.index,value:t===this.getChangeOperations()["add"]}}};return i};s.prototype._createMoveChange=function(e,t,n,i,o,r){var a={selectorElement:o,changeSpecificData:{changeType:i,content:{key:t,targetAggregation:this.getTargetAggregation(),index:n}}};return a};s.prototype._getPresenceAttribute=function(e){return"visible"};s.prototype.getBeforeApply=function(){return Promise.resolve()};s.prototype.mixInfoAndState=function(e){var t=this.getCurrentState();var n=this.arrayToMap(t);var i=this.prepareAdaptationData(e,function(e,t){var i=n[t.key];e.visible=this._fSelector?this._fSelector(t):!!i;e.position=i?i.position:-1;return!(t.visible===false)}.bind(this));this.sortP13nData({visible:"visible",position:"position"},i.items);i.items.forEach(function(e){delete e.position});return i};s.prototype.getP13nData=function(){return this._oPanel?this._oPanel.getP13nData():this._oAdaptationModel.getProperty("/items")};s.prototype.model2State=false;s.prototype.update=function(e){if(this._oPanel){var t=this.mixInfoAndState(e);this._oPanel.setP13nData(t.items)}else if(this._oAdaptationModel){var n=this.mixInfoAndState(e);this._oAdaptationModel.setProperty("/items",n.items);this._oAdaptationModel.setProperty("/itemsGrouped",n.itemsGrouped)}};s.prototype._getFilledArray=function(e,t,i){var o=n([],e);var r=n([],t);var a=this.arrayToMap(e);r.forEach(function(e){var t=a[e.key];if(!e.hasOwnProperty(i)||e[i]){var n=e.position;if(t){n=n>-1?n:t.position;var r=t.position;o.splice(n,0,o.splice(r,1)[0])}else{n=n>-1?n:o.length;o.splice(n,0,e)}o[n]=e}else if(t){o[t.position][i]=false}});return o};s.prototype._getP13nModel=function(e){if(!this._oAdaptationModel){this._oAdaptationModel=new o(this.mixInfoAndState(e));this._oP13nData=this._oAdaptationModel.getData();this._oAdaptationModel.setSizeLimit(1e4)}else{this.update(e)}return this._oAdaptationModel};s.prototype.changesToState=function(e){var t=[];e.forEach(function(e){var i=n({},e.changeSpecificData.content);var o=i.index;delete i.index;if(e.changeSpecificData.changeType===this.getChangeOperations()["move"]){i.position=o}if(e.changeSpecificData.changeType===this.getChangeOperations()["remove"]){i[this._getPresenceAttribute()]=false}t.push(i)}.bind(this));return t};s.prototype.prepareAdaptationData=function(e,t,n){var i=[];var o=n?{}:null;var r=t instanceof Function;e.getProperties().forEach(function(e){var n={};if(r){var a=t(n,e);if(!a){return}}n.key=e.key;n.name=e.key;n.label=e.label||e.key;n.tooltip=e.tooltip;if(o){n.group=e.group?e.group:"BASIC";n.groupLabel=e.groupLabel;o[n.group]=o[n.group]?o[n.group]:[];o[n.group].push(n)}i.push(n)});var a={items:i};if(o){a.itemsGrouped=this._buildGroupStructure(o)}return a};s.prototype.sortP13nData=function(e,t){var n=e;var i=n.position;var o=n.visible;var r=sap.ui.getCore().getConfiguration().getLocale().toString();var a=window.Intl.Collator(r,{});t.sort(function(e,t){if(e[o]&&t[o]){return(e[i]||0)-(t[i]||0)}else if(e[o]){return-1}else if(t[o]){return 1}else if(!e[o]&&!t[o]){return a.compare(e.label,t.label)}})};s.prototype.arrayToMap=function(e){return e.reduce(function(e,t,n){e[t.key]=t;e[t.key].position=n;return e},{})};s.prototype.destroy=function(){t.prototype.destroy.apply(this,arguments);this._oAdaptationControl=null;this._bLiveMode=null;this._oPanel=null;this._bResetEnabled=null;this._oAdaptationModel=null};return s});