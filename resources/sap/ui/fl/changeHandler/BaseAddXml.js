/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/base/util/LoaderExtensions","sap/ui/fl/changeHandler/common/revertAddedControls","sap/ui/fl/Utils"],function(e,t,n,r){"use strict";var o={};o.applyChange=function(n,a,i,u){var s=i.modifier;var f=i.view;var c=u.aggregationName;var g;var h=u.index;var l=[];var d=n.getModuleName();var m;var v;var p=function(){var e=[];v.forEach(function(t,n){var r=function(){return Promise.resolve().then(s.insertAggregation.bind(s,a,c,t,h+n,f,u.skipAdjustIndex)).then(function(){l.push({id:s.getId(t),aggregationName:c})})};e.push(r)});return r.execPromiseQueueSequentially(e,true,true).then(function(){n.setRevertData(l);return v})};return Promise.resolve().then(s.findAggregation.bind(s,a,c)).then(function(e){g=e;if(!g){return Promise.reject(new Error("The given Aggregation is not available in the given control: "+s.getId(a)))}return t.loadResource(d,{dataType:"text"})}).then(function(t){m=t;return e.instantiateFragment(n,i)}).then(function(e){v=e;var t=[];v.forEach(function(e,n){var r=function(){return Promise.resolve().then(s.validateType.bind(s,e,g,a,m,n)).then(function(e){if(!e){o._destroyArrayOfControls(v);return Promise.reject(new Error("The content of the xml fragment does not match the type of the targetAggregation: "+g.type))}})};t.push(r)});return r.execPromiseQueueSequentially(t,true,true).then(p)})};o.revertChange=n;o._throwMissingAttributeError=function(e){throw new Error("Attribute missing from the change specific content'"+e+"'")};o._destroyArrayOfControls=function(e){e.forEach(function(e){if(e.destroy){e.destroy()}})};o.completeChangeContent=function(e,t,n){if(!n){n=e.getDefinition();if(!n.content){n.content={}}}if(t.fragmentPath){n.content.fragmentPath=t.fragmentPath}else{o._throwMissingAttributeError("fragmentPath")}var r=n.reference.replace(/\.Component/g,"").replace(/\./g,"/");r+="/changes/";r+=n.content.fragmentPath;e.setModuleName(r)};return o},true);