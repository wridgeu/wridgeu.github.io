/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/base/util/merge","sap/base/util/ObjectPath"],function(e,t,n,r){"use strict";function o(e){return typeof e==="function"}function i(e){if(e.modelType){return e.modelType}else if(e.oDataServiceVersion){return"sap.ui.model.odata.v2.ODataModel"}}var a={createAddViaDelegateChangeHandler:function(a){function l(e){return e+a.fieldSuffix}function c(e,t){if(o(a[t])){return!!a[t]({changeDefinition:e})}return!!a[t]}function d(e){return c(e,"skipCreateLabel")}function u(e){return c(e,"skipCreateLayout")}function f(e,n){var r=n.modifier.bySelector(e.getSelector(),n.appComponent);var l=i(e.getDefinition().content);return t.getDelegateForControl({control:r,modifier:n.modifier,modelType:l,supportsDefault:a.supportsDefault}).then(function(t){var n=!o(t.instance.createLayout);return n||u(e.getDefinition())})}function p(e,t,r){var o=n({},t);o.fieldSelector.id=l(o.fieldSelector.id);return r.createControlForProperty(o).then(function(n){if(d(e)){return n}var o=t.modifier.getId(n.control);t.labelFor=o;return r.createLabel(t).then(function(e){return{label:e,control:n.control,valueHelp:n.valueHelp}})})}function g(e,t,i){var l=n({aggregationName:a.aggregationName,payload:t.payload||{},parentSelector:e.content.parentId},i);var c=t.instance;return Promise.resolve().then(function(){if(o(c.createLayout)&&!u(e)){return c.createLayout(l)}}).then(function(t){if(r.get("control",t)){t.layoutControl=true;return t}return p(e,l,c)})}return{applyChange:function(r,o,l){var c=r.getDefinition();var d=l.appComponent;var u=c.content;var f=u.newFieldSelector;var p={appComponent:l.appComponent,view:l.view,fieldSelector:f,bindingPath:u.bindingPath,modifier:l.modifier,element:o};if(l.modifier.bySelector(f,d,l.view)){return e.markAsNotApplicable("Control to be created already exists:"+(f.id||f),true)}var s={newFieldSelector:f};r.setRevertData(s);var v=i(u);return t.getDelegateForControl({control:o,modifier:l.modifier,modelType:v,supportsDefault:a.supportsDefault}).then(function(e){return g(c,e,p)}).then(function(e){var t=n({},{control:o,innerControls:e,change:r},l);return Promise.resolve().then(function(){return a.addProperty(t)}).then(function(){if(e.valueHelp){var t=l.modifier.getSelector(l.modifier.getId(e.valueHelp),d);s.valueHelpSelector=t}})})},revertChange:function(e,t,r){var i=r.appComponent;var l=r.modifier;var c=e.getRevertData().newFieldSelector;var d=e.getRevertData().valueHelpSelector;var u=l.bySelector(c,i);var f=e.getDependentControl(a.parentAlias,r)||t;return Promise.resolve().then(l.removeAggregation.bind(l,f,a.aggregationName,u)).then(l.destroy.bind(l,u)).then(function(){if(d){var e=l.bySelector(d,i);return Promise.resolve().then(l.removeAggregation.bind(l,f,"dependents",e)).then(l.destroy.bind(l,e))}}).then(function(){var i=n({},{control:t,change:e},r);if(o(a.revertAdditionalControls)){return Promise.resolve().then(function(){return a.revertAdditionalControls(i)}).then(function(){e.resetRevertData()})}})},completeChangeContent:function(e,t,n){var r=n.appComponent;var i=e.getDefinition();if(!i.content){i.content={}}if(t.parentId){if(o(a.mapParentIdIntoChange)){a.mapParentIdIntoChange(e,t,n)}else{e.addDependentControl(t.parentId,a.parentAlias,n)}try{i.content.parentId=n.modifier.getSelector(t.parentId,r)}catch(e){}}else{throw new Error("mSpecificChangeInfo.parentId attribute required")}if(t.bindingPath){i.content.bindingPath=t.bindingPath}else{throw new Error("mSpecificChangeInfo.bindingPath attribute required")}if(t.newControlId){i.content.newFieldSelector=n.modifier.getSelector(t.newControlId,r)}else{throw new Error("mSpecificChangeInfo.newControlId attribute required")}if(t.index===undefined){throw new Error("mSpecificChangeInfo.targetIndex attribute required")}else{i.content.newFieldIndex=t.index}if(t.oDataServiceVersion){i.content.oDataServiceVersion=t.oDataServiceVersion}if(t.modelType&&a.supportsDefault){i.content.modelType=t.modelType}},getChangeVisualizationInfo:function(e){var t=e.getRevertData();if(t&&t.labelSelector){return{affectedControls:[t.labelSelector]}}return{affectedControls:[e.getContent().newFieldSelector]}},getCondenserInfo:function(e,t){return f(e,t).then(function(t){if(!t){return undefined}if(!e.getContent().newFieldSelector||!e.getContent().parentId||!a.aggregationName){return undefined}return{affectedControl:e.getContent().newFieldSelector,classification:sap.ui.fl.condenser.Classification.Create,targetContainer:e.getContent().parentId,targetAggregation:a.aggregationName,setTargetIndex:function(e,t){e.getContent().newFieldIndex=t},getTargetIndex:function(e){return e.getContent().newFieldIndex}}})}}}};return a});