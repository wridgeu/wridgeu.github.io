/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/Change","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Versions","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/util/reflection/XmlTreeModifier","sap/ui/core/Component","sap/base/Log"],function(e,n,t,r,o,i,a,s,h,p,c,u,l){"use strict";function g(e,t){return Promise.resolve().then(function(){if(t.length!==0){t.reverse();return s.revertMultipleChanges(t,{appComponent:e,modifier:p,flexController:this})}}.bind(this)).then(function(){if(e){var r=e.getModel(n.VARIANT_MODEL_NAME);if(r){t.forEach(function(e){var n=e.getVariantReference();if(n){r.removeChange(e)}});h.update({parameters:[],updateURL:true,updateHashEntry:true,model:r})}}return t})}var f=function(e){this._oChangePersistence=undefined;this._sComponentName=e||"";if(this._sComponentName){this._createChangePersistence()}};f.prototype.getComponentName=function(){return this._sComponentName};f.prototype.setVariantSwitchPromise=function(e){this._oVariantSwitchPromise=e};f.prototype.waitForVariantSwitch=function(){if(!this._oVariantSwitchPromise){this._oVariantSwitchPromise=Promise.resolve()}return this._oVariantSwitchPromise};f.prototype.createBaseChange=function(e,n){var t;var o;if(!n){throw new Error("No application component found. To offer flexibility a valid relation to its owning component must be present.")}e.reference=this.getComponentName();e.packageName="$TMP";t=r.createInitialFileContent(e);o=new r(t);if(e.variantReference){o.setVariantReference(e.variantReference)}return o};f.prototype._createChange=function(e,t,r){var o=r&&(r.controlType||n.getControlType(r));var i=this.createBaseChange(e,t);return this._getChangeHandler(i,o,r,p).then(function(o){if(o){return o.completeChangeContent(i,e,{modifier:p,appComponent:t,view:n.getViewForControl(r)})}throw new Error("Change handler could not be retrieved for change "+JSON.stringify(e)+".")}).then(function(){return i}).catch(function(e){return Promise.reject(e)})};f.prototype.createChangeWithExtensionPointSelector=function(e,t){return Promise.resolve().then(function(){if(!t){throw new Error("A flexibility change on extension point cannot be created without a valid extension point reference.")}var r=t.view;var o=n.getAppComponentForControl(r);e.selector={name:t.name,viewSelector:p.getSelector(r.getId(),o)};return o}).then(function(n){return this._createChange(e,n)}.bind(this))};f.prototype.createChangeWithControlSelector=function(e,t){var r;return(new n.FakePromise).then(function(){if(!t){throw new Error("A flexibility change cannot be created without a targeted control.")}var o=t.id||t.getId();if(!e.selector){e.selector={}}r=t.appComponent||n.getAppComponentForControl(t);if(!r){throw new Error("No application component found. To offer flexibility, the control with the ID '"+o+"' has to have a valid relation to its owning application component.")}Object.assign(e.selector,p.getSelector(o,r));return r}).then(function(n){return this._createChange(e,n,t)}.bind(this))};f.prototype.addChange=function(e,t){return this.createChangeWithControlSelector(e,t).then(function(e){var r=n.getAppComponentForControl(t);e._ignoreOnce=true;this.addPreparedChange(e,r);e.setQueuedForApply();return e}.bind(this))};f.prototype.addPreparedChange=function(e,t){if(e.getVariantReference()){var r=t.getModel(n.VARIANT_MODEL_NAME);r.addChange(e)}this._oChangePersistence.addChange(e,t);return e};f.prototype.deleteChange=function(e,t){this._oChangePersistence.deleteChange(e);if(e.getVariantReference()){t.getModel(n.VARIANT_MODEL_NAME).removeChange(e)}};f.prototype.applyChange=function(e,t){var r={modifier:p,appComponent:n.getAppComponentForControl(t),view:n.getViewForControl(t)};return a.applyChangeOnControl(e,t,r).then(function(n){if(!n.success){var t=n.error||new Error("The change could not be applied.");this._oChangePersistence.deleteChange(e,true);throw t}return e}.bind(this))};function C(e,t,r,o,i){var a=d(e,o);if(!a){return[]}i.push(e);var s=e.getId();var h=t[s]&&t[s].dependencies||[];for(var p=0,c=h.length;p<c;p++){var u=n.getChangeFromChangesMap(r,h[p]);a=C(u,t,r,o,i);if(a.length===0){i=[];break}delete t[s]}return i}function d(e,n){var t=e.getDependentControlSelectorList();t.push(e.getSelector());return!t.some(function(e){return!p.bySelector(e,n)})}f.prototype.waitForChangesToBeApplied=function(e){var n;if(Array.isArray(e)){n=e}else{n=[e]}var t=n.map(function(e){return this._waitForChangesToBeApplied(e)}.bind(this));return Promise.all(t).then(function(){return undefined})};f.prototype._waitForChangesToBeApplied=function(e){var t=e.id&&sap.ui.getCore().byId(e.id)||e;var r=this._oChangePersistence.getChangesMapForComponent();var o=[];var i=Object.assign({},r.mDependencies);var a=r.mChanges;var s=a[t.getId()]||[];var h=s.filter(function(e){return!e.isCurrentProcessFinished()},this);var p=e.appComponent||n.getAppComponentForControl(t);var c=[];h.forEach(function(e){var n=C(e,i,r.mChanges,p,[]);n.forEach(function(e){if(c.indexOf(e)===-1){c.push(e)}})});c.forEach(function(e){o=o.concat(e.addChangeProcessingPromises())},this);o.push(this.waitForVariantSwitch());return Promise.all(o)};f.prototype.saveAll=function(e,r,o){var a=o?i.getVersionsModel({reference:n.normalizeReference(this._sComponentName),layer:t.CUSTOMER}).getProperty("/persistedVersion"):undefined;return this._oChangePersistence.saveDirtyChanges(e,r,undefined,a).then(function(e){if(o&&e&&e.response){var n=e.response;if(Array.isArray(n)){n=n[0]}i.onAllChangesSaved({reference:n.reference,layer:n.layer})}return e})};f.prototype.processXmlView=function(e,t){var r=u.get(t.componentId);var o=n.getAppComponentForControl(r);t.appComponent=o;t.modifier=c;t.view=e;return this._oChangePersistence.getChangesForView(t).then(a.applyAllChangesForXMLView.bind(a,t)).catch(this._handlePromiseChainError.bind(this,t.view))};f.prototype._handlePromiseChainError=function(e,n){l.error("Error processing view "+n+".");return e};f.prototype._getChangeHandler=function(n,t,r,o){var i=n.getChangeType();var a=n.getLayer();return e.getChangeHandler(i,t,r,o,a)};f.prototype.getComponentChanges=function(e,n){return this._oChangePersistence.getChangesForComponent(e,n)};f.prototype.checkForOpenDependenciesForControl=function(e,n){return this._oChangePersistence.checkForOpenDependenciesForControl(e,n)};f.prototype._createChangePersistence=function(){this._oChangePersistence=o.getChangePersistenceForComponent(this.getComponentName());return this._oChangePersistence};f.prototype.resetChanges=function(e,n,t,r,o){return this._oChangePersistence.resetChanges(e,n,r,o).then(g.bind(this,t))};f.prototype.removeDirtyChanges=function(e,n,t,r,o){return this._oChangePersistence.removeDirtyChanges(e,n,t,r,o).then(g.bind(this,n))};f.prototype.applyVariantChanges=function(e,t){var r;return e.reduce(function(e,n){return e.then(function(){var e={modifier:p,appComponent:t};this._oChangePersistence._addRunTimeCreatedChangeAndUpdateDependencies(t,n);r=e.modifier.bySelector(n.getSelector(),t);if(r){return a.applyChangeOnControl(n,r,e)}l.error("A flexibility change tries to change a nonexistent control.")}.bind(this))}.bind(this),new n.FakePromise)};f.prototype.saveSequenceOfDirtyChanges=function(e,n){return this._oChangePersistence.saveDirtyChanges(n,false,e)};f.prototype.getResetAndPublishInfo=function(e){e.reference=this._sComponentName;return this._oChangePersistence.getResetAndPublishInfo(e)};return f},true);