/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/ManagedObject","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/registry/Settings","sap/base/Log","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/flexObjects/States","sap/base/util/includes"],function(e,t,i,n,o,r,s,a,p,u){"use strict";var c=t.extend("sap.ui.fl.Change",{constructor:function(n){t.apply(this);if(!e.isPlainObject(n)){s.error("Constructor : sap.ui.fl.Change : oFile is not defined")}this._oDefinition=n;this._sRequest="";this._bUserDependent=n.layer===i.USER;this._vRevertData=null;this._aUndoOperations=null;this._oExtensionPointInfo=null;this.setState(c.states.NEW);this._sPreviousState=null;this._oChangeProcessedPromise=null;this.setInitialApplyState();this._oChangeProcessingPromises={}},metadata:{properties:{state:{type:"string"},applyState:{type:"int"}}}});c.states={NEW:p.NEW,PERSISTED:p.PERSISTED,DELETED:p.DELETED,DIRTY:p.DIRTY};c.applyState={INITIAL:0,APPLYING:1,APPLY_FINISHED:2,REVERTING:3,REVERT_FINISHED:4,APPLY_SUCCESSFUL:5,APPLY_FAILED:6};c.operations={APPLY:0,REVERT:1};c.prototype.setState=function(e){var t=this.getState();if(t!==e&&this._isValidState(e)){this._sPreviousState=t;this.setProperty("state",e)}return this};c.prototype.setQueuedForRevert=function(){if(this._aQueuedProcesses[this._aQueuedProcesses.length-1]!==c.operations.REVERT){this._aQueuedProcesses.unshift(c.operations.REVERT)}};c.prototype.isQueuedForRevert=function(){return this._aQueuedProcesses.indexOf(c.operations.REVERT)>-1};c.prototype.setQueuedForApply=function(){if(this._aQueuedProcesses[this._aQueuedProcesses.length-1]!==c.operations.APPLY){this._aQueuedProcesses.unshift(c.operations.APPLY)}};c.prototype.isQueuedForApply=function(){return this._aQueuedProcesses.indexOf(c.operations.APPLY)>-1};c.prototype.setInitialApplyState=function(){this._aQueuedProcesses=[];delete this._ignoreOnce;this.setApplyState(c.applyState.INITIAL);this._oChangeProcessedPromise={};this._oChangeProcessedPromise.promise=new Promise(function(e){this._oChangeProcessedPromise.resolveFunction={resolve:e}}.bind(this))};c.prototype.isInInitialState=function(){return this._aQueuedProcesses.length===0&&this.getApplyState()===c.applyState.INITIAL};c.prototype.isValidForDependencyMap=function(){return this._oDefinition.selector&&this._oDefinition.selector.id};c.prototype.startApplying=function(){this.setApplyState(c.applyState.APPLYING)};c.prototype.markFinished=function(e,t){this._aQueuedProcesses.pop();this._resolveChangeProcessingPromiseWithError(c.operations.APPLY,e);var i=t!==false?c.applyState.APPLY_SUCCESSFUL:c.applyState.APPLY_FAILED;this.setApplyState(i)};c.prototype.markSuccessful=function(e){this.markFinished(e,true)};c.prototype.markFailed=function(e){this.markFinished(e,false)};c.prototype.startReverting=function(){this.setApplyState(c.applyState.REVERTING)};c.prototype.markRevertFinished=function(e){this._aQueuedProcesses.pop();this._resolveChangeProcessingPromiseWithError(c.operations.REVERT,e);this.setApplyState(c.applyState.REVERT_FINISHED)};c.prototype.hasApplyProcessStarted=function(){return this.getApplyState()===c.applyState.APPLYING};c.prototype.isSuccessfullyApplied=function(){return this.getApplyState()===c.applyState.APPLY_SUCCESSFUL};c.prototype.hasApplyProcessFailed=function(){return this.getApplyState()===c.applyState.APPLY_FAILED};c.prototype.isApplyProcessFinished=function(){return this.isSuccessfullyApplied()||this.hasApplyProcessFailed()};c.prototype.hasRevertProcessStarted=function(){return this.getApplyState()===c.applyState.REVERTING};c.prototype.isRevertProcessFinished=function(){return this.getApplyState()===c.applyState.REVERT_FINISHED};c.prototype.isCurrentProcessFinished=function(){return this._aQueuedProcesses.length===0&&this.getApplyState()!==c.applyState.INITIAL};c.prototype.addChangeProcessingPromise=function(e){if(!this._oChangeProcessingPromises[e]){this._oChangeProcessingPromises[e]={};this._oChangeProcessingPromises[e].promise=new Promise(function(t){this._oChangeProcessingPromises[e].resolveFunction={resolve:t}}.bind(this))}return this._oChangeProcessingPromises[e].promise};c.prototype.addChangeProcessingPromises=function(){var e=[];if(this.getApplyState()===c.applyState.INITIAL&&this._oChangeProcessedPromise){e.push(this._oChangeProcessedPromise.promise)}this._aQueuedProcesses.forEach(function(t){e.push(this.addChangeProcessingPromise(t))},this);return e};c.prototype.addPromiseForApplyProcessing=function(){return this.addChangeProcessingPromise(c.operations.APPLY)};c.prototype._resolveChangeProcessingPromiseWithError=function(e,t){if(this._oChangeProcessingPromises[e]){this._oChangeProcessingPromises[e].resolveFunction.resolve(t);delete this._oChangeProcessingPromises[e]}if(this._oChangeProcessedPromise){this._oChangeProcessedPromise.resolveFunction.resolve(t);this._oChangeProcessedPromise=null}};c.prototype._isValidState=function(e){var t=false;Object.keys(c.states).some(function(i){if(c.states[i]===e){t=true}return t});if(!t){return false}if(this.getState()===c.states.NEW&&e===c.states.DIRTY){return false}return true};c.prototype.isVariant=function(){return this._oDefinition.fileType==="variant"};c.prototype.getChangeType=function(){if(this._oDefinition){return this._oDefinition.changeType}};c.prototype.getFileName=function(){if(this._oDefinition){return this._oDefinition.fileName}};c.prototype.getFileType=function(){return this._oDefinition.fileType};c.prototype.getPackage=function(){return this._oDefinition.packageName};c.prototype.setPackage=function(e){if(typeof e!=="string"){s.error("sap.ui.fl.Change.setPackage : sPackage is not defined")}this._oDefinition.packageName=e};c.prototype.getNamespace=function(){return this._oDefinition.namespace};c.prototype.setNamespace=function(e){this._oDefinition.namespace=e};c.prototype.getModuleName=function(){return this._oDefinition.moduleName};c.prototype.setModuleName=function(e){this._oDefinition.moduleName=e};c.prototype.getProjectId=function(){return this._oDefinition.projectId};c.prototype.getId=function(){return this._oDefinition.fileName};c.prototype.getContent=function(){return this._oDefinition.content};c.prototype.setContent=function(e){this._oDefinition.content=e;this.setState(c.states.DIRTY)};c.prototype.getVariantReference=function(){return this._oDefinition.variantReference||""};c.prototype.setVariantReference=function(e){this._oDefinition.variantReference=e;this.setState(c.states.DIRTY)};c.prototype.getSelector=function(){return this._oDefinition.selector};c.prototype.setSelector=function(e){this._oDefinition.selector=e};c.prototype.getText=function(e){if(typeof e!=="string"){s.error("sap.ui.fl.Change.getTexts : sTextId is not defined")}if(this._oDefinition.texts){if(this._oDefinition.texts[e]){return this._oDefinition.texts[e].value}}return""};c.prototype.getTexts=function(){return this._oDefinition.texts};c.prototype.setText=function(e,t){if(typeof e!=="string"){s.error("sap.ui.fl.Change.setTexts : sTextId is not defined");return}if(this._oDefinition.texts){if(this._oDefinition.texts[e]){this._oDefinition.texts[e].value=t;this.setState(c.states.DIRTY)}}};c.prototype.isChangeFromOtherSystem=function(){var e=this._oDefinition.sourceSystem;var t=this._oDefinition.sourceClient;if(!e||!t){return false}var i=r.getInstanceOrUndef();if(!i){return true}var n=i.getSystem();var o=i.getClient();if(!n||!o){return false}return e!==n||t!==o};c.prototype.markForDeletion=function(){this.setState(c.states.DELETED)};c.prototype.restorePreviousState=function(){if(this._sPreviousState){this.setState(this._sPreviousState);delete this._sPreviousState}};c.prototype.setRequest=function(e){if(typeof e!=="string"){s.error("sap.ui.fl.Change.setRequest : sRequest is not defined")}this._sRequest=e};c.prototype.getRequest=function(){return this._sRequest};c.prototype.getLayer=function(){return this._oDefinition.layer};c.prototype.getComponent=function(){return this._oDefinition.reference};c.prototype.setComponent=function(e){this._oDefinition.reference=e};c.prototype.getCreation=function(){return this._oDefinition.creation};c.prototype.isUserDependent=function(){return this._bUserDependent};c.prototype.getDefinition=function(){return this._oDefinition};c.prototype.setResponse=function(e){var t=JSON.stringify(e);if(t){this._oDefinition=JSON.parse(t);this.setState(c.states.PERSISTED)}};c.prototype.addDependentControl=function(e,t,i,n){if(!e){throw new Error("Parameter vControl is mandatory")}if(!t){throw new Error("Parameter sAlias is mandatory")}if(!i){throw new Error("Parameter mPropertyBag is mandatory")}if(!this._oDefinition.dependentSelector){this._oDefinition.dependentSelector={}}if(this._oDefinition.dependentSelector[t]){throw new Error("Alias '"+t+"' already exists in the change.")}var o=i.modifier;var r=i.appComponent;if(Array.isArray(e)){var s=[];e.forEach(function(e){s.push(o.getSelector(e,r,n))});this._oDefinition.dependentSelector[t]=s}else{this._oDefinition.dependentSelector[t]=o.getSelector(e,r,n)}delete this._aDependentSelectorList};c.prototype.getDependentControl=function(e,t){var i=[];var n;if(!e){throw new Error("Parameter sAlias is mandatory")}if(!t){throw new Error("Parameter mPropertyBag is mandatory")}var o=t.modifier;var r=t.appComponent;if(!this._oDefinition.dependentSelector){return undefined}n=this._oDefinition.dependentSelector[e];if(Array.isArray(n)){n.forEach(function(e){i.push(o.bySelector(e,r,t.view))});return i}return o.bySelector(n,r,t.view)};c.prototype.getOriginalSelector=function(){return this.getDefinition().dependentSelector&&this.getDefinition().dependentSelector.originalSelector};c.prototype.getDependentSelectorList=function(){var e=this;var t=[this.getSelector()];if(!this._aDependentSelectorList){if(this._oDefinition.dependentSelector){Object.keys(this._oDefinition.dependentSelector).some(function(i){if(i==="originalSelector"){t=[this.getSelector()];return true}var o=e._oDefinition.dependentSelector[i];if(!Array.isArray(o)){o=[o]}o.forEach(function(e){if(e&&n.indexOfObject(t,e)===-1){t.push(e)}})}.bind(this))}this._aDependentSelectorList=t}return this._aDependentSelectorList};c.prototype.getDependentControlSelectorList=function(){var e=this.getDependentSelectorList().concat();if(e.length>0){var t=this.getSelector();var i=n.indexOfObject(e,t);if(i>-1){e.splice(i,1)}}return e};c.prototype.getRevertData=function(){return this._vRevertData};c.prototype.hasRevertData=function(){return this._vRevertData!==null};c.prototype.setRevertData=function(e){if(e===undefined){throw new Error("Change cannot be applied in XML as revert data is not available yet. Retrying in JS.")}this._vRevertData=e};c.prototype.resetRevertData=function(){this.setRevertData(null)};c.prototype.getExtensionPointInfo=function(){return this._oExtensionPointInfo};c.prototype.setExtensionPointInfo=function(e){this._oExtensionPointInfo=e};c.createInitialFileContent=function(e){if(!e){e={}}var t;if(e.fileType){t=e.fileType}else{t=e.isVariant?"variant":"change"}var r={fileName:e.id||n.createDefaultFileName(e.changeType),fileType:t,changeType:e.changeType||"",moduleName:e.moduleName||"",reference:e.reference||"",packageName:e.packageName||"",content:e.content||{},selector:e.selector||{id:""},layer:e.layer||(e.isUserDependent?i.USER:o.getCurrentLayer()),texts:e.texts||{},namespace:e.namespace||n.createNamespace(e,t),projectId:e.projectId||e.reference&&e.reference.replace(".Component","")||"",creation:"",originalLanguage:n.getCurrentLanguage()||"",support:{generator:e.generator||"Change.createInitialFileContent",service:e.service||"",user:"",sapui5Version:sap.ui.version,sourceChangeFileName:e.support&&e.support.sourceChangeFileName||"",compositeCommand:e.support&&e.support.compositeCommand||"",command:e.command||""},oDataInformation:e.oDataInformation||{},dependentSelector:e.dependentSelector||{},jsOnly:e.jsOnly||false,variantReference:e.variantReference||"",appDescriptorChange:u(a.getChangeTypes(),e.changeType)};return r};return c},true);