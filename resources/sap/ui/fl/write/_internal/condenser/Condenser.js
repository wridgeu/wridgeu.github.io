/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/isPlainObject","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Core","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Change","sap/ui/fl/Utils","sap/ui/performance/Measurement"],function(e,n,t,r,i,a,s,o,f,c,u,l,d){"use strict";var p={};var C="unclassified";var h={lastOneWins:s,reverse:o};var g=["affectedControl","sourceContainer","targetContainer"];function v(e,n){var t=e[sap.ui.fl.condenser.Classification.Move];return n.classification===sap.ui.fl.condenser.Classification.Create&&t&&t[t.length-1].targetContainer===n.targetContainer}function y(e,n){return n.classification===sap.ui.fl.condenser.Classification.Move&&e[sap.ui.fl.condenser.Classification.Destroy]}function E(e,n){return n.classification===sap.ui.fl.condenser.Classification.Create&&e[sap.ui.fl.condenser.Classification.Destroy]}function m(e,n,t,r){if(!y(e,t)&&!E(e,t)){var i=t.classification;if(!e[i]){t.change=r;r.condenserState="select";e[i]=[t]}else{r.condenserState="delete"}e[i][0].updateChange=r}if(v(e,t)||E(e,t)){if(e[sap.ui.fl.condenser.Classification.Move]){e[sap.ui.fl.condenser.Classification.Move].forEach(function(e){e.change.condenserState="delete"});delete e[sap.ui.fl.condenser.Classification.Move]}if(e[sap.ui.fl.condenser.Classification.Destroy]){e[sap.ui.fl.condenser.Classification.Destroy].forEach(function(e){e.change.condenserState="delete"});delete e[sap.ui.fl.condenser.Classification.Destroy]}}return f.addChange(n,t)}function S(e,n,t,r,i){if(!e[r.type]){e[r.type]={}}var a=e[r.type];if(r.type===c.NOT_INDEX_RELEVANT){if(!a[r.classification]){a[r.classification]={}}var s=a[r.classification];h[r.classification].addToChangesMap(s,r.uniqueKey,i);return Promise.resolve()}t.push(i);return m(a,n,r,i)}function _(e,n,t){if(!e[n]){e[n]=[]}e[n].push(t);t.condenserState="select"}function I(e,n){var t=r.getControlIdBySelector(n.getSelector(),e);var s=i.byId(t);if(s){var o={modifier:r,appComponent:e,view:l.getViewForControl(s)};var f=a.getControlIfTemplateAffected(n,s,o);return Promise.resolve(a.getChangeHandler(n,f,o)).then(function(e){if(e&&typeof e.getCondenserInfo==="function"){return e.getCondenserInfo(n,o)}return undefined}).then(function(e){if(e&&f.bTemplateAffected){N(e,n)}return e}).catch(function(){return undefined})}return Promise.resolve()}function N(e,n){var t=n.getOriginalSelector();var r=n.getSelector();g.forEach(function(n){if(e[n]&&e[n]===r){e[n]=t}})}function M(e,n,t,i){var a=n!==undefined?n.affectedControl:r.getControlIdBySelector(t.getSelector(),i);if(!e[a]){e[a]={}}return e[a]}function x(e,n,t,r,i){return i.reduce(function(i,a){return i.then(A.bind(this,e,n,t,r,a))}.bind(this),Promise.resolve())}function A(e,n,t,r,i){return I(e,i).then(function(a){T(a,e);var s=M(n,a,i,e);if(a!==undefined){O(a);return S(s,t,r,a,i)}_(s,C,i);n[C]=true;return undefined})}function O(e){if(h[e.classification]){e.type=c.NOT_INDEX_RELEVANT}else{e.type=c.INDEX_RELEVANT}}function T(e,n){g.forEach(function(t){if(e&&e[t]){e[t]=r.getControlIdBySelector(e[t],n)}})}function D(t,r){e(t,function(e,i){if(h[e]&&h[e].getChangesFromMap){h[e].getChangesFromMap(t,e).forEach(function(e){r.push(e)})}else if(n(i)){return D(i,r)}else if(Array.isArray(i)){i.forEach(function(e){if(e instanceof u){r.push(e)}else{r.push(e.change)}})}});return r}function R(e){return D(e,[])}function b(t,r){e(t,function(e,t){if(n(t)){b(t,r)}else if(Array.isArray(t)){t.forEach(function(e){if(!(e instanceof u)){r.push(e)}})}});return r}function F(e,n){n.sort(function(n,t){return e.indexOf(n)-e.indexOf(t)})}function w(e,n){n.sort(function(n,t){return e.indexOf(n.change)-e.indexOf(t.change)})}function P(e,n){var t=e.map(function(e){return e.getId()});n.forEach(function(n){if(t.indexOf(n.getId())===-1){e.push(n)}})}function L(e,n){e.forEach(function(e){var t=e.updateChange;if(t&&t.getState()!==u.states.NEW){var r=e.change;if(t.getFileName()!==r.getFileName()){var i=r.getContent();t.setContent(i);r.condenserState="delete";n=n.map(function(e){if(e.getFileName()===r.getFileName()){return t}return e})}else{t.setState(u.states.DIRTY)}t.condenserState="update"}});return n}p.condense=function(e,n){d.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);var r={};var i={};var a=[];var s=[];var o=[];n.slice(0).reverse().forEach(function(e){if(e instanceof u&&e.isApplyProcessFinished()){o.push(e)}else{s.push(e)}});d.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);return x(e,r,i,a,o).then(function(){d.end("Condenser_defineMaps");var e=r[C];if(!e){f.compareAndUpdate(r,i)}var o=R(r);if(e){a.forEach(function(e){e.condenserState="select"});P(o,a)}o=o.concat(s);F(n,o);if(!e){d.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var c=true;var u=b(r,[]);w(n,u);try{d.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var l=f.sortIndexRelatedChanges(i,u)}catch(e){t.error("Error during Condensing: "+e.message,"No Condensing performed for index-relevant changes.");c=false}d.end("Condenser_sort");if(c){f.swapChanges(l,o);o=L(u,o)}else{a.forEach(function(e){e.condenserState="select"});P(o,a);F(n,o)}d.end("Condenser_handleIndexRelatedChanges")}d.end("Condenser_overall");return o})};return p});