/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/isPlainObject","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Core","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Change","sap/ui/fl/Utils","sap/ui/performance/Measurement"],function(e,n,t,i,r,s,a,o,f,c,u,l,d){"use strict";var p={};var C="unclassified";var h={lastOneWins:a,reverse:o};function g(e,n){var t=e[sap.ui.fl.condenser.Classification.Move];return n.classification===sap.ui.fl.condenser.Classification.Create&&t&&t[t.length-1].targetContainer===n.targetContainer}function v(e,n){return n.classification===sap.ui.fl.condenser.Classification.Move&&e[sap.ui.fl.condenser.Classification.Destroy]}function y(e,n){return n.classification===sap.ui.fl.condenser.Classification.Create&&e[sap.ui.fl.condenser.Classification.Destroy]}function E(e,n,t,i){if(!v(e,t)&&!y(e,t)){var r=t.classification;if(!e[r]){t.change=i;i.condenserState="select";e[r]=[t]}else{i.condenserState="delete"}e[r][0].updateChange=i}if(g(e,t)||y(e,t)){if(e[sap.ui.fl.condenser.Classification.Move]){e[sap.ui.fl.condenser.Classification.Move].forEach(function(e){e.change.condenserState="delete"});delete e[sap.ui.fl.condenser.Classification.Move]}if(e[sap.ui.fl.condenser.Classification.Destroy]){e[sap.ui.fl.condenser.Classification.Destroy].forEach(function(e){e.change.condenserState="delete"});delete e[sap.ui.fl.condenser.Classification.Destroy]}}return f.addChange(n,t)}function m(e,n,t,i,r){if(!e[i.type]){e[i.type]={}}var s=e[i.type];if(i.type===c.NOT_INDEX_RELEVANT){if(!s[i.classification]){s[i.classification]={}}var a=s[i.classification];h[i.classification].addToChangesMap(a,i.uniqueKey,r);return Promise.resolve()}t.push(r);return E(s,n,i,r)}function _(e,n,t){if(!e[n]){e[n]=[]}e[n].push(t);t.condenserState="select"}function I(e,n){var t=i.getControlIdBySelector(n.getSelector(),e);var a=r.byId(t);if(a){var o={modifier:i,appComponent:e,view:l.getViewForControl(a)};var f=s.getControlIfTemplateAffected(n,a,o);return Promise.resolve(s.getChangeHandler(n,f,o)).then(function(e){if(e&&typeof e.getCondenserInfo==="function"){return e.getCondenserInfo(n,o)}return undefined}).catch(function(){return undefined})}return Promise.resolve()}function S(e,n,t,r){var s=n!==undefined?n.affectedControl:i.getControlIdBySelector(t.getSelector(),r);if(!e[s]){e[s]={}}return e[s]}function N(e,n,t,i,r){return r.reduce(function(r,s){return r.then(M.bind(this,e,n,t,i,s))}.bind(this),Promise.resolve())}function M(e,n,t,i,r){return I(e,r).then(function(s){A(s,e);var a=S(n,s,r,e);if(s!==undefined){x(s);return m(a,t,i,s,r)}_(a,C,r);n[C]=true;return undefined})}function x(e){if(h[e.classification]){e.type=c.NOT_INDEX_RELEVANT}else{e.type=c.INDEX_RELEVANT}}function A(e,n){["affectedControl","sourceContainer","targetContainer"].forEach(function(t){if(e&&e[t]){e[t]=i.getControlIdBySelector(e[t],n)}})}function O(t,i){e(t,function(e,r){if(h[e]&&h[e].getChangesFromMap){h[e].getChangesFromMap(t,e).forEach(function(e){i.push(e)})}else if(n(r)){return O(r,i)}else if(Array.isArray(r)){r.forEach(function(e){if(e instanceof u){i.push(e)}else{i.push(e.change)}})}});return i}function D(e){return O(e,[])}function R(t,i){e(t,function(e,t){if(n(t)){R(t,i)}else if(Array.isArray(t)){t.forEach(function(e){if(!(e instanceof u)){i.push(e)}})}});return i}function T(e,n){n.sort(function(n,t){return e.indexOf(n)-e.indexOf(t)})}function F(e,n){n.sort(function(n,t){return e.indexOf(n.change)-e.indexOf(t.change)})}function b(e,n){var t=e.map(function(e){return e.getId()});n.forEach(function(n){if(t.indexOf(n.getId())===-1){e.push(n)}})}function w(e,n){e.forEach(function(e){var t=e.updateChange;if(t&&t.getState()!==u.states.NEW){var i=e.change;if(t.getFileName()!==i.getFileName()){var r=i.getContent();t.setContent(r);i.condenserState="delete";n=n.map(function(e){if(e.getFileName()===i.getFileName()){return t}return e})}else{t.setState(u.states.DIRTY)}t.condenserState="update"}});return n}p.condense=function(e,n){d.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);var i={};var r={};var s=[];var a=[];var o=[];n.slice(0).reverse().forEach(function(e){if(e instanceof u&&e.isApplyProcessFinished()){o.push(e)}else{a.push(e)}});d.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);return N(e,i,r,s,o).then(function(){d.end("Condenser_defineMaps");var e=i[C];if(!e){f.compareAndUpdate(i,r)}var o=D(i);if(e){s.forEach(function(e){e.condenserState="select"});b(o,s)}o=o.concat(a);T(n,o);if(!e){d.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var c=true;var u=R(i,[]);F(n,u);try{d.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var l=f.sortIndexRelatedChanges(r,u)}catch(e){t.error("Error during Condensing: "+e.message,"No Condensing performed for index-relevant changes.");c=false}d.end("Condenser_sort");if(c){f.swapChanges(l,o);o=w(u,o)}else{s.forEach(function(e){e.condenserState="select"});b(o,s);T(n,o)}d.end("Condenser_handleIndexRelatedChanges")}d.end("Condenser_overall");return o})};return p});