/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_isEqual","sap/base/util/each","sap/ui/fl/write/_internal/condenser/classifications/Create","sap/ui/fl/write/_internal/condenser/classifications/Destroy","sap/ui/fl/write/_internal/condenser/classifications/Move","sap/ui/fl/write/_internal/condenser/Utils"],function(n,e,t,i,r,a){"use strict";var c={};var o={create:t,destroy:i,move:r};function f(n,t){e(n,function(n,i){e(i,function(e,r){t(i,n,r,e)})})}function s(n,e,t){n.splice(t,0,n.splice(e,1)[0])}function u(n,e){var t={};f(n,function(n,i,r,c){var o=r[a.TARGET_UI];o.forEach(function(n){e.forEach(function(e){if(n===e.affectedControl){if(!t[i]){t[i]={}}var r=t[i];if(!r[c]){r[c]=[]}var a=r[c];a.push(e)}})})});return t}function l(n){return!n.some(function(n){return n.classification!==sap.ui.fl.condenser.Classification.Create})}function h(n){return!n.some(function(n){return a.isUnknown(n)})}function v(n){return n.getTargetIndex(n.change)}function d(n){n.sort(function(n,e){var t=v(n);var i=v(e);return t-i})}function E(n){return!n.some(function(n){return!a.isUnknown(n)})}function g(e,t){var i;if(e.length<t.length){i=t.slice(e.length);if(!E(i)){return false}t=t.slice(0,e.length)}else if(e.length>t.length){i=e.slice(t.length,e.length);if(!E(i)){return false}e=e.slice(0,t.length)}return n(e,t)}function I(n,e,t,i,r){var c={};r.forEach(function(n){var i=n.targetContainer;if(!c[i]){c[i]={}}var r=c[i];if(!r[e]){r[e]=a.initializeArrayWithPlaceholders(0,t.length-1)}o[n.classification].simulate(r[e],n,t)});var f=c[n][e];if(g(i,f)){return true}return false}function T(n,t){f(t,function(t,i,r){r[a.TARGET_UI].forEach(function(t,i){if(!a.isUnknown(t)){var r=n[t];var c=r[a.INDEX_RELEVANT];e(c,function(n,e){if(n!==sap.ui.fl.condenser.Classification.Destroy){e.forEach(function(n){n.setTargetIndex(n.change,i);n.change.condenserState="select"})}})}})})}function p(n,t){f(t,function(t,i,r,c){var o=r[a.INITIAL_UI];var f=r[a.TARGET_UI];if(g(o,f)){f.forEach(function(t){var i=n[t];if(i!==undefined){e(i[a.INDEX_RELEVANT],function(n,e){e.forEach(function(n){n.change.condenserState="delete"})});delete i[a.INDEX_RELEVANT]}});delete t[c]}})}function _(n,e){f(e,function(e,t,i){var r=i[a.INITIAL_UI];var c=i[a.TARGET_UI];r.forEach(function(e,t){var i=n[e];if(!i||!i[a.INDEX_RELEVANT]){var r=a.PLACEHOLDER+t;var o=c.indexOf(e);if(o>=0){c[o]=r}}})})}c.swapChanges=function(n,e){var t=n.map(function(n){return e.indexOf(n)}).sort();n.forEach(function(n){e[t.shift()]=n})};c.sortIndexRelatedChanges=function(n,e){var t=[];var i=u(n,e);f(i,function(e,i,r,c){var o=n[i][c][a.TARGET_UI];var f=n[i][c][a.INITIAL_UI];var u=true;if(h(o)||l(r)){d(r)}else if(!I(i,c,f,o,r)){u=false;var v=r.length;while(v!==0&&!u){var E=0;var g=1;while(g<r.length&&!u){s(r,E,g);u=I(i,c,f,o,r);E++;g++}v--}}if(!u){throw Error("no correct sorting found for the container: "+i)}r.forEach(function(n){t=t.concat(n.change)})});return t};c.addChange=function(n,e){return o[e.classification].addToReconstructionMap(n,e)};c.compareAndUpdate=function(n,e){p(n,e);_(n,e);T(n,e)};return c});