/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantState","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantMerger","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/LayerUtils","sap/ui/fl/apply/_internal/flexState/compVariants/Utils","sap/ui/fl/Utils"],function(e,t,n,r,a,i,o,l,c,s){"use strict";var f={};function p(e){e.reference=n.getFlexReferenceForControl(e.selector);return t.initialize({componentId:e.componentId||s.getAppComponentForControl(e.selector).getId(),reference:e.reference,componentData:{},manifest:{}})}function u(e){var n=t.getCompVariantsMap(e.reference);var r=[];if(e.invalidateCache){var a=t.getInitialNonFlCompVariantData(e.reference);if(a){Object.keys(a).forEach(function(e){n._initialize(e,a[e].variants);i.merge(e,n[e],a[e].standardVariant)})}}for(var o in n){var c=n[o];for(var s in c.byId){r.push(c.byId[s])}}return l.filterChangeOrChangeDefinitionsByCurrentLayer(r,e.currentLayer)}function C(e){var t=n.getFlexReferenceForControl(e.selector);return a.persistAll(t)}function g(e){if(!e.reference){var t=r.getAppComponentForSelector(e.selector);e.reference=n.getFlexReferenceForControl(t)}return o.getChangePersistenceForComponent(e.reference)}function d(t){var n=g(t);return n.getChangesForComponent(e(t,["invalidateCache","selector"]),t.invalidateCache).then(function(e){var r=[];if(t.includeDirtyChanges){r=n.getDirtyChanges()}return e.concat(r)})}function h(e,t){var n=r.getFlexControllerInstance(e.selector);var a=r.getDescriptorFlexControllerInstance(e.selector);return n.saveAll(t,e.skipUpdateCache,e.draft).then(a.saveAll.bind(a,t,e.skipUpdateCache,e.draft))}f.getFlexObjects=function(e){return p(e).then(function(){return d(e).then(function(t){return u(e).concat(t)})})};f.saveFlexObjects=function(t){var n=r.getAppComponentForSelector(t.selector);return Promise.all([C(t),h(t,n)]).then(function(){if(t.layer){t.currentLayer=t.layer}t.componentId=n.getId();t.invalidateCache=true;return f.getFlexObjects(e(t,"skipUpdateCache"))})};return f});