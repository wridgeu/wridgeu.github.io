/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/UriParameters","sap/ui/fl/Layer","sap/ui/fl/Change","sap/ui/fl/apply/_internal/flexObjects/UpdatableChange","sap/ui/fl/apply/_internal/flexObjects/CompVariant","sap/ui/fl/apply/_internal/flexObjects/RevertData","sap/ui/fl/apply/_internal/flexObjects/CompVariantRevertData","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantMerger","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/Storage"],function(e,t,n,a,r,i,o,s,c,p,u,f,l,v,g){"use strict";function d(e,t){if(!["defaultVariant","updateVariant"].includes(e.getChangeType())){return false}var n=e.getLayer()===t;var a=e.getDefinition().packageName;var r=!a||a==="$TMP";return n&&r}function y(e,t){if(t.isVariant()){return e.variants}switch(t.getChangeType()){case"defaultVariant":return e.defaultVariants;case"standardVariant":return e.standardVariants;default:return e.changes}}function C(e,t){for(var n=0;n<e.length;n++){if(e[n].fileName===t.fileName){e.splice(n,1,t);break}}}function m(e,t){return g.update({flexObject:e.getDefinition(),layer:e.getLayer(),transport:e.getRequest()}).then(function(n){if(n&&n.response){e.setResponse(n.response)}else{e.setState(p.PERSISTED)}return t}).then(function(t){var n=y(t.changes.comp,e);C(n,e.getDefinition());return e.getDefinition()})}function S(e,t,n){function a(e,t){for(var n=e.length-1;n>=0;n--){if((e[n].fileName||e[n].getFileName())===t.fileName){e.splice(n,1);break}}}return g.remove({flexObject:e.getDefinition(),layer:e.getLayer(),transport:e.getRequest()}).then(function(){delete t.byId[e.getId()];if(e.getChangeType()==="standardVariant"){t.standardVariantChange=undefined}else{a(y(t,e),e.getDefinition())}return n}).then(function(t){a(y(t.changes.comp,e),e.getDefinition());return e.getDefinition()})}function x(e){return e&&[p.NEW,p.DIRTY,p.DELETED].includes(e.getState())}function h(e){return e.variants.concat(e.changes).concat(e.defaultVariants).concat(e.standardVariantChange)}function V(e){var t={};if(typeof e.texts==="object"){Object.keys(e.texts).forEach(function(n){t[n]={value:e.texts[n],type:"XFLD"}})}return t}function O(e){if(e.layer){return e.layer}if(e.isUserDependent){return a.USER}var t=n.fromQuery(window.location.search).get("sap-ui-layer")||"";t=t.toUpperCase();if(t){return t}if(!e.fileType==="variant"){return a.CUSTOMER}var r=v.getInstanceOrUndef().isPublicLayerAvailable();return r?a.PUBLIC:a.CUSTOMER}function I(e){var t=f.getCompVariantsMap(e.reference)._getOrCreate(e.persistencyKey);return t.byId[e.id]}function T(e){if(e instanceof o){e.removeAllRevertInfo()}}function D(e,t){e.storeExecuteOnSelection(t.executeOnSelection);e.storeFavorite(t.favorite);e.storeContexts(t.contexts);if(t.name){e.setText("variantName",t.name)}e.storeContent(t.content||e.getContent());return e}function b(e,t){e.setExecuteOnSelection(t.executeOnSelection);e.setFavorite(t.favorite);e.setContexts(t.contexts);if(t.name){e.setName(t.name)}e.setContent(t.content||e.getContent());return e}var E={};E.setDefault=function(e){var t={defaultVariantName:e.defaultVariantId};e.layer=e.layer||n.fromQuery(window.location.search).get("sap-ui-layer")||a.USER;var r=f.getCompVariantsMap(e.reference)._getOrCreate(e.persistencyKey);var o="defaultVariant";var c=r.defaultVariants;var p=c[c.length-1];if(!p||!d(p,e.layer)){var l={fileName:u.createDefaultFileName(o),fileType:"change",changeType:o,layer:e.layer,content:t,namespace:u.createNamespace(e,"changes"),reference:e.reference,selector:{persistencyKey:e.persistencyKey},support:e.support||{}};l.support.generator=l.support.generator||"CompVariantState."+o;l.support.sapui5Version=sap.ui.version;p=new i(l);r.defaultVariants.push(p);r.byId[p.getId()]=p;p.addRevertInfo(new s({type:E.operationType.NewChange}))}else{p.addRevertInfo(new s({type:E.operationType.ContentUpdate,content:{previousState:p.getState(),previousContent:p.getContent()}}));p.setContent(t)}return p};E.revertSetDefaultVariantId=function(e){var t=f.getCompVariantsMap(e.reference)._getOrCreate(e.persistencyKey);var n=t.defaultVariants;var a=n[n.length-1];var i=a.popLatestRevertInfo();if(i.getType()===E.operationType.ContentUpdate){a.setContent(i.getContent().previousContent);a.setState(i.getContent().previousState)}else{a.setState(r.states.DELETED);t.defaultVariants.pop()}};E.addVariant=function(e){if(!e){return undefined}var t=e.changeSpecificData;var n={id:t.id,changeType:t.type,service:t.ODataService,content:t.content||{},reference:e.reference,fileType:"variant",packageName:t.packageName,layer:O(t),selector:{persistencyKey:e.persistencyKey},texts:V(t),command:e.command,generator:e.generator};if(t.favorite!==undefined){n.favorite=t.favorite}if(t.executeOnSelection!==undefined){n.executeOnSelection=t.executeOnSelection}if(t.contexts!==undefined){n.contexts=t.contexts}var a=o.createInitialFileContent(n);var r=new o(a);var i=f.getCompVariantsMap(e.reference);var s=i._getOrCreate(e.persistencyKey);s.variants.push(r);s.byId[r.getId()]=r;return r};E.updateVariant=function(e){function n(e,t){var n=e.getLayer()===t;var a=e.getPackage();var r=!a||a==="$TMP";var i=e.getChanges().some(function(e){return e.getLayer()===t});return e.getPersisted()&&n&&r&&!i}function a(e){return e.getChanges().reverse().find(function(e){return e.getChangeType()==="updateVariant"&&d(e,v)})}function i(e,t,n,a){var r={type:n,change:a,content:{previousState:t.getState(),previousContent:t.getContent(),previousFavorite:t.getFavorite(),previousExecuteOnSelection:t.getExecuteOnSelection(),previousContexts:t.getContexts()}};if(e.name){r.content.previousName=t.getText("variantName")}t.addRevertInfo(new c(r))}function o(e,t){i(e,t,E.operationType.ContentUpdate);if(e.executeOnSelection!==undefined){t.storeExecuteOnSelection(e.executeOnSelection)}if(e.favorite!==undefined){t.storeFavorite(e.favorite)}if(e.contexts){t.storeContexts(e.contexts)}if(e.name){t.storeName(e.name)}if(e.transportId){t.setRequest(e.transportId)}t.storeContent(e.content||t.getContent())}function s(e,n,a){var r=a.getRevertData()||[];var o=a.getContent();var s={previousContent:Object.assign({},o),previousState:a.getState(),change:t(Object.assign({},e),["favorite","executeOnSelection","contexts","content","name"])};r.push(s);a.setRevertData(r);if(e.executeOnSelection!==undefined){n.setExecuteOnSelection(e.executeOnSelection);o.executeOnSelection=e.executeOnSelection}if(e.favorite!==undefined){n.setFavorite(e.favorite);o.favorite=e.favorite}if(e.contexts){n.setContexts(e.contexts);o.contexts=e.contexts}if(e.content){n.setContent(e.content);o.variantContent=e.content}if(e.name){n.setName(e.name);o.texts={variantName:{value:e.name,type:"XFLD"}}}a.setContent(o);if(e.transportId){a.setRequest(e.transportId)}l.applyChangeOnVariant(n,a);i(e,n,E.operationType.UpdateVariantViaChangeUpdate,a)}function p(e,t){function n(e){var t=e.getDefinition();var n=f.getCompVariantsMap(e.getComponent());var a=e.getSelector().persistencyKey;n[a].changes.push(e);n[a].byId[e.getId()]=e;return t}var a=r.createInitialFileContent({changeType:"updateVariant",layer:v,fileType:"change",reference:e.reference,packageName:e.packageName,content:{},selector:{persistencyKey:e.persistencyKey,variantId:t.getId()}});["favorite","executeOnSelection","contexts"].forEach(function(t){if(e[t]!==undefined){a.content[t]=e[t]}});if(e.content!==undefined){a.content.variantContent=e.content}if(e.name){a.texts.variantName={value:e.name,type:"XFLD"}}var o=new r(a);if(e.transportId){o.setRequest(e.transportId)}n(o);i(e,t,E.operationType.NewChange,o);l.applyChangeOnVariant(t,o)}var u=I(e);var v=O(e);if(n(u,v)){o(e,u)}else{var g=a(u);if(g){s(e,u,g)}else{p(e,u)}}return u};E.operationType={StateUpdate:"StateUpdate",ContentUpdate:"ContentUpdate",NewChange:"NewChange",UpdateVariantViaChange:"UpdateVariantViaChange",UpdateVariantViaChangeUpdate:"UpdateVariantViaChangeUpdate"};E.removeVariant=function(e){var t=I(e);if(!e.revert){var n=new c({type:E.operationType.StateUpdate,content:{previousState:t.getState()}});t.addRevertInfo(n)}t.markForDeletion();return t};E.revert=function(e){function n(e){var t=e.getSelector().persistencyKey;var n=f.getCompVariantsMap(e.getComponent());delete n[t].byId[e.getId()];n[t].changes=n[t].changes.filter(function(t){return t!==e})}var a=I(e);var r=a.getRevertInfo().pop();a.removeRevertInfo(r);var i=r.getContent();var o;switch(r.getType()){case E.operationType.ContentUpdate:D(a,Object.assign({name:i.previousName,content:i.previousContent,favorite:i.previousFavorite,executeOnSelection:i.previousExecuteOnSelection,contexts:i.previousContexts},t(e,["reference","persistencyKey","id"])));break;case E.operationType.NewChange:o=r.getChange();a.removeChange(o);n(o);b(a,Object.assign({name:i.previousName,content:i.previousContent,favorite:i.previousFavorite,executeOnSelection:i.previousExecuteOnSelection,contexts:i.previousContexts},t(e,["reference","persistencyKey","id"])));break;case E.operationType.UpdateVariantViaChangeUpdate:o=r.getChange();b(a,Object.assign({name:i.previousName,content:i.previousContent,favorite:i.previousFavorite,executeOnSelection:i.previousExecuteOnSelection,contexts:i.previousContexts},t(e,["reference","persistencyKey","id"])));var s=o.getRevertData().pop();o.setContent(s.previousContent);o.setState(s.previousState);break;case E.operationType.StateUpdate:default:break}a.setState(i.previousState);return a};E.overrideStandardVariant=function(e){var t=f.getCompVariantsMap(e.reference)[e.persistencyKey];var n=t.byId[t.standardVariant.getId()];n.setExecuteOnSelection(!!e.executeOnSelection);var a=n.getChanges();n.removeAllChanges();a.forEach(function(e){l.applyChangeOnVariant(n,e)})};E.persist=function(e){function t(e,t){return g.write({flexObjects:[e.getDefinition()],layer:e.getLayer(),transport:e.getRequest(),isLegacyVariant:e.isVariant()}).then(function(n){if(n&&n.response&&n.response[0]){e.setResponse(n.response[0])}else{e.setState(p.PERSISTED)}return t}).then(function(t){y(t.changes.comp,e).push(e.getDefinition());return e.getDefinition()})}var n=e.reference;var a=e.persistencyKey;var r=f.getCompVariantsMap(n);var i=r._getOrCreate(a);var o=f.getStorageResponse(n);var s=h(i).filter(x).map(function(e){switch(e.getState()){case p.NEW:T(e);return t(e,o);case p.DIRTY:T(e);return m(e,o);case p.DELETED:T(e);return S(e,i,o);default:break}});return Promise.all(s)};E.persistAll=function(t){var n=e(f.getCompVariantsMap(t),"_getOrCreate","_initialize");var a=Object.keys(n).map(function(e){return E.persist({reference:t,persistencyKey:e})});return Promise.all(a)};return E});