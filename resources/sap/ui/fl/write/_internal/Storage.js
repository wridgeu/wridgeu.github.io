/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/write/_internal/StorageFeaturesMerger","sap/base/util/ObjectPath"],function(e,n,t){"use strict";var r="sap/ui/fl/write/_internal/connectors/";function a(){return e.getConnectors(r,false)}function i(e,n){var t=n.filter(function(n){return n.layers.indexOf("ALL")!==-1||n.layers.indexOf(e)!==-1});if(t.length===1){return t[0]}if(t.length===0){throw new Error("No Connector configuration could be found to write into layer: "+e)}if(t.length>1){throw new Error("sap.ui.core.Configuration 'flexibilityServices' has a misconfiguration: Multiple Connector configurations were found to write into layer: "+e)}}function o(n){var t=n.map(function(n){return n.writeConnectorModule.loadFeatures({url:n.url}).then(function(e){return{features:e,layers:n.layers}}).catch(e.logAndResolveDefault.bind(null,{features:{},layers:n.layers},n,"loadFeatures"))});return Promise.all(t)}function u(e){if(!e){return Promise.reject("No layer was provided")}return a().then(i.bind(this,e))}function l(e){if(e.draft){return new Promise(function(n,t){sap.ui.require(["sap/ui/fl/write/api/FeaturesAPI"],function(r){r.isVersioningEnabled(e.layer).then(function(r){if(r){n()}else{t("Draft is not supported for the given layer: "+e.layer)}})})})}return Promise.resolve()}function s(e){var n;if(e.allChanges&&e.allChanges.length&&e.condensedChanges){n={namespace:e.allChanges[0].getDefinition().namespace,layer:e.layer,delete:{change:[]},update:{change:[]},reorder:{change:[]},create:{change:[],ctrl_variant_change:[],ctrl_variant_management_change:[]}};var t=0;var r=false;e.allChanges.forEach(function(a,i){if(a.getFileType()==="ctrl_variant"){return}var o=n.create[a.getFileType()].length;if(a.condenserState){var u=false;if(a.condenserState==="delete"){if(a.getState()==="NONE"){n.delete.change.push(a.getFileName())}t++}else if(e.condensedChanges.length){u=e.allChanges[i].getFileName()!==e.condensedChanges[i-t].getFileName()}if((a.condenserState==="select"||a.condenserState==="update")&&u&&!r){var l=e.condensedChanges.slice(i-t).map(function(e){return e.getFileName()});n.reorder.change=l;r=true}if(a.condenserState==="select"&&a.getProperty("state")==="NEW"){n.create.change[o]={};n.create.change[o][a.getFileName()]=a.getDefinition()}else if(a.condenserState==="update"){var s=n.update.change.length;n.update.change[s]={};n.update.change[s][a.getFileName()]={content:a.getContent()}}delete a.condenserState}else if(a.getProperty("state")==="NEW"){n.create[a.getFileType()][o]={};n.create[a.getFileType()][o][a.getId()]=a.getDefinition()}})}return n}function c(e,n){return l(n).then(u.bind(undefined,n.layer)).then(function(r){n.url=r.url;var a=t.get(e,r.writeConnectorModule);return a.call(r.writeConnectorModule,n)})}var f={};f.write=function(e){return c("write",e)};f.condense=function(e){e.flexObjects=s(e);if(!e.flexObjects){return Promise.reject("No changes were provided")}return c("condense",e)};f.remove=function(e){return c("remove",e)};f.update=function(e){return c("update",e)};f.reset=function(e){return c("reset",e)};f.getFlexInfo=function(e){return c("getFlexInfo",e)};f.getContexts=function(e){return c("getContexts",e)};f.loadContextDescriptions=function(e){return c("loadContextDescriptions",e)};f.isContextSharingEnabled=function(e){return c("isContextSharingEnabled",e)};f.loadFeatures=function(){return a().then(o).then(n.mergeResults)};f.publish=function(e){return c("publish",e)};f.versions={load:function(e){return a().then(c.bind(undefined,"versions.load",e))},activate:function(e){return a().then(c.bind(undefined,"versions.activate",e))},discardDraft:function(e){return a().then(c.bind(undefined,"versions.discardDraft",e))}};return f});