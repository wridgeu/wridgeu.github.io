/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/registry/Settings","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Storage","sap/ui/model/json/JSONModel","sap/ui/fl/Utils","sap/ui/model/BindingMode"],function(e,r,t,n,i,s){"use strict";var a={};var o=9;var f=o+1;function d(e,r,t){var a=p(t);var f=sap.ui.fl.Versions.Original;t.forEach(function(e){if(e.version===sap.ui.fl.Versions.Draft){e.type="draft"}else if(f===sap.ui.fl.Versions.Original){e.type="active";f=e.version}else{e.type="inactive"}});return i.getUShellService("URLParsing").then(function(e){var d=i.getParameter(sap.ui.fl.Versions.UrlParameter,e);var l;if(d){l=parseInt(d)}else if(t.length>0){l=t[0].version}else{l=sap.ui.fl.Versions.Original}var c=new n({versioningEnabled:r,versions:t,activeVersion:f,backendDraft:a,dirtyChanges:false,draftAvailable:a,activateEnabled:a,persistedVersion:l,displayedVersion:l});c.setDefaultBindingMode(s.OneWay);c.setSizeLimit(o);c.setDirtyChanges=function(e){c.setProperty("/dirtyChanges",e);c.updateDraftVersion();c.updateBindings(true)};c.updateDraftVersion=function(){var e=c.getProperty("/versions");var r=c.getProperty("/versioningEnabled");var t=c.getProperty("/dirtyChanges");var n=c.getProperty("/backendDraft");var i=r&&(t||n);c.setProperty("/draftAvailable",i);var s=t?sap.ui.fl.Versions.Draft:c.getProperty("/persistedVersion");c.setProperty("/displayedVersion",s);if(!p(e)&&i){e.splice(0,0,{version:sap.ui.fl.Versions.Draft,type:"draft"})}if(p(e)&&!i){e.shift();c.setProperty("/displayedVersion",c.getProperty("/persistedVersion"))}var a=c.getProperty("/displayedVersion")!==c.getProperty("/activeVersion");c.setProperty("/activateEnabled",a)};return c})}function l(e,r){var t=[];var n=r.changePersistences;n.forEach(function(e){t=e.getDirtyChanges().concat();t.forEach(function(r){e.deleteChange(r,true)})});return t.length>0}function c(e){var t={dirtyChangesExist:false,changePersistences:[]};if(e.reference){var n=r.getChangePersistenceForComponent(e.reference);if(n.getDirtyChanges().length>0){t.dirtyChangesExist=true;t.changePersistences.push(n)}}if(e.nonNormalizedReference){var i=r.getChangePersistenceForComponent(e.nonNormalizedReference);if(i.getDirtyChanges().length>0){t.dirtyChangesExist=true;t.changePersistences.push(i)}}return t}function p(e){return e.some(function(e){return e.version===sap.ui.fl.Versions.Draft})}var v={};v.initialize=function(r){var n=r.reference;var i=r.layer;r.limit=f;return e.getInstance().then(function(e){var s=e.isVersioningEnabled(i);var o=s?t.versions.load(r):Promise.resolve([]);return o.then(function(e){return d(r,s,e)}).then(function(e){a[n]=a[n]||{};a[n][i]=a[n][i]||{};a[n][i]=e;return a[n][i]})})};v.getVersionsModel=function(e){var r=e.reference;var t=e.layer;if(!a[r]||!a[r][t]){throw Error("Versions Model for reference '"+r+"' and layer '"+t+"' were not initialized.")}var n=c(e);if(n.dirtyChangesExist){a[r][t].updateDraftVersion(e)}return a[r][t]};v.clearInstances=function(){a={}};v.onAllChangesSaved=function(e){e.reference=i.normalizeReference(e.reference);var r=v.getVersionsModel(e);var t=r.getProperty("/versioningEnabled");var n=r.getProperty("/dirtyChanges");r.setProperty("/dirtyChanges",true);r.setProperty("/backendDraft",t&&n);r.updateDraftVersion()};v.activate=function(e){var r=v.getVersionsModel(e);var n=r.getProperty("/versions");var i=p(n);var s=r.getProperty("/displayedVersion");var a=r.getProperty("/activeVersion");var o=r.getProperty("/persistedVersion");if(s===a){return Promise.reject("Version is already active")}e.version=s;var f=[];if(r.getProperty("/dirtyChanges")){var d=c(e);var l=d.changePersistences;f=l.map(function(r){return r.saveDirtyChanges(e.appComponent,false,undefined,o)})}return Promise.all(f).then(t.versions.activate.bind(undefined,e)).then(function(e){n.forEach(function(e){e.type="inactive"});e.type="active";if(i){n.shift()}n.splice(0,0,e);r.setProperty("/backendDraft",false);r.setProperty("/dirtyChanges",false);r.setProperty("/draftAvailable",false);r.setProperty("/activateEnabled",false);r.setProperty("/activeVersion",e.version);r.setProperty("/displayedVersion",e.version);r.setProperty("/persistedVersion",e.version);r.updateBindings(true)})};v.discardDraft=function(e){var r=v.getVersionsModel(e);var n=r.getProperty("/versions");var i=c(e);var s=r.getProperty("/backendDraft");var a=s?t.versions.discardDraft(e):Promise.resolve();return a.then(function(){n.shift();r.setProperty("/backendDraft",false);r.setProperty("/dirtyChanges",false);r.setProperty("/draftAvailable",false);r.setProperty("/activateEnabled",false);r.setProperty("/displayedVersion",r.getProperty("/persistedVersion"));r.updateBindings(true);var t=l(e,i);return{backendChangesDiscarded:s,dirtyChangesDiscarded:t}})};return v});