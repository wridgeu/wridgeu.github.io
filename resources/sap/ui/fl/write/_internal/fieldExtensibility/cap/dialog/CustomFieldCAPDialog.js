/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/core/Fragment","sap/m/MessageToast","sap/ui/fl/write/_internal/fieldExtensibility/cap/editor/getEditorConfig","sap/base/util/ObjectPath","sap/base/util/deepClone","sap/ui/model/resource/ResourceModel"],function(e,t,n,i,s,o,a){"use strict";var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");function l(e,t,n){var s=e.getContent()[0];s.setJson(o(t));s.setConfig(i(n));return s}function d(e){if(!e||!e.element){return{}}var t=o(e);var n=s.get(["element","@assert.range"],t);if(s.get(["element","type"],t)==="cds.String"&&Array.isArray(n)){s.set(["element","enum"],n.reduce(function(e,t){e[t]={};return e},{}),t);s.set(["element","@assert.range"],true,t)}if(t.element.annotations){t.element=Object.assign({},t.element,t.element.annotations);delete t.element.annotations}var i={extend:t.extend,elements:{}};i.elements[t.element.name]=t.element;return i}var p=e.extend("sap.ui.fl.write._internal.fieldExtensibility.cap.dialog.CustomFieldCAPDialog",{metadata:{library:"sap.ui.fl",properties:{_dialog:{type:"sap.m.Dialog",visibility:"hidden"}}}});p.prototype.open=function(e,n){var i={element:{name:"NewField",type:"cds.String"},extend:e.boundEntitySet.$Type};var s=this.getProperty("_dialog");if(s){this._oEditor.setJson(o(i));s.open()}else{t.load({name:"sap.ui.fl.write._internal.fieldExtensibility.cap.dialog.CustomFieldCAPDialog",controller:this}).then(function(t){t.setModel(new a({bundle:r}),"i18n");t.addStyleClass(n);this.setProperty("_dialog",t);this._oJson=o(i);this._oEditor=l(t,this._oJson,{entityTypes:e.entityTypes});this._oEditor.attachJsonChange(function(e){this._oJson=d(e.getParameter("json"))}.bind(this));t.open()}.bind(this))}};p.prototype.exit=function(){var e=this.getProperty("_dialog");if(e){e.destroy()}if(this.oEditor){this.oEditor.destroy()}};p.prototype.onSave=function(){var e={extensions:[JSON.stringify(this._oJson)]};var t=new Promise(function(t,n){var i=new XMLHttpRequest;i.open("POST","http://localhost:4004/extensibility/addExtension");i.setRequestHeader("Content-Type","application/json");i.onload=function(){if(i.status>=200&&i.status<400){t(i.response)}else{n({status:i.status,message:i.statusText})}};i.send(JSON.stringify(e))});t.then(function(){n.show(r.getText("CAP_ADD_FIELD_SUCCESS"))});this.getProperty("_dialog").close()};p.prototype.onCancel=function(){this.getProperty("_dialog").close()};return p});