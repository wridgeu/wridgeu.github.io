/*
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/write/_internal/transport/Transports","sap/ui/fl/write/_internal/transport/TransportDialog","sap/ui/fl/registry/Settings","sap/ui/core/BusyIndicator"],function(e,t,r,a,n,s,o){"use strict";var i=function(){};i.prototype.selectTransport=function(n,o,i,p,c,l){if(!e.getLrepUrl()){o(this._createEventObject(n,{transportId:""}));return}var f=function(e,r,n,s,o,i){a.getTransports(e).then(function(a){if(this._checkDialog(a,i)){this._openDialog({hidePackage:!t.doesCurrentLayerRequirePackage(),pkg:e.package,transports:a.transports,lrepObject:this._toLREPObject(e)},r,n,s,o)}else{var p=!a.localonly&&i?{transportId:"ATO_NOTIFICATION"}:this._getTransport(a);r(this._createEventObject(e,p))}}.bind(this),function(e){n(e)})};var u=t.getCurrentLayer();if(u&&(u===r.CUSTOMER||u===r.CUSTOMER_BASE)){s.getInstance().then(function(e){if(e.isAtoEnabled()){if(!(n&&n.name&&n.namespace&&n.type)){var t={transportId:"ATO_NOTIFICATION"};o(this._createEventObject(n,t))}else{f.apply(this,[n,o,i,p,l,true])}}else{f.apply(this,[n,o,i,p,l,false])}}.bind(this))}else{f.apply(this,[n,o,i,p,l,false])}};i.prototype._createEventObject=function(e,t){return{mParameters:{selectedTransport:t.transportId,selectedPackage:e["package"],dialog:false},getParameters:function(){return this.mParameters},getParameter:function(e){return this.mParameters[e]}}};i.prototype._toLREPObject=function(e){var t={};if(e.namespace){t.namespace=e.namespace}if(e.name){t.name=e.name}if(e.type){t.type=e.type}return t};i.prototype._openDialog=function(e,t,r,a,s){var i=new n(e);i.attachOk(t);i.attachCancel(r);i.addStyleClass(s);if(a){i.addStyleClass("sapUiSizeCompact")}else{i.removeStyleClass("sapUiSizeCompact")}i.open();o.hide();return i};i.prototype._getTransport=function(e){var t;if(!e.localonly){t=this._hasLock(e.transports)}else{t={transportId:""}}return t};i.prototype._checkDialog=function(e,t){if(e){if(e.localonly||this._hasLock(e.transports)||!e.localonly&&t){return false}}return true};i.prototype._hasLock=function(e){var t=e.length;while(t--){var r=e[t];if(r.locked){return r}}return false};i.prototype.setTransports=function(e,t){var r=e.length-1;var a=this;var n=function(e,t,r,s,o){if(t>=0){var i=e[t];if(o===true){if(i.getDefinition().packageName!=="$TMP"){i.setRequest(s)}t--;return n(e,t,r,s,o)}if(i.getDefinition().packageName!=="$TMP"){return a.openTransportSelection(i,r).then(function(a){if(a==="cancel"){return Promise.reject("cancel")}i.setRequest(a.transport);if(a.fromDialog===true){s=a.transport;o=true}t--;return n(e,t,r,s,o)},function(){return null})}t--;return n(e,t,r,s,o)}return Promise.resolve()};return n(e,r,t)};i.prototype.openTransportSelection=function(e,t,r){var a=this;return new Promise(function(n,s){var o=function(e){if(e&&e.getParameters){var t=e.getParameters().selectedTransport;var r=e.getParameters().selectedPackage;var a=e.getParameters().dialog;var s={transport:t,packageName:r,fromDialog:a};n(s)}else{n({})}};var i=function(e){if(e.sId==="cancel"){n(e.sId)}else{s(e)}};var p={};if(e){p["package"]=e.getPackage();p.namespace=e.getNamespace();p.name=e.getId();p.type=e.getDefinition().fileType}a.selectTransport(p,o,i,false,t,r)})};i.prototype.checkTransportInfo=function(e){return e&&e.transport&&e.packageName!=="$TMP"};i.prototype._prepareChangesForTransport=function(e,t,r,n){var s=a.convertToChangeTransportData(t,r);var o={};o.package=e.packageName;o.transportId=e.transport;o.changeIds=s;o.reference=n.reference;o.layer=n.layer;return a.makeChangesTransportable(o).then(function(){t.forEach(function(t){if(t.getPackage()==="$TMP"){var r=t.getDefinition();r.packageName=e.packageName;t.setResponse(r)}})})};return i});