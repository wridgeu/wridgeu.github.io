/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/base/util/UriParameters"],function(e,a,r,t,i,s,n){"use strict";function l(e){var a=!!r.getParameter(sap.ui.fl.Versions.UrlParameter,e.URLParsingService);if(a){return Promise.resolve(false)}return s.isVersioningEnabled(e.layer).then(function(a){return a&&i.isDraftAvailable({selector:e.selector,layer:e.layer})})}function o(e){var r=this.hasMaxLayerParameterWithValue({value:e.layer},e.URLParsingService);var t=e.layer===a.USER;if(t||r){return Promise.resolve(false)}return n.hasHigherLayerChanges({selector:e.selector,ignoreMaxLayerParameter:e.ignoreMaxLayerParameter,upToLayer:e.layer,includeCtrlVariants:e.includeCtrlVariants,includeDirtyChanges:true})}function f(e){var a=u(e.selector);if(a!==null){return false}var r={selector:e.selector,layer:e.layer};return n.getResetAndPublishInfo(r).then(function(a){v(a,e.selector);return!a.allContextsProvided})}function u(e){var a=t.getFlexReferenceForControl(e);var r=a||"true";var i=JSON.parse(window.sessionStorage.getItem("sap.ui.fl.info."+r));return i&&!i.allContextsProvided}function v(e,a){var r=t.getFlexReferenceForControl(a);var i=r||"true";window.sessionStorage.setItem("sap.ui.fl.info."+i,JSON.stringify(e))}var c={getReloadReasonsForStart:function(e){return Promise.all([o.call(this,e),l(e),f(e)]).then(function(a){e.hasHigherLayerChanges=a[0];e.isDraftAvailable=a[1];e.allContexts=a[2];return e})},removeInfoSessionStorage:function(e){var a=t.getFlexReferenceForControl(e);var r=a||"true";window.sessionStorage.removeItem("sap.ui.fl.info."+r)},hasVersionParameterWithValue:function(e,a){return r.hasParameterAndValue(sap.ui.fl.Versions.UrlParameter,e.value,a)},hasMaxLayerParameterWithValue:function(a,t){var i=e.FL_MAX_LAYER_PARAM;return r.hasParameterAndValue(i,a.value,t)},handleUrlParametersForStandalone:function(a){if(a.hasHigherLayerChanges){a.parameters=r.handleUrlParameters(a.parameters,e.FL_MAX_LAYER_PARAM,a.layer,a.URLParsingService)}var t=new RegExp("&*"+sap.ui.fl.Versions.UrlParameter+"=-?\\d*&?","g");a.parameters=a.parameters.replace(t,"");if(a.isDraftAvailable&&!a.onExit){a.parameters=r.handleUrlParameters(a.parameters,sap.ui.fl.Versions.UrlParameter,sap.ui.fl.Versions.Draft,a.URLParsingService)}if(a.versionSwitch){a.parameters=r.handleUrlParameters(a.parameters,sap.ui.fl.Versions.UrlParameter,a.version,a.URLParsingService)}if(a.parameters==="?"){a.parameters=""}return a.parameters},handleParametersOnStart:function(a){var t=r.getParsedURLHash(a.URLParsingService);t.params=t.params||{};if(a.hasHigherLayerChanges){t.params[e.FL_MAX_LAYER_PARAM]=[a.layer]}if(a.isDraftAvailable){t.params[sap.ui.fl.Versions.UrlParameter]=[sap.ui.fl.Versions.Draft]}return t},initialDraftGotActivated:function(e){if(e.versioningEnabled){var a=this.hasVersionParameterWithValue({value:sap.ui.fl.Versions.Draft.toString()},e.URLParsingService);return!i.isDraftAvailable(e)&&a}return false},getReloadMethod:function(e){var a={NOT_NEEDED:"NO_RELOAD",RELOAD_PAGE:"HARD_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION"};e.reloadMethod=a.NOT_NEEDED;e.isDraftAvailable=e.isDraftAvailable||c.hasVersionParameterWithValue({value:sap.ui.fl.Versions.Draft.toString()},e.URLParsingService);if(e.activeVersion>sap.ui.fl.Versions.Original){e.activeVersionNotSelected=e.activeVersion&&!c.hasVersionParameterWithValue({value:e.activeVersion.toString()},e.URLParsingService)}e.hasHigherLayerChanges=c.hasMaxLayerParameterWithValue({value:e.layer},e.URLParsingService);e.initialDraftGotActivated=c.initialDraftGotActivated(e);if(e.initialDraftGotActivated){e.isDraftAvailable=false}e.allContexts=u(e.selector);if(e.changesNeedReload||e.isDraftAvailable||e.hasHigherLayerChanges||e.initialDraftGotActivated||e.activeVersionNotSelected||e.allContexts){e.reloadMethod=a.RELOAD_PAGE;if(!e.changesNeedReload&&r.getUshellContainer()){e.reloadMethod=a.VIA_HASH}}this.removeInfoSessionStorage(e.selector);return e}};return c});