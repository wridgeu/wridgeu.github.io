/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/_internal/flexState/FlexObjectState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/Layer","sap/ui/fl/LayerUtils"],function(e,r,n,t,a,o,s,l,i,c,u,g,p){"use strict";var f={};function d(r){return r._getMap&&e(s.getChangeTypes(),r._getMap().changeType)||r.getChangeType&&e(s.getChangeTypes(),r.getChangeType())}function h(e){e.includeCtrlVariants=true;e.invalidateCache=false;return f._getUIChanges(e).then(function(e){return e.length>0})}f.hasHigherLayerChanges=function(e){e.upToLayer=e.upToLayer||p.getCurrentLayer();return i.getFlexObjects(e).then(function(r){return r.filter(function(r){return p.isOverLayer(r.getLayer(),e.upToLayer)})}).then(function(e){return e.length>0})};f.save=function(e){return i.saveFlexObjects(e)};f.getResetAndPublishInfo=function(e){return Promise.all([h(e),u.isPublishAvailable()]).then(function(r){var t=r[0];var a=r[1];var s=e.layer!==g.USER&&e.layer!==g.PUBLIC;var l={isResetEnabled:t,isPublishEnabled:false,allContextsProvided:true};if(s){return o.getFlexControllerInstance(e.selector).getResetAndPublishInfo(e).then(function(e){l.allContextsProvided=e.allContextsProvided===undefined||e.allContextsProvided;l.isResetEnabled=e.isResetEnabled;l.isPublishEnabled=a&&e.isPublishEnabled;return l}).catch(function(e){n.error("Sending request to flex/info route failed: "+e.message);return l})}return l})};f.getResetAndPublishInfoFromSession=function(e){var r=c.getFlexReferenceForControl(e)||"true";return JSON.parse(window.sessionStorage.getItem("sap.ui.fl.info."+r))};f.reset=function(e){var r=o.getAppComponentForSelector(e.selector);var n=o.getFlexControllerInstance(r);var t=[e.layer,e.generator,r,e.selectorIds,e.changeTypes];return n.resetChanges.apply(n,t)};f.publish=function(e){e.styleClass=e.styleClass||"";var r=o.getAppComponentForSelector(e.selector);return o.getFlexControllerInstance(r)._oChangePersistence.transportAllUIChanges({},e.styleClass,e.layer,e.appVariantDescriptors)};f.add=function(e){if(d(e.change)){return e.change.store()}var r=o.getAppComponentForSelector(e.selector);return o.getFlexControllerInstance(r).addPreparedChange(e.change,r)};f.remove=function(e){var r;var n;return Promise.resolve().then(function(){if(!e.selector){return Promise.reject(new Error("An invalid selector was passed so change could not be removed with id: "+e.change.getId()))}n=o.getAppComponentForSelector(e.selector);if(!n){return Promise.reject(new Error("Invalid application component for selector, change could not be removed with id: "+e.change.getId()))}if(d(e.change)){var s=o.getDescriptorFlexControllerInstance(n);s.deleteChange(e.change,n);return undefined}var l=t.bySelector(e.change.getSelector(),n);r=o.getFlexControllerInstance(n);if(l){a.sync.destroyAppliedCustomData(l,e.change,t)}r.deleteChange(e.change,n);return undefined})};f._condense=function(e){return Promise.resolve().then(function(){if(!e.selector){throw Error("An invalid selector was passed")}var r=o.getAppComponentForSelector(e.selector);if(!r){throw Error("Invalid application component for selector")}if(!e.changes||e.changes&&!Array.isArray(e.changes)){throw Error("Invalid array of changes")}return l.condense(r,e.changes)})};f._getUIChanges=function(e){if(e.layer){e.currentLayer=e.layer}return i.getFlexObjects(e)};return f});