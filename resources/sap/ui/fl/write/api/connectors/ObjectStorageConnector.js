/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/ui/fl/write/connectors/BaseConnector","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/apply/_internal/connectors/ObjectStorageUtils"],function(e,t,r,n){"use strict";function i(e){var t=[];return n.forEachObjectInStorage(e,function(e){t.push(e.changeDefinition)}).then(function(){return t})}function s(e,t){var r=true;if(e.selectorIds){if(t.selector){r=e.selectorIds.indexOf(t.selector.id)>-1}else{r=false}}if(r&&e.changeTypes){r=e.changeTypes.indexOf(t.changeType)>-1}return r}function o(e,t){if(!e.creation){var r=Date.now()+t;e.creation=new Date(r).toISOString()}return e}var a=e({},t,{storage:undefined,layers:["ALL"],loadFlexData:function(e){return i({storage:this.storage,reference:e.reference}).then(function(e){var t=r.getGroupedFlexObjects(e);return r.filterAndSortResponses(t)})},write:function(e){var t=e.flexObjects.map(function(e,t){var r=n.createFlexObjectKey(e);e=o(e,++t);var i=this.storage._itemsStoredAsObjects?e:JSON.stringify(e);return this.storage.setItem(r,i)}.bind(this));return Promise.all(t).then(function(){})},update:function(e){var t=e.flexObject;var r=n.createFlexObjectKey(e.flexObject);var i=this.storage._itemsStoredAsObjects?t:JSON.stringify(t);var s=this.storage.setItem(r,i);return Promise.resolve(s)},reset:function(e){return n.forEachObjectInStorage({storage:this.storage,reference:e.reference,layer:e.layer},function(t){if(s(e,t.changeDefinition)){return Promise.resolve(this.storage.removeItem(t.key)).then(function(){return{fileName:t.changeDefinition&&t.changeDefinition.fileName}})}}.bind(this)).then(function(e){return{response:e.filter(function(e){return!!e})}})},remove:function(e){var t=n.createFlexObjectKey(e.flexObject);this.storage.removeItem(t);var r=this.storage.removeItem(t);return Promise.resolve(r)},loadFeatures:function(){return Promise.resolve({isKeyUser:true,isVariantSharingEnabled:true})},getFlexInfo:function(e){e.storage=this.storage;return n.getAllFlexObjects(e).then(function(e){return{isResetEnabled:e.length>0}})}});return a});