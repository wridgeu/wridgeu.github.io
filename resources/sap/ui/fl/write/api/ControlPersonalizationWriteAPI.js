/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/registry/Settings","sap/ui/fl/FlexControllerFactory","sap/ui/fl/Layer","sap/ui/fl/Utils"],function(e,n,r,t,o,a,c,i,l){"use strict";function s(e,t){if(!e.changeSpecificData){return Promise.reject(new Error("No changeSpecificData available"))}if(!e.changeSpecificData.changeType){return Promise.reject(new Error("No valid changeType"))}if(!(e.selectorControl instanceof r)){return Promise.reject(new Error("No valid selectorControl"))}var a=e.selectorControl.getMetadata().getName();return o.getChangeHandler(e.changeSpecificData.changeType,a,e.selectorControl,n,t)}function u(e,r,o){var a=t.getRelevantVariantManagementControlId(r,[],o);return n.getSelector(a,e).id}function p(e){var r=t.getAllVariantManagementControlIds(e);return r.map(function(r){return n.getSelector(r,e).id})}function f(n){e.error(n);return Promise.reject(n)}var g={add:function(n){if(!n.changes.length){return Promise.resolve([])}var r=l.getAppComponentForControl(n.changes[0].selectorElement||n.changes[0].selectorControl);var t=c.createForControl(r);var o=r.getModel(l.VARIANT_MODEL_NAME);var a=i.USER;var p=[];return n.changes.reduce(function(c,i){return c.then(function(){i.selectorControl=i.selectorElement;return s(i,a)}).then(function(){if(!n.ignoreVariantManagement){if(!i.changeSpecificData.variantReference){var e=u(r,i.selectorControl,n.useStaticArea);if(e){var c=o.oData[e].currentVariant;i.changeSpecificData.variantReference=c}}}else{delete i.changeSpecificData.variantReference}i.changeSpecificData=Object.assign(i.changeSpecificData,{developerMode:false,layer:a});return t.addChange(i.changeSpecificData,i.selectorControl)}).then(function(e){return t.applyChange(e,i.selectorControl)}).then(function(e){p.push(e)}).catch(function(n){e.error("A Change was not added successfully. Reason:",n.message)})},Promise.resolve()).then(function(){return p})},reset:function(e){if(!e.selectors||e.selectors.length===0){return f("At least one control ID has to be provided as a parameter")}var n=e.selectors[0].appComponent||l.getAppComponentForControl(e.selectors[0]);if(!n){return f("App Component could not be determined")}var r=e.selectors.map(function(e){var r=e.id||e.getId();var t=n.getLocalId(r);return t||r});var t=c.createForControl(n);return t.resetChanges(i.USER,undefined,n,r,e.changeTypes)},restore:function(e){if(!e||!e.selector){return Promise.reject("No selector was provided")}var n=l.getAppComponentForControl(e.selector);if(!n){return Promise.reject("App Component could not be determined")}var r=c.createForControl(n);return r.removeDirtyChanges(i.USER,n,e.selector,e.generator,e.changeTypes)},save:function(e){var n=e.selector.appComponent||l.getAppComponentForControl(e.selector);if(!n){return f("App Component could not be determined")}var r=c.createForControl(n);var t=n.getModel(l.VARIANT_MODEL_NAME);var o=p(n);return r.saveSequenceOfDirtyChanges(e.changes,n).then(function(e){t.checkDirtyStateForControlModels(o);return e})},buildSelectorFromElementIdAndType:function(e){var n=l.getAppComponentForControl(e.element);if(!n||!e.elementId||!e.elementType){throw new Error("Not enough information given to build selector.")}return{elementId:e.elementId,elementType:e.elementType,appComponent:n,id:e.elementId,controlType:e.elementType}},isCondensingEnabled:function(){return a.getInstance().then(function(e){return e.isCondensingEnabled(i.USER)})}};return g});