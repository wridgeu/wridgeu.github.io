/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/FlexControllerFactory","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/base/ManagedObject","sap/base/util/includes","sap/ui/fl/variants/VariantManagement","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/core/Component","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,n,r,t,a,o,i,c,s,l,u,f,g){"use strict";var p={_determineParameters:function(e,r,a){var o=n.getAppComponentForControl(e);var i=t.createForControl(o);var c=o.getRootControl();var s={rootControl:c,flexController:i};if(!r){var l;var u;var f;s.variantModel=o.getModel(n.VARIANT_MODEL_NAME);s.variantManagement={};if(!a){l=g.makeArray(s.rootControl.$().find(".sapUiFlVarMngmt"))}if(a||l.length===0){l=g.makeArray(g(sap.ui.getCore().getStaticAreaRef()).find(".sapUiFlVarMngmt"))}l.map(function(e){u=sap.ui.getCore().byId(e.id);if(u.getMetadata().getName()==="sap.ui.fl.variants.VariantManagement"){f=u.getFor();f.forEach(function(n){s.variantManagement[n]=s.variantModel.getLocalId(e.id,o)})}})}return s},_getVariantManagement:function(e,n){n=n||this._determineParameters(e);var r=function(e){if(!n.variantManagement[e.getId()]&&e.getParent()&&e.getId()!==n.rootControl.getId()){return r(e.getParent())}else if(!e.getParent()||e.getId()===n.rootControl.getId()){return n.variantManagement[e.getId()]||""}return n.variantManagement[e.getId()]};return r(e)},clearVariantParameterInURL:function(e){var r;var t=n.getAppComponentForControl(e);var a=t instanceof u?t.getModel(n.VARIANT_MODEL_NAME):undefined;if(!a){f.warning("Variant model could not be found on the provided control")}if(e instanceof s){var o=a.getLocalId(e.getId(),t);var i=l.removeURLParameterForVariantManagement({model:a,vmReference:o});r=i.parameters}l.update({parameters:r||[],updateURL:true,updateHashEntry:!!a,model:a||{},silent:!a})},activateVariant:function(e,r){return Promise.resolve().then(function(){var t;if(typeof e==="string"||e instanceof String){t=u.get(e);if(!(t instanceof u)){t=sap.ui.getCore().byId(e);if(!(t instanceof o)){throw new Error("No valid component or control found for the provided ID")}}}else if(e instanceof u||e instanceof o){t=e}var a=n.getAppComponentForControl(t);if(!a){throw new Error("A valid variant management control or component (instance or ID) should be passed as parameter")}var i=a.getModel(n.VARIANT_MODEL_NAME);if(!i){throw new Error("No variant management model found for the passed control or application component")}var c=i.getVariantManagementReference(r).variantManagementReference;if(!c){throw new Error("A valid control or component, and a valid variant/ID combination are required")}return i.waitForVMControlInit(c).then(function(){return i.updateCurrentVariant({variantManagementReference:c,newVariantReference:r,appComponent:a})})})["catch"](function(e){f.error(e);return Promise.reject(e)})},_checkChangeSpecificData:function(e,n){if(!e.changeSpecificData){return Promise.reject(new Error("No changeSpecificData available"))}if(!e.changeSpecificData.changeType){return Promise.reject(new Error("No valid changeType"))}if(!(e.selectorControl instanceof o)){return Promise.reject(new Error("No valid selectorControl"))}var t=e.selectorControl.getMetadata().getName();return r.getChangeHandler(e.changeSpecificData.changeType,t,e.selectorControl,a,n)},addPersonalizationChanges:function(r){var t=[];var a=[];var o=e.USER;var i=[];function c(e,n){return p._checkChangeSpecificData(e,o).then(function(){r.params=p._determineParameters(e.selectorControl,r.ignoreVariantManagement,r.useStaticArea);if(!r.ignoreVariantManagement){if(!e.changeSpecificData.variantReference){var t=p._getVariantManagement(e.selectorControl,r.params);if(t){var a=r.params.variantModel.oData[t].currentVariant;e.changeSpecificData.variantReference=a}}}else{delete e.changeSpecificData.variantReference}return r.params.flexController.addChange(Object.assign(n,e.changeSpecificData),e.selectorControl)}).then(function(n){e.changeInstance=n;t.push(e)}).catch(function(n){return Promise.reject({change:e,message:n.message})})}function s(e){return r.params.flexController.applyChange(e.changeInstance,e.selectorControl).then(function(){a.push(e.changeInstance)}).catch(function(n){return Promise.reject({change:e,message:n.message})})}r.controlChanges.forEach(function(e){var n={};Object.assign(n,{developerMode:false,layer:o});i.push(c.bind(undefined,e,n))});return n.execPromiseQueueSequentially(i).then(function(){i=[];t.forEach(function(e){i.push(s.bind(undefined,e))});return n.execPromiseQueueSequentially(i)}).then(function(){return a})},isPersonalized:function(r,a){if(!r||r.length===0){return this._reject("At least one control ID has to be provided as a parameter")}var o=r[0].appComponent||n.getAppComponentForControl(r[0]);if(!o){return this._reject("App Component could not be determined")}var i=r.map(function(e){return e.id||e.getId()});var c=t.createForControl(o);return c.getComponentChanges({currentLayer:e.USER,includeCtrlVariants:true}).then(function(e){return e.filter(this._filterBySelectors.bind(this,o,i)).filter(this._filterByChangeType.bind(this,a)).some(this._ifValidFileType)}.bind(this))},_reject:function(e){f.error(e);return Promise.reject(e)},_filterBySelectors:function(e,n,r){var t=r.getSelector();var o=a.getControlIdBySelector(t,e);return c(n,o)},_filterByChangeType:function(e,n){return Array.isArray(e)&&e.length>0?c(e,n.getChangeType()):true},_ifValidFileType:function(e){return e.getFileType()==="change"},resetChanges:function(r,a){if(!r||r.length===0){return this._reject("At least one control ID has to be provided as a parameter")}var o=r[0].appComponent||n.getAppComponentForControl(r[0]);if(!o){return this._reject("App Component could not be determined")}var i=r.map(function(e){var n=e.id||e.getId();var r=o.getLocalId(n);return r||n});var c=t.createForControl(o);return c.resetChanges(e.USER,undefined,o,i,a)},saveChanges:function(e,r){if(!(r instanceof i)){var t="A valid sap.ui.base.ManagedObject instance is required as a parameter";f.error(t);return Promise.reject(t)}var a=p._determineParameters(r);var o=n.getAppComponentForControl(r);var c=Object.keys(a.variantManagement).reduce(function(e,n){return e.concat([a.variantManagement[n]])},[]);return a.flexController.saveSequenceOfDirtyChanges(e,o).then(function(e){a.variantModel.checkDirtyStateForControlModels(c);return e})},hasVariantManagement:function(e){try{return!!this._getVariantManagement(e)}catch(e){f.error(e.message);return false}}};return p},true);