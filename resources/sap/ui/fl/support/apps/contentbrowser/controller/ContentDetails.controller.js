/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/Dialog","sap/m/Text","sap/m/Button","sap/m/Input","sap/ui/fl/support/apps/contentbrowser/lrepConnector/LRepConnector","sap/ui/fl/support/apps/contentbrowser/utils/DataUtils","sap/ui/fl/Layer","sap/m/library"],function(e,t,n,a,o,i,r,s,l){"use strict";var c=l.ButtonType;return e.extend("sap.ui.fl.support.apps.contentbrowser.controller.ContentDetails",{oSelectedContentModel:undefined,oDataUtils:r,onInit:function(){this._initAndBindSelectedContentModel();var e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("ContentDetails").attachMatched(this._onRouteMatched,this);e.getRoute("ContentDetailsFlip").attachMatched(this._onRouteMatched,this)},_initAndBindSelectedContentModel:function(){this.oSelectedContentModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.oSelectedContentModel,"selectedContent")},_onRouteMatched:function(e){var t=this;var n=e.getParameter("arguments");var a={};a.layer=n.layer;a.namespace=decodeURIComponent(n.namespace);a.fileName=n.fileName;a.fileType=n.fileType;if(a.namespace[a.namespace.length-1]!=="/"){a.namespace+="/"}var o=a.namespace+a.fileName+"."+a.fileType;var r=t.getView().getContent()[0];r.setBusy(true);return i.getContent(a.layer,o,null,null,true).then(t._onContentReceived.bind(t,a,r,o),function(){r.setBusy(false)})},_onContentReceived:function(e,t,n,a){var o=this;e.data=r.formatData(a,e.fileType);if(e.fileType){return i.getContent(e.layer,n,true).then(o._onContentMetadataReceived.bind(o,e,t),function(){t.setBusy(false)})}return Promise.resolve()},_onContentMetadataReceived:function(e,t,n){e.metadata=n;this.oSelectedContentModel.setData(e);var a=sap.ui.getCore();var o=this.getView().createId("contentDetailsIconTabBar");var i=a.getElementById(o);if(i){var r=i.getItems()[0];if(i.getSelectedKey()!==r.getId()){i.setSelectedItem(r)}}t.setBusy(false)},onEditClicked:function(){var e=this.getView().getModel("selectedContent");var t=e.getData();var n=sap.ui.core.UIComponent.getRouterFor(this);n.navTo("ContentDetailsEdit",{layer:t.layer,namespace:encodeURIComponent(t.namespace),fileName:t.fileName,fileType:t.fileType})},onDeleteClicked:function(){var e=this;var o=new t({title:"{i18n>confirmDeletionTitle}",type:"Message",content:new n({text:"{i18n>questionFileDeletion}"}),beginButton:new a({text:"{i18n>confirm}",type:c.Reject,press:function(){o.close();e._selectTransportAndDeleteFile()}}),endButton:new a({text:"{i18n>cancel}",press:function(){o.close()}}),afterClose:function(){o.destroy()}});this.getView().addDependent(o);o.open()},_selectTransportAndDeleteFile:function(){var e=this;var i=this.getView().getModel("selectedContent");var r=i.getData();var l=r.layer;var p="";var d;var u;var f;r.metadata.some(function(e){if(e.name==="layer"){p=e.value;return true}});r.metadata.some(function(e){if(e.name==="transportId"){d=e.value;return true}});try{u=JSON.parse(r.data).packageName}catch(e){}var m=r.namespace;var v=r.fileName;var C=r.fileType;if(p===s.USER||p==="LOAD"||p==="VENDOR_LOAD"||!d&&(!u||u==="$TMP")){f=undefined;e._deleteFile(p,m,v,C,f,l)}else if(d==="ATO_NOTIFICATION"){f=d;e._deleteFile(p,m,v,C,f,l)}else{var h=new o({placeholder:"Transport ID or ATO_NOTIFICATION"});var g=new t({title:"{i18n>transportInput}",type:"Message",content:[new n({text:"{i18n>transportInputDescription}"}),h],beginButton:new a({text:"{i18n>confirm}",type:c.Accept,press:function(){f=h.getValue();g.close();e._deleteFile(p,m,v,C,f,l)}}),endButton:new a({text:"{i18n>cancel}",press:function(){g.close()}}),afterClose:function(){g.destroy()}});this.getView().addDependent(g);g.open()}},_deleteFile:function(e,t,n,a,o,r){return i.deleteFile(e,t,n,a,o,r).then(function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("LayerContentMaster",{layer:r,namespace:encodeURIComponent(t)})}.bind(this))}})});