/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/ui/core/support/Plugin","sap/ui/core/support/Support","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/model/json/JSONModel","sap/ui/fl/FlexController","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/Utils","sap/ui/fl/support/apps/uiFlexibilityDiagnostics/helper/Extractor","sap/ui/core/mvc/XMLView","sap/ui/core/Component"],function(e,t,i,n,a,s,o,p,r,d,l){"use strict";var h=t.extend("sap.ui.fl.support.Flexibility",{constructor:function(e){t.apply(this,["sapUiSupportFlexibility","Flexibility",e]);this._oStub=e;if(this.runsAsToolPlugin()){this._aEventIds=[this.getId()+"SetApps",this.getId()+"SetChangesMaps"]}else{this._aEventIds=[this.getId()+"GetApps",this.getId()+"GetChangesMaps"]}}});h.prototype.sDelimiter=";";h.prototype.init=function(e){t.prototype.init.apply(this,arguments);var n="<div class='sapUiSmallMargin'>The applications listed below have been handled by the sap.ui.fl library in this session.</div>"+"<div class='sapUiSmallMarginBegin'>You can download a file containing the data that has been applied to an application as well as "+"relevant runtime information, and then upload this file to the UI Flexibility Diagnostics application for further investigation.</div>"+"<div class='sapUiSmallMarginBegin'>The UI Flexibility Diagnostics application displays graphs and is only available with SAPUI5.</div>";if(e.isToolStub()){this.addStylesheet("sap/ui/fl/support/flexibility");this.oChangesModel=new a;this.oAppModel=new a;this.oToolSettings=new a({hideDependingChanges:false,panelInfoText:n});this.oChangeDetails=new a;this._renderToolPlugin([]);i.getStub().sendEvent(this.getId()+"GetApps",{})}else{this.onsapUiSupportFlexibilityGetApps()}};h.prototype._renderToolPlugin=function(){var e=function(){var e=sap.ui.getCore().createRenderManager();e.write("<div id='"+this.getId()+"-FlexCacheArea' class='sapUiSizeCompact'></div>");e.flush(this.$().get(0));e.destroy()}.bind(this);var t=function(){this.oViewPromise=d.create({viewName:"sap.ui.fl.support.diagnostics.Flexibility",viewData:{plugin:this}}).then(function(e){this.oView=e;this.oView.placeAt(this.getId()+"-FlexCacheArea");this.oView.setModel(this.oAppModel,"flexApps");this.oView.setModel(this.oToolSettings,"flexToolSettings");this.oView.setModel(this.oChangesModel,"flexChanges");this.oView.setModel(this.oChangeDetails,"flexChangeDetails")}.bind(this))}.bind(this);e();t()};h.prototype.onRefresh=function(){i.getStub().sendEvent(this.getId()+"GetApps",{})};h.prototype.onsapUiSupportFlexibilityGetApps=function(){var t=[];if(o._instanceCache){e(o._instanceCache,function(e,i){t.push({key:e,text:e,additionalText:this.getAppVariantHierarchy(e),data:r.extractData(i)})}.bind(this))}this._oStub.sendEvent(this.getId()+"SetApps",t)};h.prototype.getAppVariantHierarchy=function(e){var t=l.registry.all();var i=[];Object.values(t).find(function(t){var n=t.getMetadata().getManifestEntry("/sap.app/id");var a=t.getMetadata().getManifestEntry("sap.ui5");if(n===e){a.appVariantIdHierarchy.forEach(function(e){i.push(e.appVariantId+" ("+e.version+")"+(e.layer?" in layer "+e.layer:""))});return true}});return i.length?"App variant based on:\n"+i.join("\n"):""};h.prototype.onsapUiSupportFlexibilityGetChangesMaps=function(e){var t=e.mParameters.appKey;var i=t.split(this.sDelimiter);var n=i[0];this._getChangesMapForApp(n)};h.prototype.onsapUiSupportFlexibilitySetApps=function(e){var t=e.getParameters();this.oAppModel.setData(t)};h.prototype.onsapUiSupportFlexibilitySetChangesMaps=function(e){var t=e.getParameters();this.oChangesModel.setData(t);this.oView.byId("Tree").expandToLevel(1e3)};h.prototype.exit=function(){t.prototype.exit.apply(this,arguments)};h.prototype._getChangesMapForApp=function(e){function t(e,t){g[t]=[];var n=f[t];var a=sap.ui.getCore().byId(t);var o=[];var p=[];var r=[];if(a){if(a.data(s.appliedChangesCustomDataKey)){o=a.data(s.appliedChangesCustomDataKey).split(",")}if(a.data(s.failedChangesCustomDataKeyJs)){p=a.data(s.failedChangesCustomDataKeyJs).split(",")}if(a.data(s.failedChangesCustomDataKeyXml)){r=a.data(s.failedChangesCustomDataKeyXml).split(",")}}g[t]=n.map(i.bind(this,a,o,p,r,e))}function i(t,i,a,s,o,p){var d={id:p.getId(),changeType:p.getChangeType(),selector:p.getSelector(),controlPresent:!!t,indexInAppliedChanges:undefined,indexOfFirstFailing:undefined,dependentControls:[],dependentChanges:[],someDirectDependingChangesFailed:false,someDirectDependingChangesNotApplied:false,isInSubTree:false};var l=a.concat(s);if(d.controlPresent&&i.indexOf(p.getId())>-1){d.indexInAppliedChanges=i.indexOf(p.getId())}if(d.controlPresent&&a.indexOf(p.getId())>-1){d.modifier="JS";d.indexOfFirstFailing=l.indexOf(p.getId())}if(d.controlPresent&&s.indexOf(p.getId())>-1){d.modifier="XML";d.indexOfFirstFailing=l.indexOf(p.getId())}if(p._aDependentSelectorList){var h=r.getAppComponentInstance(e);d.dependentControls=p._aDependentSelectorList.map(function(e){return{id:e.id,controlPresent:n.bySelector(e,h)}})}o[p.getId()]=d;return d}function a(e,t,i){var n=i.dependencies;if(n.indexOf(e.id)!==-1){var a=JSON.stringify(h[t].selector)===JSON.stringify(e.selector);e.isInSubTree=e.isInSubTree||a}}function p(e,t){t.forEach(function(e){jQuery.each(C,a.bind(this,e));e.allDependendingControlsPresent=e.dependentControls.every(function(e){return e.controlPresent});if(C[e.id]&&C[e.id].dependencies){C[e.id].dependencies.forEach(function(t){var i=h[t];var n=i.indexInAppliedChanges===undefined;i=h[t];e.someDirectDependingChangesNotApplied=e.someDirectDependingChangesNotApplied||n;var a=i.indexOfFirstFailing===undefined;var s=a&&n;e.someDirectDependingChangesFailed=e.someDirectDependingChangesFailed||a;e.someDirectDependingChangesNotSuccessfulApplied=e.someDirectDependingChangesNotSuccessfulApplied||s;e.dependentChanges.push(i)})}e.isApplicable=!e.someDirectDependingChangesNotApplied&&e.controlPresent&&e.allDependendingControlsPresent&&!e.someDirectDependingChangesNotApplied;e.isPossibleRootCause=e.isApplicable&&e.indexInAppliedChanges===undefined})}function d(e){e=e.filter(function(t){return!e.some(function(e){return e.dependentChanges.some(function(e){return e.id===t.id})})});return e.map(function(e){return{id:e.id,text:e.changeType,nodes:e.dependentChanges?d(e.dependentChanges):[]}})}function l(e,t){c.push({text:e,nodes:d(t)})}var h={};var g={};var c=[];var u=o.getChangePersistenceForComponent(e);var f=u._mChanges.mChanges;var C=u._mChangesInitial.mDependencies;Object.keys(f).forEach(t.bind(this,h));jQuery.each(g,p);jQuery.each(g,l);this._oStub.sendEvent(this.getId()+"SetChangesMaps",{changes:h,tree:c})};return h});