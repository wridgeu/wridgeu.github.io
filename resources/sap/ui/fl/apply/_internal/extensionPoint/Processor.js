/*!
* OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
*/
sap.ui.define(["sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/changes/ExtensionPointState","sap/ui/fl/Utils","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/base/SyncPromise","sap/base/util/merge"],function(n,e,t,i,o,r,a){"use strict";var s;function u(n,e,t,i,o){return o(n,true).then(function(o){o.forEach(function(n,o){e.splice(t+o+i,0,n)});n.index+=i;return o.length-1})}function f(n,e,t){var i=[];var o=[];var a=0;var s;t.forEach(function(t,r){if(t._isExtensionPoint){t.targetControl=n.targetControl;t.aggregationName=n.aggregationName;t.fragmentId=n.fragmentId;t.index=r;if(s){s._nextSibling=t}s=t;t.referencedExtensionPoint=n;i.push(function(){return u(t,o,r,a,e).then(function(n){a+=n})})}else{o.push(t)}});if(i.length>0){return i.reduce(function(n,e){return n.then(e)},r.resolve()).then(function(){return o})}return r.resolve(o)}function l(n,r){var u=i.getAppComponentForControl(n.targetControl);var f={};var g=a({defaultContent:[]},n);f.appComponent=u;f.modifier=o;f.viewId=n.view.getId();f.componentId=u.getId();return s.registerExtensionPoint(g).then(e.initialize.bind(e,f)).then(t.enhanceExtensionPointChanges.bind(t,f,n)).then(s.createDefaultContent.bind(this,n,r,l)).then(s.addDefaultContentToExtensionPointInfo.bind(this,g,r))}s={oExtensionPointRegistry:undefined,oRegistryPromise:Promise.resolve(),registerExtensionPoint:function(n){if(sap.ui.getCore().getConfiguration().getDesignMode()){if(s.oExtensionPointRegistry){s.oExtensionPointRegistry.registerExtensionPoint(n);return r.resolve()}s.oRegistryPromise=s.oRegistryPromise.then(function(){return new Promise(function(e,t){sap.ui.require(["sap/ui/fl/write/_internal/extensionPoint/Registry"],function(t){s.oExtensionPointRegistry=t;t.registerExtensionPoint(n);e()},function(n){t(n)})})});return s.oRegistryPromise}return r.resolve()},createDefaultContent:function(n,e,t,i){if(i.length===0){return n.createDefault().then(f.bind(undefined,n,t)).then(function(t){if(!e){t.forEach(function(e,t){o.insertAggregation(n.targetControl,n.aggregationName,e,n.index+t,n.view)});n.ready(t)}return t})}return r.resolve([])},addDefaultContentToExtensionPointInfo:function(n,e,t){if(!e){n.defaultContent=n.defaultContent.concat(t)}return t},applyExtensionPoint:function(e){var t=l(e,false);n.addPreConditionForInitialChangeApplying(t);return t}};return s});