/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Component","sap/ui/fl/Utils","sap/base/Log","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/ui/base/ManagedObjectObserver","sap/ui/thirdparty/hasher","sap/base/util/includes","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState"],function(e,a,r,t,n,o,i,s,l,c,m){"use strict";var d={};var p={};function u(e,a){var r=[];return e.reduce(function(e,t){var n=a.getVariantManagementReference(t).variantManagementReference;if(n){if(l(r,n)){e.updateRequired=true;return e}r.push(n)}if(n&&a.oData[n].currentVariant!==t){e.updateRequired=true;if(a.oData[n].currentVariant!==a.oData[n].defaultVariant){e.parameters.push(a.oData[n].currentVariant)}}else{e.parameters.push(t)}return e},{updateRequired:false,parameters:[]})}function f(e,a){var r=n.get(["params",c.VARIANT_TECHNICAL_PARAMETER],e);if(r){var t=u(r,a);if(t.updateRequired){p.update({updateURL:!a._bDesignTimeMode,parameters:t.parameters,updateHashEntry:true,model:a})}}}function v(e,a){try{var t=e.getUShellService("URLParsing");if(t){var n=t.parseShellHash(a);f(n,e)}}catch(e){r.error(e.message)}var o=e.getUShellService("ShellNavigation");return o&&o.NavigationFilterStatus.Continue}function h(e){var a=e.getUShellService("ShellNavigation");if(!d[e.sFlexReference]){d[e.sFlexReference]=v.bind(null,e);if(a){a.registerNavigationFilter(d[e.sFlexReference])}}}function R(e){var a=e.getUShellService("ShellNavigation");if(a){a.unregisterNavigationFilter(d[e.sFlexReference]);delete d[e.sFlexReference]}}function A(e){var t=e.model;var n=t.getUShellService("URLParsing");var o=t.getUShellService("CrossApplicationNavigation");var i=n&&n.parseShellHash(s.getHash());if(i&&i.params){var l=a.getTechnicalParametersForComponent(t.oAppComponent);if(!l){r.warning("Component instance not provided, so technical parameters in component data and browser history remain unchanged")}if(e.parameters.length===0){delete i.params[c.VARIANT_TECHNICAL_PARAMETER];l&&delete l[c.VARIANT_TECHNICAL_PARAMETER]}else{i.params[c.VARIANT_TECHNICAL_PARAMETER]=e.parameters;l&&(l[c.VARIANT_TECHNICAL_PARAMETER]=e.parameters)}if(e.silent){s.changed.active=false;s.replaceHash(n.constructShellHash(i));s.changed.active=true}else{o.toExternal({target:{semanticObject:i.semanticObject,action:i.action,context:i.contextRaw},params:i.params,appSpecificRoute:i.appSpecificRoute,writeHistory:false})}}}function g(e){var a={index:-1};var r=e.model;var n=r.getUShellService("URLParsing");var o=n&&n.parseShellHash(s.getHash()).params;if(o){a.parameters=[];if(r._bDesignTimeMode){o[c.VARIANT_TECHNICAL_PARAMETER]=p.getStoredHashParams(e)}if(Array.isArray(o[c.VARIANT_TECHNICAL_PARAMETER])){o[c.VARIANT_TECHNICAL_PARAMETER]=o[c.VARIANT_TECHNICAL_PARAMETER].map(decodeURIComponent);o[c.VARIANT_TECHNICAL_PARAMETER].some(function(t,n){var o=m.getVariant({vmReference:e.vmReference,vReference:t,reference:r.oChangePersistence.getComponentName()});if(o){a.index=n;return true}})}}return t(a,o&&o[c.VARIANT_TECHNICAL_PARAMETER]&&{parameters:o[c.VARIANT_TECHNICAL_PARAMETER]})}p.variantTechnicalParameterName="sap-ui-fl-control-variant-id";p.initialize=function(e){var a=e.model;var r=a.getUShellService("URLParsing");var t=r&&r.parseShellHash(s.getHash());var n=t&&t.params&&t.params[c.VARIANT_TECHNICAL_PARAMETER];p.attachHandlers(e);p.update({model:a,parameters:n,updateHashEntry:Array.isArray(n)&&n.length>0});f(t,a)};p.updateVariantInURL=function(e){var a=p.removeURLParameterForVariantManagement(e);if(!a.parameters){return}var r=a.parameters||[];var t=a.index;var n=e.newVReference===e.model.oData[e.vmReference].defaultVariant;if(!n){if(t===-1){r=r.concat([e.newVReference])}else{r=r.slice(0,t).concat([e.newVReference],r.slice(t))}}if(!n||t>-1){p.update({parameters:r,updateURL:!e.model._bDesignTimeMode,updateHashEntry:true,model:e.model})}};p.removeURLParameterForVariantManagement=function(e){var a=g(e);if(a.index>-1){a.parameters.splice(a.index,1)}return a};p.attachHandlers=function(a){function r(){return a.model._oVariantSwitchPromise.then(function(){a.model._oHashData.controlPropertyObservers.forEach(function(e){e.destroy()});R(a.model);a.model.resetMap(true).then(a.model.destroy.bind(a.model));a.model.oComponentDestroyObserver.unobserve(a.model.oAppComponent,{destroy:true});a.model.oComponentDestroyObserver.destroy()})}h(a.model);if(!a.model.oComponentDestroyObserver&&a.model.oAppComponent instanceof e){a.model.oComponentDestroyObserver=new i(r.bind(null));a.model.oComponentDestroyObserver.observe(a.model.oAppComponent,{destroy:true})}};p.registerControl=function(e){if(e.updateURL){e.model._oHashData.variantControlIds.push(e.vmReference)}};p.update=function(e){if(!e.model._oHashData){e.model._oHashData={hashParams:[],controlPropertyObservers:[],variantControlIds:[]}}if(!e||!Array.isArray(e.parameters)){r.info("Variant URL parameters could not be updated since invalid parameters were received");return}if(e.updateURL){A(e)}if(e.updateHashEntry&&!o(e.model)){e.model._oHashData.hashParams=e.parameters}};p.getStoredHashParams=function(e){return Array.prototype.slice.call(e.model._oHashData.hashParams)};p.handleModelContextChange=function(e){var a="modelContextChange";function r(a,r){var t=r.model.getVariantManagementReferenceForControl(a.getSource());var n=r.model._oHashData.variantControlIds;var o=n.indexOf(t);if(o>-1){n.slice(o).forEach(function(a){if(g({vmReference:a,model:e.model}).index===-1){r.model.switchToDefaultForVariantManagement(a)}})}}var t=new i(function(t){if(t.current===true&&t.old===false){t.object.attachEvent(a,{model:e.model},r)}else if(t.current===false&&t.old===true){t.object.detachEvent(a,r)}});t.observe(e.vmControl,{properties:["resetOnContextChange"]});e.model._oHashData.controlPropertyObservers.push(t);if(e.vmControl.getResetOnContextChange()!==false){e.vmControl.attachEvent(a,{model:e.model},r)}};p.clearAllVariantURLParameters=function(e){p.update({updateURL:true,parameters:[],updateHashEntry:false,model:e.model})};return p});