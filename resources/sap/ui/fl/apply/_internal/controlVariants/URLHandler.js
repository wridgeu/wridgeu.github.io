/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Component","sap/ui/fl/Utils","sap/base/Log","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/ui/base/ManagedObjectObserver","sap/ui/thirdparty/hasher","sap/base/util/includes","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState"],function(e,a,t,r,n,o,i,s,l,m,d){"use strict";var c={};function p(e,a){var t=[];return e.reduce(function(e,r){var n=a.getVariantManagementReference(r).variantManagementReference;if(n){if(l(t,n)){e.updateRequired=true;return e}t.push(n)}if(n&&a.oData[n].currentVariant!==r){e.updateRequired=true;if(a.oData[n].currentVariant!==a.oData[n].defaultVariant){e.parameters.push(a.oData[n].currentVariant)}}else{e.parameters.push(r)}return e},{updateRequired:false,parameters:[]})}function u(e,a){var t=n.get(["params",m.VARIANT_TECHNICAL_PARAMETER],e);if(t){var r=p(t,a);if(r.updateRequired){C.update({updateURL:!a._bDesignTimeMode,parameters:r.parameters,updateHashEntry:true,model:a})}}}function f(e,a,r){try{var n=a[1].parseShellHash(r);u(n,e)}catch(e){t.error(e.message)}return a[0].NavigationFilterStatus.Continue}function R(e){a.ifUShellContainerThen(function(a){if(!c[e.sFlexReference]){c[e.sFlexReference]=f.bind(null,e,a);a[0].registerNavigationFilter(c[e.sFlexReference])}},["ShellNavigation","URLParsing"])}function A(e){a.ifUShellContainerThen(function(a){if(c[e.sFlexReference]){a[0].unregisterNavigationFilter(c[e.sFlexReference]);delete c[e.sFlexReference]}},["ShellNavigation"])}function h(e){var r=a.getParsedURLHash(m.VARIANT_TECHNICAL_PARAMETER);if(r.params){var n=a.getTechnicalParametersForComponent(e.model.oAppComponent);if(!n){t.warning("Component instance not provided, so technical parameters in component data and browser history remain unchanged")}if(e.parameters.length===0){delete r.params[m.VARIANT_TECHNICAL_PARAMETER];n&&delete n[m.VARIANT_TECHNICAL_PARAMETER]}else{r.params[m.VARIANT_TECHNICAL_PARAMETER]=e.parameters;n&&(n[m.VARIANT_TECHNICAL_PARAMETER]=e.parameters)}var o=a.getUshellContainer();if(e.silent){s.changed.active=false;s.replaceHash(o.getService("URLParsing").constructShellHash(r));s.changed.active=true}else{var i=o.getService("CrossApplicationNavigation");i.toExternal({target:{semanticObject:r.semanticObject,action:r.action,context:r.contextRaw},params:r.params,appSpecificRoute:r.appSpecificRoute,writeHistory:false})}}}function v(e){var t={index:-1};var n=a.getParsedURLHash().params;if(n){t.parameters=[];if(e.model._bDesignTimeMode){n[m.VARIANT_TECHNICAL_PARAMETER]=C.getStoredHashParams(e)}if(Array.isArray(n[m.VARIANT_TECHNICAL_PARAMETER])){n[m.VARIANT_TECHNICAL_PARAMETER]=n[m.VARIANT_TECHNICAL_PARAMETER].map(decodeURIComponent);n[m.VARIANT_TECHNICAL_PARAMETER].some(function(a,r){var n=d.getVariant({vmReference:e.vmReference,vReference:a,reference:e.model.oChangePersistence.getComponentName()});if(n){t.index=r;return true}})}}return r(t,n&&n[m.VARIANT_TECHNICAL_PARAMETER]&&{parameters:n[m.VARIANT_TECHNICAL_PARAMETER]})}var C={variantTechnicalParameterName:"sap-ui-fl-control-variant-id",initialize:function(e){var t=a.getParsedURLHash();var r=t.params&&t.params[m.VARIANT_TECHNICAL_PARAMETER];C.attachHandlers(e);C.update({model:e.model,parameters:r,updateHashEntry:Array.isArray(r)&&r.length>0});u(t,e.model)},updateVariantInURL:function(e){var a=C.removeURLParameterForVariantManagement(e);if(!a.parameters){return}var t=a.parameters||[];var r=a.index;var n=e.newVReference===e.model.oData[e.vmReference].defaultVariant;if(!n){if(r===-1){t=t.concat([e.newVReference])}else{t=t.slice(0,r).concat([e.newVReference],t.slice(r))}}if(!n||r>-1){C.update({parameters:t,updateURL:!e.model._bDesignTimeMode,updateHashEntry:true,model:e.model})}},removeURLParameterForVariantManagement:function(e){var a=v(e);if(a.index>-1){a.parameters.splice(a.index,1)}return a},attachHandlers:function(a){function t(){return a.model._oVariantSwitchPromise.then(function(){a.model._oHashData.controlPropertyObservers.forEach(function(e){e.destroy()});A(a.model);a.model.resetMap(true).then(a.model.destroy.bind(a.model));a.model.oComponentDestroyObserver.unobserve(a.model.oAppComponent,{destroy:true});a.model.oComponentDestroyObserver.destroy()})}R(a.model);if(!a.model.oComponentDestroyObserver&&a.model.oAppComponent instanceof e){a.model.oComponentDestroyObserver=new i(t.bind(null));a.model.oComponentDestroyObserver.observe(a.model.oAppComponent,{destroy:true})}},registerControl:function(e){if(e.updateURL){e.model._oHashData.variantControlIds.push(e.vmReference)}},update:function(e){if(!e.model._oHashData){e.model._oHashData={hashParams:[],controlPropertyObservers:[],variantControlIds:[]}}if(!e||!Array.isArray(e.parameters)){t.info("Variant URL parameters could not be updated since invalid parameters were received");return}if(e.updateURL){h(e)}if(e.updateHashEntry&&!o(e.model)){e.model._oHashData.hashParams=e.parameters}},getStoredHashParams:function(e){return Array.prototype.slice.call(e.model._oHashData.hashParams)},handleModelContextChange:function(e){var a="modelContextChange";function t(a,t){var r=t.model.getVariantManagementReferenceForControl(a.getSource());var n=t.model._oHashData.variantControlIds;var o=n.indexOf(r);if(o>-1){n.slice(o).forEach(function(a){if(v({vmReference:a,model:e.model}).index===-1){t.model.switchToDefaultForVariantManagement(a)}})}}var r=new i(function(r){if(r.current===true&&r.old===false){r.object.attachEvent(a,{model:e.model},t)}else if(r.current===false&&r.old===true){r.object.detachEvent(a,t)}});r.observe(e.vmControl,{properties:["resetOnContextChange"]});e.model._oHashData.controlPropertyObservers.push(r);if(e.vmControl.getResetOnContextChange()!==false){e.vmControl.attachEvent(a,{model:e.model},t)}},clearAllVariantURLParameters:function(e){C.update({updateURL:true,parameters:[],updateHashEntry:false,model:e.model})}};return C});