/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/ChangePersistenceFactory","sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/Log"],function(e,n,t,i,o){"use strict";var r={};function a(e,n,t){if(t.getSelector().name!==n.extensionPointName){return false}return e.changesHavingCorrectViewPrefix(n,t)}function s(e,n){if(n.fragmentId){var t=e.getExtensionPointInfo&&e.getExtensionPointInfo();if(t){return n.fragmentId!==t.fragmentId}return true}return false}function g(e,n,t){var o=e.getSelector();if(n.closestAggregationBindingCarrier&&n.closestAggregationBinding){o=i(o,{id:n.closestAggregationBindingCarrier,idIsLocal:false});var r=e.getDefinition();var a={id:n.targetControl.getId(),idIsLocal:false};if(!r.dependentSelector){r.dependentSelector={}}if(t){e.originalSelectorToBeAdjusted=a}else{r.dependentSelector.originalSelector=a}r.content.boundAggregation=n.closestAggregationBinding}else{o=i(o,{id:n.targetControl.getId(),idIsLocal:false})}e.setSelector(o)}r.getChangesForExtensionPoint=function(e,n){if(!n.extensionPointName){o.error("Missing name from extension point info!");return Promise.resolve([])}return e.getChangesForComponent().then(function(t){return t.filter(a.bind(this,e,n))})};r.enhanceExtensionPointChanges=function(i,o){i.extensionPointName=o.name;var a=n.getChangePersistenceForControl(o.targetControl);return r.getChangesForExtensionPoint(a,i).then(function(n){var r=[];n.forEach(function(n){if(n.isInInitialState()&&!(n.getExtensionPointInfo&&n.getExtensionPointInfo())){n.setExtensionPointInfo(o);g(n,o,false);if(a.isChangeMapCreated()){a.addChangeAndUpdateDependencies(i.appComponent,n)}}else if(s(n,o)){var c=n.getDefinition();var f=t(c,["dependentSelector","fileName","selector","content"]);Object.keys(c.content).forEach(function(e){f[e]=c.content[e]});f.support.sourceChangeFileName=c.fileName||"";r.push(e.create({changeSpecificData:f,selector:{view:o.view,name:o.name}}).then(function(e){g(e,o,true);e.setExtensionPointInfo(o);e.setModuleName(c.moduleName);e.getDefinition().creation=c.creation;a.addChangeAndUpdateDependencies(i.appComponent,e,n)}))}});return Promise.all(r).then(function(){return n})})};return r});