/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/Log","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/ChangePersistenceFactory"],function(e,n,t,i,o,r){"use strict";var a={};function s(e,n){if(n.getSelector().name!==e.extensionPointName){return false}return i.filterChangeByView(e,n)}function g(e,n){if(n.fragmentId){var t=e.getExtensionPointInfo&&e.getExtensionPointInfo();if(t){return n.fragmentId!==t.fragmentId}return true}return false}function f(e,t,i){var o=e.getSelector();if(t.closestAggregationBindingCarrier&&t.closestAggregationBinding){o=n(o,{id:t.closestAggregationBindingCarrier,idIsLocal:false});var r=e.getDefinition();var a={id:t.targetControl.getId(),idIsLocal:false};if(!r.dependentSelector){r.dependentSelector={}}if(i){e.originalSelectorToBeAdjusted=a}else{r.dependentSelector.originalSelector=a}r.content.boundAggregation=t.closestAggregationBinding}else{o=n(o,{id:t.targetControl.getId(),idIsLocal:false})}e.setSelector(o)}a.getChangesForExtensionPoint=function(e,n){if(!n.extensionPointName){t.error("Missing name from extension point info!");return Promise.resolve([])}return e.getChangesForComponent().then(function(e){return e.filter(s.bind(undefined,n))})};a.enhanceExtensionPointChanges=function(n,t){n.extensionPointName=t.name;var i=r.getChangePersistenceForControl(t.targetControl);return a.getChangesForExtensionPoint(i,n).then(function(r){var a=[];r.forEach(function(r){if(r.isInInitialState()&&!(r.getExtensionPointInfo&&r.getExtensionPointInfo())){r.setExtensionPointInfo(t);f(r,t,false);if(i.isChangeMapCreated()){i.addChangeAndUpdateDependencies(n.appComponent,r)}}else if(g(r,t)){var s=r.getDefinition();var c=e(s,["dependentSelector","fileName","selector","content"]);Object.keys(s.content).forEach(function(e){c[e]=s.content[e]});c.support.sourceChangeFileName=s.fileName||"";a.push(o.create({changeSpecificData:c,selector:{view:t.view,name:t.name}}).then(function(e){f(e,t,true);e.setExtensionPointInfo(t);e.setModuleName(s.moduleName);e.getDefinition().creation=s.creation;i.addChangeAndUpdateDependencies(n.appComponent,e,r)}))}});return Promise.all(a).then(function(){return r})})};return a});