/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/deepClone","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/Storage","sap/ui/fl/Utils"],function(e,n,t,a){"use strict";function i(e){if(typeof e==="string"){e={id:e}}e.idIsLocal=true;return e}function r(n,t){if(n){[t.changes,t.variantChanges,t.variantDependentControlChanges,t.variantManagementChanges].forEach(function(n){for(var t=n.length-1;t>=0;t--){var a=n[t];if(!a.selector.idIsLocal){var r=e(a);r.fileName=r.fileName+"_localIdClone";r.selector=i(r.selector);if(r.dependentSelector){Object.keys(r.dependentSelector).forEach(function(e,n){e.dependentSelector[n]=e.dependentSelector[n].map(i)}.bind(undefined,r))}n.splice(t,0,r)}}})}return t}function o(e){return e&&!!n.getOvpEntry(e)}function l(e){return{changes:e,cacheKey:e.cacheKey}}return{loadFlexData:function(e){var i=n.getBaseComponentNameFromManifest(e.manifest);if(e.partialFlexData){return t.completeFlexData({reference:e.reference,componentName:i,partialFlexData:e.partialFlexData}).then(l)}var c=e.reInitialize?undefined:n.getCacheKeyFromAsyncHints(e.reference,e.asyncHints);return t.loadFlexData({reference:e.reference,componentName:i,cacheKey:c,siteId:a.getSiteIdByComponentData(e.componentData),appDescriptor:e.manifest.getRawJson?e.manifest.getRawJson():e.manifest,version:e.version,allContexts:e.allContexts}).then(r.bind(undefined,o(e.manifest))).then(l)}}});