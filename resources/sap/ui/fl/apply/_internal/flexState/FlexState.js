/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexState/appDescriptorChanges/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/changes/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/compVariants/prepareCompVariantsMap","sap/ui/fl/apply/_internal/flexState/controlVariants/prepareVariantsMap","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,n,t,a,r,i,o,s,p,c,l,f,u,g,d){"use strict";var m={};var h={};var v={};var S={};var R;var F;var I={appDescriptorChanges:{prepareFunction:o,pathInResponse:[]},changes:{prepareFunction:s,pathInResponse:["changes"]},variants:{prepareFunction:c,pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},compVariants:{prepareFunction:p,pathInResponse:["comp.variants","comp.standardVariants","comp.defaultVariants","comp.changes"]}};var D={compVariants:{},variants:{}};function x(e){var n=i.get(e.componentId);h[e.reference].componentData=n?n.getComponentData():e.componentData}function C(e){var n=i.get(e.componentId);e.componentData=e.componentData||n.getComponentData()||{};e.manifest=e.manifest||e.rawManifest||n.getManifestObject();e.reference=e.reference||f.getFlexReference(e)}function V(e,n){if(!h[e]){throw new Error("State is not yet initialized")}if(!h[e].preparedMaps[n]){var t={unfilteredStorageResponse:h[e].unfilteredStorageResponse,storageResponse:h[e].storageResponse,componentId:h[e].componentId,componentData:h[e].componentData};h[e].preparedMaps[n]=m.callPrepareFunction(n,t)}return h[e].preparedMaps[n]}function y(e){return V(e,"appDescriptorChanges")}function M(e){return V(e,"changes")}function U(e){return V(e,"variants")}function b(e){return V(e,"compVariants")}function L(e){if(e.reference.endsWith(".Component")){var n=e.reference.split(".");n.pop();var a=n.join(".");h[a]=t({},{storageResponse:{changes:u.getEmptyFlexDataResponse()},unfilteredStorageResponse:{changes:u.getEmptyFlexDataResponse()},preparedMaps:{},componentId:e.componentId,partialFlexState:e.partialFlexState});S[a]=S[e.reference]}}function P(e){var r=t({},e);var i=r.changes;var o=A("URLParsing");if(g.isLayerFilteringRequired(o)){n(I,function(e,n){n.pathInResponse.forEach(function(e){a.set(e,g.filterChangeDefinitionsByMaxLayer(a.get(e,i),o),i)})})}return r}function z(e){S[e.reference]=l.loadFlexData(e).then(function(n){h[e.reference]=t({},{unfilteredStorageResponse:n,preparedMaps:{},componentId:e.componentId,componentData:e.componentData,partialFlexState:e.partialFlexState});L(e);N(e.reference);return n});return S[e.reference]}function N(e){var n=A("ShellNavigation");if(n){v[e]=j.bind(null,e);n.registerNavigationFilter(v[e])}}function _(e){var n=A("ShellNavigation");if(n){if(v[e]){n.unregisterNavigationFilter(v[e]);delete v[e]}}}function j(e,n,t){var a=A("ShellNavigation");if(a){try{var i=g.getMaxLayerTechnicalParameter(n,A("URLParsing"));var o=g.getMaxLayerTechnicalParameter(t,A("URLParsing"));if(i!==o){m.clearFilteredResponse(e)}}catch(e){r.error(e.message)}return a.NavigationFilterStatus.Continue}return undefined}function E(e){h[e].preparedMaps={}}function O(e){var n=h[e.reference];if(n.partialFlexState===true&&e.partialFlexState!==true){n.partialFlexState=false;e.partialFlexData=t({},n.unfilteredStorageResponse.changes);e.reInitialize=true}return e}function k(e){var n=h[e.reference].componentId;if(!e.reInitialize&&n!==e.componentId){e.reInitialize=true}return e}function w(){return Promise.all([d.getUShellService("ShellNavigation"),d.getUShellService("URLParsing")]).then(function(e){R=e[0];F=e[1]}).catch(function(e){r.error("Error getting service from Unified Shell: "+e.message)})}function A(e){if(d.getUshellContainer()){if(e==="ShellNavigation"){return R}else if(e==="URLParsing"){return F}}return undefined}m.initialize=function(e){return w().then(function(){C(e);var n=e.reference;if(S[n]){return S[n].then(O.bind(null,e)).then(k).then(function(e){return e.reInitialize?z(e):h[n].unfilteredStorageResponse})}return z(e)}).then(function(e,n){if(!h[e.reference].storageResponse){h[e.reference].storageResponse=P(n);x(e)}}.bind(null,e))};m.clearAndInitialize=function(e){C(e);m.clearState(e.reference);m.clearState(d.normalizeReference(e.reference));return m.initialize(e)};m.clearState=function(e){if(e){_(e);delete h[e];delete S[e]}else{Object.keys(h).forEach(function(e){_(e)});h={};S={}}};m.setInitialNonFlCompVariantData=function(e,n,t,a){D.compVariants[e]={};D.compVariants[e][n]={};D.compVariants[e][n].standardVariant=t;D.compVariants[e][n].variants=a};m.getInitialNonFlCompVariantData=function(e){return D.compVariants[e]};m.setFakeStandardVariant=function(e,n,a){var r=m.getVariantsState(e);if(!r[Object.keys(a)[0]]){t(r,a);D.variants[e]=D.variants[e]||{};D.variants[e][n]=D.variants[e][n]||{};t(D.variants[e][n],a)}};m.resetFakedStandardVariants=function(e,n){if(D.variants[e]){delete D.variants[e][n]}};m.clearFilteredResponse=function(e,n){if(h[e]&&(!n||n===h[e].componentId)){E(e);delete h[e].storageResponse}};m.getUIChanges=function(e){return M(e).changes};m.getAppDescriptorChanges=function(e){return y(e).appDescriptorChanges};m.getVariantsState=function(e){var t=U(e);if(D.variants[e]){n(D.variants[e],function(a,r){if(h[e].componentId===a){n(r,function(e,n){if(!t[e]){t[e]=n}})}})}return t};m.getUI2Personalization=function(e){return h[e].unfilteredStorageResponse.changes.ui2personalization};m.getCompVariantsMap=function(e){return b(e)};m.callPrepareFunction=function(e,n){return I[e].prepareFunction(n)};m.getStorageResponse=function(e){if(S[e]){return S[e].then(function(){return h[e].unfilteredStorageResponse})}};m.getFlexObjectsFromStorageResponse=function(e){return h[e]&&h[e].unfilteredStorageResponse.changes};return m});