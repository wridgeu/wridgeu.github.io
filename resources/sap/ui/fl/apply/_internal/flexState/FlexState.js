/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexState/appDescriptorChanges/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/changes/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/compVariants/prepareCompVariantsMap","sap/ui/fl/apply/_internal/flexState/controlVariants/prepareVariantsMap","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,n,t,a,r,i,o,s,p,c,l,f,u,g,d){"use strict";var h={};var m={};var v={};var S={};var R;var F;var C;var D={appDescriptorChanges:{prepareFunction:o,pathInResponse:[]},changes:{prepareFunction:s,pathInResponse:["changes"]},variants:{prepareFunction:c,pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},compVariants:{prepareFunction:p,pathInResponse:["comp.variants","comp.standardVariants","comp.defaultVariants","comp.changes"]}};var I={compVariants:{},variants:{}};function x(e){var n=i.get(e.componentId);e.componentData=e.componentData||n.getComponentData()||{};e.manifest=e.manifest||e.rawManifest||n.getManifestObject();e.reference=e.reference||f.getFlexReference(e)}function y(e,n){if(!m[e]){throw new Error("State is not yet initialized")}if(!m[e].preparedMaps[n]){if(!m[e].storageResponse){m[e].storageResponse=L(m[e].unfilteredStorageResponse)}var t={unfilteredStorageResponse:m[e].unfilteredStorageResponse,storageResponse:m[e].storageResponse,componentId:m[e].componentId,componentData:m[e].componentData};m[e].preparedMaps[n]=h.callPrepareFunction(n,t)}return m[e].preparedMaps[n]}function V(e){return y(e,"appDescriptorChanges")}function M(e){return y(e,"changes")}function P(e){return y(e,"variants")}function U(e){return y(e,"compVariants")}function b(e){if(e.reference.endsWith(".Component")){var n=e.reference.split(".");n.pop();var a=n.join(".");m[a]=t({},{storageResponse:{changes:u.getEmptyFlexDataResponse()},unfilteredStorageResponse:{changes:u.getEmptyFlexDataResponse()},preparedMaps:{},componentId:e.componentId,partialFlexState:e.partialFlexState});S[a]=S[e.reference]}}function L(e){var r=t({},e);var i=r.changes;var o=w("URLParsing");if(g.isLayerFilteringRequired(o)){n(D,function(e,n){n.pathInResponse.forEach(function(e){a.set(e,g.filterChangeDefinitionsByMaxLayer(a.get(e,i),o),i)})})}return r}function z(e){S[e.reference]=l.loadFlexData(e).then(function(n){m[e.reference]=t({},{unfilteredStorageResponse:n,preparedMaps:{},componentId:e.componentId,componentData:e.componentData,partialFlexState:e.partialFlexState});b(e);N(e.reference);return n});return S[e.reference]}function N(e){var n=w("ShellNavigation");if(n&&!v[e]){v[e]=E.bind(null,e);n.registerNavigationFilter(v[e])}}function _(e){var n=w("ShellNavigation");if(n){if(v[e]){n.unregisterNavigationFilter(v[e]);delete v[e]}}}function E(e,n,t){var a=w("ShellNavigation");if(a){try{var i=g.getMaxLayerTechnicalParameter(n,w("URLParsing"));var o=g.getMaxLayerTechnicalParameter(t,w("URLParsing"));if(i!==o){h.clearFilteredResponse(e)}}catch(e){r.error(e.message)}return a.NavigationFilterStatus.Continue}return undefined}function j(e){var n=m[e.reference];if(n.partialFlexState===true&&e.partialFlexState!==true){n.partialFlexState=false;e.partialFlexData=t({},n.unfilteredStorageResponse.changes);e.reInitialize=true}return e}function O(e){var n=m[e.reference].componentId;if(!e.reInitialize&&n!==e.componentId){e.reInitialize=true}return e}function k(){return Promise.all([d.getUShellService("ShellNavigation"),d.getUShellService("URLParsing")]).then(function(e){R=e[0];F=e[1]}).catch(function(e){r.error("Error getting service from Unified Shell: "+e.message)})}function w(e){if(d.getUshellContainer()){if(e==="ShellNavigation"){return R}else if(e==="URLParsing"){return F}}return undefined}function A(){return Promise.all([d.requireAsync("sap/ui/fl/ChangePersistenceFactory")]).then(function(e){C=e[0]}).catch(function(e){r.error("Error loading modules: "+e.message)})}h.initialize=function(e){return Promise.all([k(),A()]).then(function(){x(e);var n=e.reference;if(S[n]){return S[n].then(j.bind(null,e)).then(O).then(function(e){return e.reInitialize?z(e):m[n].unfilteredStorageResponse})}return z(e)}).then(function(e){if(!m[e.reference].componentData){var n=i.get(e.componentId);m[e.reference].componentData=n?n.getComponentData():e.componentData}}.bind(null,e))};h.clearAndInitialize=function(e){x(e);h.clearState(e.reference);h.clearState(d.normalizeReference(e.reference));return h.initialize(e)};h.clearState=function(e){if(e){_(e);delete m[e];delete S[e];if(C&&(C._instanceCache||{}).hasOwnProperty(e)){C._instanceCache[e].removeDirtyChanges()}}else{Object.keys(m).forEach(function(e){_(e)});m={};S={}}};h.setInitialNonFlCompVariantData=function(e,n,t,a){I.compVariants[e]={};I.compVariants[e][n]={};I.compVariants[e][n].standardVariant=t;I.compVariants[e][n].variants=a};h.getInitialNonFlCompVariantData=function(e){return I.compVariants[e]};h.setFakeStandardVariant=function(e,n,a){var r=h.getVariantsState(e);if(!r[Object.keys(a)[0]]){t(r,a);I.variants[e]=I.variants[e]||{};I.variants[e][n]=I.variants[e][n]||{};t(I.variants[e][n],a)}};h.resetFakedStandardVariants=function(e,n){if(I.variants[e]){delete I.variants[e][n]}};h.clearFilteredResponse=function(e){if(m[e]){m[e].preparedMaps={};delete m[e].storageResponse}};h.getUIChanges=function(e){return M(e).changes};h.getAppDescriptorChanges=function(e){return V(e).appDescriptorChanges};h.getVariantsState=function(e){var t=P(e);if(I.variants[e]){n(I.variants[e],function(a,r){if(m[e].componentId===a){n(r,function(e,n){if(!t[e]){t[e]=n}})}})}return t};h.getUI2Personalization=function(e){return m[e].unfilteredStorageResponse.changes.ui2personalization};h.getCompVariantsMap=function(e){return U(e)};h.callPrepareFunction=function(e,n){return D[e].prepareFunction(n)};h.getStorageResponse=function(e){if(S[e]){return S[e].then(function(){return m[e].unfilteredStorageResponse})}return undefined};h.getFlexObjectsFromStorageResponse=function(e){return m[e]&&m[e].unfilteredStorageResponse.changes};return h});