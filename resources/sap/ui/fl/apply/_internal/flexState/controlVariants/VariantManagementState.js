/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/includes","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/util/each","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/Change","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/fl/Variant"],function(e,n,t,a,r,i,c,o,f,s,u,v,g,l,d){"use strict";var p={};var m={};function h(e){var n=[];if(e.variantData.content.variantReference){n=p.getControlChangesForVariant(Object.assign(e,{vReference:e.variantData.content.variantReference,changeInstance:true}));return n.filter(function(n){return g.compareAgainstCurrentLayer(n.getDefinition().layer,e.variantData.content.layer)===-1})}return n}function C(e){var n=p.getContent(e.reference);var t=i.get([e.vmReference,"variants"],n);return t||[]}function V(e,n,t){var a=n.changeType;if(!e){e={}}if(!e[a]){e[a]=[]}if(t){e[a].push(n);return true}return e[a].some(function(t,r){if(t.fileName===n.fileName){e[a].splice(r,1);return true}})}function R(e,n){var t=F(e);n[t].push(e)}function b(e,n){var t=F(e);var a=-1;n[t].some(function(n,t){if(n.fileName===e.fileName){a=t;return true}});if(a>-1){n[t].splice(a,1)}}function F(e){switch(e.fileType){case"change":return"variantDependentControlChanges";case"ctrl_variant":return"variants";case"ctrl_variant_change":return"variantChanges";case"ctrl_variant_management_change":return"variantManagementChanges";default:}}p.getContent=function(e){var n=u.getVariantsState(e);c(m[e],function(e,t){if(e!=="currentComponentIdUsedForFakeVariants"&&!n[e]){n[e]=t}});return n};p.addFakeStandardVariant=function(e,n,t){var a=p.getContent(e);if(!a[Object.keys(t)[0]]){r(a,t);if(!m[e]||m[e].currentComponentIdUsedForFakeVariants!==n){m[e]={};m[e].currentComponentIdUsedForFakeVariants=n}r(m[e],t)}else{o.error("Error in VariantManagementState.addFakeStandardVariant: Variant already in map")}};p.clearFakedStandardVariants=function(e,n){if(m[e]&&m[e].currentComponentIdUsedForFakeVariants===n){delete m[e]}};p.resetContent=function(e){u.clearFilteredResponse(e)};p.getControlChangesForVariant=function(e){var n=[];var t=p.getVariant(e);if(t){n=t.controlChanges;if(!e.changeInstance){n=n.map(function(e){return e.getDefinition()})}}return n};p.getVariantChangesForVariant=function(e){var n=p.getVariant(e);return n&&n.variantChanges||{}};p.getVariant=function(e){var n;var t=p.getContent(e.reference);e.vReference=e.vReference||t[e.vmReference].defaultVariant;var a=C(e);a.some(function(t){if(t.content.fileName===e.vReference){n=t;return true}});return n};p.getCurrentVariantReference=function(e){var n=p.getContent(e.reference);var t=n[e.vmReference];return t.currentVariant||t.defaultVariant};p.getVariantManagementReferences=function(e){var n=p.getContent(e);return Object.keys(n)};p.addVariantToVariantManagement=function(e){var n=p.getContent(e.reference);var t=n[e.vmReference].variants.slice().splice(1);var a=s.getIndexToSortVariant(t,e.variantData);if(e.variantData.content.variantReference){var r=h(e);e.variantData.controlChanges=r.concat(e.variantData.controlChanges)}n[e.vmReference].variants.splice(a+1,0,e.variantData);return a+1};p.removeVariantFromVariantManagement=function(e){var n;var t=p.getContent(e.reference);var a=t[e.vmReference].variants.some(function(t,a){var r=new d(t);if(r.getId()===e.variant.getId()){n=a;return true}});if(a){t[e.vmReference].variants.splice(n,1)}return n};p.setVariantData=function(e){var n=p.getContent(e.reference);var t=n[e.vmReference].variants;var a=t[e.previousIndex];Object.keys(e.variantData).forEach(function(n){if(a.content.content[n]){a.content.content[n]=e.variantData[n]}});if(a.content.fileName!==e.vmReference){t.splice(e.previousIndex,1);var r=s.getIndexToSortVariant(t.slice(1),a);t.splice(r+1,0,a);return r+1}t.splice(e.previousIndex,1,a);return e.previousIndex};p.addChangeToVariant=function(e){var n=p.getControlChangesForVariant(Object.assign(e,{changeInstance:true}));var a=n.map(function(e){return e.getDefinition().fileName});if(!t(a,e.change.getDefinition().fileName)){var r=p.getVariant(e);r.controlChanges=n.concat([e.change]);return true}return false};p.removeChangeFromVariant=function(e){var n=p.getControlChangesForVariant(Object.assign(e,{changeInstance:true}));var t=p.getVariant(e);var a=false;if(t){t.controlChanges=n.filter(function(n){if(!a&&n.getId()===e.change.getId()){a=true;return false}return true})}return a};p.getInitialChanges=function(e){var n=p.getContent(e.reference);return Object.keys(n).reduce(function(t,a){if(e.vmReference&&e.vmReference===a||!e.vmReference){var r=n[a].currentVariant?"currentVariant":"defaultVariant";var i={vmReference:a,vReference:n[a][r],reference:e.reference,changeInstance:e.changeInstance};return t.concat(p.getControlChangesForVariant(Object.assign({},e,i)))}return t},[])};p.fillVariantModel=function(e){var n=p.getContent(e.reference);return Object.keys(n).reduce(function(t,a){t[a]={defaultVariant:n[a].defaultVariant,variants:[]};if(n[a].currentVariant){t[a].currentVariant=n[a].currentVariant}C(Object.assign(e,{vmReference:a})).forEach(function(e,n){t[a].variants[n]=JSON.parse(JSON.stringify({key:e.content.fileName,title:e.content.content.title,layer:e.content.layer,favorite:e.content.content.favorite,executeOnSelect:e.content.content.executeOnSelect,visible:e.content.content.visible,author:i.get("content.support.user",e)}))});return t},{})};p.updateChangesForVariantManagementInMap=function(e){var n=p.getContent(e.reference);var t=n[e.vmReference];if(e.changeContent.fileType==="ctrl_variant_change"){t.variants.some(function(n){if(n.content.fileName===e.changeContent.selector.id){V(n.variantChanges,e.changeContent,e.add)}})}else if(e.changeContent.fileType==="ctrl_variant_management_change"){V(t.variantManagementChanges,e.changeContent,e.add)}};p.setCurrentVariant=function(e){var n=p.getContent(e.reference);if(i.get([e.vmReference],n)){n[e.vmReference].currentVariant=e.newVReference}};p.updateVariantsState=function(e){var n=p.getContent(e.reference);if(a(n)){o.error("Variant state is not initialized yet");return}var t=u.getFlexObjectsFromStorageResponse(e.reference);if(e.changeToBeAddedOrDeleted){switch(e.changeToBeAddedOrDeleted.getPendingAction()){case"NEW":R(e.changeToBeAddedOrDeleted.getDefinition(),t);break;case"DELETE":b(e.changeToBeAddedOrDeleted.getDefinition(),t);break;default:}}};p.waitForInitialVariantChanges=function(e){var n=p.getInitialChanges({vmReference:e.vmReference,reference:e.reference,changeInstance:true});var t=n.reduce(function(e,n){if(l.indexOfObject(e,n.getSelector())===-1){e.push(n.getSelector())}return e},[]);var a=[];t.map(function(n){var t=f.bySelector(n,e.appComponent);if(t){a.push(t)}});return e.flexController.waitForChangesToBeApplied(a)};return p});