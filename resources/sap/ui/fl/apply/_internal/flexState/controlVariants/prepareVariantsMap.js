/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/ObjectPath","sap/base/Log","sap/ui/fl/Change","sap/base/util/includes","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/base/util/isEmptyObject","sap/base/util/each","sap/base/util/values","sap/base/util/merge","sap/ui/fl/LayerUtils"],function(e,t,n,a,r,i,c,o,s,u){"use strict";function f(e,t){var n=s({},e);t.forEach(function(e){n[e.fileName]={content:e,controlChanges:[],variantChanges:{}}});return n}function v(e,t){var a=s({},e);t.forEach(function(e){var t=new n(e);t.setState(n.states.PERSISTED);a[e.variantReference]=a[e.variantReference]||A(e.variantReference);a[e.variantReference].controlChanges.push(t)});return a}function l(e,t){var n=s({},e);t.forEach(function(e){n[e.selector.id]=n[e.selector.id]||A(e.selector.id);var t=n[e.selector.id].variantChanges[e.changeType]||[];t.push(e);n[e.selector.id].variantChanges[e.changeType]=t});return n}function g(t){var n=s({},t);o(t).forEach(function(t){var a=e.get("variantChanges.setVisible",t);if(a&&a.length>0){var r=N(a);if(!r.getContent().visible&&r.getContent().createdByReset){delete n[t.content.fileName]}}});return n}function h(e){var t=s({},e);o(t).forEach(function(e){var n=e.content.variantReference;var a;if(n){a=C(t,n,e.content.variantManagementReference)}e.controlChanges=p(a,e.content.layer).concat(e.controlChanges)});return t}function p(e,t){if(!e){return[]}return o(s({},e.controlChanges)).filter(function(e){return u.compareAgainstCurrentLayer(e.getLayer(),t)===-1})}function C(e,t,n){var a=e[t];if(!a&&t===n){a=A(t);e[t]=a}return a}function b(e){var t={};t=f(t,e.variants);t=v(t,e.variantDependentControlChanges);t=l(t,e.variantChanges);t=g(t);t=h(t);return t}function R(){return{variantManagementChanges:{},variants:[]}}function m(e,t,n){var i=s({},e);o(t).forEach(function(e){var t=e.content.variantManagementReference;if(!i[t]){i[t]=R()}e=V(e);e=y(e);if(!i[t].currentVariant&&e.content.content.visible&&a(n,e.content.fileName)){i[t].currentVariant=e.content.fileName}i[t].defaultVariant=t;var c=r.getIndexToSortVariant(i[t].variants,e);i[t].variants.splice(c,0,e)});return i}function d(e,t){var n=s({},e);t.forEach(function(e){var t=e.selector.id;if(!n[t]){n[t]=R()}var a=e.changeType;if(!n[t].variantManagementChanges[a]){n[t].variantManagementChanges[a]=[]}n[t].variantManagementChanges[a].push(e);n[t]=x(n[t])});return n}function T(e){var t=s({},e);c(t,function(e,t){var n=t.variants.findIndex(function(t){return t.content.fileName===e});var a;if(n===-1){a=A(e)}else{a=t.variants[n];t.variants.splice(n,1)}t.variants.unshift(a)});return t}function E(e,t,n){var a={};a=m(a,e,n);a=d(a,t);a=T(a);return a}function A(e){var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");return{content:{fileName:e,variantManagementReference:e,variantReference:"",content:{title:t.getText("STANDARD_VARIANT_TITLE"),favorite:true,visible:true},support:{user:r.DEFAULT_AUTHOR}},variantChanges:{},controlChanges:[]}}function x(e){var t=s({},e);var n=t.variantManagementChanges;var a;if(!i(n)){a=N(n["setDefault"]);if(a){t.defaultVariant=a.getContent().defaultVariant}}return t}function y(e){var n=s({},e);var a=n.variantChanges;var r;c(a,function(e,a){switch(e){case"setTitle":r=N(a);if(r){n.content.content.title=r.getText("title")}break;case"setFavorite":r=N(a);if(r){n.content.content.favorite=r.getContent().favorite}break;case"setExecuteOnSelect":r=N(a);if(r){n.content.content.executeOnSelect=r.getContent().executeOnSelect}break;case"setVisible":r=N(a);if(r){n.content.content.visible=r.getContent().visible}break;case"setContexts":r=N(a);if(r){n.content.contexts=r.getContent().contexts}break;default:t.error("No valid changes on variant "+n.content.content.title+" available")}});return n}function N(e){if(e.length>0){return new n(e[e.length-1])}return false}function M(e){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl").getText(e)}function V(t){var n=s({},t);if(n.content.fileName===n.content.variantManagementReference){if(!e.get("content.support.user",n)){var a={support:{user:r.DEFAULT_AUTHOR}};s(n.content,a)}}if(!n.content.content.favorite){n.content.content.favorite=true}if(!n.content.content.visible){n.content.content.visible=true}if(!n.content.content.executeOnSelect){n.content.content.executeOnSelect=false}var i=n.content.content.title.match(/.i18n>(\w+)./);if(i){n.content.content.title=M(i[1])}return n}return function(t){if(i(t)||!e.get("storageResponse.changes.variants",t)){return{}}var n=e.get(["technicalParameters",r.VARIANT_TECHNICAL_PARAMETER],t.componentData)||[];var a=b(t.storageResponse.changes);a=E(a,t.storageResponse.changes.variantManagementChanges,n);return a}});