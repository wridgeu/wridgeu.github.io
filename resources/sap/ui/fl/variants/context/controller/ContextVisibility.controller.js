/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/fl/write/_internal/Storage","sap/ui/fl/Layer","sap/m/MessageStrip","sap/ui/core/MessageType","sap/base/util/restricted/_isEqual"],function(e,t,n,o,r,i,s){"use strict";function l(e){var t={layer:o.CUSTOMER,type:"role"};return Object.assign({},t,e)}function a(e){var t={layer:o.CUSTOMER,flexObjects:e};return n.loadContextDescriptions(t).then(function(t){if(t.role&&t.role.length===e.role.length){this.oSelectedContextsModel.setProperty("/selected",t.role)}}.bind(this))}function c(){return t.load({id:this.getView().getId(),name:"sap.ui.fl.variants.context.view.fragment.AddContextDialog",controller:this}).then(function(e){this.getView().addDependent(e);e._oList.attachUpdateStarted(this._updateStartedHandler.bind(this));e._oList.attachSelectionChange(this._onSelectionChange.bind(this));return e}.bind(this))}function d(e,t){return n.getContexts(l(e)).then(function(e){if(t){e.values=t.concat(e.values)}this.oContextsModel.setData(e);this.oContextsModel.refresh(true)}.bind(this))}function u(e){return{id:e.getTitle(),description:e.getDescription()}}return e.extend("sap.ui.fl.variants.context.controller.ContextVisibility",{onInit:function(){this.oSelectedContextsModel=this.getView().getModel("selectedContexts");this.oContextsModel=this.getView().getModel("contexts");this.oI18n=this.getView().getModel("i18n").getResourceBundle()},onBeforeRendering:function(){this.oSelectedContextsModel.refresh(true);var e=this.getOwnerComponent().getSelectedContexts();var t=e.role.length>0;this.byId("selectedContextsList").setVisible(t);if(t){return a.call(this,e)}return Promise.resolve()},_onSelectionChange:function(e){var t=u(e.getParameter("listItem"));if(e.getParameter("selected")===true){this.oCurrentSelection.push(t)}else{this.oCurrentSelection=this.oCurrentSelection.filter(function(e){return!s(e,t)})}},isSelected:function(e,t){return t.some(function(t){return t.id===e.id})},formatSelectedIndex:function(e){return e.length===0?0:1},formatTooltip:function(e){if(!this.oI18n){this.oI18n=this.getView().getModel("i18n").getResourceBundle()}return e.length===0?this.oI18n.getText("NO_DESCRIPTION"):e},onSelectRestrictedRadioButton:function(e){e.getSource().setSelected(true);var t=e.getParameters()&&e.getParameters().selected;this.byId("selectedContextsList").setVisible(t)},onSelectPublicRadioButton:function(){this.oSelectedContextsModel.setProperty("/selected",[]);this.showErrorMessage(false)},_appendDataFromBackend:function(){var e=this.oContextsModel.getProperty("/values");if(this.oContextsModel.getProperty("/lastHitReached")===false){var t={$skip:e.length};return d.call(this,t,e)}return Promise.resolve(e)},_updateStartedHandler:function(e){if(e.getParameter&&e.getParameter("reason")==="Growing"){return this._appendDataFromBackend()}return Promise.resolve()},_addContexts:function(e){e.clearSelection();this.oCurrentSelection=this.oSelectedContextsModel.getProperty("/selected")||[];return d.call(this,{}).then(function(){return e.open()})},onAddContextsHandler:function(){if(!this._oDialog){this._oDialog=c.call(this)}return this._oDialog.then(function(e){return this._addContexts(e)}.bind(this))},onSearch:function(e){e.getSource().clearSelection();var t={$filter:e.getParameter("value")};return d.call(this,t)},onSelectContexts:function(){this.oSelectedContextsModel.setProperty("/selected",this.oCurrentSelection);this.oCurrentSelection=[];this.showErrorMessage(false)},onDeleteContext:function(e){var t=this.oSelectedContextsModel.getProperty("/selected");var n=e.getParameter("listItem");var o=t.filter(function(e){return e.id!==n.getTitle()});this.oSelectedContextsModel.setProperty("/selected",o);var r=e.getSource();r.attachEventOnce("updateFinished",r.focus,r)},removeAll:function(){this.oSelectedContextsModel.setProperty("/selected",[])},showErrorMessage:function(e){var t=this.getView().getId()+"--noSelectedRolesError";var n=sap.ui.getCore().byId(t);if(n){n.destroy()}if(e){n=new r(t,{text:this.oI18n.getText("SELECTED_ROLES_ERROR"),type:i.Error,showIcon:true});this.byId("visibilityPanel").insertContent(n,1)}},isRemoveAllEnabled:function(e){return e.length!==0}})});