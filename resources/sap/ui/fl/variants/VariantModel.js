/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/each","sap/base/util/includes","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/BusyIndicator","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/flexState/controlVariants/Switcher","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/changeHandler/Base","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/fl/registry/Settings","sap/ui/model/json/JSONModel"],function(e,t,n,a,r,i,o,s,c,l,f,h,u,p,g,v,d,m,V,C,R){"use strict";function y(e,t){return M(function(e,t){var n=t.model;var a=t.vmReference;var r=false;var o=e.key;var s=e.key;return Promise.resolve().then(function(){if(i.get([a,"currentVariant"],n.oData)&&n.oData[a].currentVariant!==n.oData[a].originalCurrentVariant){s=n.oData[a].originalCurrentVariant;r=true;return n.updateCurrentVariant({variantManagementReference:a,newVariantReference:o,appComponent:n.oAppComponent,internallyCalled:true})}}).then(function(){if(i.get([a,"modified"],n.oData)===true){var e=u.getControlChangesForVariant({reference:n.sFlexReference,vmReference:a,vReference:s,changeInstance:true});return D({changes:e,vmReference:a,vReference:s,revert:!r,model:n}).then(function(){n.oData[a].originalCurrentVariant=o;n.oData[a].modified=false;n.checkUpdate(true)})}}).then(function(){if(!r){n._callVariantSwitchListeners(a,n.oData[a].currentVariant)}})}.bind(null,e.getParameters(),t),t.model,t.vmReference)}function D(e){var t=e.model._getDirtyChangesFromVariantChanges(e.changes);t=t.reverse();return Promise.resolve().then(function(){if(e.revert){return l.revertMultipleChanges(t,{appComponent:e.model.oAppComponent,modifier:s,flexController:e.model.oFlexController})}}).then(function(){t.forEach(function(t){u.removeChangeFromVariant({reference:e.model.sFlexReference,change:t,vmReference:e.vmReference,vReference:e.vReference});e.model.oFlexController.deleteChange(t,e.model.oAppComponent)})})}function b(e,t,n){if(n||e.oData[t]){e.oData[t].variantBusy=n}e.checkUpdate()}function M(e,t,n){t._oVariantSwitchPromise=t._oVariantSwitchPromise.catch(function(){}).then(b.bind(null,t,n,true)).then(e).then(b.bind(null,t,n,false)).catch(function(e){b(t,n,false);throw e});t.oFlexController.setVariantSwitchPromise(t._oVariantSwitchPromise);return t._oVariantSwitchPromise}function x(e){return h.switchVariant(e).then(function(){delete this.oData[e.vmReference]}.bind(this)).catch(function(e){o.warning(e.message)})}function F(e,t){return h.switchVariant(e).then(function(){this.oData[e.vmReference].originalCurrentVariant=e.newVReference;this.oData[e.vmReference].currentVariant=e.newVReference;if(this.oData[e.vmReference].updateVariantInURL){f.updateVariantInURL({vmReference:e.vmReference,newVReference:e.newVReference,model:this})}this._callVariantSwitchListeners(e.vmReference,e.newVReference,undefined,t);this.checkUpdate()}.bind(this))}function S(e){C.getInstance().then(function(t){if(!t.isVariantPersonalizationEnabled()){e.remove=false;e.rename=false;e.change=false}})}function _(e,t,n){var a=n?m.getCurrentLayer():d.USER;if(e.layer===a&&e.key!==t){return true}return false}function E(e){return new Promise(function(t){if(e.getDomRef()){t()}else{e.addEventDelegate({onAfterRendering:function(){t()}})}})}var I=R.extend("sap.ui.fl.variants.VariantModel",{constructor:function(e,t,n,r){this.pSequentialImportCompleted=Promise.resolve();R.apply(this,arguments);this.bObserve=r;this.sharing={PRIVATE:"private",PUBLIC:"public"};this.oFlexController=t;this.oChangePersistence=this.oFlexController._oChangePersistence;this.sFlexReference=this.oChangePersistence.getComponentName();this.oAppComponent=n;this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");this._oVariantSwitchPromise=Promise.resolve();this._oVariantAppliedListeners={};if(a(e)){try{e=u.fillVariantModel({reference:this.sFlexReference})}catch(e){o.error("Variants Map was not found: "+e.message)}}if(e&&typeof e==="object"){Object.keys(e).forEach(function(t){e[t].variants.forEach(function(n){if(!e[t].currentVariant&&n.key===e[t].defaultVariant){e[t].currentVariant=n.key}n.originalTitle=n.title;n.originalFavorite=n.favorite;n.originalExecuteOnSelect=n.executeOnSelect;n.originalVisible=n.visible});e[t].originalCurrentVariant=e[t].currentVariant;e[t].originalDefaultVariant=e[t].defaultVariant});this.setData(e)}f.initialize({model:this})}});I.prototype.updateCurrentVariant=function(e){var t={vmReference:e.variantManagementReference,currentVReference:this.oData[e.variantManagementReference].originalCurrentVariant,newVReference:e.newVariantReference,flexController:this.oFlexController,appComponent:e.appComponent||this.oAppComponent,modifier:s,reference:this.sFlexReference};if(e.internallyCalled){return F.call(this,t,e.scenario)}return M(F.bind(this,t,e.scenario),this,e.variantManagementReference)};I.prototype.getCurrentVariantReference=function(e){return this.oData[e].currentVariant};I.prototype.getVariantManagementReference=function(e){var t="";var n=-1;Object.keys(this.oData).some(function(a){return this.oData[a].variants.some(function(r,i){if(r.key===e){t=a;n=i;return true}})}.bind(this));return{variantManagementReference:t,variantIndex:n}};I.prototype.getVariant=function(e,t){return u.getVariant({reference:this.sFlexReference,vmReference:t||this.getVariantManagementReference(e).variantManagementReference,vReference:e})};I.prototype.getVariantProperty=function(e,t){return this.getVariant(e).content.content[t]};function T(e,t){var n=u.getVariantChangesForVariant({vmReference:e,reference:this.sFlexReference});var a=this.oData[e].currentVariant;var r=this.oData[e].defaultVariant;if(t.getExecuteOnSelectionForStandardDefault()&&a===r&&a===e&&!n.setExecuteOnSelect){var i=u.getVariant({reference:this.sFlexReference,vmReference:e,vReference:e});i.content.content.executeOnSelect=true;this.oData[e].variants[0].originalExecuteOnSelect=true;this.oData[e].variants[0].executeOnSelect=true;return true}return false}I.prototype.attachVariantApplied=function(e){var t=sap.ui.getCore().byId(e.vmControlId);var n=this.getVariantManagementReferenceForControl(t);return this.waitForVMControlInit(n).then(function(e,n){if(!this._oVariantAppliedListeners[e]){this._oVariantAppliedListeners[e]={}}var a=T.call(this,e,t);if(n.callAfterInitialVariant||a){var r={appComponent:this.oAppComponent,reference:this.sFlexReference,vmReference:e,flexController:this.oFlexController};u.waitForInitialVariantChanges(r).then(function(){var t=u.getCurrentVariantReference({vmReference:e,reference:this.sFlexReference});this._callVariantSwitchListeners(e,t,n.callback)}.bind(this))}return E(n.control).then(function(){if(p.getRelevantVariantManagementControlId(n.control,this.getVariantManagementControlIds())===n.vmControlId){this.oData[e].showExecuteOnSelection=true;this.checkUpdate(true);this._oVariantAppliedListeners[e][n.control.getId()]=n.callback}else{o.error("Error in attachVariantApplied: The passed VariantManagement ID does not match the responsible VariantManagement control")}}.bind(this))}.bind(this,n,e))};I.prototype._callVariantSwitchListeners=function(e,n,a,i){if(this._oVariantAppliedListeners[e]){var o;this.oData[e].variants.some(function(e){if(e.key===n){o=r({},e);return true}});if(i){o.createScenario=i}if(a){a(o)}else{t(this._oVariantAppliedListeners[e],function(e,t){t(o)})}}};I.prototype.detachVariantApplied=function(e,t){var n=this.getVariantManagementReferenceForControl(sap.ui.getCore().byId(e));if(this._oVariantAppliedListeners[n]){delete this._oVariantAppliedListeners[n][t]}};I.prototype.addChange=function(e){var t=e.getVariantReference();var n=this.getVariantManagementReference(t).variantManagementReference;if(e.getState()===v.states.NEW){this.oData[n].modified=true}this.checkUpdate(true);return u.addChangeToVariant({reference:this.sFlexReference,change:e,vmReference:n,vReference:t})};I.prototype.removeChange=function(e){var t=e.getVariantReference();var n=this.getVariantManagementReference(t).variantManagementReference;var a=u.removeChangeFromVariant({reference:this.sFlexReference,change:e,vmReference:n,vReference:t});this.checkDirtyStateForControlModels([n]);return a};I.prototype._getVariantTitleCount=function(e,t){var n=this.getData();return n[t].variants.reduce(function(t,n){if(e.toLowerCase()===n.title.toLowerCase()&&n.visible){t++}return t},0)};I.prototype._duplicateVariant=function(e){var t=e.newVariantReference;var n=e.sourceVariantReference;var a=e.variantManagementReference;var i=this.getVariant(n);var o=u.getControlChangesForVariant({vmReference:a,vReference:n,changeInstance:true,reference:this.sFlexReference}).map(function(e){return e.getDefinition()});var s={content:{},controlChanges:o,variantChanges:{}};var c=m.compareAgainstCurrentLayer(i.content.layer,e.layer);Object.keys(i.content).forEach(function(a){if(a==="fileName"){s.content[a]=t}else if(a==="variantReference"){if(c===1){var r=this.getVariant(i.content.variantReference);if(r.content.layer===e.layer){s.content[a]=r.content.variantReference}else{s.content[a]=i.content.variantReference}}else if(c===0){s.content[a]=i.content.variantReference}else if(c===-1){s.content[a]=n}}else if(a==="content"){s.content[a]=JSON.parse(JSON.stringify(i.content[a]));s.content.content.title=e.title}else{s.content[a]=i.content[a]}}.bind(this));s.content.layer=e.layer;o=s.controlChanges.slice();var l={};var f;s.controlChanges=o.reduce(function(t,n){if(m.compareAgainstCurrentLayer(n.layer,e.layer)>=0){l=r({},n);l.layer=e.layer;l.variantReference=s.content.fileName;if(!l.support){l.support={}}l.support.sourceChangeFileName=n.fileName;l.packageName="$TMP";f=v.createInitialFileContent(l);t.push(new v(f))}return t},[]);return s};I.prototype.copyVariant=function(e){var t=this._duplicateVariant(e);t.generator=e.generator;var n={key:t.content.fileName,layer:e.layer,title:t.content.content.title,originalTitle:t.content.content.title,originalExecuteOnSelect:t.content.content.executeOnSelect,executeOnSelect:false,favorite:true,originalFavorite:true,rename:true,change:true,remove:true,visible:true,originalVisible:true,sharing:e.layer===d.USER?this.sharing.PRIVATE:this.sharing.PUBLIC};var a=p.createVariant({model:this,variantSpecificData:t});var i=[];[a].concat(a.getControlChanges()).forEach(function(e){i.push(this.oChangePersistence.addDirtyChange(e))}.bind(this));var o=u.addVariantToVariantManagement({variantData:r({},a.getDefinitionWithChanges(),{content:{content:{visible:n.visible,favorite:n.favorite}}}),reference:this.sFlexReference,vmReference:e.variantManagementReference});this.oData[e.variantManagementReference].variants.splice(o,0,n);return this.updateCurrentVariant({variantManagementReference:e.variantManagementReference,newVariantReference:a.getId(),appComponent:e.appComponent,internallyCalled:true,scenario:"saveAs"}).then(function(){return i})};I.prototype.removeVariant=function(e){var t=this.oChangePersistence.getDirtyChanges().filter(function(t){return t.getVariantReference&&t.getVariantReference()===e.variant.getId()||t.getId()===e.variant.getId()});return this.updateCurrentVariant({variantManagementReference:e.variantManagementReference,newVariantReference:e.sourceVariantReference,appComponent:e.component}).then(function(){var n=u.removeVariantFromVariantManagement({reference:this.sFlexReference,variant:e.variant,vmReference:e.variantManagementReference});this.oData[e.variantManagementReference].variants.splice(n,1);this.checkUpdate();t.forEach(function(e){this.oChangePersistence.deleteChange(e)}.bind(this))}.bind(this))};I.prototype.collectModelChanges=function(e,t){var n=this.getData()[e];var a=n.variants;var r=[];var i={};a.forEach(function(e){if(e.originalTitle!==e.title){i={variantReference:e.key,changeType:"setTitle",title:e.title,originalTitle:e.originalTitle,layer:t};r.push(i)}if(e.originalFavorite!==e.favorite){i={variantReference:e.key,changeType:"setFavorite",favorite:e.favorite,originalFavorite:e.originalFavorite,layer:t};r.push(i)}if(e.originalExecuteOnSelect!==e.executeOnSelect){i={variantReference:e.key,changeType:"setExecuteOnSelect",executeOnSelect:e.executeOnSelect,originalExecuteOnSelect:e.originalExecuteOnSelect,layer:t};r.push(i)}if(!e.visible&&e.originalVisible){i={variantReference:e.key,changeType:"setVisible",visible:false,layer:t};r.push(i)}});if(n.originalDefaultVariant!==n.defaultVariant){i={variantManagementReference:e,changeType:"setDefault",defaultVariant:n.defaultVariant,originalDefaultVariant:n.originalDefaultVariant,layer:t};r.push(i)}return r};I.prototype.manageVariants=function(e,t,n,a){return new Promise(function(r){e.attachEventOnce("manage",{resolve:r,variantManagementReference:t,layer:n},this.fnManageClickRta,this);e.openManagementDialog(true,a)}.bind(this))};I.prototype.setVariantProperties=function(e,t,n){var a=-1;var r;var i=null;var o=this.getData();if(t.variantReference){a=this.getVariantManagementReference(t.variantReference).variantIndex;r=o[e].variants[a]}var c={};var l={};switch(t.changeType){case"setTitle":l.title=t.title;r.title=t.title;r.originalTitle=r.title;break;case"setFavorite":l.favorite=t.favorite;r.favorite=t.favorite;r.originalFavorite=r.favorite;break;case"setExecuteOnSelect":l.executeOnSelect=t.executeOnSelect;if(r){r.executeOnSelect=t.executeOnSelect;r.originalExecuteOnSelect=r.executeOnSelect}break;case"setVisible":l.visible=t.visible;l.createdByReset=false;r.visible=t.visible;r.originalVisible=r.visible;break;case"setDefault":l.defaultVariant=t.defaultVariant;o[e].defaultVariant=t.defaultVariant;o[e].originalDefaultVariant=o[e].defaultVariant;var h=f.getStoredHashParams({model:this});if(h){if(o[e].defaultVariant!==o[e].currentVariant&&h.indexOf(o[e].currentVariant)===-1){f.update({parameters:h.concat(o[e].currentVariant),updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this})}else if(o[e].defaultVariant===o[e].currentVariant&&h.indexOf(o[e].currentVariant)>-1){h.splice(h.indexOf(o[e].currentVariant),1);f.update({parameters:h,updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this})}}if(!n&&o[e].currentVariant!==t.defaultVariant){this.updateCurrentVariant({variantManagementReference:e,newVariantReference:t.defaultVariant,appComponent:t.appComponent})}break;default:break}var p=u.getContent(this.sFlexReference);if(a>-1){var v=u.setVariantData({variantData:l,vmReference:e,previousIndex:a,reference:this.sFlexReference});o[e].variants.splice(a,1);o[e].variants.splice(v,0,r)}else if(p[e]){p[e].defaultVariant=t.defaultVariant}var d={vmReference:e,add:n,reference:this.sFlexReference};if(n===true){c.changeType=t.changeType;c.layer=t.layer;c.generator=t.generator;if(t.changeType==="setDefault"){c.fileType="ctrl_variant_management_change";c.selector=s.getSelector(e,t.appComponent)}else{if(t.changeType==="setTitle"){g.setTextInChange(c,"title",t.title,"XFLD")}c.fileType="ctrl_variant_change";c.selector=s.getSelector(t.variantReference,t.appComponent)}i=this.oFlexController.createBaseChange(c,t.appComponent);i.setContent(l);d.changeContent=i.getDefinition();u.updateChangesForVariantManagementInMap(d);this.oChangePersistence.addDirtyChange(i)}else if(t.change){d.changeContent=t.change.getDefinition();u.updateChangesForVariantManagementInMap(d);this.oChangePersistence.deleteChange(t.change)}this.setData(o);this.checkUpdate(true);return i};I.prototype._ensureStandardVariantExists=function(t){var n=this.getData();var i=n[t]||{};var s=e(i,["initPromise"]);if(!n[t]||a(s)){n[t]=r(i,{currentVariant:t,originalCurrentVariant:t,defaultVariant:t,originalDefaultVariant:t,variants:[{key:t,title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),originalTitle:this._oResourceBundle.getText("STANDARD_VARIANT_ORIGINAL_TITLE"),favorite:true,originalFavorite:true,executeOnSelect:false,originalExecuteOnSelect:false,visible:true,originalVisible:true,author:p.DEFAULT_AUTHOR}]});this.setData(n);var c={};c[t]={defaultVariant:t,variantManagementChanges:{},variants:[{content:{fileName:t,fileType:"ctrl_variant",variantManagementReference:t,variantReference:"",support:{user:p.DEFAULT_AUTHOR},content:{title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),favorite:true,visible:true,executeOnSelect:false}},controlChanges:[],variantChanges:{}}]};try{u.addFakeStandardVariant(this.sFlexReference,this.oAppComponent.getId(),c)}catch(e){o.error("Variants Map was not found: "+e.message)}}};I.prototype.setModelPropertiesForControl=function(e,t,n){this.oData[e].modified=false;this.oData[e].showFavorites=true;var a=this._bDesignTimeMode;if(a!==t){this._bDesignTimeMode=t;if(t){f.clearAllVariantURLParameters({model:this})}else if(a){f.update({parameters:f.getStoredHashParams({model:this}),updateURL:true,updateHashEntry:false,model:this})}}if(!(typeof this.fnManageClick==="function"&&typeof this.fnManageClickRta==="function")){this._initializeManageVariantsEvents()}n.detachManage(this.fnManageClick,this);if(t&&this.oData[e]._isEditable){this.oData[e].variantsEditable=false;this.oData[e].variants.forEach(function(n){n.rename=true;n.change=true;n.sharing=this.sharing.PUBLIC;n.remove=_(n,e,t)}.bind(this))}else if(this.oData[e]._isEditable){n.attachManage({variantManagementReference:e},this.fnManageClick,this);this.oData[e].variantsEditable=true;this.oData[e].variants.forEach(function(n){n.remove=_(n,e,t);switch(n.layer){case d.USER:n.rename=true;n.change=true;n.sharing=this.sharing.PRIVATE;S(n);break;case d.PUBLIC:var a=V.getUshellContainer();var r=a&&a.getUser();var i=!r||r.getId().toUpperCase()===n.author.toUpperCase()||C.getInstanceOrUndef().isKeyUser();n.remove=i;n.rename=i;n.change=i;n.sharing=this.sharing.PUBLIC;break;default:n.rename=false;n.change=false;n.sharing=this.sharing.PUBLIC}}.bind(this))}else{this.oData[e].variantsEditable=false;this.oData[e].variants.forEach(function(e){e.remove=false;e.rename=false;e.change=false})}};I.prototype._initializeManageVariantsEvents=function(){this.fnManageClickRta=function(e,t){var n=this.collectModelChanges(t.variantManagementReference,t.layer);t.resolve(n)};this.fnManageClick=function(e,t){if(!this.oFlexController||!u.getContent(this.sFlexReference)){return}var n=this.collectModelChanges(t.variantManagementReference,d.USER);var a=[];n.forEach(function(e){e.appComponent=this.oAppComponent;a.push(this.setVariantProperties(t.variantManagementReference,e,true))}.bind(this));this.oChangePersistence.saveDirtyChanges(this.oAppComponent,false,a)}};function P(e,t,n,a){if(!this._bDesignTimeMode){return e.saveSequenceOfDirtyChanges(t,a).then(function(e){if(e){var t=e.response[0];this.oData[n].variants.forEach(function(e){if(e.key===t.fileName){e.author=t.support.user}})}}.bind(this))}return Promise.resolve()}I.prototype._handleSaveEvent=function(e){if(!this._bDesignTimeMode){var t=e.getSource();var n=e.getParameters();return this._handleSave(t,n)}return Promise.resolve()};I.prototype._handleSave=function(e,t){var n=V.getAppComponentForControl(e);var a=this.getLocalId(e.getId(),n);var r;return M(function(e,t,n){var a=n.def;var i=n.execute;var o=this.getCurrentVariantReference(e);var s=u.getControlChangesForVariant({reference:this.sFlexReference,vmReference:e,vReference:o,changeInstance:true});if(n.overwrite){return this.oFlexController.saveSequenceOfDirtyChanges(this._getDirtyChangesFromVariantChanges(s),t)}var c=n.layer||(n.public?d.PUBLIC:d.USER);var l=n.newVariantReference||V.createDefaultFileName();var f={variantManagementReference:e,appComponent:t,layer:c,title:n.name,sourceVariantReference:o,newVariantReference:l,generator:n.generator};return this.copyVariant(f).then(function(n){if(a){var f={changeType:"setDefault",defaultVariant:l,originalDefaultVariant:this.oData[e].defaultVariant,appComponent:t,layer:c,variantManagementReference:e};var h=this.setVariantProperties(e,f,true);n.push(h)}if(i){var u={changeType:"setExecuteOnSelect",executeOnSelect:true,variantReference:l,appComponent:t,layer:c,variantManagementReference:e};var p=this.setVariantProperties(e,u,true);n.push(p)}r=n;return D({changes:s,vmReference:e,vReference:o,model:this}).then(P.bind(this,this.oFlexController,n,e,t))}.bind(this))}.bind(this,a,n,t),this,a).then(function(){this.oData[a].modified=false;this.checkUpdate(true);return r}.bind(this))};I.prototype.getLocalId=function(e,t){return s.getSelector(e,t).id};I.prototype.getVariantManagementReferenceForControl=function(e){var t=e.getId();var n=V.getAppComponentForControl(e);return n&&n.getLocalId(t)||t};I.prototype.switchToDefaultForVariantManagement=function(e){if(this.oData[e].currentVariant!==this.oData[e].defaultVariant){c.show(200);this.updateCurrentVariant({variantManagementReference:e,newVariantReference:this.oData[e].defaultVariant}).then(function(){c.hide()})}};I.prototype.switchToDefaultForVariant=function(e){Object.keys(this.oData).forEach(function(t){if(!e||this.oData[t].currentVariant===e){this.switchToDefaultForVariantManagement(t)}}.bind(this))};I.prototype.registerToModel=function(e){var t=this.getVariantManagementReferenceForControl(e);this._ensureStandardVariantExists(t);this.oData[t]._isEditable=e.getEditable();this.oData[t].showExecuteOnSelection=false;e.attachEvent("select",{vmReference:t,model:this},y);e.attachSave(this._handleSaveEvent,this);this.setModelPropertiesForControl(t,false,e);var n=e.getUpdateVariantInURL();this.oData[t].updateVariantInURL=n;f.registerControl({vmReference:t,updateURL:!!n,model:this});f.handleModelContextChange({model:this,vmControl:e});if(this.oData[t].initPromise){this.oData[t].initPromise.resolveFunction();delete this.oData[t].initPromise}this.oData[t].init=true};I.prototype.waitForVMControlInit=function(e){if(!this.oData[e]){this.oData[e]={}}else if(this.oData[e].init){return Promise.resolve()}this.oData[e].initPromise={};this.oData[e].initPromise.promise=new Promise(function(t){this.oData[e].initPromise.resolveFunction=t}.bind(this));return this.oData[e].initPromise.promise};I.prototype._getDirtyChangesFromVariantChanges=function(e){var t=e.map(function(e){return e.getDefinition().fileName});return this.oChangePersistence.getDirtyChanges().filter(function(e){return n(t,e.getId())&&!e.assignedToVariant})};I.prototype.checkDirtyStateForControlModels=function(e){e.forEach(function(e){var t=this.oData[e];var n=this.getCurrentVariantReference(e);var a=u.getControlChangesForVariant({reference:this.sFlexReference,vmReference:e,vReference:n,changeInstance:true});var r=this._getDirtyChangesFromVariantChanges(a);t.modified=r.length>0}.bind(this));this.checkUpdate(true)};I.prototype.getCurrentControlVariantIds=function(){return Object.keys(this.oData||{}).reduce(function(e,t){return e.concat([this.oData[t].currentVariant])}.bind(this),[])};I.prototype.getVariantManagementControlIds=function(){var e;return Object.keys(this.oData||{}).reduce(function(t,n){if(this.oAppComponent.byId(n)){e=this.oAppComponent.createId(n)}else{e=n}t.push(e);return t}.bind(this),[])};I.prototype.resetMap=function(e){var t=Object.keys(this.oData);t.forEach(function(e){var t={vmReference:e,currentVReference:this.oData[e].currentVariant||this.oData[e].defaultVariant,newVReference:true,appComponent:this.oAppComponent,flexController:this.oFlexController,modifier:s,reference:this.sFlexReference};return M(x.bind(this,t),this,e)}.bind(this));return this._oVariantSwitchPromise.then(function(){u.clearFakedStandardVariants(this.sFlexReference,this.oAppComponent.getId());u.resetContent(this.sFlexReference);if(!e){f.initialize({model:this});f.update({parameters:[],updateHashEntry:true,model:this})}}.bind(this))};return I});