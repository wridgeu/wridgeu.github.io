/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/thirdparty/URI","sap/base/Log","sap/base/util/extend","sap/base/util/mixedFetch","sap/base/strings/escapeRegExp","sap/ui/core/_IconRegistry","./Core"],function(e,t,r,o,n,i,a){"use strict";var p=sap.ui.getCore().getConfiguration();var s=p.getLanguage();var u=p.getAppCacheBusterMode()==="sync";var c=p.getAppCacheBusterMode()==="batch";var f={index:{},active:false};var l,d,h,g,v;var y=document.baseURI.replace(/\?.*|#.*/g,"");var b=t(sap.ui.require.toUrl("")+"/../");var L=b.toString();if(b.is("relative")){b=b.absoluteTo(y)}var m=b.normalize().toString();var x=t("resources").absoluteTo(m).toString();var C=new RegExp("^"+i(x));var A=function(e){if(e.length>0&&e.slice(-1)!=="/"){e+="/"}return e};var R=function(e,t){var i=f.index;var a;var p;var l;var d,h;if(Array.isArray(e)&&!c){e.forEach(function(e){R(e,t)})}else if(Array.isArray(e)&&c){var g=A(e[0]);var v=[];r.debug('sap.ui.core.AppCacheBuster.register("'+g+'"); // BATCH MODE!');var y=U.normalizeURL(g);r.debug('  --\x3e normalized to: "'+y+'"');e.forEach(function(e){p=A(e);var t=U.normalizeURL(p);if(!i[l]){v.push(t)}});if(v.length>0){p=y+"sap-ui-cachebuster-info.json?sap-ui-language="+s;a={body:v.join("\n"),headers:{Accept:n.ContentTypes.JSON,"Content-Type":"text/plain"},mode:"POST"};d=function(e){U.onIndexLoaded(p,e);o(i,e)};h=function(e){r.error('Failed to batch load AppCacheBuster index file from: "'+e+'".')}}}else{e=A(e);r.debug('sap.ui.core.AppCacheBuster.register("'+e+'");');l=U.normalizeURL(e);r.debug('  --\x3e normalized to: "'+l+'"');if(!i[l]){p=l+"sap-ui-cachebuster-info.json?sap-ui-language="+s;a={headers:{Accept:n.ContentTypes.JSON},mode:"POST"};d=function(e){U.onIndexLoaded(p,e);i[l]=e};h=function(e){r.error('Failed to load AppCacheBuster index file from: "'+e+'".')}}}if(a){var b=U.onIndexLoad(p);if(b!=null){r.info('AppCacheBuster index file injected for: "'+p+'".');d(b)}else{var L=!u&&!!t;if(L){var m=t.startTask("load "+p);var x=d,C=h;d=function(e){x.apply(this,arguments);t.finishTask(m)};h=function(){C.apply(this,arguments);t.finishTask(m,false)}}r.info('Loading AppCacheBuster index file from: "'+p+'".');n(p,a,!L).then(function(e){if(e.ok){return e.json()}else{throw new Error("Status code: "+e.status)}}).then(d).catch(function(){h(p)})}}};var U={boot:function(e){var r=p.getAppCacheBuster();if(r&&r.length>0){r=r.slice();var o=true;var n=String(r[0]).toLowerCase();if(r.length===1){if(n==="true"||n==="x"){var i=t(L);r=i.is("relative")?[i.toString()]:[]}else if(n==="false"){o=false}}if(o){U.init();R(r,e)}}},init:function(){f.active=true;l=e.prototype.validateProperty;d=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src");h=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href");var t=U.convertURL;var o=U.normalizeURL;var n=function(e){if(this.active===true&&e&&typeof e==="string"){e=o(e);return!e.match(C)}return false}.bind(f);g=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,r){if(r&&n(r)){arguments[1]=t(r)}g.apply(this,arguments)};v=XMLHttpRequest.prototype.open;e.prototype.validateProperty=function(e,r){var o=this.getMetadata(),i=o.getProperty(e),a;if(i&&i.type==="sap.ui.core.URI"){a=Array.prototype.slice.apply(arguments);try{if(n(a[1])){a[1]=t(a[1])}}catch(e){}}return l.apply(this,a||arguments)};a._convertUrl=function(e){return t(e)};var i=function(e){var r={get:e.get,set:function(r){if(n(r)){r=t(r)}e.set.call(this,r)},enumerable:e.enumerable,configurable:e.configurable};r.set._sapUiCoreACB=true;return r};var p=false;try{Object.defineProperty(HTMLScriptElement.prototype,"src",i(d))}catch(e){r.error("Your browser doesn't support redefining the src property of the script tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+e);p=true}try{Object.defineProperty(HTMLLinkElement.prototype,"href",i(h))}catch(e){r.error("Your browser doesn't support redefining the href property of the link tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+e);p=true}if(p){this.exit()}},exit:function(){e.prototype.validateProperty=l;delete a._convertUrl;if(XMLHttpRequest.prototype.open===v){XMLHttpRequest.prototype.open=g}var t;if((t=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src"))&&t.set&&t.set._sapUiCoreACB===true){Object.defineProperty(HTMLScriptElement.prototype,"src",d)}if((t=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href"))&&t.set&&t.set._sapUiCoreACB===true){Object.defineProperty(HTMLLinkElement.prototype,"href",h)}f.index={};f.active=false;f={index:{},active:false}},register:function(e){R(e)},convertURL:function(e){r.debug('sap.ui.core.AppCacheBuster.convertURL("'+e+'");');var t=f.index;if(t&&e&&!/^#/.test(e)){var o=U.normalizeURL(e);r.debug('  --\x3e normalized to: "'+o+'"');if(o&&U.handleURL(o)){for(var n in t){var i=t[n],a,p;if(n&&o.length>=n.length&&o.slice(0,n.length)===n){a=o.slice(n.length);p=a.match(/([^?#]*)/)[1];if(i[p]){e=n+"~"+i[p]+"~/"+a;r.debug('  ==> rewritten to "'+e+'";');break}}}}}return e},normalizeURL:function(e){var r=t(e||"./");if(r.is("relative")){r=r.absoluteTo(y)}return r.normalizeProtocol().normalizeHostname().normalizePort().normalizePath().toString()},handleURL:function(e){return true},onIndexLoad:function(e){return null},onIndexLoaded:function(e,t){}};var T=p.getAppCacheBusterHooks();if(T){["handleURL","onIndexLoad","onIndexLoaded"].forEach(function(e){if(typeof T[e]==="function"){U[e]=T[e]}})}return U},true);