/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/performance/Measurement","sap/ui/Global"],function(e,t,a){"use strict";var n={name:"LRUPersistentCache",logResolved:function(t){e.debug("Cache Manager: "+t+" completed successfully.")},defaultOptions:{databaseName:"ui5-cachemanager-db",_contentStoreName:"content-store",_metadataStoreName:"metadata-store",_metadataKey:"metadataKey"},_db:{},init:function(){this._metadata={};this._mru=-1;this._lru=-1;return h(this)},_destroy:function(){if(this._db.close){this._db.close()}this._metadata=null;this._ui5version=null},set:function(a,n){if(U(a)){e.warning("Cache Manager ignored 'set' for key ["+a+"]");return Promise.resolve()}if(a==null){return Promise.reject("Cache Manager does not accept undefined or null as key")}if(typeof n==="undefined"){return Promise.reject("Cache Manager does not accept undefined as value")}e.debug("Cache Manager LRUPersistentCache: adding item with key ["+a+"]...");var r=this,s="[sync ] fnSet: total[sync]  key ["+a+"]",i="[sync ] fnSet: txStart[sync]  key ["+a+"]",u="[sync ] fnSet: storeOpen[sync]  key ["+a+"]",c="[sync ] fnSet: putContent[sync]  key ["+a+"]",d="[sync ] fnSet: putMetadata[sync]  key ["+a+"]",f="[sync ] fnSet: serialize[sync]  key ["+a+"]";return new Promise(function l(m,h){t.start(s,"CM",o);var g,p,v,S,D;D=C(r._metadata);S=new y(a,n,typeof n,++r._mru,f,o).serialize();t.start(i,"CM",o);var P=r._db.transaction([r.defaultOptions._contentStoreName,r.defaultOptions._metadataStoreName],"readwrite");t.end(i);P.onerror=function(t){var a="Cache Manager cannot complete add/put transaction for entry with key: "+S.oData.key+". Details: "+k(t);e.error(a);r._metadata=D;b(r);h(a)};P.onabort=function(t){r._metadata=D;b(r);var o=M(r);if(w(t)&&o>0){e.warning("Cache Manager is trying to free some space to add/put new item");O(r,a,n).then(function(){e.debug("Cache Manager LRUPersistentCache: set completed after freeing space. ItemCount changed from "+o+" to "+M(r));m()},function(t){var a="Cache Manager LRUPersistentCache: set unsuccessful. Cannot free space to add/put entry. Details: "+t;e.error(a);h(a)})}else{var s="Cache Manager LRUPersistentCache: set failed: "+k(t);e.error(s);h(s)}};P.oncomplete=function(){e.debug("Cache Manager LRUPersistentCache: adding item with key ["+a+"]... done");m()};t.start(u,"CM",o);g=P.objectStore(r.defaultOptions._contentStoreName);v=P.objectStore(r.defaultOptions._metadataStoreName);t.end(u);t.start(c,"CM",o);p=g.put(S.oData,S.oData.key);t.end(c);t.end(s);p.onsuccess=function(){_(r,S);t.start(d,"CM",o);v.put(r._metadata,r.defaultOptions._metadataKey);t.end(d)};if(e.getLevel()>=e.Level.DEBUG){e.debug("Cache Manager LRUPersistentCache: measurements: "+s+": "+t.getMeasurement(s).duration+"; "+f+": "+t.getMeasurement(f).duration+"; "+i+": "+t.getMeasurement(i).duration+"; "+u+": "+t.getMeasurement(u).duration+"; "+c+": "+t.getMeasurement(c).duration+"; "+d+": "+t.getMeasurement(d).duration)}})},has:function(t){if(U(t)){e.warning("Cache Manager ignored 'has' for key ["+t+"]");return Promise.resolve(false)}return this.get(t).then(function(a){var n=typeof a!=="undefined";e.debug("Cache Manager: has key ["+t+"] returned "+n);return n})},_getCount:function(){return Promise.resolve(M(this))},_getAll:function(e){var t=this,a,n="[sync ] _getAll: deserialize";return new Promise(function(e,o){var s=[],i=t._db.transaction([t.defaultOptions._contentStoreName],"readonly"),u=i.objectStore(t.defaultOptions._contentStoreName);i.onerror=function(e){o(k(e))};i.oncomplete=function(t){e(s)};u.openCursor().onsuccess=function(e){var t=e.target.result;if(t&&t.value){a=new y(t.value,n,r).deserialize();s.push({key:a.oData.key,value:a.oData.value});t.continue()}}})},_loadMetaStructure:function(){var t=this;return new Promise(function(a,n){var r=t._db.transaction([t.defaultOptions._metadataStoreName],"readonly");r.onerror=function(t){if(!r.errorHandled){r.errorHandled=true;var a="Cache Manager cannot complete transaction for read metadata. Details: "+r.error;e.error(a);n(a)}};var o=r.objectStore(t.defaultOptions._metadataStoreName);try{var s=o.get(t.defaultOptions._metadataKey);s.onsuccess=function(n){t._metadata=s.result?s.result:p(t._ui5version);if(t._metadata.__ui5version!==t._ui5version){t.reset().then(a,function(t){e.error("Cannot reset the cache. Details:"+t);r.abort()})}else{if(!t._metadata.timestamps){t._metadata.timestamps={}}a()}};s.onerror=function(t){e.error("Cache Manager cannot complete transaction for read metadata items. Details: "+t.message);n(t.message)}}catch(a){e.error("Cache Manager cannot read metadata entries behind key: "+t.defaultOptions._metadataKey+". Details: "+a.message);n(a.message)}})},get:function(t){if(U(t)){e.warning("Cache Manager ignored 'get' for key ["+t+"]");return Promise.resolve()}return c(this,t)},del:function(t){if(U(t)){e.warning("Cache Manager ignored 'del' for key ["+t+"]");return Promise.resolve()}return u(this,t)},delWithFilters:function(t){var a=this,n=t||{};return new Promise(function(t,r){var o=C(a._metadata),s=a._db.transaction([a.defaultOptions._contentStoreName,a.defaultOptions._metadataStoreName],"readwrite"),i=s.objectStore(a.defaultOptions._contentStoreName),u=s.objectStore(a.defaultOptions._metadataStoreName),c=i.openCursor(),d=n.prefix||"";function f(){a._metadata=o;b(a)}function l(e){f();r(k(e))}s.onerror=l;s.onabort=l;s.oncomplete=function(e){t()};c.onsuccess=function(t){var r=t.target.result,o,s;if(!r){u.put(a._metadata,a.defaultOptions._metadataKey);return}o=r.value.key;if(o.indexOf(d)===0&&(!n.olderThan||!(o in a._metadata.timestamps)||a._metadata.timestamps[o]<=n.olderThan)){s=r.delete();s.onsuccess=function(){e.debug("Deleted "+o+"!");D(a,o)}}r.continue()}})},reset:function(){var t=this;return new Promise(function(n,r){var o,s,i,u,c;c=t._db.transaction([t.defaultOptions._contentStoreName,t.defaultOptions._metadataStoreName],"readwrite");c.onerror=c.onabort=function(t){if(!c.errorHandled){c.errorHandled=true;var a="Cache Manager LRUPersistentCache: transaction for reset() failed. Details: "+c.error;e.error(a);r(a)}};c.oncomplete=function(e){n()};o=c.objectStore(t.defaultOptions._contentStoreName);s=c.objectStore(t.defaultOptions._metadataStoreName);try{i=o.clear();i.onerror=function(){c.abort()};i.onsuccess=function(){u=s.clear();u.onerror=function(){c.abort()};u.onsuccess=function(){t._metadata=p(a.version);b(t)}}}catch(e){c.abort()}})}};var r="LRUPersistentCache,get",o="LRUPersistentCache,set",s=0;function i(t,a){var n;t._metadata.timestamps[a.oData.key]=Date.now();n=t._db.transaction([t.defaultOptions._contentStoreName,t.defaultOptions._metadataStoreName],"readwrite");n.onerror=n.onabort=function(t){e.warning("Cache Manager cannot persist the information about usage of an entry. This may lead to earlier removal of the entry if browser storage space is over. Details: "+n.error)};try{n.objectStore(t.defaultOptions._metadataStoreName).put(t._metadata,t.defaultOptions._metadataKey)}catch(t){e.warning("Cache Manager cannot persist the information about usage of an entry. This may lead to earlier removal of the entry if browser storage space is over. Details: "+t.message)}}function u(t,a){return new Promise(function(n,r){var o,s;o=t._db.transaction([t.defaultOptions._contentStoreName,t.defaultOptions._metadataStoreName],"readwrite");s=C(t._metadata);function i(n){t._metadata=s;b(t);var o="Cache Manager LRUPersistentCache: cannot delete item with key: "+a+". Details: "+k(n);e.error(o);r(o)}o.onerror=i;o.onabort=i;o.oncomplete=function(){if(M(t)===0){t._lru=-1;t._mru=-1;t._metadata=p(t._ui5version)}e.debug("Cache Manager LRUPersistentCache: item with key "+a+" deleted");n()};e.debug("Cache Manager LRUPersistentCache: deleting item ["+a+"]");var u=o.objectStore(t.defaultOptions._contentStoreName).delete(a);u.onsuccess=function(){e.debug("Cache Manager LRUPersistentCache: request for deleting item ["+a+"] is successful, updating metadata...");D(t,a);o.objectStore(t.defaultOptions._metadataStoreName).put(t._metadata,t.defaultOptions._metadataKey)}})}function c(a,n){if(a.getCounter===undefined){a.getCounter=0}a.getCounter++;var o="[sync ] fnGet"+a.getCounter+": total[sync]  key ["+n+"]",s="[sync ] fnGet"+a.getCounter+": txStart[sync]  key ["+n+"]",u="[sync ] fnGet"+a.getCounter+": storeOpen[sync]  key ["+n+"]",c="[sync ] fnGet"+a.getCounter+": access result[sync]  key ["+n+"]",d="[sync ] fnGet"+a.getCounter+": putMetadata[sync]  key ["+n+"]",f="[sync ] fnGet"+a.getCounter+": deserialize[sync]  key ["+n+"]",l="[sync ]  _instance.get",m="[sync ]  getRequest.onSuccess";e.debug("Cache Manager LRUPersistentCache: get for key ["+n+"]...");t.start(l,"CM",r);var h=new Promise(function l(h,g){var p,C,b,M;t.start(o,"CM",r);t.start(s,"CM",r);C=a._db.transaction([a.defaultOptions._contentStoreName,a.defaultOptions._metadataStoreName],"readwrite");t.end(s);C.onerror=function(t){var a="Cache Manager cannot complete delete transaction for entry with key: "+n+". Details: "+C.error;e.error(a);g(a)};try{t.start(u,"CM",r);b=C.objectStore(a.defaultOptions._contentStoreName).get(n);t.end(u);b.onsuccess=function(o){t.start(m,"CM",r);t.start(c,"CM",r);M=new y(b.result,f,r);t.end(c);I("Cache Manager LRUPersistentCache: accessing the result",n,c);if(M.oData){t.start(d,"CM",r);if(M.oData.lu!==a._mru){M.oData.lu=++a._mru;_(a,M)}i(a,M);t.end(d);p=M.deserialize().oData.value}t.end(m);e.debug("Cache Manager LRUPersistentCache: get for key ["+n+"]...done");h(p)};b.onerror=function(t){e.error("Cache Manager cannot get entry with key: "+n+". Details: "+t.message);g(t.message)}}catch(t){e.error("Cache Manager cannot get entry with key: "+n+". Details: "+t.message);g(t.message);return}t.end(o)});t.end(l);return h}function d(t){var a=v(t);if(a==undefined){var n="Cache Manager LRUPersistentCache: deleteItemAndUpdateMetadata cannot find item to delete";e.debug(n);return Promise.reject(n)}return l(t,a).then(function(){return Promise.resolve().then(function(){D(t,a);return f(t).then(function(){return a},function(){e.warning("Cache Manager LRUPersistentCache: Free space algorithm deleted item "+"but the metadata changes could not be persisted. This won't break the functionality.");return a})})})}function f(t){return new Promise(function(a,n){try{var r=t._db.transaction([t.defaultOptions._contentStoreName,t.defaultOptions._metadataStoreName],"readwrite");r.onerror=o;r.onabort=o;r.oncomplete=function(){e.debug("Cache Manager LRUPersistentCache: persistMetadata - metadata was successfully updated");a()};r.objectStore(t.defaultOptions._metadataStoreName).put(t._metadata,t.defaultOptions._metadataKey)}catch(e){o(null,e)}function o(t,a){var r="Cache Manager LRUPersistentCache: persistMetadata error - metadata was not successfully persisted. Details: "+k(t)+". Exception: "+(a?a.message:"");e.debug(r);n(r)}})}function l(t,a){return new Promise(function(n,r){var o=t._db.transaction([t.defaultOptions._contentStoreName,t.defaultOptions._metadataStoreName],"readwrite");function s(t){var n="Cache Manager LRUPersistentCache: internalDel cannot complete delete transaction for entry with key: "+a+". Details: "+k(t);e.warning(n);r(t)}o.onerror=s;o.onabort=s;o.oncomplete=function(){if(M(t)===0){t._lru=0;t._mru=0;t._metadata=p(t._ui5version)}e.debug("Cache Manager LRUPersistentCache: internalDel deleting item ["+a+"]...done");n()};e.debug("Cache Manager LRUPersistentCache: internalDel deleting item ["+a+"]...");o.objectStore(t.defaultOptions._contentStoreName).delete(a)})}function m(t,a,n){return new Promise(function(r,s){var i,u,c,d="[sync ] internalSet: serialize[sync]  key ["+a+"]";c=C(t._metadata);var f=new y(a,n,typeof n,++t._mru,d,o).serialize();e.debug("Cache Manager: LRUPersistentCache: internal set with parameters: key ["+f.oData.key+"], access index ["+f.oData.lu+"]");u=t._db.transaction([t.defaultOptions._contentStoreName,t.defaultOptions._metadataStoreName],"readwrite");u.onerror=l;u.onabort=l;function l(a){e.debug("Cache Manager: LRUPersistentCache: internal set failed. Details: "+k(a));t._metadata=c;b(t);s(a)}u.oncomplete=function(){e.debug("Cache Manager: LRUPersistentCache: Internal set transaction completed. ItemCount: "+M(t));r()};i=u.objectStore(t.defaultOptions._contentStoreName).put(f.oData,f.oData.key);i.onsuccess=function(){_(t,f);u.objectStore(t.defaultOptions._metadataStoreName).put(t._metadata,t.defaultOptions._metadataKey)}})}function _(t,a){if(t._metadata.__byKey__[a.oData.key]!=null){var n=t._metadata.__byKey__[a.oData.key];delete t._metadata.__byIndex__[n];e.debug("Cache Manager LRUPersistentCache: set/internalset - item already exists, so its indexes are updated")}t._metadata.__byIndex__[a.oData.lu]=a.oData.key;t._metadata.__byKey__[a.oData.key]=a.oData.lu;P(t)}function h(t){t._ui5version=a.version;return new Promise(function a(n,r){var o;e.debug("Cache Manager "+"_initIndexedDB started");function s(){try{o=window.indexedDB.open(t.defaultOptions.databaseName,1)}catch(t){e.error("Could not open Cache Manager database. Details: "+t.message);r(t.message)}}s();o.onerror=function(t){e.error("Could not initialize Cache Manager database. Details: "+t.message);r(t.error)};o.onsuccess=function(a){var s=R("init_onsuccess");t._db=o.result;t._db.onversionchange=function(e){if(!e.newVersion){e.target.close()}};t._loadMetaStructure().then(function(){e.debug("Cache Manager "+" metadataLoaded. Serialization support: "+L()+", resolving initIndexDb promise");n(t)},r);s.endSync()};o.onupgradeneeded=function(a){var n=a.target.result;n.onerror=function(t){e.error("Cache Manager error. Details: "+t.message);r(n.error)};try{var o=n.createObjectStore(t.defaultOptions._contentStoreName);n.createObjectStore(t.defaultOptions._metadataStoreName)}catch(t){e.error("Could not initialize Cache Manager object store. Details: "+t.message);throw t}o.createIndex("ui5version","ui5version",{unique:false})}})}function g(e,t,a,n){this.key=e;this.sOrigType=a;this.value=t;this.lu=n}function y(e,t,a,n,r,o){if(arguments.length===3){this.oData=e;this.sMeasureId=t;this.sMsrCat=a}else{this.oData=new g(e,t,a,n)}}y.prototype.deserialize=function(){if(L()&&this.oData.sOrigType==="object"){t.start(this.sMeasureId,this.sMeasureId,this.sMsrCat);this.oData.value=JSON.parse(this.oData.value);t.end(this.sMeasureId);I("Cache Manager LRUPersistentCache: de-serialization the result",this.oData.key,this.sMeasureId)}return this};y.prototype.serialize=function(){if(L()&&this.oData.sOrigType==="object"){t.start(this.sMeasureId,this.sMeasureId,this.sMsrCat);this.oData.value=JSON.stringify(this.oData.value);t.end(this.sMeasureId);I("Cache Manager LRUPersistentCache: serialization of the value",this.oData.key,this.sMeasureId)}return this};function p(e){return{timestamps:{},__byKey__:{},__byIndex__:{},__ui5version:e}}function C(e){var t=p(e.__ui5version);for(var a in e.__byIndex__){t.__byIndex__[a]=e.__byIndex__[a]}for(var n in e.__byKey__){t.__byKey__[n]=e.__byKey__[n]}for(var n in e.timestamps){t.timestamps[n]=e.timestamps[n]}return t}function b(t){var a=S(t._metadata.__byIndex__);t._mru=a.mru;t._lru=a.lru;e.debug("Cache Manager LRUPersistentCache: LRU counters are assigned to the CM: "+JSON.stringify(a))}function M(e){return Object.keys(e._metadata.__byKey__).length}function v(e){var t=e._metadata.__byIndex__[e._lru];if(t==undefined&&!P(e)){return null}else{return e._metadata.__byIndex__[e._lru]}}function S(e){var t=-1,a=-1,n=Number.MAX_VALUE,r=Object.keys(e),o=r.length;if(o===0){return{mru:-1,lru:-1}}else{while(++t<o){var s=parseInt(r[t]);if(a<s){a=s}if(n>s){n=s}}return{mru:a,lru:n}}}function O(t,a,n){return new Promise(function(r,o){var s=0;i(t,a,n);function i(t,a,n){s++;e.debug("Cache Manager LRUPersistentCache: cleanAndStore: freeing space attempt ["+s+"]");d(t).then(function(s){e.debug("Cache Manager LRUPersistentCache: cleanAndStore: deleted item with key ["+s+"]. Going to put "+a);return m(t,a,n).then(r,function(r){if(w(r)){e.debug("Cache Manager LRUPersistentCache: cleanAndStore: QuotaExceedError during freeing up space...");if(M(t)>0){i(t,a,n)}else{o("Cache Manager LRUPersistentCache: cleanAndStore: even when the cache is empty, the new item with key ["+a+"] cannot be added")}}else{o("Cache Manager LRUPersistentCache: cleanAndStore: cannot free space: "+k(r))}})},o)}})}function w(e){return e&&e.target&&e.target.error&&e.target.error.name==="QuotaExceededError"}function D(e,t){var a=e._metadata.__byKey__[t];delete e._metadata.__byKey__[t];delete e._metadata.__byIndex__[a];if(e._metadata.timestamps[t]){delete e._metadata.timestamps[t]}P(e)}function P(e){while(e._lru<=e._mru&&e._metadata.__byIndex__[e._lru]==undefined){e._lru++}return e._lru<=e._mru}function k(e){if(!e){return""}var t=e.message;if(e.target&&e.target.error&&e.target.error.name){t+=" Error name: "+e.target.error.name}return t}function L(){return sap.ui.getCore().getConfiguration().isUI5CacheSerializationSupportOn()}function N(){return sap.ui.getCore().getConfiguration().getUI5CacheExcludedKeys()}function U(e){return N().some(function(t){return e.indexOf(t)>-1})}function R(e,a){s++;var n="[async]  "+e+"["+a+"]- #"+s,r="[sync ]  "+e+"["+a+"]- #"+s;t.start(n,"CM",["LRUPersistentCache",e]);t.start(r,"CM",["LRUPersistentCache",e]);return{sMeasureAsync:n,sMeasureSync:r,endAsync:function(){t.end(this.sMeasureAsync)},endSync:function(){t.end(this.sMeasureSync)}}}function I(a,n,r){if(e.getLevel()>=e.Level.DEBUG){e.debug(a+" for key ["+n+"] took: "+t.getMeasurement(r).duration)}}return n});