/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/URI","../Element","sap/base/util/UriParameters","sap/base/Log","sap/base/util/extend","sap/base/util/syncFetch","sap/ui/core/ThemeCheck","./ThemeHelper","sap/ui/core/Configuration"],function(e,r,t,a,n,i,s,o,u){"use strict";var c=u.getSyncCallBehavior();var l={};var f=null;var m=null;var p=[];var d=[];var h=new e(sap.ui.require.toUrl(""),document.baseURI).origin();var g={};var v=/url[\s]*\('?"?([^\'")]*)'?"?\)/;var y=t.fromQuery(window.location.search).get("sap-ui-xx-no-inline-theming-parameters")!=="true";function b(r,t){var a=v.exec(r);if(a){var n=new e(a[1]);if(n.is("relative")){var i=n.absoluteTo(t).normalize().toString();r="url('"+i+"')"}}return r}function w(e,r,t){for(var a in r){if(typeof e[a]==="undefined"){e[a]=b(r[a],t)}}return e}function P(e,r){if(typeof e["default"]!=="object"){e={default:e,scopes:{}}}f=f||{};f["default"]=f["default"]||{};f["scopes"]=f["scopes"]||{};w(f["default"],e["default"],r);if(typeof e["scopes"]==="object"){for(var t in e["scopes"]){f["scopes"][t]=f["scopes"][t]||{};w(f["scopes"][t],e["scopes"][t],r)}}}function C(e){document.querySelectorAll("link[id^=sap-ui-theme-]").forEach(function(r){e(r.getAttribute("id"))})}function S(e){var r=A(e);var t=s.checkStyle(e);if(!t){a.warning("Parameters have been requested but theme is not applied, yet.","sap.ui.core.theming.Parameters")}if(t&&y){var n=document.getElementById(e);var i=window.getComputedStyle(n).getPropertyValue("background-image");var o=/\(["']?data:text\/plain;utf-8,(.*?)['"]?\)$/i.exec(i);if(o&&o.length>=2){var u=o[1];if(u.charAt(0)!=="{"&&u.charAt(u.length-1)!=="}"){try{u=decodeURIComponent(u)}catch(e){a.warning("Could not decode theme parameters URI from "+r.styleSheetUrl)}}try{var c=JSON.parse(u);P(c,r.themeBaseUrl);return true}catch(e){a.warning("Could not parse theme parameters from "+r.styleSheetUrl+". Loading library-parameters.json as fallback solution.")}}}return false}function U(r){var t=A(r);if(!S(r)){var n=t.styleSheetUrl.replace(/\/(?:css_variables|library)([^\/.]*)\.(?:css|less)($|[?#])/,function(e,r,t){return"/library-parameters.json"+(t?t:"")});if(c===2){a.error("[nosync] Loading library-parameters.json ignored",n,"sap.ui.core.theming.Parameters");return}else if(c===1){a.error("[nosync] Loading library-parameters.json with sync XHR",n,"sap.ui.core.theming.Parameters")}var i=new e(t.themeBaseUrl).origin();var s=g[i];var o=[];if(s===undefined){if(n.startsWith(h)){o=[false,true]}else{o=[true,false]}}else{o=[s]}I(n,t.themeBaseUrl,o)}}function A(r){var t=document.getElementById(r);if(!t){a.warning("Could not find stylesheet element with ID",r,"sap.ui.core.theming.Parameters");return undefined}var n=t.href;return{themeBaseUrl:new e(n).filename("").query("").toString(),styleSheetUrl:n}}function I(r,t,n){var s={Accept:i.ContentTypes.JSON};var o=n.shift();if(o){s["X-Requested-With"]="XMLHttpRequest"}function u(e){a.error("Could not load theme parameters from: "+r,e);if(n.length>0){a.warning("Initial library-parameters.json request failed ('withCredentials="+o+"'; sUrl: '"+r+"').\n"+"Retrying with 'withCredentials="+!o+"'.","sap.ui.core.theming.Parameters");I(r,t,n)}}try{var c=i(r,{credentials:o?"include":"omit",headers:s});if(c.ok){var l=c.json();var f=new e(t).origin();g[f]=o;if(Array.isArray(l)){for(var m=0;m<l.length;m++){var p=l[m];P(p,t)}}else{P(l,t)}}else{throw new Error(c.statusText||c.status)}}catch(e){u(e)}}function L(e){if(!f){P({},"");C(function(r){if(e){if(s.checkStyle(r)){S(r)}else{p.push(r)}}else{U(r)}})}return f}function j(){var e=[];p.forEach(function(r){if(s.checkStyle(r)){S(r)}else{e.push(r)}});p=e}function N(){p.forEach(U);p=[]}l._addLibraryTheme=function(e){if(f){p.push("sap-ui-theme-"+e)}};function T(e){var r=e.async,t=L(r);if(e.scopeName){t=t["scopes"][e.scopeName]}else{t=t["default"]}var a=t[e.parameterName];if(!a){var n=e.parameterName.indexOf(":");if(n!=-1){var i=e.parameterName.substr(n+1);a=t[i]}}if(e.loadPendingParameters&&typeof a==="undefined"&&!r){N();a=T({parameterName:e.parameterName,scopeName:e.scopeName,loadPendingParameters:false})}return a}function k(e,r,t){var a=l.getActiveScopesFor(r,t);var n=a.flat().reduce(function(e,r){if(e.indexOf(r)===-1){e.push(r)}return e},[]);for(var i=0;i<n.length;i++){var s=n[i];var o=T({parameterName:e,scopeName:s,async:t});if(o){return o}}return T({parameterName:e,async:t})}l._getScopes=function(e,r){if(e&&!f){return}var t=L(r);var a=Object.keys(t["scopes"]);return a};l.getActiveScopesFor=function(e,t){var a=[];if(e instanceof r){var n=e.getDomRef();if(t){j()}else{N()}var i=this._getScopes(undefined,t);if(i.length){if(n){var s=function(e){var r=n.classList;return r&&r.contains(e)};while(n){var o=i.filter(s);if(o.length>0){a.push(o)}n=n.parentNode}}else{var u=function(r){return typeof e.hasStyleClass==="function"&&e.hasStyleClass(r)};while(e){var o=i.filter(u);if(o.length>0){a.push(o)}e=typeof e.getParent==="function"&&e.getParent()}}}}return a};l.get=function(e,t){var n,i,s,o,c;var l=function(e){return e.callback===i};if(!sap.ui.getCore().isInitialized()){a.warning("Called sap.ui.core.theming.Parameters.get() before core has been initialized. "+"Consider using the API only when required, e.g. onBeforeRendering.")}if(!m){m=u.getTheme()}if(arguments.length===0){a.warning("Legacy variant usage of sap.ui.core.theming.Parameters.get API detected. Do not use the Parameters.get() API to retrieve ALL theming parameters, "+"as this will lead to unwanted synchronous requests. "+"Use the asynchronous API variant instead and retrieve a fixed set of parameters.","LegacyParametersGet","sap.ui.support",function(){return{type:"LegacyParametersGet"}});N();var f=L();return Object.assign({},f["default"])}if(!e){return undefined}if(e instanceof Object&&!Array.isArray(e)){if(!e.name){a.warning("sap.ui.core.theming.Parameters.get was called with an object argument without one or more parameter names.");return undefined}t=e.scopeElement;i=e.callback;o=typeof e.name==="string"?[e.name]:e.name;s=true}else{if(typeof e==="string"){o=[e]}else{o=e}a.warning("Legacy variant usage of sap.ui.core.theming.Parameters.get API detected for parameter(s): '"+o.join(", ")+"'. This could lead to bad performance and additional synchronous XHRs, as parameters might not be available yet. Use asynchronous variant instead.","LegacyParametersGet","sap.ui.support",function(){return{type:"LegacyParametersGet"}})}var p,h;var g=function(e){if(t instanceof r){return k(e,t,s)}else{if(s){j()}return T({parameterName:e,loadPendingParameters:!s,async:s})}};h={};for(var v=0;v<o.length;v++){n=o[v];var y=g(n);if(!s||y){h[n]=y}}if(s&&i&&Object.keys(h).length!==o.length){if(!sap.ui.getCore().isThemeApplied()){p=function(){sap.ui.getCore().detachThemeChanged(p);var r=this.get({name:e.name,scopeElement:e.scopeElement});if(!r||typeof r==="object"&&Object.keys(r).length!==o.length){a.error("One or more parameters could not be found.","sap.ui.core.theming.Parameters")}i(r);d.splice(d.findIndex(l),1)}.bind(this);c=d.findIndex(l);if(c>=0){sap.ui.getCore().detachThemeChanged(d[c].eventHandler);d[c].eventHandler=p}else{d.push({callback:i,eventHandler:p})}sap.ui.getCore().attachThemeChanged(p);return undefined}else{a.error("One or more parameters could not be found.","sap.ui.core.theming.Parameters")}}return o.length===1?h[o[0]]:h};l._setOrLoadParameters=function(e){f={default:{},scopes:{}};m=u.getTheme();C(function(r){var t=r.substr(13);if(e[t]){n(f["default"],e[t])}else{U(r)}})};l.reset=function(){var e=arguments[0]===true;if(!e||u.getTheme()!==m){m=u.getTheme();p=[];f=null;o.reset()}};l._getThemeImage=function(e,r){e=e||"sapUiGlobalLogo";var t=l.get(e);if(t){var a=v.exec(t);if(a){t=a[1]}else if(t==="''"||t==="none"){t=null}}if(r&&!t){return sap.ui.require.toUrl("sap/ui/core/themes/base/img/1x1.gif")}return t};return l},true);