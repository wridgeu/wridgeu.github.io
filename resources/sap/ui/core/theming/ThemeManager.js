/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/assert","sap/base/Log","sap/base/util/each","sap/base/util/LoaderExtensions","sap/ui/Device","sap/ui/Global","sap/ui/base/EventProvider","sap/ui/core/Configuration","sap/ui/core/Element","sap/ui/dom/includeStylesheet","sap/ui/util/ActivityDetection","sap/ui/thirdparty/jquery","./ThemeHelper"],function(e,t,s,i,r,a,n,o,h,m,u,jQuery,d){"use strict";var c;var l=150;var f={};var p=/\.sapUiThemeDesignerCustomCss/i;var g=n.extend("sap.ui.core.theming.ThemeManager",{constructor:function(){n.apply(this,arguments);this._iCount=0;this._CUSTOMID="sap-ui-core-customcss";this._customCSSAdded=false;this._themeCheckedForCustom=null;this._sFallbackTheme=null;this._mThemeFallback={};S(this);this.themeLoaded=true},metadata:{events:{ThemeChanged:{}}},checkThemeChanged:function(){this.reset();y(true);if(!this._sThemeCheckId){this.fireThemeChanged()}}});g.prototype.themeLoaded=false;g.prototype.reset=function(){this.themeLoaded=false;if(this._sThemeCheckId){clearTimeout(this._sThemeCheckId);this._sThemeCheckId=null;this._iCount=0;this._sFallbackTheme=null;this._mThemeFallback={}}};function T(){var e=o.getTheme();var i=c._getThemePath("sap.ui.core",e)+"custom.css";var r=e.indexOf("sap_")===0||e==="base";var a=true;var n=[];if(c._customCSSAdded&&c._themeCheckedForCustom===e){f[c._CUSTOMID]={}}function h(s){var o="sap-ui-theme-"+s;var h=d.checkAndRemoveStyle({prefix:"sap-ui-theme-",id:s});if(h&&document.getElementById("sap-ui-themeskeleton-"+s)){h=d.checkAndRemoveStyle({prefix:"sap-ui-themeskeleton-",id:s})}a=a&&h;if(a){if(!c._customCSSAdded||c._themeCheckedForCustom!=e){if(!r&&v(s)){var u=i;var l=k(f["sap.ui.core"]);if(l){u+=l}m(u,c._CUSTOMID);c._customCSSAdded=true;t.debug("ThemeManager: delivered custom CSS needs to be loaded, Theme not yet applied");c._themeCheckedForCustom=e;a=false;return false}else if(c._customCSSAdded){var p=document.querySelector("LINK[id='"+c._CUSTOMID+"']");if(p){p.remove();t.debug("ThemeManager: Custom CSS removed")}c._customCSSAdded=false}}}if(!r&&h&&!c._mThemeFallback[s]){var g=document.getElementById(o);if(g&&g.getAttribute("data-sap-ui-ready")==="false"&&!(g.sheet&&d.hasSheetCssRules(g.sheet))){n.push(s)}}}s(f,h);if(n.length>0){if(!c._sFallbackTheme){for(var u in f){var l=d.getMetadata(u);if(l&&l.Extends&&l.Extends[0]){c._sFallbackTheme=l.Extends[0];break}}}if(c._sFallbackTheme){n.forEach(function(s){var i="sap-ui-theme-"+s;var r=document.getElementById(i);t.warning("ThemeManager: Custom theme '"+e+"' could not be loaded for library '"+s+"'. "+"Falling back to its base theme '"+c._sFallbackTheme+"'.");_(r,c._sFallbackTheme);c._mThemeFallback[s]=true});a=false}}if(!a){t.debug("ThemeManager: Theme not yet applied.")}else{c._themeCheckedForCustom=e}return a}function v(e){var s=window.document.getElementById("sap-ui-theme-"+e);if(!s){return false}var i=window.getComputedStyle(s,":after");var a=i?i.getPropertyValue("content"):null;if(!a&&r.browser.safari){var n=document.documentElement;n.classList.add("sapUiThemeDesignerCustomCss");a=window.getComputedStyle(n,":after").getPropertyValue("content");n.classList.remove("sapUiThemeDesignerCustomCss")}if(a&&a!=="none"){try{if(a[0]==="'"||a[0]==='"'){a=a.substring(1,a.length-1)}return a==="true"}catch(e){t.error("Custom check: Error parsing JSON string for custom.css indication.",e)}}var o=s.sheet?d.safeAccessSheetCssRules(s.sheet):null;if(!o||o.length===0){t.warning("Custom check: Failed retrieving a CSS rule from stylesheet "+e);return false}for(var h=0;h<2&&h<o.length;h++){if(p.test(o[h].selectorText)){return true}}return false}function y(e){c._iCount++;var s=c._iCount>l;if(!T()&&!s){var i;if(c._iCount<=100){i=2}else if(c._iCount<=110){i=500}else{i=1e3}c._sThemeCheckId=setTimeout(y,i)}else if(!e){c.reset();c.themeLoaded=true;c.fireThemeChanged();if(s){t.error("ThemeManager: max. check cycles reached.")}}else{c.themeLoaded=true}}function C(e){var t=document.getElementById(e);if(t){t.dataset.sapUiFoucmarker=e}}g.prototype._includeLibraryThemeAndEnsureThemeRoot=function(e){var t=e.name;b(t,o.getTheme());b(t,"base");f[t]=e;if(o.getValue("preloadLibCss").indexOf(t)<0){this.includeLibraryTheme(t,e.variant,e)}};g.prototype.includeLibraryTheme=function(s,i,r){e(typeof s==="string","sLibName must be a string");e(i===undefined||typeof i==="string","sVariant must be a string or undefined");var a=r;if(typeof a==="object"){a=k(r)}if(s!="sap.ui.legacy"&&s!="sap.ui.classic"){if(!i){i=""}var n=/^(true|x)$/i.test(o.getValue("xx-cssVariables"))?"_skeleton":"";var h=o.getRTL()?"-RTL":"";var u,d=s+(i.length>0?"-["+i+"]":i);if(s&&s.indexOf(":")==-1){u="library"+i+n+h}else{u=s.substring(s.indexOf(":")+1)+i;s=s.substring(0,s.indexOf(":"))}var c="sap-ui-theme-"+d;var l=document.getElementById(c)&&document.getElementById(c).href;var f=new URL(this._getThemePath(s,this.sTheme),document.baseURI).toString();var p=document.createElement("link");p.href=f+u+".css"+(a?a:"");var g=p.href;p.href=f+"css_variables.css"+(a?a:"");var T=p.href;if(!(g===l||T===l)){C(c);if(/^(true|x|additional)$/i.test(o.getValue("xx-cssVariables"))){t.info("Including "+T+" -  sap.ui.core.theming.ThemeManager.includeLibraryTheme()");m(T,c);c="sap-ui-themeskeleton-"+d;C(c)}t.info("Including "+g+" -  sap.ui.core.theming.ThemeManager.includeLibraryTheme()");m(g,c);var v=sap.ui.require("sap/ui/core/theming/Parameters");if(v){v._addLibraryTheme(d)}this.checkThemeChanged()}}};g.prototype._getThemePath=function(e,t){b(e,t);return sap.ui.require.toUrl((e+".themes."+t).replace(/\./g,"/")+"/")};function b(e,t){if(c._mThemeRoots){var s=c._mThemeRoots[t+" "+e]||c._mThemeRoots[t];if(s){s=s+e.replace(/\./g,"/")+"/themes/"+t+"/";i.registerResourcePath((e+".themes."+t).replace(/\./g,"/"),s)}}}g.prototype.setThemeRoot=function(t,s,i,r){e(typeof t==="string","sThemeName must be a string");e(Array.isArray(s)&&typeof i==="string"||typeof s==="string"&&i===undefined,"either the second parameter must be a string (and the third is undefined), or it must be an array and the third parameter is a string");if(!this._mThemeRoots){this._mThemeRoots={}}if(typeof s==="string"){r=i;i=s;s=undefined}i=i+(i.slice(-1)=="/"?"":"/");if(s){for(var a=0;a<s.length;a++){var n=s[a];this._mThemeRoots[t+" "+n]=i}}else{this._mThemeRoots[t]=i}if(r&&t===this.sTheme){this._updateThemeUrls(this.sTheme)}};g.prototype._updateThemeUrls=function(e,t){var s=document.querySelectorAll("link[id^=sap-ui-theme-],link[id^=sap-ui-themeskeleton-]");Array.prototype.forEach.call(s,function(s){_(s,e,t)})};function _(e,t,s){var i,r=e.href.search(/[?#]/),a,n,h="library",u=o.getRTL()?"-RTL":"",d,l;var p=/^sap-ui-theme(?:skeleton)?-(.*)$/i.exec(e.id);if(Array.isArray(p)){i=p[1]}else{i=e.id.slice(13)}f[i]=f[i]||{};if(r>-1){a=e.href.substring(0,r);n=e.href.substring(r)}else{a=e.href;n=""}a=a.substring(a.lastIndexOf("/")+1);if((l=i.indexOf("-["))>0){h+=i.slice(l+2,-1);i=i.slice(0,l)}if(a===h+".css"||a===h+"-RTL.css"){a=h+u+".css"}d=c._getThemePath(i,t)+a+n;if(d!=e.href){if(s){e.dataset.sapUiFoucmarker=e.id}m(d,e.id)}}g.prototype.applyTheme=function(t,s,i){e(typeof t==="string","sThemeName must be a string");e(typeof s==="string"||typeof s==="undefined","sThemeBaseUrl must be a string or undefined");t=o.normalizeTheme(t,s);if(s){this.setThemeRoot(t,s)}if(t&&this.sTheme!=t||i){var r=this.sTheme;var a=document.documentElement;this._updateThemeUrls(t,true);this.sTheme=t;o.setTheme(t);a.classList.remove("sapUiTheme-"+r);a.classList.add("sapUiTheme-"+t);this.checkThemeChanged()}};function k(e){var t;if(o.getValue("versionedLibCss")&&e){t="?version="+e.version;if(a.versioninfo){t+="&sap-ui-dist-version="+a.versioninfo.version}}return t}function S(e){var s=o.getValue("themeRoots");if(s){for(var i in s){var r=s[i];if(typeof r==="string"){e.setThemeRoot(i,r)}else{for(var a in r){if(a.length>0){e.setThemeRoot(i,[a],r[a])}else{e.setThemeRoot(i,r[a])}}}}}e.sTheme=o.getTheme();document.documentElement.classList.add("sapUiTheme-"+e.sTheme);t.info("Declared theme "+e.sTheme,null)}g.prototype.notifyContentDensityChanged=function(){this.fireThemeChanged()};g.prototype.fireThemeChanged=function(e){var t=sap.ui.require("sap/ui/core/theming/Parameters");if(t){t._reset(true)}e=e||{};if(!e.theme){e.theme=o.getTheme()}var s="ThemeChanged";var i=jQuery.Event(s);i.theme=e.theme;h.registry.forEach(function(e){e._handleEvent(i)});u.refresh();this.fireEvent(s,e)};c=new g;return c});
//# sourceMappingURL=ThemeManager.js.map