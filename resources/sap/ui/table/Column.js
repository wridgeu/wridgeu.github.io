/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ColumnMenu","./utils/TableUtils","./library","sap/ui/core/Element","sap/ui/core/Popup","sap/ui/core/library","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","sap/ui/model/Type","sap/ui/model/type/String","sap/base/util/ObjectPath","sap/base/util/JSTokenizer","sap/base/util/deepClone","sap/base/Log"],function(e,t,r,i,n,a,o,s,l,u,p,f,g,h,d,y){"use strict";var c=a.HorizontalAlign,m=r.SortOrder,b=a.ValueState;var v={Standard:"Standard",Creation:"Creation"};var _=t.createWeakMapFacade();var C=new window.WeakMap;var T=i.extend("sap.ui.table.Column",{metadata:{library:"sap.ui.table",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},minWidth:{type:"int",group:"Dimension",defaultValue:0},flexible:{type:"boolean",group:"Behavior",defaultValue:true,deprecated:true},resizable:{type:"boolean",group:"Behavior",defaultValue:true},hAlign:{type:"sap.ui.core.HorizontalAlign",group:"Appearance",defaultValue:c.Begin},sorted:{type:"boolean",group:"Appearance",defaultValue:false},sortOrder:{type:"sap.ui.table.SortOrder",group:"Appearance",defaultValue:m.Ascending},sortProperty:{type:"string",group:"Behavior",defaultValue:null},filtered:{type:"boolean",group:"Appearance",defaultValue:false},filterProperty:{type:"string",group:"Behavior",defaultValue:null},filterValue:{type:"string",group:"Behavior",defaultValue:null},filterOperator:{type:"string",group:"Behavior",defaultValue:null},defaultFilterOperator:{type:"string",group:"Behavior",defaultValue:null},filterType:{type:"any",group:"Misc",defaultValue:null},grouped:{type:"boolean",group:"Appearance",defaultValue:false},visible:{type:"boolean",group:"Appearance",defaultValue:true},name:{type:"string",group:"Appearance",defaultValue:null},showFilterMenuEntry:{type:"boolean",group:"Appearance",defaultValue:true},showSortMenuEntry:{type:"boolean",group:"Appearance",defaultValue:true},headerSpan:{type:"any",group:"Behavior",defaultValue:1},autoResizable:{type:"boolean",group:"Behavior",defaultValue:false}},defaultAggregation:"label",aggregations:{label:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false},multiLabels:{type:"sap.ui.core.Control",multiple:true,singularName:"multiLabel"},template:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false},creationTemplate:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},menu:{type:"sap.ui.unified.Menu",multiple:false}},events:{columnMenuOpen:{allowPreventDefault:true,parameters:{menu:{type:"sap.ui.unified.Menu"}}}}}});T._DEFAULT_FILTER_TYPE=new f;T.prototype.init=function(){this.mSkipPropagation={template:true,creationTemplate:true};_(this).oSorter=null;_(this).mCellContentVisibilitySettings=V(this);_(this).bHasDefaultLabel=false;_(this).bHasDefaultTemplate=false;this._initTemplateClonePool()};T.prototype._initTemplateClonePool=function(){this._mTemplateClones=Object.keys(v).reduce(function(e,t){e[t]=[];return e},{})};T.prototype.exit=function(){this._destroyTemplateClones()};T.prototype.setParent=function(){var e=i.prototype.setParent.apply(this,arguments);var t=this.getAggregation("menu");if(t&&typeof t._updateReferences==="function"){t._updateReferences(this)}return e};T.prototype.invalidate=function(e){if(e!==this.getTemplate()&&e!==this.getCreationTemplate()&&!t.isA(e,"sap.ui.table.ColumnMenu")){i.prototype.invalidate.apply(this,arguments)}};T.prototype.setLabel=function(e){var t=e;if(typeof e==="string"){if(_(this).bHasDefaultLabel){this.getLabel().setText(e);return this}t=r.TableHelper.createLabel({text:e});_(this).bHasDefaultLabel=true}else if(_(this).bHasDefaultLabel){this.destroyLabel();_(this).bHasDefaultLabel=false}return this.setAggregation("label",t)};T.prototype.setTemplate=function(e){var t=e;var i=this._getTable();var n=this.getTemplate();var a=true;if(typeof e==="string"){if(_(this).bHasDefaulTemplate){this.getTemplate().bindProperty("text",e);a=false}else{t=r.TableHelper.createTextView().bindProperty("text",e);_(this).bHasDefaulTemplate=true}}else if(_(this).bHasDefaulTemplate){this.destroyTemplate();_(this).bHasDefaulTemplate=false}if(a){this.setAggregation("template",t,true)}if(this.getVisible()){this.invalidate()}this._destroyTemplateClones("Standard");if(i&&this.getVisible()){if(t){i.invalidateRowsAggregation()}if(!n||!t){var o=i.getCreationRow();if(o){o._update()}}}return this};T.prototype.destroyTemplate=function(){this.destroyAggregation("template");this._destroyTemplateClones("Standard");var e=this._getTable();var t=e?e.getCreationRow():null;if(t){t._update()}return this};T.prototype.setCreationTemplate=function(e){var t=this._getTable();this.setAggregation("creationTemplate",e,true);this._destroyTemplateClones("Creation");if(e&&t&&this.getVisible()){var r=t.getCreationRow();if(r){r._update()}}return this};T.prototype.getCreationTemplate=function(){return this.getAggregation("creationTemplate")};T.prototype.destroyCreationTemplate=function(){this.destroyAggregation("creationTemplate",true);this._destroyTemplateClones("Creation");return this};T.prototype.getMenu=function(){var e=this.getAggregation("menu");if(!e){e=this._createMenu();this.setMenu(e)}return e};T.prototype.invalidateMenu=function(){var e=this.getAggregation("menu");if(this._bMenuIsColumnMenu){e._invalidate()}};T.prototype._menuHasItems=function(){var e=this.getAggregation("menu");var r=this._getTable();var i=(e?e.getItems().length>0:false)||(r?r.getEnableColumnFreeze():false)||(r?r.getShowColumnVisibilityMenu():false)||this.isSortableByMenu()||this.isFilterableByMenu()||this.isGroupable();if(i){return true}return t.Hook.call(r,t.Hook.Keys.Column.MenuItemNotification,this).some(function(e){return e})};T.prototype.isFilterableByMenu=function(){return!!(this.getFilterProperty()&&this.getShowFilterMenuEntry())};T.prototype.isSortableByMenu=function(){return!!(this.getSortProperty()&&this.getShowSortMenuEntry())};T.prototype.isGroupable=function(){var e=this.getParent();return!!(e&&e.getEnableGrouping&&e.getEnableGrouping()&&this.getSortProperty())};T.prototype.setMenu=function(e){this.setAggregation("menu",e,true);this._bMenuIsColumnMenu=t.isA(e,"sap.ui.table.ColumnMenu");return this};T.prototype._createMenu=function(){if(!this._defaultMenu){this._defaultMenu=new e(this.getId()+"-menu",{ariaLabelledBy:this})}return this._defaultMenu};T.prototype.setSortProperty=function(e){this.setProperty("sortProperty",e);this.invalidateMenu();return this};T.prototype.setSorted=function(e){this.setProperty("sorted",e,true);this._updateIcons();return this};T.prototype.setSortOrder=function(e){this.setProperty("sortOrder",e,true);this._updateIcons();return this};T.prototype.setFilterProperty=function(e){this.invalidateMenu();return this.setProperty("filterProperty",e)};T.prototype.setFiltered=function(e){this.setProperty("filtered",e,true);this._updateIcons();return this};T.prototype.setFilterValue=function(e){this.setProperty("filterValue",e,true);var t=this.getMenu();if(this._bMenuIsColumnMenu){t._setFilterValue(e)}return this};T.prototype.setFilterOperator=function(e){return this.setProperty("filterOperator",e,true)};T.prototype._openMenu=function(e){var t=this.getMenu();if(!this._menuHasItems()){return false}var r=this.fireColumnMenuOpen({menu:t});if(r){var i=n.Dock;var a=e;if(!e){e=this.getDomRef();a=this.getFocusDomRef()}t.open(null,a,i.BeginTop,i.BeginBottom,e);return true}else{return true}};T.prototype.toggleSort=function(){this.sort(this.getSorted()&&this.getSortOrder()===m.Ascending)};T.prototype.sort=function(e,t){var r=this.getParent();if(r){r.pushSortedColumn(this,t);var i=e?m.Descending:m.Ascending;var n=r.fireSort({column:this,sortOrder:i,columnAdded:t});if(n){var a=r.getSortedColumns();var o=r.getColumns();for(var s=0,l=o.length;s<l;s++){if(a.indexOf(o[s])<0){o[s].setProperty("sorted",false,true);o[s].setProperty("sortOrder",m.Ascending,true);o[s]._updateIcons(true);delete _(o[s]).oSorter}}this.setProperty("sorted",true,true);this.setProperty("sortOrder",i,true);_(this).oSorter=new u(this.getSortProperty(),this.getSortOrder()===m.Descending);var p=[];for(var s=0,l=a.length;s<l;s++){a[s]._updateIcons(true);p.push(_(a[s]).oSorter)}r._resetColumnHeaderHeights();r._updateRowHeights(r._collectRowHeights(true),true);var f=r.getBinding();if(f){if(this._updateTableAnalyticalInfo){this._updateTableAnalyticalInfo(true)}f.sort(p)}else{y.warning("Sorting not performed because no binding present",this)}}}return this};T.prototype._updateIcons=function(e){var t=this.getParent(),r=this.getSorted(),i=this.getFiltered();if(!t||!t.getDomRef()){return}this.$().parents(".sapUiTableCHT").find('td[data-sap-ui-colindex="'+this.getIndex()+'"]:not([colspan]):not(.sapUiTableHidden):first').toggleClass("sapUiTableColFiltered",i).toggleClass("sapUiTableColSorted",r).toggleClass("sapUiTableColSortedD",r&&this.getSortOrder()===m.Descending);t._getAccExtension().updateAriaStateOfColumn(this);if(!e){t._resetColumnHeaderHeights();t._updateRowHeights(t._collectRowHeights(true),true)}};T.prototype._renderSortIcon=function(){this._updateIcons()};T.prototype._getFilter=function(){var e,t=this.getFilterProperty(),r=this.getFilterValue(),i=this.getFilterOperator(),n,a,l=this.getFilterType()||T._DEFAULT_FILTER_TYPE,u=l instanceof f,p;if(r){if(!i){p=r.match(/(.*)\s*\.\.\s*(.*)/);if(r.indexOf("=")==0){i=s.EQ;n=r.substr(1)}else if(r.indexOf("!=")==0){i=s.NE;n=r.substr(2)}else if(r.indexOf("<=")==0){i=s.LE;n=r.substr(2)}else if(r.indexOf("<")==0){i=s.LT;n=r.substr(1)}else if(r.indexOf(">=")==0){i=s.GE;n=r.substr(2)}else if(r.indexOf(">")==0){i=s.GT;n=r.substr(1)}else if(p){if(p[1]&&p[2]){i=s.BT;n=p[1];a=p[2]}else if(p[1]&&!p[2]){i=s.GE;n=p[1]}else{i=s.LE;n=p[2]}}else if(u&&r.indexOf("*")==0&&r.lastIndexOf("*")==r.length-1){i=s.Contains;n=r.substr(1,r.length-2)}else if(u&&r.indexOf("*")==0){i=s.EndsWith;n=r.substr(1)}else if(u&&r.lastIndexOf("*")==r.length-1){i=s.StartsWith;n=r.substr(0,r.length-1)}else{if(this.getDefaultFilterOperator()){i=this.getDefaultFilterOperator()}else{if(u){i=s.Contains}else{i=s.EQ}}n=r.substr(0)}if(!a){e=new o(t,i,this._parseFilterValue(n))}else{e=new o(t,i,this._parseFilterValue(n),this._parseFilterValue(a))}}else{e=new o(t,i,this._parseFilterValue(r))}}return e};T.prototype.filter=function(e){var t=this.getParent();if(t&&t.isBound("rows")){var r=t.fireFilter({column:this,value:e});if(r){this.setProperty("filtered",!!e,true);this.setProperty("filterValue",e,true);var i=this.getMenu();if(this._bMenuIsColumnMenu){i._setFilterValue(e)}var n=[];var a=t.getColumns();for(var o=0,s=a.length;o<s;o++){var u=a[o],p;i=u.getMenu();try{p=u._getFilter();if(u._bMenuIsColumnMenu){i._setFilterState(b.None)}}catch(e){if(u._bMenuIsColumnMenu){i._setFilterState(b.Error)}continue}if(p){n.push(p)}}t.getBinding().filter(n,l.Control);this._updateIcons()}}return this};T.prototype._parseFilterValue=function(e){var t=this.getFilterType();if(t){if(typeof t==="function"){e=t(e)}else{e=t.parseValue(e,"string")}}return e};T.prototype.shouldRender=function(){return this.getVisible()&&!this.getGrouped()&&this.getTemplate()!=null};T.prototype.setProperty=function(e,t){var r=this._getTable();var n=r&&this.getProperty(e)!=t;var a=n&&e==="visible";var o=n&&(e==="visible"||e==="headerSpan");var s=i.prototype.setProperty.apply(this,arguments);if(a){r.invalidateRowsAggregation();var l=r.getCreationRow();if(l){l._update()}}if(o){r._invalidateComputedFixedColumnCount()}return s};T.prototype.setFilterType=function(e){var t=e;if(typeof e==="string"){try{var r=h.parseJS(e);if(typeof r.type==="string"){var i=g.get(r.type);t=i&&new i(r.formatOptions,r.constraints)}}catch(r){var i=g.get(e);t=i&&new i}if(!(t instanceof p)){y.error("The filter type is not an instance of sap.ui.model.Type! Ignoring the filter type!");t=undefined}}this.setProperty("filterType",t,true);return this};T.prototype.getIndex=function(){var e=this.getParent();if(e){return e.indexOfColumn(this)}else{return-1}};T.prototype._getFreeTemplateClone=function(e){var t=this._mTemplateClones[e];var r=null;if(!t){return null}for(var i=0;i<t.length;i++){if(!t[i]||t[i].bIsDestroyed){t.splice(i,1);i--}else if(!r&&!t[i].getParent()){r=t[i]}}return r};T.prototype.getTemplateClone=function(e,t){if(typeof e!=="number"||this.getTemplate()==null){return null}var r=t==null?"Standard":t;var i=this._getFreeTemplateClone(r);if(!i&&v.hasOwnProperty(r)){var n=this["get"+(r==="Standard"?"":r)+"Template"];var a=n.call(this);if(a){i=a.clone();this._mTemplateClones[r].push(i)}}if(i){C.set(i,this);var o=this.getParent();if(o){o._getAccExtension().addColumnHeaderLabel(this,i)}}return i};function S(e){for(var t=0;t<e.length;t++){if(e[t]!=null&&!e[t].bIsDestroyed){e[t].destroy()}}}T.prototype._destroyTemplateClones=function(e){if(e==null){for(var t in v){S(this._mTemplateClones[t])}this._initTemplateClonePool()}else{S(this._mTemplateClones[e]);this._mTemplateClones[e]=[]}};T.prototype._closeMenu=function(){var e=this.getAggregation("menu");if(e){e.close()}};T.prototype._getTable=function(){var e=this.getParent();return t.isA(e,"sap.ui.table.Table")?e:null};T.prototype._setCellContentVisibilitySettings=function(e){P(e);_(this).mCellContentVisibilitySettings=V(this,e)};T.prototype._getCellContentVisibilitySettings=function(){return _(this).mCellContentVisibilitySettings};function P(e){if(e==null){return}M(e,null,false,["standard","groupHeader","summary"]);M(e.standard,"standard",true);M(e.groupHeader,"groupHeader",true,["nonExpandable","expanded","collapsed"]);M(e.summary,"summary",true,["group","total"])}function M(e,t,r,i){if(e!=null&&!(r&&typeof e==="boolean"||i&&typeof e==="object")){throw new Error("Invalid value"+(t?" for '"+t+"'":""))}if(i&&e!=null&&typeof e==="object"){Object.keys(e).forEach(function(r){if(i.includes(r)){if(t!=null){M(e[r],t+"."+r,true)}}else{throw new Error("Unsupported setting '"+(t?t+".":"")+r+"'")}})}}function V(e,t){t=t?t:{};return{standard:F(t.standard),groupHeader:{nonExpandable:F(t.groupHeader,"nonExpandable"),expanded:F(t.groupHeader,"expanded"),collapsed:F(t.groupHeader,"collapsed")},summary:{group:F(t.summary,"group"),total:F(t.summary,"total")}}}function F(e,t){if(typeof e==="boolean"){return e}else if(t&&e){return e[t]!==false}else{return true}}T.ofCell=function(e){return C.get(e)||null};return T});