/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/base/Log","sap/base/util/isEmptyObject"],function(e,i,t){"use strict";var n=e.extend("sap.ui.support.supportRules.WindowCommunicationBus",{constructor:function(i){e.call(this);this.bSilentMode=false;this._channels={};this._frame={};this._oConfig=i;if(window.addEventListener){window.addEventListener("message",this._onmessage.bind(this),false)}else{window.attachEvent("onmessage",this._onmessage.bind(this))}}});n.prototype.subscribe=function(e,i,t){if(this.bSilentMode){return}this._channels[e]=this._channels[e]||[];this._channels[e].push({callback:i,context:t})};n.prototype.publish=function(e,i){if(this.bSilentMode){return}var t=this._oConfig.getReceivingWindow();var n={channelName:e,params:i,_frameIdentifier:this._getFrameIdentifier(),_origin:window.location.href};t.postMessage(n,this._oConfig.getOrigin())};n.prototype.allowFrame=function(e){this._frame={origin:e.origin,identifier:e.identifier,url:e.url}};n.prototype.destroyChannels=function(){this._channels={}};n.prototype._onmessage=function(e){if(!this._validate(e)){i.error("Message was received but failed validation");return}var t=this._channels[e.data.channelName]||[];t.forEach(function(i){i.callback.apply(i.context,[e.data.params])})};n.prototype._validate=function(e){if(t(this._frame)){return true}var i=e.data._frameIdentifier===this._frame.identifier;var n=new RegExp("^"+this._frame.origin+"$","i");var a=n.exec(e.origin);var r=this._frame.url.indexOf("?");var s=this._frame.url.substr(0,r).replace(/\.\.\//g,"").replace(/\.\//g,"")+this._frame.url.substr(r);var o=e.data._origin.indexOf(s)>-1;return i&&a&&o};n.prototype._getFrameIdentifier=function(){return this._frame.identifier||this._oConfig.getFrameId()};return n},true);