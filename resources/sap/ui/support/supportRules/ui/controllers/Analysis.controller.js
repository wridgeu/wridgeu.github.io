/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/deepExtend","sap/ui/support/supportRules/ui/controllers/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/MessageToast","sap/ui/support/supportRules/CommunicationBus","sap/ui/support/supportRules/WCBChannels","sap/ui/support/supportRules/ui/models/SharedModel","sap/ui/support/supportRules/RuleSerializer","sap/ui/support/supportRules/Constants","sap/ui/support/supportRules/Storage","sap/ui/support/supportRules/util/EvalUtils","sap/ui/support/supportRules/ui/models/SelectionUtils","sap/ui/support/supportRules/ui/controllers/PresetsController","sap/ui/support/supportRules/ui/models/PresetsUtils","sap/ui/support/supportRules/ui/models/CustomJSONListSelection"],function(e,t,i,s,o,r,l,n,u,a,d,c,p,h,f,g){"use strict";return t.extend("sap.ui.support.supportRules.ui.controllers.Analysis",{onInit:function(){this.model=n;this.setCommunicationSubscriptions();this.tempRulesLoaded=false;this.getView().setModel(this.model);this.treeTable=p.treeTable=this.byId("ruleList");this._oRuleSetsModel=new i;this.treeTable.setModel(this._oRuleSetsModel,"ruleSets");this.ruleSetView=this.byId("ruleSetsView");this.rulesViewContainer=this.byId("rulesNavContainer");this.bAdditionalViewLoaded=false;this.bAdditionalRulesetsLoaded=false;this.oApplicationinfo={};new g(this.treeTable,true,"id");r.subscribe(l.UPDATE_SUPPORT_RULES,function(){if(!this.bAdditionalViewLoaded){r.publish(l.RESIZE_FRAME,{bigger:true});this.bAdditionalViewLoaded=true;this.loadAdditionalUI()}},this);if(this.model.getProperty("/persistingSettings")){var e=d.getVisibleColumns()||[];if(e.length){this.setColumnVisibility(e,true)}}this.byId("presetVariant").addEventDelegate({onclick:this.onPresetVariantClick.bind(this)});this.treeTable.attachEvent("rowSelectionChange",function(e){if(e.getParameter("userInteraction")){f.syncCurrentSelectionPreset(p.getSelectedRules())}});this.byId("rowActionTemplate").setVisible(!this.model.getProperty("/tempRulesDisabled"))},loadAdditionalUI:function(){if(!this._ruleDetails){this._ruleDetails=s.load({name:"sap.ui.support.supportRules.ui.views.RuleDetails",controller:this}).then(function(e){this.byId("rulesDisplayPage").addContentArea(e)}.bind(this))}if(!this._ruleCreateUpdatePages){this._ruleCreateUpdatePages=s.load({name:"sap.ui.support.supportRules.ui.views.RuleUpdate",controller:this}).then(function(e){e.forEach(function(e){this.byId("rulesNavContainer").insertPage(e)},this)}.bind(this))}this._updateRuleList()},onAfterRendering:function(){var e=function(){r.publish(l.ON_INIT_ANALYSIS_CTRL);sap.ui.getCore().detachThemeChanged(e)};if(sap.ui.getCore().isThemeApplied()){r.publish(l.ON_INIT_ANALYSIS_CTRL)}else{sap.ui.getCore().attachThemeChanged(e)}},onAsyncSwitch:function(e){var t=e.getSource();if(e.getParameter("selected")){var i=t.getCustomData()[0].getValue()==="true";var s=t.getProperty("groupName")==="asyncContext"?"/newRule":"/editRule";this.model.setProperty(s+"/async",i);this._updateCheckFunction(s,i)}},_updateCheckFunction:function(e,t){var i=this.model.getProperty(e+"/check");if(!i){return}var s=i.match(/function[^(]*\(([^)]*)\)/);if(!s){return}var o=s[1].trim().split(/\W+/);o[0]=o[0]||"oIssueManager";o[1]=o[1]||"oCoreFacade";o[2]=o[2]||"oScope";if(t){o[3]=o[3]||"fnResolve"}else{o=o.slice(0,3)}var r=i.replace(/function[^(]*\(([^)]*)\)/,"function ("+o.join(", ")+")");this.model.setProperty(e+"/check",r)},getTemporaryLib:function(){var t=this.model.getProperty("/libraries");for(var i=0;i<t.length;i++){if(t[i].title==a.TEMP_RULESETS_NAME){return e({},t[i])}}return null},setTemporaryLib:function(e){var t=this.model.getProperty("/libraries");for(var i=0;i<t.length;i++){if(t[i].title==a.TEMP_RULESETS_NAME){this.model.setProperty("/libraries/"+i,e);return}}},setCommunicationSubscriptions:function(){if(!this.model.getProperty("/tempRulesDisabled")){this._setTempRulesCommunicationSubscriptions()}r.subscribe(l.UPDATE_SUPPORT_RULES,this.updateSupportRules,this);r.subscribe(l.POST_AVAILABLE_LIBRARIES,function(e){this.bAdditionalRulesetsLoaded=true;this.model.setProperty("/availableLibrariesSet",e.libNames);this.rulesViewContainer.setBusy(false)},this);r.subscribe(l.POST_APPLICATION_INFORMATION,function(e){this.oApplicationinfo=e},this);r.subscribe(l.POST_AVAILABLE_COMPONENTS,function(e){var t=[],i=this.model.getProperty("/executionScopeComponents"),s=d.getSelectedScopeComponents(),o;for(var r=0;r<e.length;r+=1){t.push({text:e[r]})}if(i&&i.length>0){for(o=0;o<t.length;o++){t[o].selected=this.checkIfComponentIsSelected(t[o],i)}}else if(s&&s.length>0){for(o=0;o<t.length;o++){t[o].selected=this.checkIfComponentIsSelected(t[o],s)}}this.model.setProperty("/executionScopeComponents",t)},this);r.subscribe(l.GET_RULES_MODEL,function(e){var t=d.readPersistenceCookie(a.COOKIE_NAME),i=this.model.getProperty("/loadingAdditionalRuleSets");if(i){p._syncSelectionAdditionalRuleSetsMainModel(e,this._oRuleSetsModel.getData());p._deselectAdditionalRuleSets(e,this.model.getProperty("/namesOfLoadedAdditionalRuleSets"))}if(t){this.initializeTempRules();var s=p.updateSelectedRulesFromLocalStorage(e);if(s){e=s}f.loadCustomPresets()}this._oRuleSetsModel.setData(e);if(t||i){this.treeTable.updateSelectionFromModel()}else{this.treeTable.selectAll()}this.model.setProperty("/selectedRulesCount",p.getSelectedRules().length);f.initializeSelectionPresets(p.getSelectedRules())},this);r.subscribe(l.POST_MESSAGE,function(e){o.show(e.message)},this);r.subscribe(l.ON_ANALYZE_STARTED,function(e){this.model.setProperty("/showProgressIndicator",true)},this)},checkIfComponentIsSelected:function(e,t){for(var i=0;i<t.length;i+=1){if(t[i].text==e.text&&t[i].selected){return true}}return false},onAnalyze:function(){var e=this.model.getProperty("/selectionPresetsCurrent"),t=this._getExecutionContext();if(e.selections.length===0){o.show("Select some rules to be analyzed.");return}if(t.type==="components"&&t.components.length===0){o.show("Please select some components to be analyzed.");return}r.publish(l.ON_ANALYZE_REQUEST,{rulePreset:e,executionContext:t})},_getExecutionContext:function(){var e={type:this.model.getProperty("/analyzeContext/key")};if(e.type==="subtree"){e.parentId=this.model.getProperty("/subtreeExecutionContextId")}if(e.type==="components"){var t=sap.ui.getCore().byId("componentsSelectionContainer"),i=t.getContent();e.components=[];i.forEach(function(t){if(t.getSelected()){e.components.push(t.getText())}})}return e},onSelectedRuleSets:function(e){var t=true,i=this.model.getProperty("/selectedRule"),s=e.getParameter("selectedKey")==="additionalRulesets";if(s||!i){t=false}if(!this.bAdditionalRulesetsLoaded&&s){this.rulesViewContainer.setBusyIndicatorDelay(0);this.rulesViewContainer.setBusy(true);r.publish(l.GET_NON_LOADED_RULE_SETS,{loadedRulesets:this._getLoadedRulesets()})}this.getView().getModel().setProperty("/showRuleProperties",t)},_getLoadedRulesets:function(){var e=this.treeTable.getModel("ruleSets").getData(),t=[];Object.keys(e).forEach(function(i){var s=e[i].name;if(s&&s!=="temporary"){t.push(s)}});return t},_applyTempRulesSelection:function(t){var i=e({},this._oRuleSetsModel.getData()),s,o,r,l,n,u,d=function(e){return e.id===o.id};for(var c in i){s=i[c];r=i[c].nodes;if(s.name!==a.TEMP_RULESETS_NAME){continue}i[c].nodes=[];for(var p in t.rules){o=t.rules[p];l=r[p]!==undefined?r[p].selected:true;if(this.tempRulesFromStorage){n=this.tempRulesFromStorage.filter(d);if(n.length>0){l=n[0].selected;u=this.tempRulesFromStorage.indexOf(n[0]);this.tempRulesFromStorage.splice(u,1);if(l===false){s.selected=false}}if(this.tempRulesFromStorage.length===0){this.tempRulesFromStorage.length=null}}s.nodes.push({name:o.title,description:o.description,id:o.id,audiences:o.audiences.toString(),categories:o.categories.toString(),minversion:o.minversion,resolution:o.resolution,title:o.title,selected:l,libName:s.name,check:o.check})}}this._oRuleSetsModel.setData(i)},_syncTreeTableVieModelTempRule:function(e,t){var i=this.model.getProperty("/editRuleSource");for(var s in t){if(t[s].name===a.TEMP_RULESETS_NAME){for(var o in t[s].nodes){if(t[s].nodes[o].id===i.id){t[s].nodes[o]={name:e.title,description:e.description,id:e.id,audiences:e.audiences,categories:e.categories,minversion:e.minversion,resolution:e.resolution,selected:t[s].nodes[o].selected,title:e.title,libName:t[s].name,check:e.check}}}}}},_hasSelectedComponent:function(){var e=sap.ui.getCore().byId("componentsSelectionContainer").getContent();function t(e){return e.getSelected()}return e.some(t)},onAnalyzeSettings:function(e){var t=e.getSource();r.publish(l.GET_AVAILABLE_COMPONENTS);if(!this._analyzeSettingsPopover){this._analyzeSettingsPopover=s.load({name:"sap.ui.support.supportRules.ui.views.AnalyzeSettings",controller:this}).then(function(e){this.getView().addDependent(e);return e}.bind(this))}this._analyzeSettingsPopover.then(function(e){e.openBy(t)})},onContextSelect:function(e){if(e.getParameter("selected")){var t=e.getSource(),i=t.getCustomData()[0].getValue(),s=this.model.getProperty("/executionScopes")[i];if(i==="components"&&!this._hasSelectedComponent()){var o=sap.ui.getCore().byId("componentsSelectionContainer").getContent();if(o.length>0){o[0].setSelected(true);this.onScopeComponentSelect(null)}}this.model.setProperty("/analyzeContext",s)}if(d.readPersistenceCookie(a.COOKIE_NAME)){this.persistExecutionScope()}},onExecutionContextChange:function(e){var t=e.getSource().getValue();if(t){this.model.setProperty("/subtreeExecutionContextId",t)}if(d.readPersistenceCookie(a.COOKIE_NAME)){this.persistExecutionScope()}},onScopeComponentSelect:function(e){var t=this.model.getProperty("/executionScopeComponents");if(d.readPersistenceCookie(a.COOKIE_NAME)){d.setSelectedScopeComponents(t)}},onBeforePopoverOpen:function(){if(this.model.getProperty("/executionScopeComponents").length===0){r.publish(l.GET_AVAILABLE_COMPONENTS)}},createNewRulePress:function(t){var i=this.model.getProperty("/newEmptyRule");this.model.setProperty("/selectedSetPreviewKey","availableRules");this.model.setProperty("/newRule",e({},i));this.model.setProperty("/tempLink",{href:"",text:""});this.goToCreateRule()},goToRuleProperties:function(){var e=this.byId("rulesNavContainer");e.to(this.byId("rulesDisplayPage"),"show")},createRuleString:function(e){if(!e){return""}var t="{\n",i=0,s=Object.keys(e).length;for(var o in e){var r=e[o];i++;t+="\t";t+=o+": ";if(o==="check"){t+=r.split("\n").join("\n\t")}else{t+=JSON.stringify(r)}if(i<s){t+=","}t+="\n"}t+="}";return t},updateRule:function(){var e=this.model.getProperty("/editRuleSource/id"),t=this.model.getProperty("/editRule");if(this.checkFunctionString(t.check)){r.publish(l.VERIFY_UPDATE_RULE,{oldId:e,updateObj:u.serialize(t)})}},updateSupportRules:function(e){e=u.deserialize(e.sRuleSet);r.publish(l.REQUEST_RULES_MODEL,e);var t=[],i=this;for(var s in e){var n=[],a=e[s].ruleset._mRules;for(var d in a){var c=a[d];c.libName=s;c.selected=true;n.push(c)}t.push({title:s,type:"library",rules:n,selected:true})}var p;if(t[0].rules[0]){p=t[0].rules[0]}else{p=t[1].rules[0]}i.placeTemporaryRulesetAtStart(t);i.model.setProperty("/selectedRuleStringify","");i.model.setProperty("/selectedRule",p);i.model.setProperty("/selectedRuleStringify",i.createRuleString(p));i.model.setProperty("/libraries",t);var h=i.model.getProperty("/loadingAdditionalRuleSets");if(h){o.show("Additional rule set(s) loaded!");this.ruleSetView.setSelectedKey("availableRules")}},initializeTempRules:function(){if(this.model.getProperty("/tempRulesDisabled")){return}var e=d.getRules(),t=this.model.getProperty("/loadingAdditionalRuleSets");if(e&&!t&&!this.tempRulesLoaded){this.tempRulesFromStorage=e;this.tempRulesLoaded=true;e.forEach(function(e){r.publish(l.VERIFY_CREATE_RULE,u.serialize(e))});this.persistedTempRulesCount=e.length}},placeTemporaryRulesetAtStart:function(e){for(var t=0;t<e.length;t++){var i=e[t];if(i.title===a.TEMP_RULESETS_NAME){var s=i;e.splice(t,1);e.unshift(s);return}}},addLinkToRule:function(t){var i=this.model.getProperty("/tempLink"),s=e({},i),o=t.getSource().getProperty("text"),r=o==="Add"?"/newRule":"/editRule",l=this.model.getProperty(r+"/resolutionurls");if(l){l.push(s)}else{this.model.setProperty(r+"/resolutionurls","");l.push(s)}this.model.setProperty("/tempLink",{href:"",text:""})},goToCreateRule:function(){var e=this.byId("rulesNavContainer");e.to(sap.ui.getCore().byId("rulesCreatePage"),"show")},checkFunctionString:function(e){try{c.evalFunction(e)}catch(e){o.show("Your check function contains errors, and can't be evaluated:"+e);return false}return true},addNewRule:function(){var e=this.model.getProperty("/newRule");if(this.checkFunctionString(e.check)){this.showRuleCreatedToast=true;r.publish(l.VERIFY_CREATE_RULE,u.serialize(e))}},rulesToolbarITHSelect:function(e){if(e.getParameter("key")==="jsonOutput"){var t=this.model.getProperty("/newRule"),i=this.createRuleString(t);this.model.setProperty("/newRuleStringified",i)}},rulesToolbarEditITHSelect:function(e){if(e.getParameter("key")==="jsonOutput"){var t=this.model.getProperty("/editRule"),i=this.createRuleString(t);this.model.setProperty("/updateRuleStringified",i)}},loadMarkedSupportLibraries:function(){var e=this.byId("availableLibrariesSet"),t=[],i=this.model.getProperty("/availableLibrariesSet");t=e.getSelectedItems().map(function(e){return e.getTitle()});e.getItems().forEach(function(e){e.setSelected(false)});if(t.length>0){i=i.filter(function(e){return t.indexOf(e)<0});this.model.setProperty("/availableLibrariesSet",i);this.model.setProperty("/namesOfLoadedAdditionalRuleSets",t);r.publish(l.LOAD_RULESETS,{aLibNames:{publicRules:t,internalRules:t}});this.model.setProperty("/loadingAdditionalRuleSets",true);this.model.setProperty("/showRuleProperties",true)}else{o.show("Select additional RuleSet to be loaded.")}},onCellClick:function(e){if(e.getParameter("rowBindingContext")){var t=e.getParameter("rowBindingContext").getObject(),i,s="",o=false;if(t.id&&t.type!=="lib"){i=this.getMainModelFromTreeViewModel(t);s=this.createRuleString(i);o=true}this.model.setProperty("/selectedRuleStringify",s);this.model.setProperty("/selectedRule",i);this.model.setProperty("/showRuleProperties",o)}},getMainModelFromTreeViewModel:function(e){var t=this.model.getProperty("/libraries"),i=null;t.forEach(function(s,o){t[o].rules.forEach(function(t){if(e.id===t.id){i=t}})});return i},_generateRuleId:function(e){var t=0,i=this.getTemporaryLib(),s=i.rules,o,r=function(i){return i.id===e+t};while(++t){o=s.some(r);if(!o){return e+t}}},duplicateRule:function(t){var i=t.getSource().getBindingContext("ruleSets").getPath(),s=this.treeTable.getBinding().getModel().getProperty(i),o=this.getMainModelFromTreeViewModel(s),r=e({},o);r.id=this._generateRuleId(r.id);this.model.setProperty("/newRule",r);this.goToCreateRule()},editRule:function(t){var i=t.getSource().getBindingContext("ruleSets").getPath(),s=this.treeTable.getBinding().getModel().getProperty(i),o=this.getMainModelFromTreeViewModel(s);this.model.setProperty("/editRuleSource",o);this.model.setProperty("/editRule",e({},o));var r=this.byId("rulesNavContainer");r.to(sap.ui.getCore().byId("ruleUpdatePage"),"show")},deleteTemporaryRule:function(t){var i=this.getObjectOnTreeRow(t),s=e({},this._oRuleSetsModel.getData()),o=this.model.getProperty("/libraries"),n;o.forEach(function(e){if(e.title===a.TEMP_RULESETS_NAME){n=e.rules.filter(function(e){return e.id!==i.id});e.rules=n}});for(var c in s){if(s[c].name===a.TEMP_RULESETS_NAME){for(var h in s[c].nodes){if(s[c].nodes[h].id===i.id){s[c].nodes.splice(h,1)}}}}this._oRuleSetsModel.setData(s);r.publish(l.DELETE_RULE,u.serialize(i));this._updateRuleList();f.syncCurrentSelectionPreset(p.getSelectedRules());if(d.readPersistenceCookie(a.COOKIE_NAME)){d.removeSelectedRules(n);p.persistSelection()}},getObjectOnTreeRow:function(e){var t=e.getSource().getBindingContext("ruleSets").getPath(),i=this.treeTable.getBinding().getModel().getProperty(t),s=this.model.getProperty("/libraries");s.forEach(function(e,t){e.rules.forEach(function(e){if(e.id===i.id){i.check=e.check}})});return i},_updateRuleList:function(){var e=this.getView().byId("ruleList"),t=this.getTemporaryLib(),i=t?t["rules"]:[];if(!i.length){e.setRowActionCount(1)}else{e.setRowActionCount(2)}},setColumnVisibility:function(e,t){var i=this.treeTable.getColumns();i.forEach(function(i){i.setVisible(!t);e.forEach(function(e){if(i.sId.includes(e)){i.setVisible(t)}})})},onColumnVisibilityChange:function(e){var t=e.getParameter("column"),i=e.getParameter("newVisible");if(!this.model.getProperty("/persistingSettings")){return}t.setVisible(i);this.persistVisibleColumns()},onPresetVariantClick:function(){if(!this._PresetsController){this._PresetsController=new h(this.model,this.getView())}this._PresetsController.openPresetVariant()},_setTempRulesCommunicationSubscriptions:function(){r.subscribe(l.VERIFY_RULE_CREATE_RESULT,function(t){var i=t.result,s=u.deserialize(t.newRule,true),r=this.getTemporaryLib();if(i=="success"){r.rules.push(s);this.setTemporaryLib(r);this._applyTempRulesSelection(r);f.syncCurrentSelectionPreset(p.getSelectedRules());if(d.readPersistenceCookie(a.COOKIE_NAME)){p.persistSelection();d.setRules(r.rules);if(this.showRuleCreatedToast){o.show('Your temporary rule "'+s.id+'" was persisted in the local storage');this.showRuleCreatedToast=false}}var l=this.model.getProperty("/newEmptyRule");this.model.setProperty("/newRule",e({},l));this.goToRuleProperties();this.model.setProperty("/selectedRule",s);this._updateRuleList();this.treeTable.updateSelectionFromModel()}else{o.show("Add rule failed because: "+i)}},this);r.subscribe(l.VERIFY_RULE_UPDATE_RESULT,function(e){var t=e.result,i=u.deserialize(e.updateRule,true),s=this;if(t==="success"){var r=this.model.getProperty("/editRuleSource"),l=this._oRuleSetsModel.getData(),n=this.model.getProperty("/libraries");n.forEach(function(e,t){if(e.title===a.TEMP_RULESETS_NAME){e.rules.forEach(function(t,o){if(t.id===r.id){e.rules[o]=i;if(s.model.getProperty("/persistingSettings")){d.setRules(e.rules)}}});s._syncTreeTableVieModelTempRule(i,l)}});this._oRuleSetsModel.setData(l);this.model.setProperty("/selectedRule",i);p.getSelectedRules();this.treeTable.updateSelectionFromModel();this.goToRuleProperties()}else{o.show("Update rule failed because: "+t)}},this)}})});