/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/VersionInfo","sap/ui/support/supportRules/RuleSet","sap/ui/support/supportRules/CommunicationBus","sap/ui/support/supportRules/WCBChannels","sap/ui/support/supportRules/RuleSerializer","sap/ui/support/supportRules/Constants","sap/ui/support/supportRules/util/Utils"],function(e,t,r,u,i,a,s,n){"use strict";var l=function(){var e;return function(t){if(!e){e=document.createElement("a")}e.href=t;return e.href.replace(/\/$/,"")}}();var o="sprt";var p=e.sap.getModulePath("sap.ui.support");var c=p.replace("/sap/ui/support","");var f=l(c);var h={};h._mRuleSets={};h._mRuleSets[s.TEMP_RULESETS_NAME]={lib:{name:s.TEMP_RULESETS_NAME},ruleset:new r({name:s.TEMP_RULESETS_NAME})};h.getRuleSets=function(){return this._mRuleSets};h.addRuleSet=function(e,t){this._mRuleSets[e]=t};h.getRuleSet=function(e){return this._mRuleSets[e]};h._fetchSupportRuleSets=function(e,s){var n=this,l=s||sap.ui.getCore().getLoadedLibraries(),o=this._fetchLibraryNamesWithSupportRules(l);var p=new Promise(function(s){t.load({library:"sap.ui.core"}).then(function(t){r.versionInfo=t;o.then(function(t){var l=n._fetchLibraryFiles(t,h._fetchRuleSet);Promise.all(l).then(function(){n._bRulesCreated=true;u.publish(i.UPDATE_SUPPORT_RULES,{sRuleSet:a.serialize(n._mRuleSets),oVersionInfo:r.versionInfo});s();if(e&&typeof e==="function"){e()}})})})});return p};h.loadAdditionalRuleSets=function(e){var t=this,r=t._fetchLibraryFiles(e,t._fetchRuleSet);Promise.all(r).then(function(){t._bRulesCreated=true;u.publish(i.UPDATE_SUPPORT_RULES,{sRuleSet:a.serialize(t._mRuleSets)})})};h._fetchLibraryNamesWithSupportRules=function(t){return new Promise(function(r){n.canLoadInternalRulesAsync().then(function(u){var i={publicRules:[],internalRules:[],allRules:[]};t=t||{};var a=[];Object.keys(t).forEach(function(t){var r=new Promise(function(r){var u=f+"/"+t.replace(/\./g,"/")+"/.supportrc";e.ajax({type:"GET",dataType:"json",url:u,success:function(e){r({lib:t,rcData:e})},error:function(){r({lib:t,rcData:null})}})});a.push(r)});Promise.all(a).then(function(e){e.forEach(function(e){if(e.rcData){var t=false;if(e.rcData.publicRules){i.publicRules.push(e.lib);t=true}if(u&&e.rcData.internalRules){i.internalRules.push(e.lib);t=true}if(t&&i.allRules.indexOf(e.lib)<0){i.allRules.push(e.lib)}}r(i)})})})})};h._fetchLibraryFiles=function(t,r,a){var s=[],l=this,o=e.sap.getModulePath("sap.ui.support"),p=o.replace("sap/ui/support",""),c=n.canLoadInternalRules(),f=c&&t.internalRules.length>0,h=0,R=t.publicRules.length;var S=sap.ui.getCore().getConfiguration().getSupportMode();var _=S&&S.indexOf("silent")>-1;if(f){R+=t.internalRules.length}function b(){h+=1;var e=Math.ceil(h/R*100);u.publish(i.CURRENT_LOADING_PROGRESS,{value:e})}if(t.publicRules.length>0){t.publicRules.forEach(function(e){var t=l._registerLibraryPath(e,o,p);if(t){var u=l._requireRuleSet(t.customizableLibName,r);if(!_&&!a){u.then(function(){b()})}s.push(u)}})}if(c&&t.internalRules.length>0){t.internalRules.forEach(function(e){var t=l._registerLibraryPath(e,o,p);if(t){var u=l._requireRuleSet(t.internalLibName,r);if(!_&&!a){u.then(function(){b()})}s.push(u)}})}return s};h._registerLibraryPath=function(t,r,u){if(this._mRuleSets[t]){return null}var i=t.replace(/\./g,"/");var a=t;var s=this._getLoadFromSupportOrigin();if(s){a+="."+o;e.sap.registerModulePath(a,u+t.replace(/\./g,"/"))}var n=a+".internal";var l=u.replace("resources/","")+"test-resources/"+i+"/internal";e.sap.registerModulePath(n,l);return{internalLibName:n,customizableLibName:a}};h._requireRuleSet=function(e,t){var r=this;return new Promise(function(u){try{sap.ui.require([e.replace(/\./g,"/")+"/library.support"],function(){t.call(r,e);u()},u)}catch(e){u()}})};h._fetchRuleSet=function(t){try{var u,i,a,n=e.sap.getObject(t).library.support;if(!n){throw"The library.support file was not fetched successfully."}u=t.replace("."+o,"").replace(".internal","");i=e.extend({},n);a=this._mRuleSets[u];if(!(i.ruleset instanceof r)){i=this._createRuleSet(i)}if(a){a.ruleset._mRules=e.extend(a.ruleset._mRules,i.ruleset._mRules)}else{a=i}this._mRuleSets[u]=a}catch(r){e.sap.log.error("["+s.SUPPORT_ASSISTANT_NAME+"] Failed to load RuleSet for "+t+" library",r)}};h._getLoadFromSupportOrigin=function(){var t=false;var r=new window.URI(e.sap.getModulePath("sap.ui.core"));var u=new window.URI(e.sap.getModulePath("sap.ui.support"));if(r.protocol()!==u.protocol()||r.host()!==u.host()){t=true}return t};h.fetchNonLoadedRuleSets=function(e){var t=[],r={};sap.ui.getVersionInfo().libraries.forEach(function(e){r[e.name]=e});this._fetchLibraryNamesWithSupportRules(r).then(function(r){r.allRules.forEach(function(r){if(e.indexOf(r)<0){t.push(r)}});u.publish(i.POST_AVAILABLE_LIBRARIES,{libNames:t})})};h._onLibraryChanged=function(e){var t=this;if(e.getParameter("stereotype")==="library"&&h._bRulesCreated){t._oMainPromise=h._fetchSupportRuleSets()}};h.updateRuleSets=function(e){this._oMainPromise=h._fetchSupportRuleSets(e)};h._createRuleSet=function(e){var t={name:e.name,niceName:e.niceName};var u=new r(t);for(var i=0;i<e.ruleset.length;i++){var a=e.ruleset[i];if(Array.isArray(a)){for(var s=0;s<a.length;s++){u.addRule(a[s])}}else{u.addRule(a)}}return{lib:t,ruleset:u}};h.getAllRules=function(){var t={};Object.keys(this._mRuleSets).map(function(r){t=e.extend(t,this._mRuleSets[r].ruleset.getRules())},this);return t};h.getAllRuleDescriptors=function(){var e=this.getAllRules();return Object.keys(e).map(function(t){return{libName:e[t].libName,ruleId:t}})};return h},true);