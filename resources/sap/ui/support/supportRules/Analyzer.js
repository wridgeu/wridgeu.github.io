/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/support/supportRules/IssueManager","sap/ui/support/supportRules/Constants"],function(e,t,i){"use strict";var s=function(){this.dStartedAt=null;this.dFinishedAt=null;this.iElapsedTime=0;this._iAllowedTimeout=1e4;this.reset()};s.prototype.reset=function(){this._iTotalProgress=0;this._iCompletedRules=0;this._iTotalRules=0;this._bRunning=false;this._aRulePromices=[]};s.prototype.running=function(){return this._bRunning};s.prototype.start=function(e,i,s){var n,o=this;this.dStartedAt=new Date;this._iTotalRules=e.length;this._bRunning=true;e.forEach(function(e){o._aRulePromices.push(new Promise(function(r){try{n=t.createIssueManagerFacade(e);if(e.async){o._runAsyncRule(n,i,s,e,r)}else{e.check(n,i,s);r();o._updateProgress()}}catch(t){o._handleException(t,e.id,r)}}))});return Promise.all(this._aRulePromices).then(function(){o.reset();o.dFinishedAt=new Date;o.iElapsedTime=o.dFinishedAt.getTime()-o.dStartedAt.getTime()})};s.prototype._handleException=function(t,s,n){var o=t.message||t;var r="["+i.SUPPORT_ASSISTANT_NAME+'] Error while execution rule "'+s+'": '+o;e.error(r);n();this._updateProgress()};s.prototype._updateProgress=function(){this._iCompletedRules++;this._iTotalProgress=Math.ceil(this._iCompletedRules/this._iTotalRules*100);if(this.onNotifyProgress){this.onNotifyProgress(this._iTotalProgress)}};s.prototype._runAsyncRule=function(e,t,i,s,n){var o=this,r=false;var u=setTimeout(function(){r=true;o._handleException("Check function timed out",s.id,n)},this._iAllowedTimeout);new Promise(function(n){s.check(e,t,i,n)}).then(function(){if(!r){clearTimeout(u);n();o._updateProgress()}}).catch(function(e){if(!r){clearTimeout(u);o._handleException(e,s.id,n)}})};s.prototype.getElapsedTimeString=function(){if(!this.iElapsedTime){return""}var e=new Date(null);e.setHours(0,0,0,0);e.setMilliseconds(this.iElapsedTime);var t=[(e.getHours()<10?"0":"")+e.getHours(),(e.getMinutes()<10?"0":"")+e.getMinutes(),(e.getSeconds()<10?"0":"")+e.getSeconds(),e.getMilliseconds()];return t.join(":")};return s});