/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/thirdparty/URI","sap/ui/base/Object","sap/base/util/restricted/_debounce","sap/ui/testrecorder/CommunicationBus","sap/ui/testrecorder/CommunicationChannels","sap/ui/testrecorder/Constants"],function(e,t,i,o,s,n,r){"use strict";var a=null;var d=false;var c=i.extend("sap.ui.testrecorder.UIContextInjector",{constructor:function(){if(!a){i.apply(this,arguments);this._sIdentifier=p()}else{return a}}});c.prototype.injectFrame=function(e,t){window.communicationWindows=window.communicationWindows||{};this._generateTestRecorderUrl();this.fnOnClose=t;this._isInIframe=e.indexOf("window")===-1;this._onResizeHandleMouseover=u.bind(this);this._onResizeHandleMousedown=l.bind(this);this._onResizeHandleMouseleave=h.bind(this);this._onDocumentMouseup=m.bind(this);this._onDocumentMousemove=f.bind(this);if(this._isInIframe){this.dockFrameBottom()}else{this._openWindow()}window.communicationWindows.testRecorder.addEventListener("beforeunload",function(){if(!this._dockStarted&&!this._closeTriggered){this.close()}}.bind(this));s.subscribe(n.MINIMIZE_IFRAME,this.minimizeFrame.bind(this));s.subscribe(n.SHOW_IFRAME,this.unminimizeFrame.bind(this));s.subscribe(n.CLOSE_IFRAME,this.close.bind(this));s.subscribe(n.OPEN_NEW_WINDOW,this.openNewWindow.bind(this));s.subscribe(n.DOCK_IFRAME_BOTTOM,this.dockFrameBottom.bind(this));s.subscribe(n.DOCK_IFRAME_RIGHT,this.dockFrameRight.bind(this));s.subscribe(n.DOCK_IFRAME_LEFT,this.dockFrameLeft.bind(this))};c.prototype.minimizeFrame=function(){this._iframe.style.width=r.FRAME.MINIMIZED.width;this._iframe.style.height=r.FRAME.MINIMIZED.height;Object.values(this._resizeHandles).forEach(function(e){e.style.display="none"})};c.prototype.unminimizeFrame=function(){switch(this._sRememberedDockSide){case r.DOCK.RIGHT:this.dockFrameRight();break;case r.DOCK.LEFT:this.dockFrameLeft();break;case r.DOCK.BOTTOM:default:this.dockFrameBottom();break}};c.prototype.dockFrameBottom=function(){this._dockFrame(r.DOCK.BOTTOM)};c.prototype.dockFrameRight=function(){this._dockFrame(r.DOCK.RIGHT)};c.prototype.dockFrameLeft=function(){this._dockFrame(r.DOCK.LEFT)};c.prototype._dockFrame=function(e){if(!this._iframe){this._dockStarted=true;this.close();this._openFrame()}this._sRememberedDockSide=e;for(var t in r.FRAME[e]){this._iframe.style[t]=r.FRAME[e][t]}Object.values(this._resizeHandles).forEach(function(e){e.style.display="none"});this._resizeHandles[e].style.display="block";for(var i in r.RESIZE_HANDLE[e]){this._resizeHandles[e].style[i]=r.RESIZE_HANDLE[e][i]}};c.prototype.openNewWindow=function(){this._dockStarted=true;this.close();this._openWindow()};c.prototype._openWindow=function(){window.communicationWindows.testRecorder=window.open(this._sUrl,"sapUiTestRecorder","width=1024,height=700,status=no,toolbar=no,menubar=no,resizable=yes,location=no,directories=no,scrollbars=yes");window.communicationWindows.testRecorder.document.title="Test Recorder";_();this._isInIframe=false;this._dockStarted=false;this._closeTriggered=false};c.prototype._openFrame=function(){var t=document.createElement("IFRAME");var i=document.createElement("DIV");var o=this._createResizeHandle(e.extend(r.RESIZE_HANDLE.BOTTOM,{cursor:"n-resize",resize:function(e,t){e.style.top=t.y+"px";this._iframe.style.height="calc(100% - "+t.y+"px)"}.bind(this)}));var s=this._createResizeHandle(e.extend(r.RESIZE_HANDLE.RIGHT,{cursor:"e-resize",resize:function(e,t){e.style.left=t.x+"px";this._iframe.style.left=t.x+"px";this._iframe.style.width="calc(100% - "+t.x+"px)"}.bind(this)}));var n=this._createResizeHandle(e.extend(r.RESIZE_HANDLE.LEFT,{cursor:"w-resize",resize:function(e,t){e.style.left=t.x+"px";this._iframe.style.width=t.x+"px"}.bind(this)}));i.id=r.RESIZE_OVERLAY_ID;i.style.position="absolute";i.style.width="100%";i.style.height="100%";i.style.top="0";i.style.left="0";i.style["z-index"]=r.RESIZE_OVERLAY_ZINDEX;i.style.display="none";t.id=r.IFRAME_ID;t.src=this._sUrl;t.style.position="absolute";t.style.border="none";t.style.borderRadius="1px";t.style["z-index"]=r.IFRAME_ZINDEX;t.style.boxShadow="1px -10px 42px -4px #888";document.body.appendChild(o);document.body.appendChild(s);document.body.appendChild(n);document.body.appendChild(i);document.body.appendChild(t);window.communicationWindows.testRecorder=t.contentWindow;_();this._iframe=t;this._resizeOverlay=i;this._resizeHandles={BOTTOM:o,RIGHT:s,LEFT:n};this._dockStarted=false;this._isInIframe=true;this._closeTriggered=false};c.prototype.close=function(){if(this._closeTriggered){return}this._closeTriggered=true;if(this._isInIframe){var e=this._iframe&&this._iframe.contentWindow;if(e){this._iframe.src="about:blank";e.close();if(typeof CollectGarbage=="function"){CollectGarbage()}this._iframe.remove();this._resizeOverlay.remove();Object.values(this._resizeHandles).forEach(function(e){e.remove()});this._iframe=null;this._resizeOverlay=null;this._resizeHandles={}}}else if(window.communicationWindows.testRecorder){window.communicationWindows.testRecorder.close()}if(!this._dockStarted){window.communicationWindows={};this.fnOnClose()}};c.prototype.getCommunicationInfo=function(){return{origin:this._sOrigin,identifier:this._sIdentifier,url:this._sUrl}};c.prototype._generateTestRecorderUrl=function(){var e=(new t).search(true);var i=["sap-language"];var o=["sap-ui-testRecorder"];var s=Object.keys(e).map(function(t){if(o.indexOf(t)===-1&&t.startsWith("sap-ui-")||i.indexOf(t)>-1){return"&"+t+"="+e[t]}}).join("");this._sUrl=sap.ui.require.toUrl("sap/ui/testrecorder/ui/overlay.html")+"?sap-ui-testrecorder-origin="+window.location.protocol+"//"+window.location.host+"&"+"sap-ui-testrecorder-frame-identifier="+this._sIdentifier+s;var n=new t(this._sUrl);this._sOrigin=(n.protocol()||window.location.protocol.replace(":",""))+"://"+(n.host()||window.location.host)};c.prototype._createResizeHandle=function(e){var t=document.createElement("DIV");t.id=e.id;t.style.position="absolute";t.style.width=e.width;t.style.height=e.height;t.style.left=e.left;t.style.top=e.top;t.style["z-index"]=r.RESIZE_HANDLE_ZINDEX;t.style.cursor=e.cursor;t.style.display="none";t.onmouseover=this._onResizeHandleMouseover(t);t.onmousedown=this._onResizeHandleMousedown(t,e.resize);t.onmouseleave=this._onResizeHandleMouseleave(t);return t};function u(e){return function(){e.style.background="#0854a0"}}function l(e,t){return function(i){i.preventDefault();d=true;this._resizeOverlay.style.display="block";document.onmouseup=this._onDocumentMouseup;document.onmousemove=this._onDocumentMousemove(e,t)}.bind(this)}function h(e){return function(){if(!d){e.style.background="transparent"}}}function m(){d=false;this._resizeOverlay.style.display="none";document.onmouseup=null;document.onmousemove=null}function f(e,t){return o(function(i){i.preventDefault();var o=150;t(e,{x:Math.max(Math.min(i.clientX,window.innerWidth-o),o),y:Math.max(Math.min(i.clientY,window.innerHeight-o),o)})},50)}function p(){return""+Date.now()}function _(){var e=window.document.getElementById("sap-ui-bootstrap");if(e&&e.dataset.sapUiLanguage){w(function(t){t.dataset.sapUiLanguage=e.dataset.sapUiLanguage})}if(e&&e.dataset.sapUiConfig){e.dataset.sapUiConfig.split(",").forEach(function(e){if(e.startsWith("language:")){w(function(t){t.dataset.sapUiConfig=t.dataset.sapUiConfig?t.dataset.sapUiConfig+","+e:e})}})}if(window["sap-ui-config"].language){window.communicationWindows.testRecorder["sap-ui-config"]=window.communicationWindows.testRecorder["sap-ui-config"]||{};window.communicationWindows.testRecorder["sap-ui-config"].language=window["sap-ui-config"].language}}function w(e){var t=window.communicationWindows.testRecorder.document.getElementById("sap-ui-bootstrap");if(t){e(t)}else{setTimeout(function(){w(e)},10)}}a=new c;return a},true);