/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","./../util/isTemplate","sap/ui/model/json/JSONModel","sap/m/Label","sap/ui/core/Fragment","sap/base/util/restricted/_omit","sap/ui/base/ManagedObjectObserver","sap/ui/integration/designtime/baseEditor/propertyEditor/PropertyEditorFactory","sap/ui/integration/designtime/baseEditor/util/createPromise","sap/base/util/restricted/_CancelablePromise","sap/base/util/deepClone","sap/base/util/deepEqual","sap/base/util/isPlainObject","sap/base/util/values","sap/base/util/each","sap/ui/integration/designtime/baseEditor/validator/ValidatorRegistry","sap/ui/integration/designtime/baseEditor/util/BaseDefaultValidatorModules","sap/ui/integration/designtime/baseEditor/util/cleanupDesigntimeMetadata"],function(t,e,i,a,r,n,s,o,p,u,h,g,l,d,f,c,y,m){"use strict";var _=t.extend("sap.ui.integration.designtime.baseEditor.propertyEditor.BasePropertyEditor",{metadata:{library:"sap.ui.integration",interfaces:["sap.ui.core.IFormContent"],properties:{renderLabel:{type:"boolean",defaultValue:true},value:{type:"any"},config:{type:"object"}},aggregations:{_label:{type:"sap.m.Label",visibility:"hidden",multiple:false},content:{type:"sap.ui.core.Control",multiple:false}},events:{beforeValueChange:{parameters:{path:{type:"string"},value:{type:"any"},nextValue:{type:"any"}}},valueChange:{parameters:{path:{type:"string"},value:{type:"any"},previousValue:{type:"any"}}},designtimeMetadataChange:{parameters:{path:{type:"string"},value:{type:"any"},previousValue:{type:"any"}}},configChange:{parameters:{previousConfig:{type:"object"},config:{type:"object"}}},fragmentChange:{parameters:{previousFragment:{type:"string"},fragment:{type:"string"}}},ready:{},init:{}}},xmlFragment:null,_currentXmlFragment:null,_bFragmentReady:false,constructor:function(){this._iExpectedWrapperCount=0;this._currentXmlFragment=this.xmlFragment;t.prototype.constructor.apply(this,arguments);this._oDefaultModel=new i({value:this.getValue(),config:this.getConfig(),displayValue:this._formatValue(this.getValue())});this._oDefaultModel.setDefaultBindingMode("OneWay");this.setBindingContext(this._oDefaultModel.getContext("/"));this.setModel(this._oDefaultModel);this.bindProperty("visible","config/visible");this._setReady(false);this._aEditorWrappers=[];this._bInitFinished=false;this.attachBeforeValueChange(function(t){this._iExpectedWrapperCount=this.getExpectedWrapperCount(t.getParameter("nextValue"))},this);this.attachValueChange(function(t){var e=t.getParameter("value");this._oDefaultModel.setData(Object.assign({},this._oDefaultModel.getData(),{value:e,displayValue:this._formatValue(e)}));this._checkReadyState()},this);this.attachConfigChange(function(t){var e=t.getParameter("previousConfig");var i=t.getParameter("config");if(e&&i&&!g(e.validators,i.validators)){this._validate(this.getValue())}this._oDefaultModel.setData(Object.assign({},this._oDefaultModel.getData(),{config:i}))},this);this.asyncInit().then(function(){this._bInitFinished=true;this.fireInit();this._checkReadyState()}.bind(this));if(this.getFragment()){this._initFragment(this.getFragment())}},renderer:function(t,e){t.openStart("div",e);t.addStyle("display","inline-block");t.addStyle("width","100%");t.openEnd();if(e.getRenderLabel()&&e.getLabel()){t.openStart("div");t.openEnd();t.renderControl(e.getLabel());t.close("div")}t.renderControl(e.getContent());t.close("div")}});_.prototype.init=function(){this.attachFragmentChange(function(t){if(this.getContent()){this.getContent().destroy()}var e=t.getParameter("fragment");this._initFragment(e)},this)};_.prototype.asyncInit=function(){return Promise.resolve()};_.prototype.onFragmentReady=function(){};_.prototype.setValue=function(t,e){var i=this.getValue();var a=this.getConfig()||{};var r=t;if(a.visible===false){return}if(typeof r==="undefined"&&typeof a.defaultValue!=="undefined"){r=h(a.defaultValue)}this._validate(r,function(t){if((t||e)&&!g(r,i)){this.fireBeforeValueChange({path:a.path,value:i,nextValue:r});this.setProperty("value",r);this.fireValueChange({path:a.path,previousValue:i,value:r})}}.bind(this))};_.prototype.setDesigntimeMetadata=function(t){var e=this.getDesigntimeMetadata();var i=t;m(i);var a=this.getConfig();if(!g(e,i)){this.fireDesigntimeMetadataChange({path:a.path,previousValue:e,value:i})}};_.prototype.getDesigntimeMetadata=function(){return(this.getConfig()||{}).designtime||{}};_.prototype.setDesigntimeMetadataValue=function(t){this.setDesigntimeMetadata(Object.assign({},this.getConfig().designtime,{__value:t}))};_.prototype.getNestedDesigntimeMetadata=function(t){var e=(this.getConfig()||{}).designtime||{};return e[t]};_.prototype.getNestedDesigntimeMetadataValue=function(t){return(this.getNestedDesigntimeMetadata(t)||{}).__value||{}};_.prototype.getDesigntimeMetadataValue=function(){var t=(this.getConfig()||{}).designtime||{};return t.__value||{}};_.prototype._getValidators=function(){var t=this.getConfig().validators||{};return d(Object.assign({},this.getDefaultValidators(),t)).filter(function(t){return t.isEnabled!==false})};_.prototype.getDefaultValidators=function(){return{}};_.prototype._validate=function(t,e){var i=[];var a=this._getValidators();a=a.map(function(t){var e=c.hasValidator(t.type)?c.getValidator(t.type):this.getDefaultValidatorModules()[t.type];if(!e){throw new Error("Unknown validator: "+t.type)}var i={};var a=t.errorMessage||e.errorMessage;var r=[];var n=a;if(l(a)){r=a.placeholders(t.config);n=a.message}Object.keys(t.config||{}).forEach(function(e){var a=t.config[e];if(typeof a==="function"){a=a(this)}i[e]=a}.bind(this));return{validator:e,config:i,errorMessage:this.getI18nProperty(n,r),type:t.type}}.bind(this));var r=function(){var t=i.length===0;this.setInputState(!t,i[0]);if(typeof e==="function"){e(t)}}.bind(this);a.forEach(function(e){if(!e.validator.validate(t,e.config)){i.push(e.errorMessage)}});r()};_.prototype.setInputState=function(t,e){this._sErrorMessage=t&&e;if(this.isReady()){this._setInputState()}};_.prototype._setInputState=function(){var t=this.getContent();if(!t||!t.setValueState){return}var e=this._sErrorMessage;if(e){t.setValueState("Error");t.setValueStateText(e)}else{t.setValueState("None")}};_.prototype.getDefaultValidatorModules=function(){return y};_.prototype._formatValue=function(t){return this.formatValue(h(t))};_.prototype.formatValue=function(t){return t};_.prototype.getExpectedWrapperCount=function(){return 0};_.prototype._checkReadyState=function(){if(this._mWrapperReadyCheck){this._mWrapperReadyCheck.cancel()}if(!this._bInitFinished){this._setReady(false);return}if(!this._bFragmentReady){this._setReady(false);return}if(this._iExpectedWrapperCount===0){this._setReady(true);return}if(this._iExpectedWrapperCount===this._aEditorWrappers.length){if(this._aEditorWrappers.every(function(t){return t.isReady()})){this._setReady(true)}else{this._setReady(false);this._mWrapperReadyCheck=p(function(t){Promise.all(this._aEditorWrappers.map(function(t){return t.ready()})).then(t)}.bind(this));this._mWrapperReadyCheck.promise.then(function(){this._setReady(true);delete this._mWrapperReadyCheck}.bind(this))}}else{this._setReady(false)}};_.prototype.wrapperInit=function(t){if(!this._oWrapperObserver){this._oWrapperObserver=new s(function(t){var i=t.object;switch(t.type){case"destroy":this._aEditorWrappers=this._aEditorWrappers.filter(function(t){return t!==i});this._checkReadyState();break;case"parent":C(i).forEach(function(t){if(!e(t,this)){this._registerWrapper(t)}else{v(this._oWrapperObserver,t)}}.bind(this));this._oWrapperObserver.unobserve(i);break;default:return}}.bind(this))}var i=t.getSource();if(e(i,this)){v(this._oWrapperObserver,i);return}this._registerWrapper(i)};function v(t,e){var i=b(e);if(!t.isObserved(i,{parent:true})){t.observe(i,{parent:true})}}function b(t){var e=t.getParent();return e?b(e):t}function C(t){return R(t)?[t]:t.findAggregatedObjects(true,function(t){return R(t)})}function R(t){return t.isA("sap.ui.integration.designtime.baseEditor.PropertyEditors")||t.isA("sap.ui.integration.designtime.baseEditor.PropertyEditor")}_.prototype._registerWrapper=function(t){this._aEditorWrappers.push(t);t.attachReady(function(t){this._setReady(false);this._checkReadyState()}.bind(this));if(t.isA("sap.ui.integration.designtime.baseEditor.PropertyEditor")){t.attachPropertyEditorChange(function(t){var e=t.getParameter("propertyEditor");if(!e){this._setReady(false)}},this)}this._oWrapperObserver.observe(t,{destroy:true});this._checkReadyState()};_.prototype._setReady=function(t){var e=this._bIsReady;this._bIsReady=t;if(e!==true&&t===true){this.fireReady()}};_.prototype.isReady=function(){return!!this._bIsReady};_.prototype.ready=function(){return new Promise(function(t){if(this.isReady()){t()}else{this.attachEventOnce("ready",t)}}.bind(this))};_.prototype.setFragment=function(t,e){if(this._currentXmlFragment!==t){var i=this._currentXmlFragment;this._currentXmlFragment=t;if(typeof e==="function"){this.getExpectedWrapperCount=e}this.fireFragmentChange({previousFragment:i,fragment:t})}};_.prototype.getFragment=function(){return this._currentXmlFragment};_.prototype._initFragment=function(t){this._setReady(false);this._bFragmentReady=false;if(this._oFragmentPromise){this._oFragmentPromise.cancel()}var e=new u(function(e,i,a){a.shouldReject=false;this._loadFragment(t).then(e,i)}.bind(this));this._oFragmentPromise=e;return e.then(function(t){if(e.isCanceled){t.destroy();return}this._bFragmentReady=true;this.setContent(t);this.onFragmentReady();this._setInputState();this._checkReadyState()}.bind(this))};_.prototype._loadFragment=function(t){return r.load({name:t,controller:this})};_.prototype.clone=function(){this.destroyContent();return t.prototype.clone.apply(this,arguments)};_.prototype.exit=function(){this._oDefaultModel.destroy();if(this._oConfigBinding){this._oConfigBinding.destroy()}if(this._oWrapperObserver){this._oWrapperObserver.destroy()}if(this._oFragmentPromise){this._oFragmentPromise.cancel()}};_.configMetadata={visible:{defaultValue:true,mergeStrategy:"mostRestrictiveWins"}};_.prototype.setConfig=function(t){var e=this.getConfig();var i={};var a=o.getType(this.getMetadata().getName()).configMetadata;f(a,function(t,e){i[t]=e.defaultValue});var r=Object.assign({},i,t);r=this.onBeforeConfigChange(r);if(!g(e,r)){this.setProperty("config",r);this.fireConfigChange({previousConfig:e,config:r})}};_.prototype.onBeforeConfigChange=function(t){return t};_.prototype.getI18nProperty=function(t,e){if(this.getModel("i18n")){return this.getModel("i18n").getResourceBundle().getText(t,e)}return t};_.prototype.getLabel=function(){var t=this.getAggregation("_label");if(!t){t=new a({text:"{config/label}",design:"Bold"});this.setAggregation("_label",t)}return t};_.prototype.enhanceAccessibilityState=function(t,e){var i=this.getParent();if(i&&i.enhanceAccessibilityState){i.enhanceAccessibilityState(this,e)}};_.prototype.getFocusDomRef=function(){var t=this.getContent();if(t&&t.isA("sap.ui.core.IFormContent")){return t.getFocusDomRef()}};_.prototype.getIdForLabel=function(){var t=this.getContent();if(t&&t.isA("sap.ui.core.IFormContent")){return t.getIdForLabel()}};return _});