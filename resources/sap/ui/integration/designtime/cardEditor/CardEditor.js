/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_CancelablePromise","sap/base/util/restricted/_isEqual","sap/base/util/restricted/_omit","sap/base/util/restricted/_castArray","sap/base/util/deepEqual","sap/base/util/each","sap/base/util/merge","sap/base/util/deepClone","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/ui/integration/designtime/baseEditor/BaseEditor","sap/ui/integration/util/CardMerger","sap/ui/thirdparty/jquery","./config/index"],function(e,t,i,n,a,r,s,o,u,p,g,c,d,f){"use strict";var h=g.extend("sap.ui.integration.designtime.cardEditor.CardEditor",{metadata:{library:"sap.ui.integration",properties:{layout:{type:"string",defaultValue:"form"},designtimeChanges:{type:"array",defaultValue:[]},baseUrl:{type:"sap.ui.core.URI",defaultValue:null},config:{type:"object",defaultValue:{i18n:[].concat(g.getMetadata().getProperty("config").getDefaultValue().i18n,"sap/ui/integration/designtime/cardEditor/i18n/i18n.properties")}}}},constructor:function(e){e=e||{};g.prototype.constructor.apply(this,arguments);this.setPreventInitialization(true);if(!e["config"]){this.addConfig(f,true)}},renderer:g.getMetadata().getRenderer()});function l(e,t,i,n,a){if(!e[t]){e[t]={}}if(!e[t][i]){e[t][i]={}}e[t][i][n]=a}function m(e,t){var i="sap.card";var n=u.get([i,"configuration"],e);var s=u.get([i,"configuration"],t);if(a(n,s)){return undefined}var o={};r(n,function(e,t){r(t,function(t,i){if(!s[e][t]){o[e]=o[e]||{};o[e][t]=i}else{r(i,function(i,n){if(s[e][t][i]!==n){l(o,e,t,i,n)}})}})});return{configuration:o}}h.prototype.init=function(){g.prototype.init.apply(this,arguments);this.attachJsonChange(function(e){if(!this._oInitialJson){this._oInitialJson=e.getParameter("json")}},this)};h.prototype.setJson=function(){g.prototype.setJson.apply(this,arguments);var t=this.getJson();var i=u.get(["sap.app","id"],t);if(this._bDesigntimeInit&&this._bCardId!==i){if(this._oDesigntimePromise){this._oDesigntimePromise.cancel()}delete this._bCardId;delete this._bDesigntimeInit}if(!this._bDesigntimeInit){this.setPreventInitialization(true);this._bDesigntimeInit=true;this._bCardId=i;var a=v(u.get(["sap.card","configuration","editor"],t)||"");if(a===""){a=v(u.get(["sap.card","designtime"],t)||"")}var r=v(this.getBaseUrl()||"");if(r&&a){var o={};var f=v(r);var h=C(a);var l=f+"/"+h;var m=i.replace(/\./g,"/")+"/"+h;o[m]=l;sap.ui.loader.config({paths:o});var D=m+"/editor.config";var _=m+"/i18n/i18n.properties";var b=l+"/metadata.json";this._oDesigntimePromise=new e(function(e){Promise.all([new Promise(function(e){sap.ui.require([D],e,function(){e({})})}),new Promise(function(e){d.getJSON(b).done(e).fail(function(){e({})})})]).then(e)});this._oDesigntimePromise.then(function(e){this.setPreventInitialization(false);var t=e[1];t=c.mergeCardDesigntimeMetadata(t,this.getDesigntimeChanges());this._oInitialDesigntimeMetadata=t;this.setDesigntimeMetadata(y(t),true);var i=e[0];if(p(i)){this.addConfig({i18n:_})}else{i=s({},i);i.i18n=i.i18n?n(i.i18n):[];i.i18n.push(_);this._addSpecificConfig(i)}}.bind(this))}else{this.setPreventInitialization(false);this.addConfig({})}}};h.prototype.setDesigntimeChanges=function(e){if(this._oInitialDesigntimeMetadata){throw Error("Designtime Changes can only be set initially")}this.setProperty("designtimeChanges",e)};function y(e){var t={};Object.keys(e).forEach(function(i){u.set(i.split("/"),{__value:o(e[i])},t)});return t}function v(e){return e.trim().replace(/\/*$/,"")}function C(e){return e.replace(/^\.\//,"")}h.prototype.getChanges=function(e){return Promise.all([this.getDeltaChangeDefinition(e).catch(function(){return}),this.getDesigntimeChangeDefinition(e).catch(function(){return})]).then(function(e){if(e[0]===undefined&&e[1]===undefined){return Promise.reject("No changes")}return{runtimeChange:e[0],designtimeChange:e[1]}})};function D(e){return new Promise(function(t){sap.ui.require(["sap/ui/fl/Change"],function(i){var n=i.createInitialFileContent(e);n.creation=(new Date).toISOString();t(n)})})}h.prototype.getDesigntimeChangeDefinition=function(e){var n=[];var a=Object.assign({},this._oInitialDesigntimeMetadata);var o=this._formatExportedDesigntimeMetadata(this.getDesigntimeMetadata());r(o,function(e,i){if(a.hasOwnProperty(e)){if(!t(a[e],i)){n.push({propertyPath:e,operation:"UPDATE",propertyValue:i})}delete a[e]}else{n.push({propertyPath:e,operation:"INSERT",propertyValue:i})}});r(a,function(e){n.push({propertyPath:e,operation:"DELETE"})});if(!n.length){return Promise.reject("No Change")}this._oInitialDesigntimeMetadata=o;var p=this.getJson();var g=s({},i(e,["oldValue","newValue"]));g.content={entityPropertyChange:n};g.changeType="appdescr_card_designtime";g.generator="CardEditor";g.selector={};g.reference=u.get(["sap.app","id"],p);return D(g)};h.prototype.getDeltaChangeDefinition=function(e){var t=this.getJson();var i=s({},e);i.content=m(t,this._oInitialJson);if(!i.content){return Promise.reject("No Change")}this._oInitialJson=t;i.changeType="appdescr_card";i.generator="CardEditor";i.selector={};i.reference=u.get(["sap.app","id"],t);return D(i)};return h});