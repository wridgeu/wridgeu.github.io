/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_CancelablePromise","sap/base/util/restricted/_isEqual","sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/util/deepClone","sap/base/util/deepEqual","sap/base/util/ObjectPath","./CardEditor","sap/ui/integration/designtime/baseEditor/BaseEditor","sap/ui/integration/Designtime","sap/ui/integration/util/CardMerger","sap/base/util/LoaderExtensions","sap/base/Log"],function(e,i,t,a,n,s,r,o,f,l,g,u,p){"use strict";var m="";m=u.loadResource("sap/ui/integration/designtime/cardEditor/ConfigurationTemplate.js",{dataType:"text",failOnError:false,async:false});var h=o.extend("sap.ui.integration.designtime.cardEditor.BASEditor",{metadata:{library:"sap.ui.integration",events:{configurationChange:{},createConfiguration:{},error:{},designtimeInited:{}}},renderer:o.getMetadata().getRenderer()});h.prototype.getManifest=function(){return this._oCurrent.manifest};h.prototype.getConfigurationClass=function(){return this._oCurrent.configurationclass};h.prototype.getConfiguration=function(){return this._oCurrent.configuration};h.prototype.getConfigurationString=function(){return this._oCurrent.configurationstring};h.prototype._generateDesigntimeJSConfig=function(){var e=this._formatExportedDesigntimeMetadata(this.getDesigntimeMetadata());var t=this.getJson();if(this._eventTimeout){clearTimeout(this._eventTimeout);this._eventTimeout=null}this._eventTimeout=setTimeout(function(){var n={form:{items:{}}};var o=a(n,this._oDesigntimeJSConfig);var f={};var g=[];var u;if(!r.get(["sap.card","configuration"],t)){r.set(["sap.card","configuration"],{parameters:{}},t)}else if(!r.get(["sap.card","configuration","parameters"],t)){r.set(["sap.card","configuration","parameters"],{},t)}var p=r.get(["sap.card","configuration","parameters"],t);if(t){var m=r.get(["sap.card","configuration","parameters"],this._oDesigntimeMetadataModel.getData());if(s(p,{})&&!m){this._oDesigntimeJSConfig.form.items={};this._oCurrent={configuration:this._cleanConfig(this._oDesigntimeJSConfig),manifest:this._cleanJson(),configurationclass:this._fnDesigntime,configurationstring:this._cleanConfig(this._oDesigntimeJSConfig,true)};this.fireConfigurationChange(this._oCurrent);return}var h=Object.keys(p);for(var c in o.form.items){u=a({},o.form.items[c]);if(!p[c]){if(m[c]){if(u.type==="group"||u.type==="separater"){p[c]={}}else if(u.manifestpath&&!u.manifestpath.startsWith("/sap.card/configuration/parameters")){var d=u.manifestpath;if(d.startsWith("/")){d=d.substring(1)}var v=r.get(d.split("/"),t)||"";p[c]={value:v}}}else{delete o.form.items[c];continue}}else if(u.manifestpath&&!u.manifestpath.startsWith("/sap.card/configuration/parameters")){var d=u.manifestpath;if(d.startsWith("/")){d=d.substring(1)}var _=d.split("/");var v=r.get(_,t);var y=r.get(_,this._oInitialJson);if(!i(v,y)){p[c].value=v}else{r.set(_,p[c].value,t)}}var C=h.indexOf(c);if(C>-1){h.splice(C,1)}var b;if(p[c].visualization){b=p[c].visualization}var D;if(p[c].values){D=p[c].values}o.form.items[c]=a(u,p[c]);if(!m[c].__value.visualization){delete o.form.items[c].visualization}else if(b){o.form.items[c].visualization=b;b=null}if(!m[c].__value.values){delete o.form.items[c].values}else if(D){o.form.items[c].values=D;D=null}if(u.type==="group"||u.type==="separator"){delete o.form.items[c].manifestpath}else if(!o.form.items[c].manifestpath){m[c].manifestpath="/sap.card/configuration/parameters/"+c+"/value";m[c].__value.manifestpath="/sap.card/configuration/parameters/"+c+"/value";o.form.items[c].manifestpath="/sap.card/configuration/parameters/"+c+"/value"}}if(h.length>0){for(var J=0;J<h.length;J++){var S=h[J];var I=p[S];o.form.items[S]={manifestpath:"/sap.card/configuration/parameters/"+S+"/value",type:I.type||"string",label:I.label,translatable:false,editable:I.editable,visible:I.visible}}p[S]=a(o.form.items[S],p[S])}}if(e){if(o){for(var c in e){var E=e[c];var z=c.substring(c.lastIndexOf("/")+1);if(!c.startsWith("sap.card/configuration/parameters")){continue}var M=o.form.items[z]||{};var b;if(M.visualization){b=M.visualization}var D;if(M.values){D=M.values}u=a(M,p[z]);if(E.hasOwnProperty("label")){u.label=E.label}if(E.hasOwnProperty("position")){u.position=E.position}if(u.editable==="false"){u.editable=false}else if(u.editable==="true"){u.editable=false}if(u.visible==="false"){u.visible=false}else if(u.visible==="true"){u.visible=false}if(u.type==="group"||u.type==="separator"){delete u.manifestpath}if(b){u.visualization=b;b=null}if(D){u.values=D;D=null}u.__key=z;g[u.position]=u}for(var J=0;J<g.length;J++){u=g[J];if(!u){continue}f[u.__key]=u;delete u.__key;delete u.position}o.form.items=f}}this._oDesigntimeJSConfig=o;var T=this._cleanConfig(this._oDesigntimeJSConfig);this._fnDesigntime=function(e){return new l(e)}.bind(this,T);this._oCurrent={configuration:T,manifest:this._cleanJson(t),configurationclass:this._fnDesigntime,configurationstring:this._cleanConfig(this._oDesigntimeJSConfig,true)};this._oDataModel.setData(this._prepareData(t));this.fireConfigurationChange(this._oCurrent);this._oInitialJson=t}.bind(this),500)};h.prototype.init=function(){o.prototype.init.apply(this,arguments);this._oCurrent={configuration:null,manifest:null,configurationclass:null}};h.prototype._applyDefaultValue=function(e){if(e.value===undefined||e.value===null){switch(e.type){case"boolean":e.value=false;break;case"integer":case"number":e.value=0;break;case"string[]":e.value=[];break;default:e.value=""}}};h.prototype.getJson=function(e){if(e===true){return this._cleanJson()}else{return f.prototype.getJson.apply(this,arguments)}};h.prototype._cleanJson=function(e,i){e=e||this.getJson();var t=d(r.get(["sap.card","configuration","editor"],e)||"");if(t===""){t=d(r.get(["sap.card","designtime"],e)||"")}if(!t){r.set(["sap.card","designtime"],"sap/ui/integration/designtime/cardEditor/ConfigurationTemplate",e)}e=n(e);var i=i!==false;if(i){var a=r.get(["sap.card","configuration","parameters"],e);for(var s in a){var o=a[s];if(o&&(o.type==="group"||o.type==="separator")){delete a[s];continue}if(this._oDesigntimeJSConfig&&this._oDesigntimeJSConfig.form&&this._oDesigntimeJSConfig.form.items){var f=this._oDesigntimeJSConfig.form.items[s]||{};if(f.type==="group"||f.type==="separator"){delete a[s];continue}if(f.manifestpath&&!f.manifestpath.startsWith("/sap.card/configuration/parameters")){var l=f.manifestpath;if(l.startsWith("/")){l=l.substring(1)}if(f.type==="simpleicon"){f.type="string"}if(f.type==="string[]"){f.type="array"}r.set(l.split("/"),f.value,e);delete a[s];continue}}a[s]={value:a[s].value}}}if(this._i18n){r.set(["sap.app","i18n"],this._i18n,e)}return e};h.prototype._cleanConfig=function(e,i){var e=a({},e);for(var t in e.form.items){var n=e.form.items[t];if(n.type==="simpleicon"){if(!n.visualization){n.visualization={type:"IconSelect",settings:{value:"{currentSettings>value}",editable:"{currentSettings>editable}"}}}n.type="string"}if(n.type==="array"){n.type="string[]"}if(n.type!=="string[]"&&n.type!="string"){delete n.values}delete n.value}if(i){var s=JSON.stringify(e,null,"\t");s=s.replace(/\"\$\$([a-zA-Z]*)\$\$\"/g,function(e){return e.substring(3,e.length-3)});return s}return e};h.prototype._generateMetadataFromJSConfig=function(e){var i={};if(e){this._oDesigntimeJSConfig=a(this._oDesigntimeJSConfig,e)}if(this._oDesigntimeJSConfig){var t=this._oDesigntimeJSConfig.form.items;var n=0;for(var s in t){var o="sap.card/configuration/parameters/"+s,f=o.split("/"),l;i[o]=a({},t[s]);l=i[o];l.position=n++;if(l.visualization){if(l.visualization.type==="IconSelect"){l.type="simpleicon"}}if(l.type==="string[]"){l.type="array"}if(l.manifestpath&&(!l.manifestpath.startsWith("/sap.card/configuration/parameters/")||!r.get(f,this._oInitialJson))){r.set(f,l,this._oInitialJson)}if(!l.hasOwnProperty("type")){this.fireError({name:"Designtime Error",detail:{message:"Type of parameter "+s+" not exist"}})}else if(l.type===""){this.fireError({name:"Designtime Error",detail:{message:"Type of parameter "+s+" is Invalid"}})}if(l.type!=="group"&&l.type!=="separator"){if(!l.hasOwnProperty("value")){var g=l.manifestpath.substring(1).split("/"),u=r.get(g,this._oInitialJson);if(u!==undefined){l.value=u}else{this._applyDefaultValue(l)}}else{this._applyDefaultValue(l)}if(r.get(f,this._oInitialJson)){if(r.get(f,this._oInitialJson).value===undefined){r.get(f,this._oInitialJson).value=l.value}}}}}return i};h.prototype.setJson=function(i){if(!this._i18n){this._i18n=r.get(["sap.app","i18n"],i)}f.prototype.setJson.apply(this,arguments);if(!this.__generateDesigntimeJSConfigAttached){this.attachDesigntimeMetadataChange(this._generateDesigntimeJSConfig.bind(this));this.attachJsonChange(this._generateDesigntimeJSConfig.bind(this));this.__generateDesigntimeJSConfigAttached=true}var i=this.getJson();var t=r.get(["sap.app","id"],i);if(this._bDesigntimeInit&&this._bCardId!==t){if(this._oDesigntimePromise){this._oDesigntimePromise.cancel()}delete this._bCardId;delete this._bDesigntimeInit}if(!this._bDesigntimeInit){this.setPreventInitialization(true);this._bCardId=t;var a;var n=d(r.get(["sap.card","configuration","editor"],i)||"");if(n===""){n=d(r.get(["sap.card","designtime"],i)||"")}if(!n){var s=m;r.set(["sap.card","designtime"],"sap/ui/integration/designtime/cardEditor/ConfigurationTemplate",i);a="sap/ui/integration/designtime/cardEditor/ConfigurationTemplate";this.fireCreateConfiguration({file:"sap/ui/integration/designtime/cardEditor/ConfigurationTemplate.js",content:s,manifest:this._cleanJson(i,false)});return}var o=d(this.getBaseUrl()||""),l={},u=null,h=null,_=null,y=null;if(n&&n.indexOf("cardEditor/ConfigurationTemplate")>0){a=n;h=v(n);_=t.replace(/\./g,"/")+"/"+h;l[_]=h;l[_+"js"]=h.substring(0,h.lastIndexOf("/"));y=h.replace(l[_+"js"]+"/","")}else if(o&&n){u=d(o);h=v(n);var C=u+"/"+h;_=t.replace(/\./g,"/")+"/"+h;l[_]=C;l[_+"js"]=C.substring(0,C.lastIndexOf("/"));y=C.replace(l[_+"js"]+"/","")}if(o&&n){sap.ui.loader.config({paths:l});var b=this;this._oDesigntimePromise=new e(function(e){var i=_+"js"+"/"+y+".js";if(a){i=a+".js"}sap.ui.loader._.loadJSResourceAsync(i).then(function(i){if(!i){b.fireError({name:"Designtime Error",detail:{message:"Invalid file format"}})}else if(i){var t=new i;b._oDesigntimeJSConfig=t.getSettings();b._fnDesigntime=i;var a=b._generateMetadataFromJSConfig();i=t.getMetadata().getClass();e(a)}}).catch(function(e){p.error(e);b.fireError({name:"Designtime Error",detail:e})})});this._oDesigntimePromise.then(function(e){this.setPreventInitialization(false);var i=e;i=g.mergeCardDesigntimeMetadata(i,this.getDesigntimeChanges());this._oInitialDesigntimeMetadata=i;this.setDesigntimeMetadata(c(i),true);this._bDesigntimeInit=true;this.fireDesigntimeInited()}.bind(this))}else{this.setPreventInitialization(false)}}};h.prototype.initialize=function(){if(!this._bDesigntimeInit){this.attachEventOnce("designtimeInited",this.initialize);return}if(!this._bPreventInitialization){this._initialize()}};h.prototype.getConfigurationTemplate=function(){return m};h.prototype.updateDesigntimeMetadata=function(e,i){var t=this._generateMetadataFromJSConfig(e);this._oInitialDesigntimeMetadata=t;this.setDesigntimeMetadata(c(t),i)};h.prototype.setDestinations=function(e){if(Array.isArray(e)&&e.length>0){var i=this.getConfig();if(!i.properties){i.properties={destinations:{}}}else if(!i.properties.destinations){i.properties.destinations={}}i.properties.destinations.allowedValues=e;this.setConfig(i)}};function c(e){var i={};Object.keys(e).forEach(function(t){r.set(t.split("/"),{__value:n(e[t])},i)});return i}function d(e){return e.trim().replace(/\/*$/,"")}function v(e){return e.replace(/^\.\//,"")}return h});