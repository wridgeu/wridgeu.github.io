/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/util/DataProvider","jquery.sap.global","sap/base/Log","sap/ui/model/odata/v4/ODataUtils"],function(e,t,r,s){"use strict";var i=[429,503];var o=["no-cors","same-origin","cors"];var a=["GET","POST"];var n=e.extend("sap.ui.integration.util.RequestDataProvider",{metadata:{properties:{allowCustomDataType:{type:"boolean",defaultValue:false}}}});n.prototype.destroy=function(){if(this._iRetryAfterTimeout){clearTimeout(this._iRetryAfterTimeout)}e.prototype.destroy.apply(this,arguments)};n.prototype.getData=function(){var e=this.getSettings().request;if(this._oDestinations){return this._oDestinations.process(e).then(this._fetch.bind(this))}return this._fetch(e)};n.prototype._isValidRequest=function(e){if(!e){return false}if(o.indexOf(e.mode)===-1){return false}if(a.indexOf(e.method)===-1){return false}if(typeof e.url!=="string"){return false}return true};n.prototype._fetch=function(e){var t="Invalid request",i=this._oSettings;if(!e||!e.url){r.error(t);return Promise.reject(t)}if(!this.getAllowCustomDataType()&&e.dataType){r.error("To specify dataType property in the Request Configuration, first set allowCustomDataType to 'true'.")}var o=e.parameters,a=e.url,n=this.getAllowCustomDataType()&&e.dataType||"json",u=e.headers||{},f=e.batch,d,h;if(!a.startsWith("/")){a=this._getRuntimeUrl(e.url)}if(this._hasHeader(e,"Content-Type","application/json")){o=JSON.stringify(e.parameters)}if(f){d=s.serializeBatchRequest(Object.values(f));n="text";o=d.body;u=Object.assign({},u,d.headers)}u=this._prepareHeaders(u,i);h={mode:e.mode||"cors",url:a,method:e.method&&e.method.toUpperCase()||"GET",dataType:n,data:o,headers:u,timeout:15e3,xhrFields:{withCredentials:!!e.withCredentials}};if(!this._isValidRequest(h)){r.error(t);return Promise.reject(t)}return this._request(h).then(function(e){var t=e[0],r=e[1];if(f){return this._deserializeBatchResponse(f,t,r)}return t}.bind(this))};n.prototype._request=function(e,r){return new Promise(function(s,i){t.ajax(e).done(function(e,t,r){if(this.bIsDestroyed){i("RequestDataProvider is already destroyed before the response is received.");return}s([e,r])}).fail(function(t,o,a){var n=[a,t];if(this.bIsDestroyed){i("RequestDataProvider is already destroyed while error in the response occurred.");return}if(r){i(n);return}this._retryRequest(n,e).then(s,i)}.bind(this))}.bind(this))};n.prototype._retryRequest=function(e,t){var s=e[1],o=this._getRetryAfter(s);if(!i.includes(s.status)){return Promise.reject(e)}if(!o){r.warning("Request could be retried, but Retry-After header or configuration parameter retryAfter are missing.");return Promise.reject(e)}if(this._iRetryAfterTimeout){return Promise.reject("The retry was already scheduled.")}return new Promise(function(e,r){this._iRetryAfterTimeout=setTimeout(function(){this._request(t,true).then(e,r);this._iRetryAfterTimeout=null}.bind(this),o*1e3)}.bind(this))};n.prototype._getRetryAfter=function(e){var t=this.getSettings().request,s=e.getResponseHeader("Retry-After")||t.retryAfter;if(!s){return 0}if(Number.isInteger(s)){return s}if(!s.match(/^\d+$/)){r.error("Only number of seconds is supported as value of retry-after. Given '"+s+"'.");return 0}return parseInt(s)};n.prototype._hasHeader=function(e,t,r){if(!e.headers){return false}for(var s in e.headers){if(s.toLowerCase()===t.toLowerCase()&&e.headers[s]===r){return true}}return false};n.prototype._deserializeBatchResponse=function(e,t,r){return new Promise(function(i,o){var a=r.getResponseHeader("Content-Type"),n=s.deserializeBatchResponse(a,t,false),u=Object.keys(e),f={};u.forEach(function(e,t){var r=n[t],s;if(!r){o("Batch responses do not match the batch requests.");return}s=new Response(r.responseText,r);if(!s.ok){o("One of batch requests fails with '"+s.status+" "+s.statusText+"'");return}f[e]=r.responseText?JSON.parse(r.responseText):{}});i(f)})};n.prototype._prepareHeaders=function(e,t){return e};return n});