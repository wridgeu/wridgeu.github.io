/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/Manifest","sap/base/util/deepClone","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/Log","./ParameterMap","sap/ui/integration/util/CardMerger"],function(e,t,i,s,r,n,o,a){"use strict";var f="/{SECTION}/configuration/parameters",u="/{SECTION}/configuration/filters",h="/{SECTION}",c="/sap.app/dataSources",p=/\{\{(?!parameters.)(?!destinations.)([^\}\}]+)\}\}|\{i18n>([^\}]+)\}/g;var l=e.extend("sap.ui.integration.util.Manifest",{constructor:function(s,r,o,a){e.call(this);this._aChanges=a;this.PARAMETERS=f.replace("{SECTION}",s);this.FILTERS=u.replace("{SECTION}",s);this.CONFIGURATION=h.replace("{SECTION}",s);if(r){var c={},p;c.process=false;this._oInitialJson=i(r,500);if(o){c.baseUrl=o;this._sBaseUrl=o}else{n.warning("If no base URL is provided when the manifest is an object static resources cannot be loaded.")}if(this._aChanges){p=this.mergeDeltaChanges(r)}else{p=r}this._oManifest=new t(p,c);this.oJson=this._oManifest.getRawJson()}}});l.prototype.mergeDeltaChanges=function(e){return a.mergeCardDelta(e,this._aChanges)};l.prototype.getJson=function(){return this._unfreeze(this.oJson)};l.prototype.getInitialJson=function(){return this._oInitialJson};l.prototype.get=function(e){return this._unfreeze(m(this.oJson,e))};l.prototype.getUrl=function(){return this._oManifest.resolveUri("./","manifest")};l.prototype.getResourceBundle=function(){return this.oResourceBundle};l.prototype._unfreeze=function(e){if(typeof e==="object"){return JSON.parse(JSON.stringify(e))}return e};l.prototype.destroy=function(){this.oJson=null;this.oResourceBundle=null;if(this._oManifest){this._oManifest.destroy()}this._bIsDestroyed=true};l.prototype.isDestroyed=function(){return this._bIsDestroyed};l.prototype.load=function(e){if(!e||!e.manifestUrl){if(this._sBaseUrl&&this._oManifest){return this.loadI18n().then(function(){this.processManifest()}.bind(this))}else{if(this._oManifest){this.processManifest()}return new Promise(function(e){e()})}}return t.load({manifestUrl:e.manifestUrl,async:true,processJson:function(e){this._oInitialJson=i(e,500);if(this._aChanges){return this.mergeDeltaChanges(e)}return e}.bind(this)}).then(function(e){this._oManifest=e;this.oJson=this._oManifest.getRawJson();return this.loadI18n().then(function(){this.processManifest()}.bind(this))}.bind(this))};l.prototype.loadI18n=function(){var e=false;t.processObject(this._oManifest.getJson(),function(t,i,s){if(!e&&s.match(p)){e=true}});if(this.get("/sap.app/i18n")){e=true}if(!e){return Promise.resolve()}return this._oManifest._loadI18n(true).then(function(e){this.oResourceBundle=e}.bind(this))};l.prototype.processManifest=function(){var e=0,t=15,i=jQuery.extend(true,{},this._oManifest.getRawJson()),s=this.get(c);_(i,this.oResourceBundle,e,t,this._oCombinedParams,s,this._oCombinedFilters);d(i);this.oJson=i};function d(e){if(e&&typeof e==="object"&&!Object.isFrozen(e)){Object.freeze(e);for(var t in e){if(e.hasOwnProperty(t)){d(e[t])}}}}function g(e){return typeof e==="string"&&e.indexOf("{{")===0&&e.indexOf("}}")===e.length-2}function y(e){return typeof e==="string"&&(e.indexOf("{{parameters.")>-1||e.indexOf("{{dataSources")>-1||e.indexOf("{{filters.")>-1)}l._processPlaceholder=function(e,t,i,s){var n=o.processPredefinedParameter(e),a,f;if(!r(t)){for(var u in t){a=t[u].value;f="{{parameters."+u;n=b(n,a,f)}}if(i){n=b(n,i,"{{dataSources")}if(s){n=b(n,s,"{{filters")}return n};function b(e,t,i){if(s(t)||Array.isArray(t)){for(var r in t){e=b(e,t[r],i+"."+r)}}else if(e.includes(i+"}}")){e=e.replace(new RegExp(i+"}}","g"),t)}return e}function _(e,t,i,s,r,n,o){if(i===s){return}if(Array.isArray(e)){e.forEach(function(e,a,f){if(typeof e==="object"){_(e,t,i+1,s,r,n,o)}else if(y(e)){f[a]=l._processPlaceholder(e,r,n,o)}else if(g(e)&&t){f[a]=t.getText(e.substring(2,e.length-2))}},this)}else{for(var a in e){if(typeof e[a]==="object"){_(e[a],t,i+1,s,r,n,o)}else if(y(e[a])){e[a]=l._processPlaceholder(e[a],r,n,o)}else if(g(e[a])&&t){e[a]=t.getText(e[a].substring(2,e[a].length-2))}}}}function m(e,t){if(t==="/"){return e}if(e&&t&&typeof t==="string"&&t[0]==="/"){var i=t.substring(1).split("/"),s;for(var r=0,n=i.length;r<n;r++){s=i[r];e=e.hasOwnProperty(s)?e[s]:undefined;if(e===null||typeof e!=="object"){if(r+1<n&&e!==undefined){e=undefined}break}}return e}return e&&e[t]}l.prototype.processFilters=function(e){if(!this._oManifest){return}var t=this.get(this.FILTERS),i={};if(e.size&&!t){n.error("If runtime filters are set, they have to be defined in the manifest configuration as well.");return}jQuery.each(t,function(t,s){var r=e.get(t)||s.value;i[t]=r});this._oCombinedFilters=i;this.processManifest()};l.prototype.processParameters=function(e){if(!this._oManifest){return}var t=this.get(this.PARAMETERS);if(!r(e)&&!t){n.error("If parameters property is set, parameters should be described in the manifest");return}this._oCombinedParams=this._syncParameters(e,t);this.processManifest()};l.prototype.getProcessedParameters=function(e){var t=this.get(this.PARAMETERS),i=this._syncParameters(e,t);_(i,this.oResourceBundle,0,15,e);return i};l.prototype._syncParameters=function(e,t){if(r(e)){return t}var s=i(t||{},500),n=Object.getOwnPropertyNames(e),o=Object.getOwnPropertyNames(s);for(var a=0;a<o.length;a++){for(var f=0;f<n.length;f++){if(o[a]===n[f]){s[o[a]].value=e[n[f]]}}}return s};l.prototype.findDataSections=function(e){var t=[],i;if(!e){e=this.get(this.CONFIGURATION)}if(!s(e)){return[]}if(e.data){t.push(e.data)}for(i in e){if(e[i]){t=t.concat(this.findDataSections(e[i]))}}return t};return l},true);