/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/base/util/isPlainObject","sap/ui/model/json/JSONModel"],function(e,t,r){"use strict";var o=/\{\{csrfTokens.([^\}]+)/;var n="X-CSRF-Token";var s=e.extend("sap.ui.integration.util.CsrfTokenHandler",{metadata:{library:"sap.ui.integration"},constructor:function(t){e.call(this);t=t||{};this._oHost=t.host;this._oConfiguration=t.configuration}});s._mTokens=new Map;s.prototype.resolveToken=function(e){var t=this._findCsrfPlaceholder(e),r;if(!t){return Promise.resolve(e)}r=this._getCsrfConfig(t);if(this._oHost){return this._oHost.getCsrfToken(r).then(function(t){if(!t){return this._resolveTokenByUrl(e)}this._replaceCsrfPlaceholder(e,t);return e}.bind(this)).catch(function(e){return Promise.reject(e)})}return this._resolveTokenByUrl(e)};s.prototype._resolveTokenByUrl=function(e){var t=this._findCsrfPlaceholder(e),r=this._getCsrfConfig(t).data.request.url;if(s._mTokens.has(r)){return s._mTokens.get(r).then(function(t){this._replaceCsrfPlaceholder(e,t);return e}.bind(this))}if(t){return this._requestToken(e)}return Promise.resolve(e)};s.prototype.setDataProviderFactory=function(e){this._oDataProviderFactory=e};s.prototype.setHost=function(e){this._oHost=e};s.prototype.isExpiredToken=function(e){if(!e){return false}var t=e.getResponseHeader(n);return t&&t.toLowerCase()==="required"&&e.status===403};s.prototype._requestToken=function(e){var t=this._findCsrfPlaceholder(e),o=this._getCsrfConfig(t);if(!t||!o){return Promise.reject("CSRF definition is incorrect")}var s=new Promise(function(e,t){var s=this._oDataProviderFactory.create(o.data);s.getData().then(function(t){var i,a;if(o.data.path){a=new r(t);i=a.getProperty(o.data.path);a.destroy()}else{i=s.getLastJQXHR().getResponseHeader(n)}e(i)}).catch(function(){t("CSRF token cannot be resolved")})}.bind(this));this._registerToken(o,s);return s.then(function(t){this._replaceCsrfPlaceholder(e,t);return e}.bind(this))};s.prototype.resetTokenByRequest=function(e){var t=this._findCsrfPlaceholder(e);if(!t){return}this._deleteRegisteredToken(this._getCsrfConfig(t))};s.prototype._getCsrfConfig=function(e){return this._oConfiguration[e]};s.prototype._findCsrfPlaceholder=function(e){var t=this._findCsrfInHeaders(e);if(t){return this._getCsrfName(e.headers[t])}return null};s.prototype._replaceCsrfPlaceholder=function(e,t){e.headers[n]=t};s.prototype._findCsrfInHeaders=function(e){if(!e||!e.headers||!t(e.headers)){return""}for(var r in e.headers){if(typeof e.headers[r]==="string"&&this._hasCsrf(e.headers[r])){return r}}return""};s.prototype._hasCsrf=function(e){return!!e.match(o)};s.prototype._getCsrfName=function(e){var t=e.match(o);if(!t){return""}return t[1]};s.prototype._registerToken=function(e,t){s._mTokens.set(e.data.request.url,t);if(this._oHost){this._oHost.csrfTokenFetched(e,t)}};s.prototype._deleteRegisteredToken=function(e){s._mTokens.delete(e.data.request.url);if(this._oHost){this._oHost.csrfTokenExpired(e)}};return s});