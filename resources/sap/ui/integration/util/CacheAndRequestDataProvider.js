/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/util/RequestDataProvider","sap/base/Log","sap/ui/core/Core","sap/base/util/merge"],function(e,t,a,s){"use strict";var i=31536e3;function r(e){var t=e.url,a=e.data,s,i;if(e.method!=="GET"){return e.url}s=new URL(t,window.location.href);for(i in a){s.searchParams.set(i,a[i])}return s.href}var n=e.extend("sap.ui.integration.util.CacheAndRequestDataProvider",{metadata:{associations:{card:{type:"sap.ui.integration.widgets.Card",multiple:false}}}});n.prototype.init=function(){this._oRefreshWithoutCacheBound=this.refreshWithoutCache.bind(this)};n.prototype.destroy=function(){this._unsubscribeFromHostMessages();this._detachTimestampPress();e.prototype.destroy.apply(this,arguments)};n.prototype.getCardInstance=function(){return a.byId(this.getCard())};n.prototype.onDataRequestComplete=function(){var e;if(this._iUpdateIntervalTimeout){clearTimeout(this._iUpdateIntervalTimeout);this._iUpdateIntervalTimeout=null}if(!this._oSettings||!this._oSettings.updateInterval){return}e=parseInt(this._oSettings.updateInterval);if(isNaN(e)){return}this._iUpdateIntervalTimeout=setTimeout(function(){this.refreshWithoutCache()}.bind(this),e*1e3)};n.prototype._request=function(t){var a,s=this.getCardInstance(),i=s.getCardHeader();this._sCurrentRequestFullUrl=r(t);this._subscribeToHostMessages();a=e.prototype._request.apply(this,arguments);a.then(function(e){var t=e[1],a=t.getResponseHeader("Date");if(a&&i){this._attachTimestampPress();i.setDataTimestamp(new Date(a).toISOString())}}.bind(this));return a};n.prototype.refreshWithoutCache=function(){var e=this.getCardInstance().getCardHeader();if(e){e.setDataTimestampUpdating(true)}setTimeout(function(){this._bCacheOnly=false;this._bNoCache=true;this._triggerDataUpdate()}.bind(this),200)};n.prototype.refreshFromCache=function(){var e=this.getCardInstance().getCardHeader();if(e){e.setDataTimestampUpdating(true)}setTimeout(function(){this._bCacheOnly=true;this._bNoCache=false;this._triggerDataUpdate()}.bind(this),200)};n.prototype._prepareHeaders=function(e,t){var a=this.getCardInstance(),r=a.getHostInstance(),n={enabled:true,maxAge:0,staleWhileRevalidate:true},o=s({request:{cache:n}},t),h=o.request.cache;if(h.noStore){h.enabled=false}if(h.enabled){if(this._bCacheOnly){h.maxAge=i;h.staleWhileRevalidate=false}else if(this._bNoCache){h.maxAge=0;h.staleWhileRevalidate=false}}o.request.cache=h;if(r&&r.modifyRequestHeaders){return r.modifyRequestHeaders(Object.assign({},e),o,a)}return e};n.prototype._subscribeToHostMessages=function(){var e=this.getCardInstance(),t=e.getHostInstance();if(this._bIsSubscribed){return}if(!t){return}t.attachMessage(this._handleHostMessage,this);this._bIsSubscribed=true};n.prototype._unsubscribeFromHostMessages=function(){var e=this.getCardInstance(),t=e.getHostInstance();if(!t){return}t.detachMessage(this._handleHostMessage,this);this._bIsSubscribed=false};n.prototype._handleHostMessage=function(e){var a=e.getParameter("data");if(a.type!=="ui-integration-card-update"){return}if(a.url!==this._sCurrentRequestFullUrl){return}t.info("[CARDS CACHE] message ui-integration-card-update received for "+a.url);this.refreshFromCache()};n.prototype._attachTimestampPress=function(e){var t=this.getCardInstance(),a=t.getCardHeader();if(this._oHeaderDelegate){return}if(!a){return}this._oHeaderDelegate={onBeforeRendering:function(){var e=t.$().find(".sapFCardDataTimestamp");e.off("click",this._oRefreshWithoutCacheBound)}.bind(this),onAfterRendering:function(){var e=t.$().find(".sapFCardDataTimestamp");e.on("click",this._oRefreshWithoutCacheBound)}.bind(this)};a.addEventDelegate(this._oHeaderDelegate)};n.prototype._detachTimestampPress=function(e){var t=this.getCardInstance(),a=t.getCardHeader(),s=this.getCardInstance().$().find(".sapFCardDataTimestamp");if(!a){return}s.off("click",this._oRefreshWithoutCacheBound);a.removeEventDelegate(this._oHeaderDelegate);this._oHeaderDelegate=null};return n});