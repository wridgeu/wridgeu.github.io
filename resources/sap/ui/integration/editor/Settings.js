/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/m/ResponsivePopover","sap/ui/model/json/JSONModel","sap/m/Button","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/m/VBox","sap/m/HBox","sap/m/Select","sap/ui/core/ListItem","sap/m/Label","sap/m/Text","sap/m/Title","sap/m/CheckBox","sap/m/Menu","sap/m/MenuItem","sap/m/Input","sap/ui/integration/util/ParameterMap","sap/base/util/merge","sap/ui/core/Core","sap/m/Table","sap/m/Column","sap/m/ColumnListItem","sap/m/ScrollContainer","sap/base/util/ObjectPath","sap/ui/integration/util/BindingHelper"],function(e,t,a,n,s,r,i,l,o,d,u,g,p,c,f,m,y,_,h,v,S,b,T,I,x,w){"use strict";var P=e.extend("sap.ui.integration.editor.Settings",{metadata:{library:"sap.ui.integration"},renderer:null});var D=v.getLibraryResourceBundle("sap.ui.integration"),E,C,V=null,M,A,O,R,L,N,$,U,B,j,F,H;P.prototype.setConfiguration=function(e){this._originalConfig=e;e=h({},e);var t=new a(e);this.setModel(t,"currentSettings");this.bindElement({path:"currentSettings>/"})};P.prototype.open=function(e,t,a,n,s,r,i){var l=this.getModel("currentSettings").getData();if(l.values){this.prepareFieldsInKey(l)}V=this;H=K(l,s);this.addDependent(H);this.oHost=n;this.fnApply=r;this.fnCancel=i;this._oOpener=s;C=true;e.addDependent(this);if(!l.allowDynamicValues&&l.values){v.byId("settings_scroll_container").setHeight("155px")}this.getModel("currentSettings").checkUpdate(true,true);re(D.getText("EDITOR_SELECT_FROM_LIST"),[]);if(t){var o=!a||a.getDomRef()===null||a.getDomRef().offsetWidth===0?270:a.getDomRef().offsetWidth;var d=!a||a.getDomRef()===null||a.getDomRef().offsetHeight===0?350:a.getDomRef().offsetHeight;H.setContentWidth(o+"px");H.setContentHeight(d-50+"px");if(s.getPreviewPosition()==="right"){H.setPlacement("Right")}else{H.setPlacement("Left")}R.setValue(e._label);H.openBy(e)}else{H.open()}E=this.getModel("currentSettings");if(E.getProperty("/_hasDynamicValue")){q()}else if(E.getProperty("/_hasSettings")){Y()}else if(E.getProperty("/allowDynamicValues")){q()}else if(E.getProperty("/allowSettings")){Y()}};P.prototype._applyCurrentSettings=function(){this.fnApply(E.getData())};P.prototype._cancelCurrentSettings=function(){this.fnCancel(this._originalConfig)};P.prototype.destroy=function(){this.removeDependent(H);return e.prototype.destroy.apply(this,arguments)};function K(e,a){var s=k(),r=z(e),i=X(),l=ee(),o=te(e,a),d=new t({id:"settings_popover",showArrow:true,contentWidth:"400px",showHeader:false,horizontalScrolling:false,verticalScrolling:false,modal:false,endButton:new n({text:D.getText("EDITOR_MORE_CANCEL"),press:function(){d.close()}}),beginButton:new n({text:D.getText("EDITOR_MORE_OK"),type:"Emphasized",press:function(){if(e.values){var t=v.byId("settings_pav_table"),a=t.getSelectedContexts(),n=[];if(E.getProperty("/selectedValues")==="Partion"){for(var s=0;s<a.length;s++){var r=V.getKeyFromItem(a[s].getObject());n.push(r)}Z("pageAdminValues",n)}else{Z("pageAdminValues",[])}}V._applyCurrentSettings();C=false;d.close()}}),afterClose:function(){if(C){V._cancelCurrentSettings()}C=true;d.destroy()},afterOpen:function(){var t=this.getDomRef().querySelector("footer");var a=r.getDomRef(),n=t.querySelector("button").parentNode;if(a){n.insertBefore(a,n.firstChild)}window.requestAnimationFrame(function(){d.getDomRef()&&(d.getDomRef().style.opacity="1")});if(e.values){var s=v.byId("settings_pav_table"),i=E.getProperty("/_next/pageAdminValues");if(i!==undefined&&i.length>0){s.removeSelections();E.setProperty("/selectedValues","None");var l=E.getProperty("/_next/pageAdminValues"),o=s.getItems();for(var u=0;u<l.length;u++){for(var g=0;g<o.length;g++){var p=V.getKeyFromItem(o[g].getBindingContext().getObject());if(l[u]===p){s.setSelectedItem(o[g])}}}E.setProperty("/selectedValues","Partion")}else{s.selectAll();E.setProperty("/selectedValues","All")}}}});d.setCustomHeader(s);d.addContent(r);d.addContent(i);d.addContent(l);d.addContent(o);d.addStyleClass("sapUiIntegrationFieldSettings");return d}function G(){B=new r({text:D.getText("EDITOR_MORE_SETTINGS"),key:"settings",icon:"sap-icon://action-settings",width:"50%",press:Y}).addStyleClass("setbtn");return B}function W(){B=G();j=new s("settings_Segment_btn",{width:"100%",visible:"{= ${currentSettings>allowDynamicValues} && ${currentSettings>allowSettings}}",items:[new r({text:D.getText("EDITOR_MORE_DYNAMICVALUES"),key:"dynamic",icon:"{= ${currentSettings>_hasDynamicValue} ? 'sap-icon://display-more' : 'sap-icon://enter-more'}",width:"50%",press:q}).addStyleClass("dynbtn sel"),B]});return j}function k(){j=W();var e=new g({text:D.getText("EDITOR_MORE_DYNAMICVALUES"),tooltip:D.getText("EDITOR_MORE_DYNAMICVALUES"),visible:"{= ${currentSettings>allowDynamicValues} && !${currentSettings>allowSettings}}"}).addStyleClass("sapUiTinyMagin");var t=new g({text:D.getText("EDITOR_MORE_SETTINGS"),visible:"{= !${currentSettings>allowDynamicValues} && ${currentSettings>allowSettings}}"}).addStyleClass("sapUiTinyMagin");var a=new l({width:"100%",items:[j,e,t]}).addStyleClass("headertitle");return a}function z(e){F=new n("settings_reset_to_default_btn",{type:"Transparent",text:D.getText("EDITOR_MORE_RESET"),enabled:"{= ${currentSettings>_next/visible} === (typeof(${currentSettings>visibleToUser}) === 'undefined' ? false : !${currentSettings>visibleToUser}) || ${currentSettings>_next/editable} === (typeof(${currentSettings>editableToUser}) === 'undefined' ? false : !${currentSettings>editableToUser}) || ${currentSettings>_next/allowDynamicValues} === (typeof(${currentSettings>allowDynamicValues}) === 'undefined' ? false : !${currentSettings>allowDynamicValues}) || ${currentSettings>_beforeValue} !== ${currentSettings>value}}",tooltip:D.getText("EDITOR_MORE_SETTINGS_P_ADMIN_RESET"),press:function(){var t=typeof E.getProperty("/visibleToUser")==="undefined"?true:E.getProperty("/visibleToUser");var a=typeof E.getProperty("/editableToUser")==="undefined"?true:E.getProperty("/editableToUser");var n=typeof E.getProperty("/allowDynamicValues")==="undefined"?true:E.getProperty("/allowDynamicValues");var s=v.byId("settings_popover");Z("visible",t);Z("editable",a);Z("allowDynamicValues",n);if(E.getProperty("/translatable")){if(E.getProperty("/_translatedDefaultValue")&&E.getProperty("/_translatedDefaultValue")!==""){E.setProperty("/value",E.getProperty("/_translatedDefaultValue"))}else if(E.getProperty("/_translatedDefaultPlaceholder")&&E.getProperty("/_translatedDefaultPlaceholder")!==""){E.setProperty("/value",E.getProperty("/_translatedDefaultPlaceholder"))}E.setProperty("/_changed",false)}else{E.setProperty("/value",E.getProperty("/_beforeValue"))}if(e.values){var r=v.byId("settings_pav_table"),i=E.getProperty("/_next/pageAdminValues"),l=r.getItems();if(i!==undefined&&i.length>0&&i.length<l.length){r.removeSelections();for(var o=0;o<i.length;o++){for(var d=0;d<l.length;d++){var u=V.getKeyFromItem(l[d].getBindingContext().getObject());if(i[o]===u){r.setSelectedItem(l[d])}}}E.setProperty("/selectedValues","Partion")}else{r.selectAll();E.setProperty("/selectedValues","All")}}s.getBeginButton().firePress()}}).addStyleClass("resetbutton");return F}function Y(){A.setVisible(true);M.setVisible(false);v.byId("settings_Segment_btn").setSelectedKey("settings");var e=v.byId("settings_current_value");e.setVisible(false)}function q(){A.setVisible(false);M.setVisible(true);v.byId("settings_Segment_btn").setSelectedKey("dynamic");var e=V.getModel("contextflat"),t=e._getValueObject(E.getProperty("/value"));if(t&&t.object.label){R.setValue(t.object.label);re(t.object.description,t.object.tags);if(t.path==="empty"){R.setValue(t.object.label)}le(t)}var a=v.byId("settings_current_value");a.setVisible(true)}function Z(e,t){if(!E.getProperty("/_next")){E.setProperty("/_next",{})}E.setProperty("/_next/"+e,t)}function J(e,t){var a=[];for(var n in e){if(e[n]&&e[n].label){var s=new m({text:e[n].label});s.__data=e[n];e[n].pathvalue=(t+"/"+n).substring(1);a.push(s);var r=J(e[n],t+"/"+n);for(var i=0;i<r.length;i++){s.addItem(r[i])}}}return a}var Q=[{formatMethod:"format.DateTime",sourceTypes:["datetime","date"],label:"Relative date/datetime text of the value",description:"Should be applied to dynamic values of type date or datetime or string values that represent a datetime in the format 'yyyy-MM-ddZhh:mm:ss'",example:"4 weeks ago",syntax:"handlebars",binding:"{= format.dateTime('__|VALUE|__',{relative:true})}"},{formatMethod:"format.DateTime",sourceTypes:["datetime","date"],label:"Short date/datetime text of the value",description:"Should be applied to dynamic values of type date, date-time or text values that represent a datetime in the format 'yyyy-MM-ddZhh:mm:ss.sss'",example:"9/18/20, 2:09 PM",binding:"{= format.dateTime('__|VALUE|__',{style:'short'})}"},{formatMethod:"format.DateTime",sourceTypes:["datetime","date"],label:"Medium date/datetime text of the value",description:"Should be applied to dynamic values of type date, date-time or text values that represent a datetime in the format 'yyyy-MM-ddThh:mm:ss.sssZ'",example:"Sep 18, 2020, 2:09:04 PM",binding:"{= format.dateTime('__|VALUE|__',{style:'medium'})}"},{formatMethod:"format.DateTime",sourceTypes:["datetime","date"],label:"Long date, date-time text of the value",description:"Should be applied to dynamic values of type date or date-time or string values that represent a datetime in the format 'yyyy-MM-ddThh:mm:ss.sssZ'",example:"Sep 18, 2020, 2:09:04 PM",binding:"{= format.dateTime('__|VALUE|__',{style:'long'})}"}];function X(){M=new i({visible:true});M.addStyleClass("sapUiSmallMargin");R=new y({width:"100%",showValueHelp:true,valueHelpOnly:true,valueHelpRequest:function(){if(L){L.destroy()}L=new f({});N=J(M.getModel("context").getData(),"");for(var e=0;e<N.length;e++){L.addItem(N[e])}L.attachItemSelected(function(e){var t=e.getParameter("item").__data;re(t.description||"",t.tags||[]);R.setValue(t.placeholder||t.label);var a=V.getModel("contextflat");le(a._getPathObject(t.pathvalue))});R.addDependent(L);L.addStyleClass("sapUiIntegrationFieldSettingsMenu");L.openBy(R,false,null,null,"1 0")}});R.addStyleClass("selectvariable");var e=new u({text:"Select a dynamic value"});R.addAriaLabelledBy(e);var t=new i({items:[e,R]});M.addItem(t);O=new g({text:"",maxLines:6,renderWhitespace:true});t=new i({width:"100%",items:[O]});O.addStyleClass("description");M.addItem(t);if(Q.length===-1){$=new o({width:"100%",enabled:true,change:function(){U.setText($.getSelectedItem()._data.description)}});t=new i({visible:false,items:[new u({text:"Customize the value..."}),$]});M.addItem(t);U=new g({text:"",maxLines:4,renderWhitespace:true});U.addStyleClass("description");t=new i({width:"100%",items:[U]});M.addItem(t);M.getItems()[2].getItems()[0].addStyleClass("sapUiTinyMarginTop")}M.getItems()[0].getItems()[0].addStyleClass("sapUiTinyMarginTop");return M}function ee(){var e=new g({text:D.getText("EDITOR_ACTUAL_VALUE")});var t=new y({value:{path:"currentSettings>_currentContextValue"},editable:false});t.addAriaLabelledBy(e);var a=new i("settings_current_value",{width:"100%",items:[e,t]});a.addStyleClass("currentval");return a}function te(e,t){A=new i({visible:false});var s=(new i).addStyleClass("commonSettings");A.addItem(s);s.addItem(new p({text:D.getText("EDITOR_MORE_SETTINGS_P_ADMIN"),wrapping:true}).addStyleClass("stitle"));var r=new u({text:D.getText("EDITOR_MORE_SETTINGS_P_ADMIN_VISIBLE"),wrapping:true});var o=new c({selected:"{= ${currentSettings>_next/visible} !== false}",select:function(e){Z("visible",e.getParameter("selected"))}});o.addAriaLabelledBy(r);s.addItem(new l({items:[r,o]}).addStyleClass("cbrow"));var d=new u({text:D.getText("EDITOR_MORE_SETTINGS_P_ADMIN_EDIT"),wrapping:true});var f=new c({selected:"{= ${currentSettings>_next/editable} !== false}",enabled:"{= ${currentSettings>_next/visible} !== false}",select:function(e){Z("editable",e.getParameter("selected"))}});f.addAriaLabelledBy(d);s.addItem(new l({items:[d,f]}).addStyleClass("cbrow"));var m=new u({text:D.getText("EDITOR_MORE_SETTINGS_P_ADMIN_DYN"),wrapping:true});var y=new c({selected:"{= ${currentSettings>_next/allowDynamicValues} !== false}",enabled:"{= ${currentSettings>_next/visible} !== false && ${currentSettings>_next/editable} !== false}",select:function(e){Z("allowDynamicValues",e.getParameter("selected"))}});y.addAriaLabelledBy(m);s.addItem(new l({visible:"{= ${currentSettings>allowDynamicValues}!== false}",items:[m,y]}).addStyleClass("cbrow"));if(e.values){var _;if(e.values.data){var h=e.values.data.path,v;if(h&&h!=="/"){if(h.startsWith("/")){h=h.substring(1)}if(h.endsWith("/")){h=h.substring(0,h.length-1)}v=h.split("/");_=x.get(["_values",v],e)}else{_=x.get(["_values"],e)}}else if(t.getParent().getParent().getAggregation("_extension")){var P=e.values.path;if(P.length>1){P=P.substring(1)}_=x.get([P],t.getModel().getData())}s.addItem(new l({visible:"{= ${currentSettings>_next/visible} !== false && ${currentSettings>_next/editable} !== false}",items:[new u({text:D.getText("EDITOR_MORE_SETTINGS_P_ADMIN_VALUES_LIST"),tooltip:D.getText("EDITOR_MORE_SETTINGS_P_ADMIN_VALUES_LIST_TOOLTIPS"),wrapping:false}),new n({type:"Transparent",enabled:_!==undefined,icon:{path:"currentSettings>selectedValues",formatter:function(e){if(e==="All"){return"sap-icon://multiselect-all"}else if(e==="Partion"){return"sap-icon://multi-select"}else if(e==="None"){return"sap-icon://multiselect-none"}}},tooltip:{path:"currentSettings>selectedValues",formatter:function(e){if(e==="All"){return D.getText("EDITOR_MORE_SETTINGS_P_ADMIN_DESELECT_ALL")}else{return D.getText("EDITOR_MORE_SETTINGS_P_ADMIN_SELECT_ALL")}}},press:ae})]}).addStyleClass("cbrow"));var E=new S({id:"settings_pav_table",mode:"MultiSelect",width:"84%",select:ne,columns:[new b]}).addStyleClass("tableHdr");var C=e.values.item.text,V=new a(_);E.setModel(V);var M=(new T).addStyleClass("pavlistItem");if(_){for(var O=0;O<_.length;O++){M.addCell(new l({items:[new g({text:w.createBindingInfos(C)}).addStyleClass("pavTblCellText")]})).addStyleClass("pavlistItem")}}E.bindItems("/",M);var R=new I({id:"settings_scroll_container",height:"125px",width:"94%",vertical:true,horizontal:false,visible:"{= ${currentSettings>_next/visible} !== false && ${currentSettings>_next/editable} !== false}",content:[E]}).addStyleClass("SettingsPAVTable");A.addItem(R)}return A}function ae(){var e=v.byId("settings_pav_table"),t=v.byId("settings_reset_to_default_btn"),a=E.getProperty("/selectedValues");if(a==="All"){e.removeSelections();E.setProperty("/selectedValues","None")}else{e.selectAll();E.setProperty("/selectedValues","All")}if(!t.getEnabled()){t.setEnabled(true)}}function ne(e){var t=e.getSource(),a=t.getSelectedItems(),n=t.getItems(),s=v.byId("settings_reset_to_default_btn");if(a.length===n.length){E.setProperty("/selectedValues","All")}else if(a.length<n.length&&a.length>0){E.setProperty("/selectedValues","Partion")}else{E.setProperty("/selectedValues","None")}if(!s.getEnabled()){s.setEnabled(true)}}function se(e,t){e=e||[];$.removeAllItems();var a=[];$.addItem(new d({text:"No customizing needed",key:""}));for(var n=0;n<Q.length;n++){var s=Q[n],r=new d({text:s.label,key:"key"+n});r._data=s;if(s.sourceTypes.indexOf(t)>-1||e.indexOf(s.formatMethod)>-1){$.addItem(r)}else{a.push(r)}}for(var n=0;n<a.length;n++){$.addItem(a[n])}}function re(e,t){t=t||[];if(t.indexOf("technical")>-1){e=e+"\n"+D.getText("EDITOR_MORE_DYNAMICVALUES_TECHHINT")}O.setText(e)}function ie(e){if(Q.length===-1){if(!e){$.removeAllItems();$.addItem(new d({text:"No customizing available for this value"}));U.setText("");$.setEnabled(false)}else{se(e.customize,e.type);$.setEnabled(true)}}}function le(e){if(e){E.setProperty("/_hasDynamicValue",true);var t=e.value;E.setProperty("/value",t);E.setProperty("/_contextpath",e.path);if(e.object&&e.object.value&&e.object.value.indexOf("{{")===0){E.setProperty("/_currentContextValue",_.processPredefinedParameter(e.object.value));ie(e.object)}else{if(e.path==="empty"){E.setProperty("/value","");E.setProperty("/_currentContextValue","");E.setProperty("/_hasDynamicValue",false);ie()}else{ie(e.object);if(e.object&&e.object.hasOwnProperty("value")){E.setProperty("/_currentContextValue",e.object.value)}else{V.oHost.getContextValue(e.path+"/value").then(function(t){if(t===null){E.setProperty("/_currentContextValue","(not available)")}else{E.setProperty("/_currentContextValue",t)}e.object&&(e.object.value=t)})}}}}}P._private=function(){return{oPopover:H,oSegmentedButton:j,oSettingsButton:B,oDynamicPanel:M,oSettingsPanel:A,oCurrentModel:E,updateCurrentValue:le,oCurrentInstance:V,oDynamicValueField:R,oResetToDefaultButton:F,getMenuItems:function(){return N},getMenu:function(){return L}}};P.prototype.prepareFieldsInKey=function(e){this._sKeySeparator=e.values.keySeparator;if(!this._sKeySeparator){this._sKeySeparator="#"}var t=e.values.item.key;this._aFields=t.split(this._sKeySeparator);for(var a in this._aFields){if(this._aFields[a].startsWith("{")){this._aFields[a]=this._aFields[a].substring(1)}if(this._aFields[a].endsWith("}")){this._aFields[a]=this._aFields[a].substring(0,this._aFields[a].length-1)}}};P.prototype.getKeyFromItem=function(e){var t="";this._aFields.forEach(function(a){t+=e[a].toString()+this._sKeySeparator}.bind(this));if(t.endsWith(this._sKeySeparator)){t=t.substring(0,t.length-this._sKeySeparator.length)}return t};return P});