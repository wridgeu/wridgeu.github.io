/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/BaseField","sap/m/Input","sap/m/Text","sap/m/Title","sap/m/Select","sap/m/ComboBox","sap/m/Popover","sap/m/Button","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/ui/core/ListItem","sap/m/List","sap/m/CustomListItem","sap/m/VBox","sap/base/util/each","sap/base/util/restricted/_debounce","sap/ui/core/Core","sap/ui/model/json/JSONModel","sap/base/util/deepClone","sap/ui/model/Sorter","sap/m/GroupHeaderListItem","sap/ui/core/CustomData"],function(e,t,a,n,s,r,i,l,o,u,g,p,d,c,v,_,h,f,T,L,m,y){"use strict";var I=/parameters\.([^\}\}]+)/g;var P=["TODAY_ISO","NOW_ISO","LOCALE"];var S=e.extend("sap.ui.integration.editor.fields.StringField",{metadata:{library:"sap.ui.integration"},renderer:e.getMetadata().getRenderer()});S.prototype.initVisualization=function(e){var n=e.visualization;var i;if(!n){var l=e.value?e.value.match(I):undefined;var o,u,p;if(l&&l.length>0){l=l.filter(function(e){var t=e.substring(11);return!P.includes(t)})}if(l&&l.length>0){o=l.map(function(e){if(this.isOrigLangField){return"items>"+e.substring(11)+"/_language/value"}return"items>"+e.substring(11)+"/value"}.bind(this));o.unshift("currentSettings>value");u={parts:o,formatter:function(e){var t=Array.prototype.slice.call(arguments,1);for(var a=0;a<t.length;a++){if(t[a]){e=e.replaceAll("{{"+l[a]+"}}",t[a])}}return e}};p=function(e){var t=e.getSource().getValue();var a=this.getBindingContext("currentSettings").sPath;this._settingsModel.setProperty(a+"/value",t);var n=this._settingsModel.getBindings();var s=a.substring(a.lastIndexOf("/")+1);v(n,function(e,t){if(t.sPath==="/form/items/"+s+"/value"){t.checkUpdate(true)}})}.bind(this)}if(this.getMode()==="translation"){if(e.editable){n={type:t,settings:{value:{path:"currentSettings>value"},tooltip:{path:"currentSettings>value"},editable:e.editable,visible:e.visible,maxLength:e.maxLength,placeholder:e.placeholder}}}else{n={type:a,settings:{text:{path:"currentSettings>value"},tooltip:{path:"currentSettings>value"},visible:e.visible,wrapping:false}}}}else if(e.enum){i=new g({key:{path:"currentSettings>"},text:{path:"currentSettings>"}});n={type:s,settings:{selectedKey:{path:"currentSettings>value"},forceSelection:false,editable:e.editable,visible:e.visible,showSecondaryValues:false,width:"100%",items:{path:"currentSettings>enum",template:i}}}}else if(e.values){i=this.formatListItem(e.values.item);if(!e.values.item.key){e.values.item.key=e.values.item.text}n={type:r,settings:{busy:{path:"currentSettings>_loading"},selectedKey:{path:"currentSettings>value"},editable:e.editable,visible:e.visible,showSecondaryValues:true,width:"100%",items:{path:"",template:i}}};if(this.isFilterBackend()){n.settings.selectedKey={parts:["currentSettings>value","currentSettings>suggestValue"],formatter:function(e,t){if((!e||e==="")&&t){return t.replaceAll("''","'")}else{return e}}}}}else if(this.getMode()!=="translation"&&e.translatable){n={type:t,settings:{value:{path:"currentSettings>value"},tooltip:{path:"currentSettings>value"},editable:e.editable,visible:e.visible,maxLength:e.maxLength,placeholder:e.placeholder,valueHelpIconSrc:"sap-icon://translate",showValueHelp:true,valueHelpRequest:this.openTranslationListPopup.bind(this),change:function(t){var a=t.getSource();var n=a.getValue();var s=h.getConfiguration().getLanguage().replaceAll("_","-");a.getParent().setTranslationValueInTexts(s,e.manifestpath,n)}}};if(o){delete n.settings.tooltip;n.settings.value=u;n.settings.change=p;n.settings.showValueHelp=false;delete n.settings.valueHelpRequest}}else{n={type:t,settings:{value:{path:"currentSettings>value"},tooltip:{path:"currentSettings>value"},editable:e.editable,visible:e.visible,maxLength:e.maxLength,placeholder:e.placeholder}};if(o){delete n.settings.tooltip;n.settings.value=u;n.settings.change=p}}}else if(n.type==="TextArea"){n.type="sap/m/TextArea"}else if(n.type==="Select"&&e.values){i=this.formatListItem(e.values.item);var d=Object.assign({selectedKey:{path:"currentSettings>value"},forceSelection:false,editable:e.editable,visible:e.visible,showSecondaryValues:false,width:"100%",items:{path:"",template:i}},n.settings||{});n={type:s,settings:d}}this._visualization=n;this.attachAfterInit(this._afterInit)};S.prototype._afterInit=function(){var e=this.getAggregation("_field");if(e instanceof r){if(this.isFilterBackend()){this.onInput=_(this.onInput,500);e.oninput=this.onInput.bind(this);e.attachSelectionChange(this.onSelectionChange.bind(this))}}};S.prototype.onSelectionChange=function(e){var t=e.getParameter("selectedItem")||{};var a=t.getKey();var n=this.getBindingContext("currentSettings").sPath;this._settingsModel.setProperty(n+"/value",a)};S.prototype.onInput=function(e){var t=e.target.value;var a=this.getBindingContext("currentSettings").sPath;this._settingsModel.setProperty(a+"/suggestValue",t.replaceAll("'","''"));this._settingsModel.setProperty(a+"/_loading",true);this._settingsModel.setProperty(a+"/value","");var n=this._settingsModel.getBindings();var s=a.substring(a.lastIndexOf("/")+1);v(n,function(e,t){if(t.sPath==="/form/items/"+s+"/value"){t.checkUpdate(true)}});var r=e.srcControl;r.open();r.setValue(t);r.setSelection(null)};S.prototype.getOriginTranslatedValues=function(e){var t=[];var a=this._oEditorResourceBundles.getResourceBundles();var n;if(e._translatedDefaultPlaceholder&&e._translatedDefaultPlaceholder.startsWith("{i18n>")&&e._translatedDefaultPlaceholder.endsWith("}")){n=e._translatedDefaultPlaceholder.substring(6,e._translatedDefaultPlaceholder.length-1)}else if(e._translatedDefaultPlaceholder&&e._translatedDefaultPlaceholder.startsWith("{{")&&e._translatedDefaultPlaceholder.endsWith("}}")){n=e._translatedDefaultPlaceholder.substring(2,e._translatedDefaultPlaceholder.length-2)}for(var s in a){var r=a[s];var i="";var l="";if(n&&r){var o=r.resourceBundle&&r.resourceBundle.getText(n,[],true);if(o!==undefined){i=o;l=o}else{i=e._translatedValue||"";l=e._translatedValue||""}}else{i=e._translatedDefaultPlaceholder||"";l=e._translatedDefaultPlaceholder||""}var u={key:s,description:r.language,value:i,originValue:l,editable:true};t.push(u)}return t};S.prototype.getTranslationValueInTexts=function(e,t){var a="/texts/"+e;var n=this._settingsModel.getProperty(a)||{};return n[t]};S.prototype.setTranslationValueInTexts=function(e,t,a){var n="/texts";var s=this._settingsModel.getData();if(!s){return}if(!s.hasOwnProperty("texts")){var r={};r[e]={};r[e][t]=a;this._settingsModel.setProperty(n,r)}else{n="/texts/"+e;var i;if(!s.texts.hasOwnProperty(e)){i={}}else{i=s.texts[e]}i[t]=a;this._settingsModel.setProperty(n,i)}};S.prototype.openTranslationListPopup=function(e){var s=this;var r=e.getSource();var g=r.getParent();var v=g.getParameterId();var _=g.getConfiguration();if(!s._aOriginTranslatedValues){s._aOriginTranslatedValues=g.getOriginTranslatedValues(_)}var h=T(s._aOriginTranslatedValues,500);var m=g.getResourceBundle();h.forEach(function(e){var t=g.getTranslationValueInTexts(e.key,_.manifestpath);if(t){e.value=t;if(Array.isArray(s._aUpdatedLanguages)&&!s._aUpdatedLanguages.includes(e.key)){e.originValue=e.value}}else if(_._beforeLayerChange){e.value=_._beforeLayerChange;if(Array.isArray(s._aUpdatedLanguages)&&!s._aUpdatedLanguages.includes(e.key)){e.originValue=e.value}}e.status=m.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_NOTUPDATED");if(e.key===m.sLocale.replaceAll("_","-")){e.editable=false}});var I={currentLanguage:{},isUpdated:false,translatedLanguages:[]};var P;if(h){h.forEach(function(e){if(Array.isArray(s._aUpdatedLanguages)&&s._aUpdatedLanguages.includes(e.key)){e.value=g.getTranslationValueInTexts(e.key,_.manifestpath);e.status=m.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_UPDATED")}if(e.key===m.sLocale.replaceAll("_","-")){e.value=r.getValue();I.currentLanguage=e}else{I.translatedLanguages.push(e)}})}var S=g.getPopoverPlacement(r._oValueHelpIcon);if(!s._oTranslationPopover){var O=new p(v+"_translation_popover_value_list",{items:{path:"languages>/translatedLanguages",template:new d({content:[new c({items:[new a({text:"{languages>description}"}),new t({value:"{languages>value}",editable:"{languages>editable}"})]})],customData:[new y({key:"{languages>key}",value:"{languages>description}"})]}),sorter:[new L({path:"status",descending:true,group:true})],groupHeaderFactory:g.getGroupHeader}});s._oTranslationPopover=new i(v+"_translation_popover",{placement:S,contentWidth:"300px",contentHeight:"345px",customHeader:new c({items:[new n({text:m.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_TITLE")}).addStyleClass("sapMPopoverTitle"),new n({text:m.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_CURRENTLANGUAGE")}).addStyleClass("sapMHeaderTitle"),new c({items:[new a(v+"_translation_popover_currentlanguage_description_label",{text:"{languages>/currentLanguage/description}"}),new t(v+"_translation_popover_currentlanguage_value_input",{value:"{languages>/currentLanguage/value}",editable:false})]}).addStyleClass("sapMCurrentLanguageVBox"),new n({text:m.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_OTHERLANGUAGES")}).addStyleClass("sapMHeaderTitle")]}),content:O,footer:new o({content:[new u,new l(v+"_translation_popover_save_btn",{type:"Emphasized",text:m.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_SAVE"),enabled:"{languages>/isUpdated}",press:function(){var e=s._oTranslationPopover.getModel("languages").getData();var t=[];e.translatedLanguages.forEach(function(e){if(e.value!==e.originValue){g.setTranslationValueInTexts(e.key,_.manifestpath,e.value);t.push(e.key)}});if(e.currentLanguage.value!=e.currentLanguage.originValue){g.setTranslationValueInTexts(e.currentLanguage.key,_.manifestpath,e.currentLanguage.value);t.push(e.currentLanguage.key)}if(t.length>0){s._aUpdatedLanguages=t}s._oTranslationPopover.close()}}),new l(v+"_translation_popover_cancel_btn",{text:m.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_CANCEL"),press:function(){s._oTranslationPopover.close()}})]})}).addStyleClass("sapUiIntegrationFieldTranslation");P=new f(I);P.attachPropertyChange(function(e){var t=P.getData();var a=m.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_UPDATED");var n=m.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_NOTUPDATED");var s=false;t.translatedLanguages.forEach(function(e){if(e.value!==e.originValue){e.status=a;s=true}else{e.status=n}});t.isUpdated=s;P.setData(t);P.checkUpdate(true)});s._oTranslationPopover.setModel(P,"languages")}else{s._oTranslationPopover.setPlacement(S);P=s._oTranslationPopover.getModel("languages");P.setData(I);P.checkUpdate(true)}s._oTranslationPopover.openBy(r._oValueHelpIcon)};S.prototype.getGroupHeader=function(e){return new m({title:e.key,upperCase:false})};return S});
//# sourceMappingURL=StringField.js.map