/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/BaseField","sap/m/Input","sap/m/Text","sap/m/MultiComboBox","sap/ui/core/ListItem","sap/base/util/each","sap/base/util/restricted/_debounce","sap/base/util/restricted/_isEqual","sap/base/util/ObjectPath","sap/base/util/includes","sap/ui/core/SeparatorItem","sap/ui/core/Core","sap/ui/model/Sorter","sap/base/util/deepClone"],function(e,t,i,a,r,s,n,o,g,l,u,h,p,c){"use strict";var d="#";var v=h.getLibraryResourceBundle("sap.ui.integration");var f=e.extend("sap.ui.integration.editor.fields.ListField",{metadata:{library:"sap.ui.integration"},renderer:e.getMetadata().getRenderer()});f.prototype.initVisualization=function(e){if(v&&v.sLocale!==h.getConfiguration().getLanguage()){v=h.getLibraryResourceBundle("sap.ui.integration")}var i=this;var r=e.visualization;if(!r){if(e.values){var s=this.formatListItem(e.values.item);r={type:a,settings:{selectedKeys:{path:"currentSettings>value"},busy:{path:"currentSettings>_loading"},editable:e.editable,visible:e.visible,showSecondaryValues:true,width:"100%",items:{path:"",template:s,sorter:[new p({path:"Selected",descending:false,group:true})],groupHeaderFactory:i.getGroupHeader}}};if(this.isFilterBackend()){r.settings.selectedKeys={parts:["currentSettings>value","currentSettings>suggestValue"],formatter:function(e,t){if(t){i.setSuggestValue()}return e}}}}else{r={type:t,settings:{value:{path:"currentSettings>value",formatter:function(e){e=e||[];return e.join(",")}},change:function(e){var t=e.getSource();t.getBinding("value").setRawValue(t.getValue().split(","))},editable:e.editable,visible:e.visible,placeholder:e.placeholder}}}}this._visualization=r;this.attachAfterInit(this._afterInit)};f.prototype._afterInit=function(){var e=this.getAggregation("_field");if(e instanceof a){var t=this.getConfiguration();this.prepareFieldsInKey(t);e.onAfterOpen=this.onAfterOpen;if(this.isFilterBackend()){this.onInput=n(this.onInput,500);e.oninput=this.onInput;e.attachSelectionChange(this.onSelectionChangeForFilterBackend);e.attachSelectionFinish(this.onSelectionFinish);var i=this.getModel();i.attachPropertyChange(this.onPropertyChange,this)}else{e.attachSelectionChange(this.onSelectionChange)}}};f.prototype.prepareFieldsInKey=function(e){this._sKeySeparator=e.values.keySeparator;if(!this._sKeySeparator){this._sKeySeparator=d}var t=e.values.item.key;this._aFields=t.split(this._sKeySeparator);for(var i in this._aFields){if(this._aFields[i].startsWith("{")){this._aFields[i]=this._aFields[i].substring(1)}if(this._aFields[i].endsWith("}")){this._aFields[i]=this._aFields[i].substring(0,this._aFields[i].length-1)}}};f.prototype.getKeyFromItem=function(e){var t="";this._aFields.forEach(function(i){t+=e[i].toString()+this._sKeySeparator}.bind(this));if(t.endsWith(this._sKeySeparator)){t=t.substring(0,t.length-this._sKeySeparator.length)}return t};f.prototype.onPropertyChange=function(e){var t=this.getConfiguration();if(!t.valueItems){t.valueItems=[]}var i=t.values.data.path||"/";var a=this.getModel();var r=a.getData();if(i!=="/"){if(i.startsWith("/")){i=i.substring(1)}if(i.endsWith("/")){i=i.substring(0,i.length-1)}var s=i.split("/");var n=g.get(s,r);n=this.mergeSelectedItems(t,n);g.set(s,n,r)}else{r=this.mergeSelectedItems(t,r)}a.setData(r);this.setSuggestValue()};f.prototype.mergeSelectedItems=function(e,t){if(Array.isArray(t)){var i=e.valueItems.map(function(e){return this.getKeyFromItem(e)}.bind(this));var a=t.filter(function(e){var t=this.getKeyFromItem(e);return!l(i,t)}.bind(this));var r=a.filter(function(e){return e.Selected===v.getText("EDITOR_ITEM_SELECTED")});e.valueItems=e.valueItems.concat(r);var s=a.filter(function(e){return e.Selected!==v.getText("EDITOR_ITEM_SELECTED")});t=e.valueItems.concat(s);var n=this.getAggregation("_field");if(n.isOpen()){i=e.valueItems.map(function(e){return this.getKeyFromItem(e)}.bind(this));var g=n.getSelectedKeys();if(!o(i,g)){n.setSelectedKeys(i)}}}else{t=e.valueItems}return t};f.prototype.setSuggestValue=function(){var e=this.getAggregation("_field");var t=this.getBindingContext("currentSettings").sPath;var i=this.getModel("currentSettings");var a=i.getProperty(t+"/suggestValue");if(a&&a!==""){e.setValue(a.replaceAll("''","'"))}};f.prototype.getSuggestValue=function(){var e=this.getBindingContext("currentSettings").sPath;var t=this.getModel("currentSettings");return t.getProperty(e+"/suggestValue")};f.prototype.getGroupHeader=function(e){return new u({text:e.key})};f.prototype.onSelectionChangeForFilterBackend=function(e){var t=e.oSource.getParent();var i=t.getConfiguration();var a=e.getParameter("changedItem");var r=a.getKey();var s=e.getParameter("selected");var n=this.getModel().getData();var o=i.values.data.path||"/";var l,u;if(o!=="/"){if(o.startsWith("/")){o=o.substring(1)}if(o.endsWith("/")){o=o.substring(0,o.length-1)}l=o.split("/");u=g.get(l,n)}else{u=n}if(u){if(!i.valueItems){i.valueItems=[]}var h=[];u.forEach(function(e){var a=c(e,500);var n=t.getKeyFromItem(a);if(n===r){if(s){a.Selected=v.getText("EDITOR_ITEM_SELECTED");i.valueItems=i.valueItems.concat([a])}else{a.Selected=v.getText("EDITOR_ITEM_UNSELECTED");i.valueItems=i.valueItems.filter(function(e){var i=t.getKeyFromItem(e);return i!==r})}}h.push(a)});if(l!==undefined){g.set(l,h,n);this.getModel().checkUpdate(true)}else{this.getModel().setData(h)}}};f.prototype.onSelectionChange=function(e){var t=e.oSource.getParent();var i=t.getConfiguration();var a=e.getParameter("changedItem");var r=a.getKey();var s=e.getParameter("selected");var n=this.getModel().getData();var o=i.values.data.path||"/";if(o!=="/"){if(o.startsWith("/")){o=o.substring(1)}if(o.endsWith("/")){o=o.substring(0,o.length-1)}var l=o.split("/");var u=g.get(l,n);if(Array.isArray(u)){for(var h in u){var p=t.getKeyFromItem(u[h]);if(p===r){if(s){u[h].Selected=v.getText("EDITOR_ITEM_SELECTED")}else{u[h].Selected=v.getText("EDITOR_ITEM_UNSELECTED")}}}g.set(l,u,n)}}else if(Array.isArray(n)){for(var h in n){var p=t.getKeyFromItem(n[h]);if(p===r){if(s){n[h].Selected=v.getText("EDITOR_ITEM_SELECTED")}else{n[h].Selected=v.getText("EDITOR_ITEM_UNSELECTED")}}}}this.getModel().setData(n);this.getModel().checkUpdate(true)};f.prototype.onSelectionFinish=function(e){var t=this.getParent();var i=t.getConfiguration();var a=e.getParameter("selectedItems").map(function(e){return e.getKey()});var r=this.getModel().getData();var s=i.values.data.path||"/";if(s!=="/"){if(s.startsWith("/")){s=s.substring(1)}if(s.endsWith("/")){s=s.substring(0,s.length-1)}var n=s.split("/");r=g.get(n,r)}if(r){i.valueItems=r.filter(function(e){var i=t.getKeyFromItem(e);return l(a,i)})}var o=this.getBindingContext("currentSettings").sPath;var u=this.getModel("currentSettings");u.setProperty(o+"/value",a);var h=t.getSuggestValue();if(h&&h!==""){u.setProperty(o+"/suggestValue","")}};f.prototype.onInput=function(e){var t=e.target.value;var i=this.getBindingContext("currentSettings").sPath;var a=this.getModel("currentSettings");a.setProperty(i+"/suggestValue",t.replaceAll("'","''"));a.setProperty(i+"/_loading",true);e.srcControl.open();e.srcControl._getSuggestionsPopover()._sTypedInValue=t};f.prototype.onAfterOpen=function(){a.prototype.onAfterOpen.apply(this,arguments);var e=this.getPicker();if(e._oCalcedPos==="Bottom"&&!e.hasStyleClass("sapUiIntegrationEditorPopupHeight")){e.addStyleClass("sapUiIntegrationEditorPopupHeight")}else if(e._oCalcedPos!=="Bottom"&&e.hasStyleClass("sapUiIntegrationEditorPopupHeight")){e.removeStyleClass("sapUiIntegrationEditorPopupHeight")}};return f});