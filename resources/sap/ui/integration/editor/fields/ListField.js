/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/BaseField","sap/m/Input","sap/m/Text","sap/m/MultiComboBox","sap/m/MultiInput","sap/ui/core/ListItem","sap/base/util/each","sap/base/util/restricted/_debounce","sap/base/util/restricted/_isEqual","sap/base/util/ObjectPath","sap/base/util/includes","sap/base/util/merge","sap/ui/core/SeparatorItem","sap/ui/core/Core","sap/ui/model/Sorter","sap/m/Token","sap/m/Tokenizer","sap/base/util/deepClone"],function(e,t,a,r,i,s,n,o,u,l,g,h,p,v,c,d,f,y){"use strict";var m="#";var I=v.getLibraryResourceBundle("sap.ui.integration");var S=e.extend("sap.ui.integration.editor.fields.ListField",{metadata:{library:"sap.ui.integration"},renderer:e.getMetadata().getRenderer()});S.prototype.initVisualization=function(e){if(I&&I.sLocale!==v.getConfiguration().getLanguage()){I=v.getLibraryResourceBundle("sap.ui.integration")}var a=this,s;var n=e.visualization;if(!n){if(e.values){s=this.formatListItem(e.values.item);n={type:r,settings:{selectedKeys:{path:"currentSettings>value"},busy:{path:"currentSettings>_loading"},editable:e.editable,visible:e.visible,showSecondaryValues:true,width:"100%",items:{path:"",template:s,sorter:[new c({path:"Selected",descending:false,group:true})],groupHeaderFactory:a.getGroupHeader}}};if(this.isFilterBackend()){n.settings.selectedKeys={parts:["currentSettings>value","currentSettings>suggestValue"],formatter:function(e,t){if(t){a.setSuggestValue()}return e}}}}else{n={type:t,settings:{value:{path:"currentSettings>value",formatter:function(e){e=e||[];return e.join(",")}},change:function(e){var t=e.getSource();t.getBinding("value").setRawValue(t.getValue().split(","))},editable:e.editable,visible:e.visible,placeholder:e.placeholder}}}}else if(e.values&&this.isFilterBackend()&&n.type==="MultiInput"){s=this.formatListItem(e.values.item);var o={busy:{path:"currentSettings>_loading"},placeholder:e.placeholder,editable:e.editable,visible:e.visible,showSuggestion:true,autocomplete:false,showValueHelp:false,filterSuggests:false,width:"100%",suggestionItems:{path:"",template:s,sorter:[new c({path:"Selected",descending:false,group:true})],groupHeaderFactory:a.getGroupHeader}};if(n.settings){o=h(o,n.settings)}n={type:i,settings:o}}this._visualization=n;this.attachAfterInit(this._afterInit)};S.prototype._afterInit=function(){var e=this.getAggregation("_field");var t=this.getConfiguration();var a=this.getModel();if(t.values){this.prepareFieldsInKey(t)}if(e instanceof r){if(this.isFilterBackend()){this.onInputForMultiComboBox=o(this.onInputForMultiComboBox,500);e.oninput=this.onInputForMultiComboBox;e.attachSelectionChange(this.onSelectionChangeForFilterBackend);e.attachSelectionFinish(this.onSelectionFinish);a.attachPropertyChange(this.onPropertyChange,this)}else{e.attachSelectionChange(this.onSelectionChange)}}else if(e instanceof i){this.initTokens();this.onInputForMultiInput=o(this.onInputForMultiInput,500);e.oninput=this.onInputForMultiInput;a.attachPropertyChange(this.onPropertyChange,this);a.attachPropertyChange(this.initTokens,this);e.attachTokenChange(this.onTokenChange)}};S.prototype.prepareFieldsInKey=function(e){this._sKeySeparator=e.values.keySeparator;if(!this._sKeySeparator){this._sKeySeparator=m}var t=e.values.item.key;this._aFields=t.split(this._sKeySeparator);for(var a in this._aFields){if(this._aFields[a].startsWith("{")){this._aFields[a]=this._aFields[a].substring(1)}if(this._aFields[a].endsWith("}")){this._aFields[a]=this._aFields[a].substring(0,this._aFields[a].length-1)}}};S.prototype.initTokens=function(){var e=this.getAggregation("_field");var t=this.getConfiguration();var a=[];if(Array.isArray(t.valueTokens)&&t.valueTokens.length>0){t.valueTokens.forEach(function(e){var t=new d(e);a.push(t)})}else if(Array.isArray(t.value)&&t.value.length>0&&Array.isArray(t.valueItems)&&t.valueItems.length>0){t.valueTokens=[];var r=t.valueItems.map(function(e){return this.getKeyFromItem(e)}.bind(this));t.value.forEach(function(i){if(g(r,i)){var s=e.getSuggestionItemByKey(i);var n=s?s.getText():i;var o={key:i,text:n};var u=new d(o);a.push(u);t.valueTokens.push(o)}})}e.setTokens(a)};S.prototype.getKeyFromItem=function(e){var t="";this._aFields.forEach(function(a){t+=e[a].toString()+this._sKeySeparator}.bind(this));if(t.endsWith(this._sKeySeparator)){t=t.substring(0,t.length-this._sKeySeparator.length)}return t};S.prototype.onPropertyChange=function(e){var t=this.getConfiguration();if(!t.valueItems){t.valueItems=[]}var a=t.values.data.path||"/";var r=this.getModel();var i=r.getData();if(a!=="/"){if(a.startsWith("/")){a=a.substring(1)}if(a.endsWith("/")){a=a.substring(0,a.length-1)}var s=a.split("/");var n=l.get(s,i);n=this.mergeSelectedItems(t,n);l.set(s,n,i)}else{i=this.mergeSelectedItems(t,i)}r.setData(i);this.setSuggestValue()};S.prototype.mergeSelectedItems=function(e,t){if(Array.isArray(t)){var a=e.valueItems.map(function(e){return this.getKeyFromItem(e)}.bind(this));var r=t.filter(function(e){var t=this.getKeyFromItem(e);return!g(a,t)}.bind(this));var i=r.filter(function(e){return e.Selected===I.getText("EDITOR_ITEM_SELECTED")});e.valueItems=e.valueItems.concat(i);var s=r.filter(function(e){return e.Selected!==I.getText("EDITOR_ITEM_SELECTED")});t=e.valueItems.concat(s);var n=this.getAggregation("_field");if(n.isOpen&&n.isOpen()){a=e.valueItems.map(function(e){return this.getKeyFromItem(e)}.bind(this));var o=n.getSelectedKeys();if(!u(a,o)){n.setSelectedKeys(a)}}}else{t=e.valueItems}return t};S.prototype.setSuggestValue=function(){var e=this.getAggregation("_field");var t=this.getBindingContext("currentSettings").sPath;var a=this.getModel("currentSettings");var r=a.getProperty(t+"/suggestValue");if(r&&r!==""){e.setValue(r.replaceAll("''","'"))}};S.prototype.getSuggestValue=function(){var e=this.getBindingContext("currentSettings").sPath;var t=this.getModel("currentSettings");return t.getProperty(e+"/suggestValue")};S.prototype.getGroupHeader=function(e){return new p({text:e.key})};S.prototype.onSelectionChangeForFilterBackend=function(e){var t=e.getSource().getParent();var a=t.getConfiguration();var r=e.getParameter("changedItem");var i=r.getKey();var s=e.getParameter("selected");var n=this.getModel().getData();var o=a.values.data.path||"/";var u,g;if(o!=="/"){if(o.startsWith("/")){o=o.substring(1)}if(o.endsWith("/")){o=o.substring(0,o.length-1)}u=o.split("/");g=l.get(u,n)}else{g=n}if(g){if(!a.valueItems){a.valueItems=[]}var h=[];g.forEach(function(e){var r=y(e,500);var n=t.getKeyFromItem(r);if(n===i){if(s){r.Selected=I.getText("EDITOR_ITEM_SELECTED");a.valueItems=a.valueItems.concat([r])}else{r.Selected=I.getText("EDITOR_ITEM_UNSELECTED");a.valueItems=a.valueItems.filter(function(e){var a=t.getKeyFromItem(e);return a!==i})}}h.push(r)});if(u!==undefined){l.set(u,h,n);this.getModel().checkUpdate(true)}else{this.getModel().setData(h)}}};S.prototype.onTokenChange=function(e){var t=this.getParent();var a=t.getConfiguration();var r=t.getModel("currentSettings");var i=t.getBindingContext("currentSettings").sPath;var s=r.getProperty(i+"/value");var n=e.getParameter("token");if(n){var o=n.getKey();if(!a.valueTokens){a.valueTokens=[]}if(!s){s=[]}var u=e.getParameter("type");switch(u){case f.TokenChangeType.Removed:s=s.filter(function(e){return e!==o});a.value=s;a.valueTokens=a.valueTokens.filter(function(e){return e.key!==o});break;case f.TokenChangeType.Added:if(!g(s,o)){s=s.concat([o]);a.value=s}var h=a.valueTokens.map(function(e){return e.key});if(!g(h,o)){a.valueTokens=a.valueTokens.concat([{key:o,text:n.getText()}])}break;case f.TokenChangeType.RemovedAll:a.value=[];a.valueItems=[];a.valueTokens=[];break;default:break}var p=t.getModel().getData();var v;var c=a.values.data.path||"/";var d;if(c!=="/"){if(c.startsWith("/")){c=c.substring(1)}if(c.endsWith("/")){c=c.substring(0,c.length-1)}d=c.split("/");v=y(l.get(d,p),10)}else{v=y(p,10)}if(Array.isArray(v)){a.valueItems=[];v.forEach(function(e){var r=t.getKeyFromItem(e);if(g(a.value,r)){e.Selected=I.getText("EDITOR_ITEM_SELECTED");a.valueItems.push(e)}else{e.Selected=I.getText("EDITOR_ITEM_UNSELECTED")}});if(c!=="/"){l.set(d,v,p)}else{p=v}t.getModel().setData(p);t.getModel().checkUpdate(true)}r.setProperty(i+"/value",a.value);r.setProperty(i+"/valueItems",a.valueItems)}};S.prototype.onSelectionChange=function(e){var t=e.oSource.getParent();var a=t.getConfiguration();var r=e.getParameter("changedItem");var i=r.getKey();var s=e.getParameter("selected");var n=this.getModel().getData();var o=a.values.data.path||"/";if(o!=="/"){if(o.startsWith("/")){o=o.substring(1)}if(o.endsWith("/")){o=o.substring(0,o.length-1)}var u=o.split("/");var g=l.get(u,n);if(Array.isArray(g)){for(var h in g){var p=t.getKeyFromItem(g[h]);if(p===i){if(s){g[h].Selected=I.getText("EDITOR_ITEM_SELECTED")}else{g[h].Selected=I.getText("EDITOR_ITEM_UNSELECTED")}}}l.set(u,g,n)}}else if(Array.isArray(n)){for(var h in n){var p=t.getKeyFromItem(n[h]);if(p===i){if(s){n[h].Selected=I.getText("EDITOR_ITEM_SELECTED")}else{n[h].Selected=I.getText("EDITOR_ITEM_UNSELECTED")}}}}this.getModel().setData(n);this.getModel().checkUpdate(true)};S.prototype.onSelectionFinish=function(e){var t=this.getParent();var a=t.getConfiguration();var r=e.getParameter("selectedItems").map(function(e){return e.getKey()});var i=this.getModel().getData();var s=a.values.data.path||"/";if(s!=="/"){if(s.startsWith("/")){s=s.substring(1)}if(s.endsWith("/")){s=s.substring(0,s.length-1)}var n=s.split("/");i=l.get(n,i)}if(i){a.valueItems=i.filter(function(e){var a=t.getKeyFromItem(e);return g(r,a)})}var o=this.getBindingContext("currentSettings").sPath;var u=this.getModel("currentSettings");u.setProperty(o+"/value",r);var h=t.getSuggestValue();if(h&&h!==""){u.setProperty(o+"/suggestValue","")}};S.prototype.onInputForMultiComboBox=function(e){var t=e.target.value;var a=this.getBindingContext("currentSettings").sPath;var r=this.getModel("currentSettings");r.setProperty(a+"/suggestValue",t.replaceAll("'","''"));r.setProperty(a+"/_loading",true);e.srcControl.open();e.srcControl._getSuggestionsPopover()._sTypedInValue=t};S.prototype.onInputForMultiInput=function(e){var t=e.srcControl;i.prototype.oninput.apply(t,arguments);var a=e.target.value;if(a===""){return}var r=this.getBindingContext("currentSettings").sPath;var s=this.getModel("currentSettings");var n=s.getProperty(r+"/suggestValue");if(n!==a.replaceAll("'","''")){s.setProperty(r+"/suggestValue",a.replaceAll("'","''"));s.setProperty(r+"/_loading",true)}};return S});