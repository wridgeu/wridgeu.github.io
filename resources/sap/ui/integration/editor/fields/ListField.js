/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/BaseField","sap/m/Input","sap/m/Text","sap/m/MultiComboBox","sap/ui/core/ListItem","sap/base/util/each","sap/base/util/restricted/_debounce","sap/base/util/ObjectPath","sap/base/util/includes","sap/ui/core/SeparatorItem","sap/ui/core/Core","sap/ui/model/Sorter","sap/base/util/deepClone"],function(e,t,i,a,r,s,n,o,l,u,g,h,p){"use strict";var c="#";var d=g.getLibraryResourceBundle("sap.ui.integration");var v=e.extend("sap.ui.integration.editor.fields.ListField",{metadata:{library:"sap.ui.integration"},renderer:e.getMetadata().getRenderer()});v.prototype.initVisualization=function(e){if(d&&d.sLocale!==g.getConfiguration().getLanguage()){d=g.getLibraryResourceBundle("sap.ui.integration")}var i=this;var r=e.visualization;if(!r){if(e.values){var s=this.formatListItem(e.values.item);r={type:a,settings:{selectedKeys:{path:"currentSettings>value"},busy:{path:"currentSettings>_loading"},editable:e.editable,visible:e.visible,showSecondaryValues:true,width:"100%",items:{path:"",template:s,sorter:[new h({path:"Selected",descending:false,group:true})],groupHeaderFactory:i.getGroupHeader}}};if(this.isFilterBackend()){r.settings.selectedKeys={parts:["currentSettings>value","currentSettings>suggestValue"],formatter:function(e,t){if(t){i.setSuggestValue()}return e}}}}else{r={type:t,settings:{value:{path:"currentSettings>value",formatter:function(e){e=e||[];return e.join(",")}},change:function(e){var t=e.getSource();t.getBinding("value").setRawValue(t.getValue().split(","))},editable:e.editable,visible:e.visible,placeholder:e.placeholder}}}}this._visualization=r;this.attachAfterInit(this._afterInit)};v.prototype._afterInit=function(){var e=this.getAggregation("_field");if(e instanceof a){var t=this.getConfiguration();this.prepareFieldsInKey(t);e.onAfterOpen=this.onAfterOpen;if(this.isFilterBackend()){this.onInput=n(this.onInput,500);e.oninput=this.onInput;e.attachSelectionChange(this.onSelectionChangeForFilterBackend);e.attachSelectionFinish(this.onSelectionFinish);var i=this.getModel();i.attachPropertyChange(this.mergeSelectedItems,this)}else{e.attachSelectionChange(this.onSelectionChange)}}};v.prototype.prepareFieldsInKey=function(e){this._sKeySeparator=e.values.keySeparator;if(!this._sKeySeparator){this._sKeySeparator=c}var t=e.values.item.key;this._aFields=t.split(this._sKeySeparator);for(var i in this._aFields){if(this._aFields[i].startsWith("{")){this._aFields[i]=this._aFields[i].substring(1)}if(this._aFields[i].endsWith("}")){this._aFields[i]=this._aFields[i].substring(0,this._aFields[i].length-1)}}};v.prototype.getKeyFromItem=function(e){var t="";this._aFields.forEach(function(i){t+=e[i].toString()+this._sKeySeparator}.bind(this));if(t.endsWith(this._sKeySeparator)){t=t.substring(0,t.length-this._sKeySeparator.length)}return t};v.prototype.mergeSelectedItems=function(e){var t=this.getConfiguration();if(!t.valueItems){t.valueItems=[]}var i=t.values.data.path||"/";var a=this.getModel();var r=a.getData();if(i!=="/"){if(i.startsWith("/")){i=i.substring(1)}if(i.endsWith("/")){i=i.substring(0,i.length-1)}var s=i.split("/");var n=o.get(s,r);if(Array.isArray(n)){var u=t.valueItems.map(function(e){return this.getKeyFromItem(e)}.bind(this));var g=n.filter(function(e){var t=this.getKeyFromItem(e);return!l(u,t)}.bind(this));var h=g.filter(function(e){return e.Selected===d.getText("EDITOR_ITEM_SELECTED")});t.valueItems=t.valueItems.concat(h);var p=g.filter(function(e){return e.Selected!==d.getText("EDITOR_ITEM_SELECTED")});n=t.valueItems.concat(p)}else{n=t.valueItems}o.set(s,n,r)}else if(Array.isArray(r)){var u=t.valueItems.map(function(e){return this.getKeyFromItem(e)}.bind(this));var g=r.filter(function(e){var t=this.getKeyFromItem(e);return!l(u,t)}.bind(this));var h=g.filter(function(e){return e.Selected===d.getText("EDITOR_ITEM_SELECTED")});t.valueItems=t.valueItems.concat(h);var p=g.filter(function(e){return e.Selected!==d.getText("EDITOR_ITEM_SELECTED")});r=t.valueItems.concat(p)}else{r=t.valueItems}a.setData(r);this.setSuggestValue()};v.prototype.setSuggestValue=function(){var e=this.getAggregation("_field");var t=this.getBindingContext("currentSettings").sPath;var i=this.getModel("currentSettings");var a=i.getProperty(t+"/suggestValue");if(a&&a!==""){e.setValue(a.replaceAll("''","'"))}};v.prototype.getSuggestValue=function(){var e=this.getBindingContext("currentSettings").sPath;var t=this.getModel("currentSettings");return t.getProperty(e+"/suggestValue")};v.prototype.getGroupHeader=function(e){return new u({text:e.key})};v.prototype.onSelectionChangeForFilterBackend=function(e){var t=e.oSource.getParent();var i=t.getConfiguration();var a=e.getParameter("changedItem");var r=a.getKey();var s=e.getParameter("selected");var n=this.getModel().getData();var l=i.values.data.path||"/";var u,g;if(l!=="/"){if(l.startsWith("/")){l=l.substring(1)}if(l.endsWith("/")){l=l.substring(0,l.length-1)}u=l.split("/");g=o.get(u,n)}else{g=n}if(g){if(!i.valueItems){i.valueItems=[]}var h=[];g.forEach(function(e){var a=p(e,500);var n=t.getKeyFromItem(a);if(n===r){if(s){a.Selected=d.getText("EDITOR_ITEM_SELECTED");i.valueItems=i.valueItems.concat([a])}else{a.Selected=d.getText("EDITOR_ITEM_UNSELECTED");i.valueItems=i.valueItems.filter(function(e){var i=t.getKeyFromItem(e);return i!==r})}}h.push(a)});if(u!==undefined){o.set(u,h,n);this.getModel().checkUpdate(true)}else{this.getModel().setData(h)}}};v.prototype.onSelectionChange=function(e){var t=e.oSource.getParent();var i=t.getConfiguration();var a=e.getParameter("changedItem");var r=a.getKey();var s=e.getParameter("selected");var n=this.getModel().getData();var l=i.values.data.path||"/";if(l!=="/"){if(l.startsWith("/")){l=l.substring(1)}if(l.endsWith("/")){l=l.substring(0,l.length-1)}var u=l.split("/");var g=o.get(u,n);if(Array.isArray(g)){for(var h in g){var p=t.getKeyFromItem(g[h]);if(p===r){if(s){g[h].Selected=d.getText("EDITOR_ITEM_SELECTED")}else{g[h].Selected=d.getText("EDITOR_ITEM_UNSELECTED")}}}o.set(u,g,n)}}else if(Array.isArray(n)){for(var h in n){var p=t.getKeyFromItem(n[h]);if(p===r){if(s){n[h].Selected=d.getText("EDITOR_ITEM_SELECTED")}else{n[h].Selected=d.getText("EDITOR_ITEM_UNSELECTED")}}}}this.getModel().setData(n);this.getModel().checkUpdate(true)};v.prototype.onSelectionFinish=function(e){var t=this.getParent();var i=t.getConfiguration();var a=e.getParameter("selectedItems").map(function(e){return e.getKey()});var r=this.getModel().getData();var s=i.values.data.path||"/";if(s!=="/"){if(s.startsWith("/")){s=s.substring(1)}if(s.endsWith("/")){s=s.substring(0,s.length-1)}var n=s.split("/");r=o.get(n,r)}if(r){i.valueItems=r.filter(function(e){var i=t.getKeyFromItem(e);return l(a,i)})}var u=this.getBindingContext("currentSettings").sPath;var g=this.getModel("currentSettings");g.setProperty(u+"/value",a);var h=t.getSuggestValue();if(h&&h!==""){g.setProperty(u+"/suggestValue","")}};v.prototype.onInput=function(e){var t=e.target.value;var i=this.getBindingContext("currentSettings").sPath;var a=this.getModel("currentSettings");a.setProperty(i+"/suggestValue",t.replaceAll("'","''"));a.setProperty(i+"/_loading",true);e.srcControl.open();e.srcControl._getSuggestionsPopover()._sTypedInValue=t};v.prototype.onAfterOpen=function(){a.prototype.onAfterOpen.apply(this,arguments);var e=this.getPicker();if(e._oCalcedPos==="Bottom"&&!e.hasStyleClass("sapUiIntegrationEditorPopupBottom")){e.addStyleClass("sapUiIntegrationEditorPopupBottom")}else if(e._oCalcedPos!=="Bottom"&&e.hasStyleClass("sapUiIntegrationEditorPopupBottom")){e.removeStyleClass("sapUiIntegrationEditorPopupBottom")}};return v});