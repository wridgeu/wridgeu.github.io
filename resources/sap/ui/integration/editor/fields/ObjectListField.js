/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/ObjectField","sap/ui/core/Core","sap/ui/model/json/JSONModel","sap/ui/table/Table","sap/base/util/deepEqual","sap/base/util/deepClone","sap/base/util/includes"],function(e,t,a,r,i,l,n){"use strict";var s=e.extend("sap.ui.integration.editor.fields.ObjectListField",{metadata:{library:"sap.ui.integration"},renderer:e.getMetadata().getRenderer()});s.prototype.initVisualization=function(e){var t=this;t._newObjectTemplate={};t._bIsEnableSelectAllInTable=true;var a=e.visualization;if(!a){if(e.value&&!e.properties&&(!e.values||e.values&&!e.values.metadata)){t.parseValueProperties()}if(e.values||e.properties){a=t.createTableVisualization(e)}else{a=t.createTextAreaVisualization(e)}e.withLabel=true}this._visualization=a;this.attachAfterInit(this._afterInit)};s.prototype._afterInit=function(){var e=this;var t=e.getAggregation("_field");if(t instanceof r){t.addStyleClass("sapUiIntegrationEditorItemObjectListFieldTable");var i=e.getConfiguration();if(!i.values){var n=l(i.value,500)||[];t.setModel(new a({value:n}));t.selectAll()}}};s.prototype.parseValueProperties=function(){var e=this;var t=e.getConfiguration();if(Array.isArray(t.value)&&t.value.length>0&&!t.properties){var a={};t.value.forEach(function(e){for(var t in e){if(!a[t]){var r=typeof e[t];var i=r==="string"?{}:{type:r};a[t]=i}}});if(!i(a,{})){t.properties=a;t._propertiesParsedFromValue=true}}};s.prototype.onSelectionChange=function(e){var t=this;var a=e.getSource();var r=e.getParameter("userInteraction")||false;if(r){var i=a.getSelectedIndices();var n=a.getBinding("rows").getContexts();var s;if(i.length>0){s=[];i.forEach(function(e){var t=n[e].getObject();s.push(l(t,500))})}if(a._aPathsOfFilteredOut&&a._aPathsOfFilteredOut.length>0){s=s||[];var u=a.getModel();a._aPathsOfFilteredOut.forEach(function(e){var t=u.getProperty(e);s.push(l(t,500))})}t._setCurrentProperty("value",s)}};s.prototype.mergeValueWithRequestResult=function(e){var t=this;var a=t.getConfiguration();var r=t.getAggregation("_field");if(a.value&&Array.isArray(a.value)&&a.value.length>0){var n,s=r.getModel(),u=r.getBinding("rows").getPath();if(Array.isArray(e)&&e.length>0){var o=[];for(var f=0;f<e.length;f++){var v=e[f];var h=false;for(var d=0;d<a.value.length;d++){if(i(a.value[d],v)){h=true;break}}if(!h){o.push(v)}}e=l(a.value.concat(o),500);s.setProperty(u,e);r.addSelectionInterval(0,a.value.length-1)}else{n=l(a.value,500);e=n;s.setProperty(u,e);r.selectAll()}}return e};s.prototype.onChangeOfTextArea=function(e){var t=this;var a=t.getResourceBundle();var r=e.getSource();var i=r.getValue();if(!i||i===""){t.saveValue(undefined,r)}else{try{var l=JSON.parse(i);if(!(l instanceof Array)){r.setValueState("Error");r.setValueStateText(a.getText("EDITOR_VAL_NOT_AN_ARRAY_OF_JSONOBJECTS"));return}t.saveValue(l,r)}catch(e){r.setValueState("Error");r.setValueStateText(a.getText("EDITOR_VAL_NOT_A_JSONOBJECT"))}}};s.prototype.saveValue=function(e,t,a){var r=this;var i;if(!a){r._setCurrentProperty("value",e)}else{i=t.getModel();i.setProperty("/value",e)}t.setValueState("None");t.setValueStateText("")};s.prototype.checkHasValue=function(){var e=this;var t=e._getCurrentProperty("value");if(Array.isArray(t)&&t.length>0){return true}return false};s.prototype.applyBeforeValueAndSelections=function(e,t){var a=this;var r=a.getAggregation("_field");var i=t.selectedIndices;var s=t.rowNumber;var u=r.getBinding("rows").getPath();var o=r.getBinding("rows").getContexts();var f=o.length;var v=t.rowIndex;var h=r.getModel();var d=[];var g;switch(e){case"add":i.forEach(function(e){r.addSelectionInterval(e,e)});break;case"update":var c=false;if(s!==f){g=l(i);i=[];g.forEach(function(e){if(e<v){i.push(e)}else if(e>v){i.push(e-1)}else if(e===v){c=true;r._aPathsOfFilteredOut.push(t.path)}})}else if(n(i,v)){c=true}if(c){i.forEach(function(e){var t=o[e].getPath();var a=h.getProperty(t);d.push(l(a,500))});if(r._aPathsOfFilteredOut&&r._aPathsOfFilteredOut.length>0){r._aPathsOfFilteredOut.forEach(function(e){var t=h.getProperty(e);d.push(l(t,500))})}a._setCurrentProperty("value",d)}i.forEach(function(e){r.addSelectionInterval(e,e)});break;case"delete":var p=false;if(n(i,v)){p=true}g=l(i);i=[];g.forEach(function(e){if(e<v){i.push(e)}else if(e>v){i.push(e-1)}});i.forEach(function(e){r.addSelectionInterval(e,e)});if(r._aPathsOfFilteredOut&&r._aPathsOfFilteredOut.length>0){r._aPathsOfFilteredOut=r._aPathsOfFilteredOut.map(function(e){var a=e.substring(e.lastIndexOf("/")+1);if(a>t.realIndex){a--;return u+"/"+a}else{return e}})}if(p){i.forEach(function(e){var t=o[e].getPath();var a=h.getProperty(t);d.push(l(a,500))});if(r._aPathsOfFilteredOut&&r._aPathsOfFilteredOut.length>0){r._aPathsOfFilteredOut.forEach(function(e){var t=h.getProperty(e);d.push(l(t,500))})}if(d.length===0){d=undefined}a._setCurrentProperty("value",d)}break;case"filter":var O=t.column;var _=r._aPathsOfFilteredOut||[];if(i.length>0){i.forEach(function(e){var t=o[e].getPath();_.push(t)});r._aPathsOfFilteredOut=_}if(O._applySelection!==false&&r._aPathsOfFilteredOut&&r._aPathsOfFilteredOut.length>0){r.attachEventOnce("rowsUpdated",function(){if(r._aPathsOfFilteredOut&&r._aPathsOfFilteredOut.length>0){var e=r.getBinding("rows").getContexts()||[];for(var t=0;t<e.length;t++){if(r._aPathsOfFilteredOut.length===0){break}var a=e[t].getPath();for(var i=0;i<r._aPathsOfFilteredOut.length;i++){if(r._aPathsOfFilteredOut[i]===a){r.addSelectionInterval(t,t);r._aPathsOfFilteredOut.splice(i,1);break}}}}})}delete O._applySelection;break;default:}};return s});