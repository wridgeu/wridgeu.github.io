/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/ObjectField","sap/ui/model/json/JSONModel","sap/ui/table/Table","sap/m/CheckBox","sap/base/util/deepEqual","sap/base/util/deepClone","sap/ui/integration/util/Utils"],function(e,t,a,r,i,l,o){"use strict";var n=e.extend("sap.ui.integration.editor.fields.ObjectListField",{metadata:{library:"sap.ui.integration"},renderer:e.getMetadata().getRenderer()});n.prototype.initVisualization=function(e){var t=this;t._newObjectTemplate={_dt:{_selected:true,_uuid:""}};var a=e.visualization;if(!a){if(e.value&&!e.properties&&(!e.values||e.values&&!e.values.metadata)){t.parseValueProperties()}if(e.values||e.properties){a=t.createTableVisualization(e)}else{a=t.createTextAreaVisualization(e)}e.withLabel=true}this._visualization=a;this.attachAfterInit(this._afterInit)};n.prototype._afterInit=function(){var e=this;var r=e.getAggregation("_field");if(r instanceof a){r.addStyleClass("sapUiIntegrationEditorItemObjectListFieldTable");var i=e.getConfiguration();if(!i.values){var n=l(i.value,500)||[];n.forEach(function(e){e._dt=e._dt||{};e._dt._selected=true;e._dt._uuid=e._dt._uuid||o.generateUuidV4()});e.setModel(new t({value:n,_allSelected:true}));e.bindObject({path:"/value"})}}};n.prototype.parseValueProperties=function(){var e=this;var t=e.getConfiguration();if(Array.isArray(t.value)&&t.value.length>0&&!t.properties){var a={};t.value.forEach(function(e){for(var t in e){if(!a[t]&&t!=="_dt"){var r=typeof e[t];var i=r==="string"?{}:{type:r};a[t]=i}}});if(!i(a,{})){t.properties=a;t._propertiesParsedFromValue=true}}};n.prototype.buildSelectionColumnLables=function(){var e=this;var t=e.getConfiguration();var a=e.getResourceBundle();return new r({selected:"{/_allSelected}",visible:typeof t.values!=="undefined",tooltip:{path:"/_allSelected",formatter:function(e){if(!e){return a.getText("EDITOR_FIELD_OBJECT_LIST_TABLE_COLUMN_SELECTION_TOOLTIP_ADDALL")}else{return a.getText("EDITOR_FIELD_OBJECT_LIST_TABLE_COLUMN_SELECTION_TOOLTIP_REMOVEALL")}}},select:e.onSelectionColumnClick.bind(e)})};n.prototype.onSelectionColumnClick=function(e){var t=this;var a=e.getParameter("selected");var r=t.getAggregation("_field");var i=r.getBinding("rows").getContexts();i.forEach(function(e){var t=e.getObject();t._dt=t._dt||{};t._dt._selected=a});var o=r.getModel();var n=r.getBinding("rows").getPath();var u=o.getProperty(n);var s;u.forEach(function(e){if(e._dt&&e._dt._selected){var t=l(e,500);s=s||[];s.push(t)}});o.checkUpdate(true);t.setValue(s)};n.prototype.updateSelectionColumn=function(){var e=this;var t=e.getAggregation("_field");var a=t.getBinding("rows").getContexts();var r=true;if(a.length===0){r=false}else{for(var i=0;i<a.length;i++){var l=a[i].getObject();if(!l._dt||l._dt._selected!==true){r=false;break}}}t.getModel().setProperty("/_allSelected",r)};n.prototype.onAdd=function(e){var t=this;var a=t.getAggregation("_field");var r=t._oObjectDetailsPopover.getModel().getProperty("/value");var i=a.getBinding("rows").getPath();var l=a.getModel();var o=l.getProperty(i);o.push(r);l.setProperty("/_hasTableAllSelected",false);l.setProperty("/_hasTableSelected",false);l.checkUpdate();t.refreshValue();t._oObjectDetailsPopover.close()};n.prototype.refreshValue=function(){var e=this;var t=e.getAggregation("_field");var a=t.getModel();var r=t.getBinding("rows").getPath();var i=a.getProperty(r);var o=[];i.forEach(function(e){if(e._dt._selected){var t=l(e);o.push(t)}});e.setValue(o)};n.prototype.onSelectionChange=function(e){var t=this;var a=e.getParameter("selected");var r=this._getCurrentProperty("value");var i=t.getAggregation("_field");var l=i.getModel();if(a||r.length>1){t.refreshValue();t.updateSelectionColumn()}else{l.setProperty("/_allSelected",false);t.setValue(undefined)}};n.prototype.mergeValueWithRequestResult=function(e){var t=this;var a=t.getConfiguration();var r=t.getAggregation("_field");var n=r.getModel();if(a.value&&Array.isArray(a.value)&&a.value.length>0){var u=l(a.value,500),s=r.getBinding("rows").getPath();if(Array.isArray(e)&&e.length>0){var d=[];u.forEach(function(e){var t;if(!e._dt){t=o.generateUuidV4()}else{t=e._dt._uuid||o.generateUuidV4();delete e._dt._uuid}d.push(t)});var g=[];for(var _=0;_<e.length;_++){var f=e[_];var v=false;for(var c=0;c<u.length;c++){if(i(f,u[c])){v=true;break}}if(!v){f._dt._uuid=o.generateUuidV4();g.push(f)}}for(var p=0;p<u.length;p++){var h=u[p];h._dt=h._dt||{};h._dt._selected=true;h._dt._uuid=d[p]}if(g.length>0){n.setProperty("/_allSelected",false);u=u.concat(g)}else{n.setProperty("/_allSelected",true)}}else{u.forEach(function(e){e._dt=e._dt||{};e._dt._selected=true;e._dt._uuid=e._dt._uuid||o.generateUuidV4()});n.setProperty("/_allSelected",true)}n.setProperty(s,u)}else{if(Array.isArray(e)&&e.length>0){e.forEach(function(e){e._dt._uuid=o.generateUuidV4()})}n.setProperty("/_allSelected",false)}n.checkUpdate()};n.prototype.onChangeOfTextArea=function(e){var t=this;var a=t.getResourceBundle();var r=e.getSource();var i=r.getValue();if(!i||i===""){t.saveValue(undefined,r)}else{try{var l=JSON.parse(i);if(!(l instanceof Array)){r.setValueState("Error");r.setValueStateText(a.getText("EDITOR_VAL_NOT_AN_ARRAY_OF_JSONOBJECTS"));return}t.saveValue(l,r)}catch(e){r.setValueState("Error");r.setValueStateText(a.getText("EDITOR_VAL_NOT_A_JSONOBJECT"))}}};n.prototype.saveValue=function(e,t,a){var r=this;var i;if(!a){r.setValue(e)}else{i=t.getModel();i.setProperty("/value",e)}t.setValueState("None");t.setValueStateText("")};n.prototype.cleanDT=function(e){if(e){e.forEach(function(e){if(e&&e._dt&&e._dt._selected){delete e._dt._selected}if(e&&e._dt&&i(e._dt,{})){delete e._dt}})}};return n});