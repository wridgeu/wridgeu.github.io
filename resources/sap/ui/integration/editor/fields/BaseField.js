/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/m/MultiInput","sap/m/Token","sap/ui/core/Core","sap/ui/integration/util/BindingHelper","sap/ui/core/ListItem","sap/base/util/ObjectPath","sap/base/util/deepEqual","sap/base/util/deepClone","sap/ui/core/Fragment"],function(t,e,i,s,a,n,r,o,l,u){"use strict";var g="sap/ui/integration/editor/fields/viz";var d=t.extend("sap.ui.integration.editor.fields.BaseField",{metadata:{library:"sap.ui.integration",properties:{configuration:{type:"object"},specialButton:{type:"object"},mode:{type:"string"},host:{type:"object"},visible:{type:"boolean",defaultValue:true}},aggregations:{_field:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_dynamicField:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{_messageIcon:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"},_messageStrip:{type:"sap.m.MessageStrip",multiple:false,visibility:"hidden"}},events:{afterInit:{},validateFailed:{}}},renderer:function(t,e){var i=e.getAggregation("_field"),s=e._getDynamicField();t.openStart("div");t.addClass("sapUiIntegrationEditorItemField");if(i&&i.getWidth){}if(!e.getVisible()){t.addStyle("display","none")}t.writeElementData(e);t.openEnd();if(e.getVisible()){t.openStart("span");t.openEnd();t.openStart("span");t.addClass("sapUiIntegrationEditorEditor");if(e._hasDynamicValue()){t.addStyle("width","1px");t.addStyle("opacity","0")}else{t.addStyle("width","100%")}t.openEnd();t.renderControl(i);t.close("span");t.close("span");if(e._hasDynamicValue()){t.openStart("span");t.addClass("sapUiIntegrationEditorSettings");t.openEnd();t.openStart("span");t.addClass("sapUiIntegrationEditorSettingsField");t.addStyle("width","100%");t.addStyle("opacity","1");t.openEnd();t.renderControl(s);t.close("span")}t.openStart("div");t.writeAttribute("id",e.getId()+"-ms");t.addStyle("height","0");t.openEnd();t.close("div")}t.close("div")}});d.prototype.init=function(){this._readyPromise=new Promise(function(t){this._fieldResolver=t}.bind(this))};d.prototype.getMessagestrip=function(){var t=this.getAssociation("_messageStrip");return s.byId(t)};d.prototype.getMessageIcon=function(){var t=this.getAssociation("_messageIcon");return s.byId(t)};d.prototype._removeValidationMessage=function(){var t=this.control,e=t.getParent().getMessageIcon();if(e){e.setVisible(false)}if(t.getEnabled()){t.setEnabled(false)}};d.prototype.getResourceBundle=function(){return this.getModel("i18n").getResourceBundle()};d.prototype.setConfiguration=function(t,e){if(t!==this.getConfiguration()){this._sanitizeValidationSettings(t);this.setProperty("configuration",t,e);if(t){Promise.resolve().then(function(){this.initEditor(t)}.bind(this))}}return this};d.prototype._sanitizeValidationSettings=function(t){t.validations=t.validations||[];if(t.validation&&t.validations&&Array.isArray(t.validations)){t.validations.push(t.validation);delete t.validation}if(t.validation&&!t.validations){t.validations=[t.validation];delete t.validation}if(t.required){t.validations.unshift({required:true,type:"error"})}};d.prototype.deleteTranslationValuesInTexts=function(t){var e=this;var i=e.getConfiguration();var s="/texts";var a=this._settingsModel.getData();if(!a||!a.texts){return}var n=l(a.texts,500);if(t){if(n[t]){delete n[t][i.manifestpath];if(o(n[t],{})){delete n[t]}if(o(n,{})){delete a.texts;this._settingsModel.setData(a)}else{this._settingsModel.setProperty(s,n)}}}else{for(var r in n){e.deleteTranslationValuesInTexts(r)}}};d.prototype._triggerValidation=function(t){if(o(t,this._preChangedValue)&&this._messageFrom==="validation"){return}this._preChangedValue=t;var e=this.getConfiguration();var i=false;if(e.required){i=true}else if(e.type==="string"&&t){i=true}else if((e.type==="integer"||e.type==="number")&&!isNaN(t)){if(t!==""){i=true}}else if(e.type==="boolean"){i=true}else if(e.type==="string[]"&&Array.isArray(t)){i=true}if(e.validations&&Array.isArray(e.validations)&&i){for(var s=0;s<e.validations.length;s++){var a=this._handleValidation(e.validations[s],t);if(typeof a==="boolean"&&!a){this.fireValidateFailed();return false}else if(typeof a.then==="function"){a.then(function(t){if(!t){this.fireValidateFailed();return false}}.bind(this))}}this._hideValueState()}return true};d.validations={string:{maxLength:function(t,e){return t.length<=e},maxLengthTxt:"EDITOR_VAL_MAXLENGTH",minLength:function(t,e){return t.length>=e},minLengthTxt:"EDITOR_VAL_MINLENGTH",pattern:function(t,e){var i=new RegExp(e);return i.test(t)},patternTxt:"EDITOR_VAL_NOMATCH",required:function(t,e){return e&&!!t},requiredTxt:"EDITOR_VAL_TEXTREQ",validateTxt:"EDITOR_VAL_NOMATCH"},"string[]":{maxLength:function(t,e){return Array.isArray(t)&&t.length<=e},maxLengthTxt:"EDITOR_VAL_LISTMAXLENGTH",minLength:function(t,e){return Array.isArray(t)&&t.length>=e},minLengthTxt:"EDITOR_VAL_LISTMINLENGTH",required:function(t,e){return Array.isArray(t)&&t.length>0},requiredTxt:"EDITOR_VAL_LISTREQ"},integer:{maximum:function(t,e,i){if(i.exclusiveMaximum){i._txt="maximumExclusiveTxt";return t<e}return t<=e},maximumTxt:"EDITOR_VAL_MAX",maximumExclusiveTxt:"EDITOR_VAL_MAX_E",minimum:function(t,e,i){if(i.exclusiveMinimum){i._txt="minimumExclusiveTxt";return t>e}return t>=e},minimumTxt:"EDITOR_VAL_MIN",minimumExclusiveTxt:"EDITOR_VAL_MIN_E",multipleOf:function(t,e){return t%e===0},multipleOfTxt:"EDITOR_VAL_MULTIPLE",required:function(t,e){return!isNaN(t)&&t!==""},requiredTxt:"EDITOR_VAL_NUMBERREQ",validateTxt:"EDITOR_VAL_NOMATCH"},number:{maximum:function(t,e,i){if(i.exclusiveMaximum){i._txt="maximumExclusiveTxt";return t<e}return t<=e},maximumTxt:"EDITOR_VAL_MAX",maximumExclusiveTxt:"EDITOR_VAL_MAX_E",minimum:function(t,e,i){if(i.exclusiveMinimum){i._txt="minimumExclusiveTxt";return t>e}return t>=e},minimumTxt:"EDITOR_VAL_MIN",minimumExclusiveTxt:"EDITOR_VAL_MAX_E",multipleOf:function(t,e){return t%e===0},multipleOfTxt:"EDITOR_VAL_MULTIPLE",required:function(t,e){return!isNaN(t)&&t!==""},requiredTxt:"EDITOR_VAL_NUMBERREQ",validateTxt:"EDITOR_VAL_NOMATCH"}};d.prototype._requestData=function(t){var e=this.control.getParent();var i=e.getConfiguration();var s=e._oDataProviderFactory.create(t.data);e.getModel("currentSettings").setProperty(i._settingspath+"/_loading",true);var a=s.getData();return a.then(function(s){e.getModel("currentSettings").setProperty(i._settingspath+"/_loading",false);var a=t.data.path||"/";if(a.startsWith("/")){a=a.substring(1)}if(a.endsWith("/")){a=a.substring(0,a.length-1)}var n=a.split("/");var o=r.get(n,s);return o})};d.prototype._handleValidation=function(t,e){var i=this.getConfiguration(),s=d.validations[i.type];var a=function(a,n){var r;if(typeof t.message==="function"){r=t.message(e,i,n)}else{r=t.message}if(!r){if(t._txt){r=this.getResourceBundle().getText(s[t._txt],[t[a]])}else{r=this.getResourceBundle().getText(s[a+"Txt"],[t[a]])}}this._showValueState(t.type||"error",r)}.bind(this);if(t["validate"]){var n={control:this.getAggregation("_field"),requestData:this._requestData,removeValidationMessage:this._removeValidationMessage};var r=t["validate"];return Promise.resolve(r(e,i,n)).then(function(t){var e=t.isValid;if(typeof e==="undefined"){e=t}var i=t.data?t.data:undefined;if(!e){a("validate",i);return false}else{this._hideValueState(true,false);return true}}.bind(this))}else{for(var o in t){if(s){var l=s[o];t._txt="";if(l){if(!l(e,t[o],t)){a(o);return false}}}}}return true};d.prototype.onAfterRendering=function(){this._applyMessage();var t=this.getMessagestrip();if(t&&t.getDomRef()){t.getDomRef().style.opacity="0"}};d.prototype._applyMessage=function(){var t=s.byId(this.getAssociation("_messageIcon"));if(this.getAssociation("_messageIcon")&&t){var e=t.getDomRef();if(e){e.classList.remove("error");e.classList.remove("warning");e.classList.remove("success");if(this._message){e.classList.add(this._message.type)}}}if(this._message&&(this._message.type==="error"||this._message.type==="warning")){var i=this._message.type==="error"?"Error":"Warning";this._setCurrentProperty("hasError",true);this._setCurrentProperty("errorType",i)}else{this._setCurrentProperty("hasError",false);this._setCurrentProperty("errorType","None")}};d.prototype._showValueState=function(t,e,i){var s=this.getAggregation("_field"),a=t.substring(0,1).toUpperCase()+t.substring(1);this._message={enum:a,type:t,message:e,atControl:false};this._messageFrom="validation";if(i){this._messageFrom="request"}var n=this.getMessagestrip();if(s&&s.setValueState){this._message.atControl=true;if(s.setShowValueStateMessage){s.setShowValueStateMessage(false)}s.setValueState(a);s.setValueStateText(e)}else if(n&&n.getVisible()&&s.getMetadata().getName()!=="sap.m.Switch"){this._showMessage()}this._applyMessage()};d.prototype._hideValueState=function(t,e){if(!this.getParent()){return}var i=this.getMessagestrip();if(this._message){if(t&&this._messageFrom==="request"||!t&&this._messageFrom==="validation"){var s=this.getAggregation("_field");this._message={enum:"Success",type:"success",message:"Corrected",atControl:this._message.atControl};this._messageFrom="validation";if(t){this._messageFrom="request"}if(this._messageto){clearTimeout(this._messageto)}this._messageto=setTimeout(function(){this._messageto=null;this._applyMessage();if(!this._message&&s.setValueState){s.setValueState("None")}}.bind(this),1500);this._applyMessage();if(i){if(i.getDomRef()){i.getDomRef().style.opacity="0"}i.onAfterRendering=null}if(s.setValueState){s.setValueState("Success")}if(s.setValueStateText){s.setValueStateText("")}this._message=null}if(!this._message&&t&&e){this._triggerValidation(this.getConfiguration().value)}}};d.prototype.onfocusin=function(t){if(t&&t.target.classList.contains("sapMBtn")){return}this._showMessage()};d.prototype.onfocusout=function(t){this._hideMessage()};d.prototype._showMessage=function(){if(!this.getParent()){return}var t=this.getMessagestrip();if(this._message&&t){t.applySettings({type:this._message.enum,text:this._message.message});var e=this;t.onAfterRendering=function(){t.getDomRef().style.zIndex="1";t.getDomRef().style.opacity="1";e.getDomRef("ms")&&e.getDomRef("ms").appendChild(t.getDomRef());var i=e.getAggregation("_field");if(e._message&&!e._message.atControl){t.getDomRef().style.marginTop="0";t.getDomRef().style.marginLeft="0"}var s=i.getDomRef()?i.getDomRef().offsetWidth-5:100;if(s<=100){s=i.getParent().getDomRef()?i.getParent().getDomRef().offsetWidth-35:100}t.getDomRef().style.width=s+"px"};t.rerender()}};d.prototype._hideMessage=function(){var t=this.getMessagestrip();var e=this.getAggregation("_field"),i=e.getDomRef()&&e.getDomRef().contains(window.document.activeElement);if(t){if(!i&&t.getDomRef()){t.getDomRef().style.opacity="0";t.getDomRef().style.zIndex="-1"}t.onAfterRendering=null}};d.prototype.initEditor=function(e){var i;this._settingsModel=this.getModel("currentSettings");this.initVisualization&&this.initVisualization(e);if(this._visualization.editor){i=this._visualization.editor}else if(this._visualization.type){if(typeof this._visualization.type==="string"){if(this._visualization.type.indexOf("/")===-1){this._visualization.type=g+"/"+this._visualization.type;this._visualization.settings=this._visualization.settings||{value:"{currentSettings>value}",editable:e.editable}}sap.ui.require([this._visualization.type],function(t){this._visualization.type=t;this.initEditor(e)}.bind(this));return}i=new this._visualization.type(this._visualization.settings||{})}else if(this._visualization.fragment){if(typeof this._visualization.fragment==="string"){if(!this._visualization.controller){this._visualization.controller=this._visualization.fragment+".controller"}if(typeof this._visualization.controller==="string"){sap.ui.require([this._visualization.controller],function(t){this._visualization.controller=new t;this._visualization.controller.init();this._visualization.controller.setField(this);this.initEditor(e)}.bind(this))}else if(typeof this._visualization.controller==="object"){u.load({name:this._visualization.fragment,controller:this._visualization.controller}).then(function(t){this._visualization.fragment=t;this.initEditor(e)}.bind(this))}else{u.load({name:this._visualization.fragment}).then(function(t){this._visualization.fragment=t;this.initEditor(e)}.bind(this))}return}i=this._visualization.fragment}if(i instanceof t){this.setAggregation("_field",i);if(i.attachChange){i.attachChange(function(t){if(t.mParameters.value===""){var e=this.getConfiguration();if(e.type==="string[]"){this._triggerValidation(e.value)}else{this._triggerValidation(t.getParameter("value"))}}}.bind(this))}var s=this._settingsModel.bindProperty("value",this.getBindingContext("currentSettings"));s.attachChange(function(){this._triggerValidation(e.value)}.bind(this));this._triggerValidation(e.value)}var a=this.getMode();e.allowSettings=e.allowSettings||e.allowSettings!==false&&a==="admin";e.allowDynamicValues=e.allowDynamicValues||e.allowDynamicValues!==false;e._changeDynamicValues=e.visible&&e.editable&&(e.allowDynamicValues||e.allowSettings)&&a!=="translation";if(e._changeDynamicValues){this._getDynamicField()}this._applySettings(e);this.fireAfterInit()};d.prototype.initVisualization=function(){};d.prototype._hasDynamicValue=function(){var t=this._getCurrentProperty("value");var e=typeof t==="string"&&(t.indexOf("{context>")===0||t.indexOf("{{parameters")===0);this._setCurrentProperty("_hasDynamicValue",e);return e};d.prototype._hasSettings=function(){var t=this.getConfiguration();if(t._next){var e=t.hasOwnProperty("visibleToUser")?t.visibleToUser:true;var i=t.hasOwnProperty("editableToUser")?t.editableToUser:true;var s=t._next.visible===false?false:t._next.editable;var a=t.hasOwnProperty("allowDynamicValues")?t.allowDynamicValues:true;t._hasSettings=t._next.visible===!e||s===!i||t._next.allowDynamicValues===!a}else{t._hasSettings=false;if(t.hasOwnProperty("editableToUser")||t.hasOwnProperty("visibleToUser")){t._next={}}if(t.hasOwnProperty("editableToUser")){t._next.editable=t.editableToUser}if(t.hasOwnProperty("visibleToUser")){t._next.visible=t.visibleToUser}}return t._hasSettings};d.prototype._getDynamicField=function(){var t=this.getAggregation("_dynamicField");if(!t){var t=new e({showValueHelp:false});this.setAggregation("_dynamicField",t)}return t};d.prototype._hideDynamicField=function(){var t=this._getDynamicField(),e=this.getAggregation("_field");if(t.getDomRef()){var i=t.getDomRef().parentNode.style;i.width="1px";i.opacity=0;i=e.getDomRef().parentNode.style;e.getDomRef().style.visibility="visible";i.width="100%";i.opacity=1}};d.prototype._showDynamicField=function(){var t=this._getDynamicField(),e=this.getAggregation("_field");if(t.getDomRef()){var i=t.getDomRef().parentNode.style;i.width="100%";i.opacity=1;i=e.getDomRef().parentNode.style;e.getDomRef().style.visibility="hidden";i.width="1px";i.opacity=0}};d.prototype._setCurrentProperty=function(t,e){if(this._getCurrentProperty(t)!==e){this._settingsModel.setProperty(t,e,this.getBindingContext("currentSettings"))}};d.prototype._getCurrentProperty=function(t){return this._settingsModel.getProperty(t,this.getBindingContext("currentSettings"))};d.prototype._applySettings=function(t){var e=this._getDynamicField(),s=this.getModel("contextflat")._getValueObject(t.value);e.removeAllTokens();if(!this._getCurrentProperty("_changeDynamicValues")){e.setEnabled(false)}if(s&&s.path!=="empty"){if(s.object.value&&s.object.value.indexOf("{{")==0){this._setCurrentProperty("value",s.object.value)}else{this._setCurrentProperty("value",s.value)}e.addToken(new i({text:s.object.label,delete:function(){this._setCurrentProperty("value","");var t=this.getAggregation("_field");t.setValue("");t.fireChange();if(!this._hasDynamicValue()){this._hideDynamicField()}this._applyButtonStyles();window.setTimeout(function(){this.getAggregation("_field").focus()}.bind(this),100)}.bind(this)}));var a=this.getConfiguration();if(a.type==="string"&&a.translatable){this.deleteTranslationValuesInTexts()}}else{this._setCurrentProperty("value",t.value);this._setCurrentProperty("_changed",t._changed);this._hideDynamicField()}this._setCurrentProperty("_next",t._next);this._applyButtonStyles();if(!this._hasDynamicValue()){this._hideDynamicField()}else{this._showDynamicField()}this._fieldResolver&&this._fieldResolver();this._fieldResolver=null};d.prototype._cancelSettings=function(){this._applyButtonStyles();if(!this._hasDynamicValue()){this._hideDynamicField()}};d.prototype._applyButtonStyles=function(){if(!this._settingsButton){return}if(!this._hasDynamicValue()){this._settingsButton.removeStyleClass("dynamicvalue")}else{this._settingsButton.addStyleClass("dynamicvalue")}if(!this._hasSettings()){this._settingsButton.removeStyleClass("settings")}else{this._settingsButton.addStyleClass("settings")}};d.prototype.isFilterBackend=function(){var t=this.getConfiguration();var e=false;if(t&&t.values&&t.values.data){if(t.values.data.request&&t.values.data.request.parameters&&t.values.data.request.parameters.$filter&&t.values.data.request.parameters.$filter.indexOf("{currentSettings>suggestValue}")>-1){e=true}else if(t.values.data.request&&t.values.data.request.url&&t.values.data.request.url.indexOf("{currentSettings>suggestValue}")>-1){e=true}}return e};d.prototype.formatListItem=function(t){var e=new n;for(var i in t){e.bindProperty(i,a.createBindingInfos(t[i]))}return e};d.prototype.getPreviewPosition=function(){return this._settingsModel.getProperty("/preview/position")};return d});