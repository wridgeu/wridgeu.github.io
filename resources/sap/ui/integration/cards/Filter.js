/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/core/Core","sap/base/Log","sap/ui/core/Icon","sap/m/HBox","sap/m/Text","sap/m/Select","sap/ui/core/ListItem","sap/ui/model/json/JSONModel","sap/ui/integration/model/ObservableModel","sap/ui/integration/util/LoadingProvider"],function(e,t,i,a,r,o,n,s,d,l,g){"use strict";var h=e.extend("sap.ui.integration.cards.Filter",{metadata:{properties:{key:{type:"string",defaultValue:""},config:{type:"object",defaultValue:"null"},value:{type:"string",defaultValue:""}},aggregations:{_select:{type:"sap.m.Select",multiple:false,visibility:"hidden"},_loadingProvider:{type:"sap.ui.core.Element",multiple:false,visibility:"hidden"}},associations:{card:{type:"sap.ui.integration.widgets.Card",multiple:false}}},renderer:{apiVersion:2,render:function(e,t){var i=t.isLoading();e.openStart("div",t).class("sapFCardFilter");if(i){e.class("sapFCardFilterLoading")}e.openEnd();if(t._hasError()){e.renderControl(t._getErrorMessage())}else{e.renderControl(t._getSelect())}e.close("div")}}});h.prototype.init=function(){this.setAggregation("_loadingProvider",new g);this.attachEventOnce("_dataReady",function(){this.fireEvent("_ready")})};h.prototype.exit=function(){if(this._oDataProvider){this._oDataProvider.destroy();this._oDataProvider=null}};h.prototype.isLoading=function(){var e=this.getAggregation("_loadingProvider");return!e.isDataProviderJson()&&e.getLoading()};h.prototype._getSelect=function(){var e=this.getAggregation("_select");if(!e){e=this._createSelect();this.setAggregation("_select",e)}return e};h.prototype._hasError=function(){return!!this._bError};h.prototype._getErrorMessage=function(){var e="Unable to load the filter.";return new r({justifyContent:"Center",alignItems:"Center",items:[new a({src:"sap-icon://message-error",size:"1rem"}).addStyleClass("sapUiTinyMargin"),new o({text:e})]})};h.prototype._handleError=function(e){i.error(e);this._bError=true;this.invalidate()};h.prototype._onDataRequestComplete=function(){this.fireEvent("_dataReady");this.hideLoadingPlaceholders()};h.prototype.showLoadingPlaceholders=function(){this.getAggregation("_loadingProvider").setLoading(true)};h.prototype.hideLoadingPlaceholders=function(){this.getAggregation("_loadingProvider").setLoading(false)};h.prototype._onDataChanged=function(){var e=this._getSelect();e.setSelectedKey(this.getValue());this._updateSelected(e.getSelectedItem())};h.prototype._setDataConfiguration=function(e){var t=this.getCardInstance(),i;if(!e){this.fireEvent("_dataReady");return}if(this._oDataProvider){this._oDataProvider.destroy()}this._oDataProvider=t.getDataProviderFactory().create(e,null,true);this.getAggregation("_loadingProvider").setDataProvider(this._oDataProvider);if(e.name){i=t.getModel(e.name)}else if(this._oDataProvider){i=new l;this.setModel(i)}i.attachEvent("change",function(){this._onDataChanged()}.bind(this));this._oDataProvider.attachDataRequested(function(){this.showLoadingPlaceholders()}.bind(this));this._oDataProvider.attachDataChanged(function(e){i.setData(e.getParameter("data"));this._onDataRequestComplete()}.bind(this));this._oDataProvider.attachError(function(e){this._handleError(e.getParameter("message"));this._onDataRequestComplete()}.bind(this));this._oDataProvider.triggerDataUpdate()};h.prototype._updateSelected=function(e){var t=this.getModel("filters"),i=this.getKey();t.setProperty("/"+i,{value:e.getKey(),selectedItem:{title:e.getText(),key:e.getKey()}})};h.prototype._createSelect=function(){var e=new n,t,i,a="/",r=this.getConfig();e.attachChange(function(e){var t=e.getParameter("selectedItem").getKey();this.setValue(t);this._updateSelected(e.getParameter("selectedItem"))}.bind(this));if(r&&r.item){a=r.item.path||a}if(r&&r.item&&r.item.template){t=r.item.template.key;i=r.item.template.title}if(r&&r.items){t="{key}";i="{title}";this.setModel(new d(r.items))}e.bindItems({path:a,template:new s({key:t,text:i})});e.setSelectedKey(this.getValue());return e};h.prototype.refreshData=function(){if(this._oDataProvider){this._oDataProvider.triggerDataUpdate()}};h.prototype.getCardInstance=function(){return t.byId(this.getCard())};return h});