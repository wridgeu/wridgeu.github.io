/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/library","sap/ui/core/library","sap/ui/dom/includeScript","sap/ui/integration/cards/BaseContent","sap/ui/integration/cards/adaptivecards/elements/hostConfig","sap/m/VBox","sap/m/MessageStrip","sap/ui/core/HTML","sap/ui/core/Core","sap/ui/model/json/JSONModel","sap/base/Log"],function(t,e,n,i,a,r,o,s,d,p,u){"use strict";var l,g,c,h,C,f,m,y,_,v;var b=e.MessageType;var R=i.extend("sap.ui.integration.cards.AdaptiveContent",{metadata:{library:"sap.ui.integration"},renderer:{apiVersion:2,render:function(t,e){var n=i.getMetadata().getRenderer();return n.render.apply(this,arguments)}}});R.prototype.init=function(){i.prototype.init.apply(this,arguments);this.setComponentsReady(false);this._bAdaptiveCardElementsReady=false;this._setupCardContent();d.attachThemeChanged(function(){this._adjustHostConfig();this.invalidate()}.bind(this))};R.prototype.onAfterRendering=function(){this._renderMSCardContent(this._oCardTemplate||this._oCardConfig)};R.prototype.loadDependencies=function(t){this._loadWebcomponents();var e=[];e.push(new Promise(function(t,e){sap.ui.require(["sap/ui/integration/thirdparty/adaptivecards","sap/ui/integration/thirdparty/adaptivecards-templating","sap/ui/integration/cards/adaptivecards/elements/UI5InputText","sap/ui/integration/cards/adaptivecards/elements/UI5InputNumber","sap/ui/integration/cards/adaptivecards/elements/UI5InputChoiceSet","sap/ui/integration/cards/adaptivecards/elements/UI5InputTime","sap/ui/integration/cards/adaptivecards/elements/UI5InputDate","sap/ui/integration/cards/adaptivecards/elements/UI5InputToggle","sap/ui/integration/cards/adaptivecards/overwrites/ActionRender"],function(e,n,i,a,r,o,s,d,p){l=e;g=n;h=i;C=a;f=r;m=o;y=s;_=d;v=p;this._setupAdaptiveCardDependency();t()}.bind(this),e)}.bind(this)));if(t.get("/sap.card/configuration/enableMarkdown")){e.push(new Promise(function(t,e){sap.ui.require(["sap/ui/integration/thirdparty/markdown-it"],function(e){c=e;t()},e)}))}return Promise.all(e)};R.prototype._setupCardContent=function(){var t=new o(this.getId()+"-message",{showCloseButton:true,visible:false}),e=new s(this.getId()+"content",{preferDOM:false,content:"<div>&nbsp;</div>"});t.addStyleClass("sapUiTinyMargin");this.setAggregation("_content",new r({items:[t,e]}))};R.prototype.setConfiguration=function(t){this._oCardConfig=t;if(t&&t.request&&t.request.url){this._loadManifestFromUrl(t.request.url);return}this._handleMarkDown();this._setupMSCardContent()};R.prototype.getConfiguration=function(){return this._oCardConfig};R.prototype._handleMarkDown=function(){var t=this;l.AdaptiveCard.onProcessMarkdown=function(e,n){var i=t.getParent(),a=i&&i.getManifestEntry("/sap.card/configuration/enableMarkdown");if(a){n.outputHtml=(new c).render(e);n.didProcess=true;return n}}};R.prototype._loadManifestFromUrl=function(t){var e=new p,n=this;e.loadData(t).then(function(){n._oCardConfig=Object.assign(n._oCardConfig,e.getData())}).then(function(){n._handleMarkDown();n._setupMSCardContent()}).then(function(){e.destroy();e=null}).catch(function(){u.error("No JSON file found on this URL. Please provide a correct path to the JSON-serialized card object model file.")})};R.prototype._setupAdaptiveCardDependency=function(){this.adaptiveCardInstance=new l.AdaptiveCard;this._doMSCardsOverwrites();this._adjustHostConfig();this._handleActions();this._replaceElements();this._isRtl()};R.prototype._doMSCardsOverwrites=function(){l.Action.prototype.render=v};R.prototype._adjustHostConfig=function(){this.adaptiveCardInstance.hostConfig=new l.HostConfig(a())};R.prototype._isRtl=function(){this.adaptiveCardInstance.isRtl=function(){return d.getConfiguration().getRTL()}};R.prototype._handleActions=function(){this.adaptiveCardInstance.onExecuteAction=function(e){var n,i,a;if(e instanceof l.OpenUrlAction){i={url:e.url};n=t.CardActionType.Navigation}else if(e instanceof l.SubmitAction){i={data:e.data};n=t.CardActionType.Submit}else{return}a=this.getActions();if(a){a.fireAction(this,n,i)}}.bind(this)};R.prototype.onActionSubmitStart=function(t){this.getParent().setBusy(true)};R.prototype.onActionSubmitEnd=function(t,e){var n=d.getLibraryResourceBundle("sap.ui.integration"),i=e?n.getText("CARDS_ADAPTIVE_ACTION_SUBMIT_ERROR"):n.getText("CARDS_ADAPTIVE_ACTION_SUBMIT_SUCCESS"),a=e?b.Error:b.Success;this.showMessage(i,a);this.getParent().setBusy(false)};R.prototype.showMessage=function(t,e){var n=this.getAggregation("_content").getItems()[0];n.applySettings({type:e,text:t,visible:true})};R.prototype._replaceElements=function(){l.GlobalRegistry.elements.unregister("Input.Text");l.GlobalRegistry.elements.register("Input.Text",h);l.GlobalRegistry.elements.unregister("Input.Number");l.GlobalRegistry.elements.register("Input.Number",C);l.GlobalRegistry.elements.unregister("Input.ChoiceSet");l.GlobalRegistry.elements.register("Input.ChoiceSet",f);l.GlobalRegistry.elements.unregister("Input.Time");l.GlobalRegistry.elements.register("Input.Time",m);l.GlobalRegistry.elements.unregister("Input.Date");l.GlobalRegistry.elements.register("Input.Date",y);l.GlobalRegistry.elements.unregister("Input.Toggle");l.GlobalRegistry.elements.register("Input.Toggle",_)};R.prototype.setCardDataProvider=function(t){this._oCardDataProvider=t};R.prototype._setupMSCardContent=function(){var t=this._oCardConfig,e,n=this._oCardDataProvider;if(!this.adaptiveCardInstance||!t){return}e=t.$data||t.data;if(!e&&!n){this._oCardTemplate=null;this._renderMSCardContent(t);return}if(t.$data){e={json:e}}this._setDataConfiguration(e)};R.prototype.onDataChanged=function(){var t=this.getBindingContext().getPath(),e=this.getModel().getProperty(t);this._oCardTemplate=this._setTemplating(this._oCardConfig,e);this.getAggregation("_loadingProvider").setLoading(false);this.invalidate()};R.prototype._renderMSCardContent=function(t){var e=this.getAggregation("_content").getItems()[1].$(),n=!!this.isLoading();this.setBusy(n);this.getAggregation("_content").toggleStyleClass("sapFCardContentHidden",n);if(this.adaptiveCardInstance&&t&&e.length){this.adaptiveCardInstance.parse(t);e.html(this.adaptiveCardInstance.render());this._bAdaptiveCardElementsReady=true;this._fireCardReadyEvent();if(this.adaptiveCardInstance.renderedElement){this.adaptiveCardInstance.renderedElement.tabIndex=-1}}};R.prototype._fireCardReadyEvent=function(){if(this._bAdaptiveCardElementsReady&&this.getComponentsReady()){this._bReady=true;this.fireReady()}};R.prototype._setTemplating=function(t,e){var n=new g.Template(t),i=new g.EvaluationContext;i.$root=e;return n.expand(i)};R.prototype._loadWebcomponents=function(){if(this.getComponentsReady()){u.debug("WebComponents were already loaded");this._fireCardReadyEvent();return}if(window.customElements){window.customElements.whenDefined("ui5-button").then(function(){if(!this.getComponentsReady()){this.setComponentsReady(true);this._fireCardReadyEvent()}}.bind(this))}setTimeout(function(){if(this.getComponentsReady()){u.debug("WebComponents were already loaded");return}n({id:"webcomponents-loader",url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/webcomponentsjs/webcomponents-loader.js")})}.bind(this));document.addEventListener("WebComponentsReady",function(){if(this.getComponentsReady()){u.debug("WebComponents were already loaded");return}n({id:"webcomponents-bundle",attributes:{type:"module"},url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/bundle.esm.js")});this.setComponentsReady(true);this._fireCardReadyEvent()}.bind(this))};R.prototype.setComponentsReady=function(t){this._bComponentsReady=t;return this};R.prototype.getComponentsReady=function(){return!!this._bComponentsReady};return R});