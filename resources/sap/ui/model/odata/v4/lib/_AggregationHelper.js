/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_Helper","./_Parser","sap/ui/model/Filter"],function(e,t,r){"use strict";var n=/,|%2C|%2c/,a={aggregate:{"*":{grandTotal:"boolean",max:"boolean",min:"boolean",name:"string",subtotals:"boolean",unit:"string",with:"string"}},"grandTotal like 1.84":"boolean",grandTotalAtBottomOnly:"boolean",group:{"*":{additionally:["string"]}},groupLevels:["string"],search:"string",subtotalsAtBottomOnly:"boolean"},i=new RegExp("^("+t.sODataIdentifier+"(?:/"+t.sODataIdentifier+")*"+")(?:"+t.sWhitespace+"+(?:asc|desc))?$"),o={expandTo:/^[1-9]\d*$/,hierarchyQualifier:"string"},u;function s(e,t,r,n,a,i,o){var u=e.aggregate[a],s=u.name||a,l=u.unit,g=u.with;if(n){if(g==="average"||g==="countdistinct"){throw new Error("Cannot aggregate totals with '"+g+"'")}s=a;a="UI5grand__"+a}if(g){s+=" with "+g+" as "+a}else if(u.name){s+=" as "+a}r.push(s);if(l&&!r.includes(l)&&!o.includes(l,i+1)&&!t.includes(l)){r.push(l)}}function l(e){var t=[];if(e.$skip){t.push("skip("+e.$skip+")")}delete e.$skip;if(e.$top<Infinity){t.push("top("+e.$top+")")}delete e.$top;return t.join("/")}u={buildApply:function(e,t,r,n,a){var i,o="",g=[],f=e["grandTotal like 1.84"],c,d,p,h=[],y,v=[];function $(t,r){var n,i=e.aggregate[t];if(i[r]){n="UI5"+r+"__"+t;h.push(t+" with "+r+" as "+n);if(a){a[n]={measure:t,method:r}}}}if(e.hierarchyQualifier){return u.buildApply4Hierarchy(e,t)}t=Object.assign({},t);e.groupLevels=e.groupLevels||[];d=!r||r>e.groupLevels.length;e.group=e.group||{};e.groupLevels.forEach(function(t){e.group[t]=e.group[t]||{}});c=d?Object.keys(e.group).sort().filter(function(t){return!e.groupLevels.includes(t)}):[e.groupLevels[r-1]];if(!r){c=e.groupLevels.concat(c)}e.aggregate=e.aggregate||{};i=Object.keys(e.aggregate).sort();if(r===1&&!n){i.filter(function(t){return e.aggregate[t].grandTotal}).forEach(s.bind(null,e,[],g,f))}if(!n){i.forEach(function(e){$(e,"min");$(e,"max")})}i.filter(function(t){return d||e.aggregate[t].subtotals}).forEach(s.bind(null,e,c,v,false));if(v.length){o="aggregate("+v.join(",")+")"}if(c.length){c.forEach(function(t){var r=e.group[t].additionally;if(r){c.push.apply(c,r)}});o="groupby(("+c.join(",")+(o?"),"+o+")":"))")}if(n){delete t.$count}else if(t.$count){h.push("$count as UI5__count");delete t.$count}if(t.$filter){o+="/filter("+t.$filter+")";delete t.$filter}if(t.$orderby){o+="/orderby("+t.$orderby+")";delete t.$orderby}y=l(t);if(f&&g.length){if(e.groupLevels.length){throw new Error("Cannot combine visual grouping with grand total")}o+="/concat(aggregate("+g.join(",")+"),aggregate("+h.join(",")+"),"+(y||"identity")+")"}else{if(h.length){o+="/concat(aggregate("+h.join(",")+"),"+(y||"identity")+")"}else if(y){o+="/"+y}if(r===1&&t.$$leaves&&!n){p="groupby(("+Object.keys(e.group).sort().join(",")+"))/aggregate($count as UI5__leaves)"}delete t.$$leaves;if(g.length){o="concat("+(p?p+",":"")+"aggregate("+g.join(",")+"),"+o+")"}else if(p){o="concat("+p+","+o+")"}}if(e.search){o="search("+e.search+")/"+o}if(t.$$filterBeforeAggregate){o="filter("+t.$$filterBeforeAggregate+")/"+o;delete t.$$filterBeforeAggregate}if(o){t.$apply=o}return t},buildApply4Hierarchy:function(e,t){var r,n=e.hierarchyQualifier,a=e.$path,i=t?e.$fetchMetadata(a+"/@Org.OData.Aggregation.V1.RecursiveHierarchy#"+n+"/NodeProperty/$PropertyPath").getResult():"???",o;function u(r){if(t.$select){if(!o){o=e.$fetchMetadata(a+"/@com.sap.vocabularies.Hierarchy.v1.RecursiveHierarchy#"+n).getResult()}t.$select.push(o[r].$PropertyPath)}}t=Object.assign({},t);if(t.$select){t.$select=t.$select.slice()}if(t.$$filterBeforeAggregate){r="descendants($root"+a+","+n+","+i+",filter("+t.$$filterBeforeAggregate+"),1)";delete t.$$filterBeforeAggregate}else{r="com.sap.vocabularies.Hierarchy.v1.TopLevels(HierarchyNodes=$root"+a+",HierarchyQualifier='"+n+"',NodeProperty='"+i+"',Levels="+(e.expandTo||1)+")";if(e.expandTo>1){u("DescendantCountProperty");u("DistanceFromRootProperty")}}u("DrillStateProperty");t.$apply=r;return t},checkTypeof:function(e,t,r){if(Array.isArray(t)){if(!Array.isArray(e)){throw new Error("Not an array value for '"+r+"'")}e.forEach(function(e,n){u.checkTypeof(e,t[0],r+"/"+n)})}else if(t instanceof RegExp){if(!t.test(e)){throw new Error("Not a matching value for '"+r+"'")}}else if(typeof t==="object"){var n="*"in t;if(typeof e!=="object"||!e||Array.isArray(e)){throw new Error("Not an object value for '"+r+"'")}Object.keys(e).forEach(function(a){if(!n&&!(a in t)){throw new Error("Unsupported property: '"+r+"/"+a+"'")}u.checkTypeof(e[a],t[n?"*":a],r+"/"+a)})}else if(typeof e!==t){throw new Error("Not a "+t+" value for '"+r+"'")}},createPlaceholder:function(t,r,n){var a={"@$ui5.node.level":t};e.setPrivateAnnotation(a,"index",r);e.setPrivateAnnotation(a,"parent",n);return a},extractSubtotals:function(e,t,r,n){var a=t["@$ui5.node.level"];Object.keys(e.aggregate).forEach(function(i){var o=e.aggregate[i],u,s=o.unit;if(!o.subtotals){return}r[i]=t[i];if(n){n[i]=null}if(s){r[s]=t[s];if(n){u=e.groupLevels.indexOf(s);if(u<0||u>=a){n[s]=null}}}})},filterOrderby:function(e,t,r){var n=u.getFilteredOrderby(e.$orderby,t,r);e=Object.assign({},e);if(n){e.$orderby=n}else{delete e.$orderby}return e},getAllProperties:function(e){var t=Object.keys(e.aggregate),r=Object.keys(e.group),n=t.concat(r);t.forEach(function(t){var r=e.aggregate[t].unit;if(r){n.push(r)}});r.forEach(function(t){var r=e.group[t].additionally;if(r){r.forEach(function(e){n.push(e.includes("/")?e.split("/"):e)})}});return n},getFilteredOrderby:function(e,t,r){var a=!r||r>t.groupLevels.length;function o(e){return Object.keys(t.aggregate).some(function(r){var n=t.aggregate[r];return n.subtotals&&e===n.unit})}function u(e){if(e in t.group&&(!r||!t.groupLevels.includes(e))){return true}return Object.keys(t.aggregate).some(function(r){return e===t.aggregate[r].unit})||Object.keys(t.group).some(function(n){return(!r||!t.groupLevels.includes(n))&&s(e,n)})}function s(e,r){return e===r||t.group[r].additionally&&t.group[r].additionally.includes(e)}if(e){return e.split(n).filter(function(e){var n=i.exec(e),l;if(n){l=n[1];return l in t.aggregate&&(a||t.aggregate[l].subtotals)||a&&u(l)||!a&&(s(l,t.groupLevels[r-1])||o(l))}return true}).join(",")}},getOrCreateExpandedObject:function(t,r){var n,a=e.getPrivateAnnotation(r,"expanded");if(!a){n={"@$ui5.node.isExpanded":false};e.setPrivateAnnotation(r,"collapsed",n);a={"@$ui5.node.isExpanded":true};e.setPrivateAnnotation(r,"expanded",a);if(t.subtotalsAtBottomOnly!==undefined){u.extractSubtotals(t,r,n,t.subtotalsAtBottomOnly?a:null)}}return a},hasGrandTotal:function(e){return e&&Object.keys(e).some(function(t){return e[t].grandTotal})},hasMinOrMax:function(e){return e&&Object.keys(e).some(function(t){var r=e[t];return r.min||r.max})},isAffected:function(t,r,n){function a(t,r){if(t.endsWith("/*")){t=t.slice(0,-2)}return e.hasPathPrefix(r,t)||e.hasPathPrefix(t,r)}function i(e,t){return t.some(function(t){return t.aFilters?i(e,t.aFilters):a(e,t.sPath)})}return n.some(function(e){var n=a.bind(null,e);return e===""||e==="*"||Object.keys(t.aggregate).some(function(r){var n=t.aggregate[r];return a(e,n.name||r)})||Object.keys(t.group).some(n)||t.groupLevels.some(n)||i(e,r)})},removeUI5grand__:function(e){Object.keys(e).forEach(function(t){if(t.startsWith("UI5grand__")){e[t.slice(10)]=e[t];delete e[t]}})},setAnnotations:function(t,r,n,a,i){e.setAnnotation(t,"@$ui5.node.isExpanded",r);e.setAnnotation(t,"@$ui5.node.isTotal",n);t["@$ui5.node.level"]=a;if(i){i.forEach(function(r){if(Array.isArray(r)){e.createMissing(t,r)}else if(!(r in t)){t[r]=null}})}},splitFilter:function(e,t){var n=[],a=[];function i(e){return e.aFilters?e.aFilters.some(i):e.sPath in t.aggregate}function o(e){if(e.aFilters&&e.bAnd){e.aFilters.forEach(o)}else{(i(e)?n:a).push(e)}}function u(e){return e.length>1?new r(e,true):e[0]}if(!t||!t.aggregate){return[e]}o(e);return[u(n),u(a)]},validateAggregation:function(e,t,r,n){if(e.hierarchyQualifier&&!n){throw new Error("Missing parameter autoExpandSelect at model")}u.checkTypeof(e,e.hierarchyQualifier?o:a,"$$aggregation");e.$fetchMetadata=r;e.$path=t}};return u},false);