/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_GroupLock","./_Helper","./_Requestor","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/model/odata/ODataUtils"],function(e,t,i,n,r,s){"use strict";var o="sap.ui.model.odata.v4.lib._Cache",a=/\(\$uid=[-\w]+\)$/,u=/^\$inactive\./,h="@com.sap.vocabularies.Common.v1.Messages",c=/^-?\d+$/,l=/^([^(]*)(\(.*\))$/;function d(e,t,i,n){if(i.$count!==undefined){p(e,t,i,i.$count+n)}}function f(e,t){return t===""||e===t||e.startsWith(t+"/")}function p(e,i,n,r){if(typeof r==="string"){r=parseInt(r)}t.updateExisting(e,i,n,{$count:r})}function g(e,t,i,n,r,s){this.iActiveUsages=1;this.mChangeListeners={};this.mChangeRequests={};this.sOriginalResourcePath=r||t;this.iInactiveSince=Infinity;this.mEditUrl2PatchPromise={};this.oPendingRequestsPromise=null;this.mPostRequests={};this.sReportedMessagesPath=undefined;this.oRequestor=e;this.bSentRequest=false;this.bSortExpandSelect=n;this.setResourcePath(t);this.setQueryOptions(i);this.bSharedRequest=s}g.prototype._delete=function(i,n,s,o,a){var u=s.split("/"),h=u.pop(),c=u.join("/"),l=this;this.checkSharedRequest();return this.fetchValue(e.$cached,c).then(function(e){var s=g.from$skip(h,e),u,f=h?e[s]||e.$byPredicate[s]:e,p,P,y,m,v=typeof s==="number"?s:undefined,$=t.getPrivateAnnotation(f,"predicate"),R=t.buildPath(c,Array.isArray(e)?$:h),E=l.oRequestor.getModelInterface(),b,q=t.getPrivateAnnotation(f,"transient"),S=t.getPrivateAnnotation(f,"transientPredicate");function A(){var i;t.removeByPath(l.mChangeRequests,R,b);if(y.length){E.updateMessages(undefined,y)}delete f["@$ui5.context.isDeleted"];if(Array.isArray(e)){v=u.index;if(v!==undefined){d(l.mChangeListeners,c,e,1)}i=e.$deleted.indexOf(u);l.adjustIndexes(c,e,v,1,i);e.splice(v,0,f);e.$deleted.splice(i,1);if(S){e.$created+=1;if(!c){l.iActiveElements+=1}}}if(l.iActiveUsages){a(v,1)}else if(v===undefined&&l.reset){l.reset([])}}if(q){if(typeof q!=="string"){throw new Error("No 'delete' allowed while waiting for server response")}if(e.$postBodyCollection){e.$postBodyCollection.splice(v,1);l.removeElement(e,v,S,c);a(v,-1);p=new Error("Deleted from deep create");p.canceled=true;t.getPrivateAnnotation(f,"reject")(p);t.cancelNestedCreates(f,"Deleted from deep create")}else{l.oRequestor.removePost(q,f)}return undefined}y=E.getMessagesByPath(t.buildPath("/",l.sResourcePath,R),true);E.updateMessages(y);f["@$ui5.context.isDeleted"]=true;if(Array.isArray(e)){u=l.addDeleted(e,v,$,i,!!S);l.removeElement(e,v,$,c)}a(v,-1);if(i){P=i.getGroupId();l.oRequestor.relocateAll("$parked."+P,P,f)}m={"If-Match":o||f};n+=l.oRequestor.buildQueryString(l.sMetaPath,l.mQueryOptions,true);b=i?l.oRequestor.request("DELETE",n,i,m,undefined,undefined,A,undefined,t.buildPath(l.sOriginalResourcePath,R)):r.resolve();t.addByPath(l.mChangeRequests,R,b);return b.catch(function(e){if(e.status!==404){throw e}}).then(function(){t.removeByPath(l.mChangeRequests,R,b);if(Array.isArray(e)){e.$deleted.splice(e.$deleted.indexOf(u),1);delete e.$byPredicate[$];delete e.$byPredicate[S]}else if(h){t.updateExisting(l.mChangeListeners,c,e,g.makeUpdateData([h],null))}else{f["$ui5.deleted"]=true}},function(e){if(!e.canceled){y=y.filter(function(e){return!e.persistent});A()}throw e})})};g.prototype.addDeleted=function(e,t,i,n,r){var s={created:r,groupId:n&&n.getGroupId(),predicate:i,index:t},o;e.$deleted=e.$deleted||[];if(t===undefined){e.$deleted.unshift(s)}else{for(o=0;o<e.$deleted.length;o+=1){if(t<e.$deleted[o].index){break}}e.$deleted.splice(o,0,s)}return s};g.prototype.addPendingRequest=function(){var e;if(!this.oPendingRequestsPromise){this.oPendingRequestsPromise=new r(function(t){e=t});this.oPendingRequestsPromise.$count=0;this.oPendingRequestsPromise.$resolve=e}this.oPendingRequestsPromise.$count+=1};g.prototype.addTransientCollection=function(e,i){var n,r=e.split("/"),s=r.pop(),o=this.getValue(r.join("/")),a=t.getPrivateAnnotation(o,"postBody"),u,h=e.indexOf(")",e.indexOf("($uid="))+1,c=this.getValue(e.slice(0,h)),l=t.getPrivateAnnotation(c,"select")||{},d=this;function f(){n.$postBodyCollection=a[s]=u}this.checkSharedRequest();n=o[s]=o[s]||[];n.$count=n.$created=n.length;n.$byPredicate={};u=a[s]||[];if(n.length){f()}else{n.$postBodyCollection=f}l[t.getMetaPath(e.slice(h+1))]=i;t.setPrivateAnnotation(c,"select",l);n.forEach(function(e,i){var r="($uid="+t.uid()+")";e["@$ui5.context.isTransient"]=true;t.setPrivateAnnotation(e,"postBody",u[i]);t.setPrivateAnnotation(e,"transient",t.getPrivateAnnotation(o,"transient"));t.setPrivateAnnotation(e,"transientPredicate",r);t.setPrivateAnnotation(e,"promise",t.addPromise(e));n.$byPredicate[r]=e});this.fetchTypes().then(function(i){d.oRequestor.fetchType(i,d.sMetaPath+"/"+t.getMetaPath(e))});return n};g.prototype.adjustIndexes=function(e,t,i,n,r,s){if(i===undefined){return}if(!e){this.aReadRequests.forEach(function(e){if(e.iStart>=i){e.iStart+=n;e.iEnd+=n}})}(t.$deleted||[]).forEach(function(e,t){if(i<e.index||r<t||s&&(i===0||!e.created)){e.index+=n}})};g.prototype.calculateKeyPredicate=function(e,i,n){var r,s=i[n];if(s&&s.$Key){r=t.getKeyPredicate(e,n,i);if(r){t.setPrivateAnnotation(e,"predicate",r)}}return r};g.prototype.checkSharedRequest=function(){if(this.bSharedRequest){throw new Error(this+" is read-only")}};g.prototype.create=function(e,i,n,s,o,a,h,c){var l=this.getValue(n),f=e.getGroupId(),p,g,P=this;function y(r){var a=o["@$ui5.context.isInactive"],u=l.indexOf(o);if(r&&a){if(a===1){t.resetInactiveEntity(P.mChangeListeners,s,o)}return true}t.cancelNestedCreates(o,"Deep create of "+i.getResult()+" canceled; group: "+e.getGroupId());t.removeByPath(P.mPostRequests,n,o);l.splice(u,1);l.$created-=1;if(!o["@$ui5.context.isInactive"]){if(!n){P.iActiveElements-=1}d(P.mChangeListeners,n,l,-1)}delete l.$byPredicate[s];P.adjustIndexes(n,l,u,-1);e.cancel()}function m(){P.addPendingRequest();t.setPrivateAnnotation(o,"transient",new Promise(function(e){g=e}));c()}function v(e,i){t.setPrivateAnnotation(o,"transient",f);t.addByPath(P.mPostRequests,n,o);return r.all([P.oRequestor.request("POST",e,i,null,p,m,y,undefined,t.buildPath(P.sResourcePath,n,s)),P.fetchTypes()]).then(function(i){var r=i[0],a,u,h;t.deletePrivateAnnotation(o,"postBody");t.deletePrivateAnnotation(o,"transient");i[0]["@$ui5.context.isTransient"]=false;t.removeByPath(P.mPostRequests,n,o);P.visitResponse(r,i[1],t.getMetaPath(t.buildPath(P.sMetaPath,n)),n+s);a=t.getPrivateAnnotation(r,"predicate");if(a){t.setPrivateAnnotation(o,"predicate",a);if(s in l.$byPredicate){l.$byPredicate[a]=o;t.updateTransientPaths(P.mChangeListeners,s,a)}}h=t.getQueryOptionsForPath(P.mLateQueryOptions||P.mQueryOptions,n).$select;u=t.buildPath(n,a||s);t.updateSelected(P.mChangeListeners,u,o,r,h,undefined,true);t.cancelNestedCreates(o,"Deep create of "+e+" succeeded. Do not use this promise.");t.setPrivateAnnotation(o,"deepCreate",P.updateNestedCreates(u,o,r,t.getPrivateAnnotation(o,"select")));t.deletePrivateAnnotation(o,"select");P.removePendingRequest();g(true);return o},function(t){var i;if(t.canceled){throw t}if(g){P.removePendingRequest();g()}if(P.fetchTypes().isRejected()){h(t);throw t}f=f.replace(u,"");f=P.oRequestor.getGroupSubmitMode(f)==="API"?f:"$parked."+f;i=v(e,P.oRequestor.lockGroup(f,P,true,true));h(t);return i})}this.checkSharedRequest();if(!Array.isArray(l)){throw new Error("Create is only supported for collections; '"+n+"' does not reference a collection")}o=t.publicClone(o,true)||{};p=t.clone(o);t.setPrivateAnnotation(o,"postBody",p);t.setPrivateAnnotation(o,"transientPredicate",s);o["@$ui5.context.isTransient"]=true;if(f.startsWith("$inactive.")){t.setPrivateAnnotation(o,"initialData",t.publicClone(o,true));o["@$ui5.context.isInactive"]=true}else{if(!n){this.iActiveElements+=1}d(this.mChangeListeners,n,l,1)}if(a){l.splice(l.$created,0,o)}else{l.unshift(o)}l.$created+=1;l.$byPredicate=l.$byPredicate||{};l.$byPredicate[s]=o;P.adjustIndexes(n,l,0,1,0,true);if(l.$postBodyCollection){if(typeof l.$postBodyCollection==="function"){l.$postBodyCollection()}t.setPrivateAnnotation(o,"transient",f);if(a){l.$postBodyCollection.push(p)}else{l.$postBodyCollection.unshift(p)}e.unlock();return t.addPromise(o)}return i.then(function(t){t+=P.oRequestor.buildQueryString(P.sMetaPath,P.mQueryOptions,true);return v(t,e)})};g.prototype.deregisterChangeListener=function(e,i){if(!(this.bSharedRequest&&e)){t.removeByPath(this.mChangeListeners,e,i)}};g.prototype.drillDown=function(e,i,s,a){var u=r.resolve(e),h,c,d=false,f,p=false,P=this;function y(e,t){n[t?"info":"error"]("Failed to drill-down into "+i+", invalid segment: "+e,P.toString(),o);return undefined}function m(i,n,r,o){var a,u,l=f.slice(0,r).join("/"),g=t.getMetaPath(l),m;if(Array.isArray(i)){return y(n,n==="0")}if(d){return y(n,true)}if(n.includes("@")){u=n.split("@")[0];g=t.getMetaPath(l.split("@")[0]);if(p||u in i||i[u+"@$ui5.noData"]||t.isSelected(g,P.mQueryOptions)){return y(n,true)}}a=i[t.getAnnotationKey(i,".Permissions",n)];if(a===0||a==="None"){return undefined}return P.oRequestor.getModelInterface().fetchMetadata(P.sMetaPath+"/"+g).then(function(r){var a=false;if(!r){return y(n)}if(r.$Type==="Edm.Stream"&&!u){m=i[n+"@odata.mediaReadLink"]||i[n+"@mediaReadLink"];if(m){return m}if(i[n+"@$ui5.noData"]||t.isSelected(g,P.mQueryOptions)){return t.buildPath(P.oRequestor.getServiceUrl()+P.sResourcePath,l)}}if(!p){if(!h&&!Array.isArray(e)){h=e;c=0}if(h&&!o){a=P.fetchLateProperty(s,h,f.slice(0,c).join("/"),f.slice(c).join("/"))}return typeof a==="boolean"?y(n,a):a}if(r.$kind==="NavigationProperty"){return null}if(!r.$Type.startsWith("Edm.")){return{}}if("$DefaultValue"in r){return r.$Type==="Edm.String"?r.$DefaultValue:t.parseLiteral(r.$DefaultValue,r.$Type,l)}return null})}if(!i){return u}f=i.split("/");return f.reduce(function(e,i,n){return e.then(function e(s,o){var u,f,P;if(i==="$count"){return Array.isArray(s)?s.$count:y(i)}if(s===undefined||s===null){return undefined}if(typeof s!=="object"||i==="@$ui5._"||Array.isArray(s)&&(i[0]==="$"||i==="length")){return y(i)}if(t.hasPrivateAnnotation(s,"predicate")){h=s;c=n}P=s;p=p||s["@$ui5.context.isTransient"];f=l.exec(i);if(f){if(f[1]){s=s[f[1]]}if(s){s=s.$byPredicate&&s.$byPredicate[f[2]]}}else{u=g.from$skip(i,s);if(a&&u===i&&(s[i]===undefined||s[i]===null)){s[i]={}}s=s[u]}if(s===undefined&&i[0]!=="#"&&i[0]!=="@"){s=m(P,i,n+1,o);if(s instanceof r&&s.isPending()){return s.then(function(){return e(P,true)})}}if(i.includes("@")){d=true}return s})},u)};g.prototype.fetchLateProperty=function(e,i,n,r){var s=false,o,a,u,h=r.indexOf("@"),c,l,d,f,p=t.getMetaPath(n),g=this.fetchTypes().getResult(),P,y=this;function m(){s=true;y.oRequestor.getModelInterface().fireDataRequested("/"+a)}function v(e,i){var n=t.buildPath(o,i),r=g[n],s;if(!r){r=y.oRequestor.fetchType(g,n).getResult()}if(i){(r.$Key||[]).forEach(function(e){if(typeof e==="object"){e=e[Object.keys(e)[0]]}P.push(t.buildPath(i,e))})}if(e.$expand){s=Object.keys(e.$expand)[0];v(e.$expand[s],t.buildPath(i,s))}}if(!(this.mLateQueryOptions||this.mQueryOptions&&this.mQueryOptions.$select)){return false}if(h>=0){if(r.startsWith("@$ui5.",h)){return true}r=r.slice(0,h)}P=[r];o=t.buildPath(this.sMetaPath,p);d=this.mLateQueryOptions||{$select:this.mQueryOptions.$select,$expand:this.mQueryOptions.$expand};d=t.intersectQueryOptions(t.getQueryOptionsForPath(d,n),[r],this.oRequestor.getModelInterface().fetchMetadata,o);if(!d){return false}v(d);a=t.buildPath(this.sResourcePath,n);f=a+this.oRequestor.buildQueryString(o,d,false,true);l=this.mPropertyRequestByPath[f];if(!l){c=a+this.oRequestor.buildQueryString(o,this.mQueryOptions,true);u=t.getPrivateAnnotation(i,"groupId");l=this.oRequestor.request("GET",c,u?this.oRequestor.lockGroup(u,this):e.getUnlockedCopy(),undefined,undefined,m,undefined,o,undefined,false,d).then(function(e){y.visitResponse(e,g,o,n);return e});this.mPropertyRequestByPath[f]=l}return l.then(function(e){var r=t.getPrivateAnnotation(e,"predicate"),o=t.getPrivateAnnotation(i,"predicate");if(o&&r&&o!==r){throw new Error("GET "+f+": Key predicate changed from "+o+" to "+r)}if(i["@odata.etag"]&&e["@odata.etag"]!==i["@odata.etag"]){throw new Error("GET "+f+": ETag changed")}t.updateSelected(y.mChangeListeners,n,i,e,P);if(s){s=false;y.oRequestor.getModelInterface().fireDataReceived(undefined,"/"+a)}}).catch(function(e){if(s){y.oRequestor.getModelInterface().fireDataReceived(e,"/"+a)}throw e}).finally(function(){delete y.mPropertyRequestByPath[f]})};g.prototype.fetchTypes=function(){var e,t,i=this;function n(r,s){if(s&&s.$expand){Object.keys(s.$expand).forEach(function(o){var a=r;o.split("/").forEach(function(n){a+="/"+n;e.push(i.oRequestor.fetchType(t,a))});n(a,s.$expand[o])})}}if(!this.oTypePromise){e=[];t={};e.push(this.oRequestor.fetchType(t,this.sMetaPath));n(this.sMetaPath,this.mQueryOptions);this.oTypePromise=r.all(e).then(function(){return t})}return this.oTypePromise};g.prototype.getAndRemoveValue=function(t){var i=t.split("/"),n=i.pop(),r=this.fetchValue(e.$cached,i.join("/")).getResult(),s=r[n];this.checkSharedRequest();delete r[n];return s};g.prototype.getAllElements=function(e){var t;if(e){return this.getValue(e)}t=this.aElements.map(function(e){return e instanceof r?undefined:e});t.$count=this.aElements.$count;return t};g.prototype.getCreatedElements=function(e){var t=this.getValue(e);return t?t.slice(0,t.$created):[]};g.prototype.getDownloadQueryOptions=function(e){return e};g.prototype.getDownloadUrl=function(e,i){var n=this.mQueryOptions;if(e){n=t.getQueryOptionsForPath(n,e);n=t.merge({},i,n)}return this.oRequestor.getServiceUrl()+t.buildPath(this.sResourcePath,e)+this.oRequestor.buildQueryString(t.buildPath(this.sMetaPath,t.getMetaPath(e)),this.getDownloadQueryOptions(n),false,true)};g.prototype.getLateQueryOptions=function(){return this.mLateQueryOptions};g.prototype.getPendingRequestsPromise=function(){return this.oPendingRequestsPromise&&this.oPendingRequestsPromise.getResult()};g.prototype.getQueryOptions=function(){return this.mQueryOptions};g.prototype.getValue=function(e){throw new Error("Unsupported operation")};g.prototype.getResourcePath=function(){return this.sResourcePath};g.prototype.hasChangeListeners=function(){return!t.isEmptyObject(this.mChangeListeners)};g.prototype.hasPendingChangesForPath=function(e,i,n){var r=this;return Object.keys(this.mChangeRequests).some(function(n){return t.hasPathPrefix(n,e)&&!(i&&r.mChangeRequests[n].every(function(e){return!e.$isKeepAlive||e.$isKeepAlive()}))})||Object.keys(this.mPostRequests).some(function(i){return n&&!i?false:t.hasPathPrefix(i,e)&&r.mPostRequests[i].some(function(e){return e["@$ui5.context.isInactive"]!==true})})};g.prototype.hasSentRequest=function(){return this.bSentRequest};g.prototype.patch=function(i,n){var r=this;this.checkSharedRequest();return this.fetchValue(e.$cached,i).then(function(e){t.updateExisting(r.mChangeListeners,i,e,n);return e})};g.prototype.refreshSingle=function(i,n,s,o,a,u,h){var c=false,l=this;this.checkSharedRequest();return this.fetchValue(e.$cached,n).then(function(e){var d=u&&n===""&&l.oRequestor.getModelInterface().fetchMetadata(l.sMetaPath+"/@com.sap.vocabularies.Common.v1.Messages/$Path").getResult(),f=t.clone(t.getQueryOptionsForPath(l.mQueryOptions,n)),p;if(s!==undefined){o=t.getPrivateAnnotation(e[s],"predicate")}if(!o){throw new Error("No key predicate known")}p=t.buildPath(l.sResourcePath,n,o);if(a&&l.mLateQueryOptions){t.aggregateExpandSelect(f,l.mLateQueryOptions)}if(d&&f.$select&&!f.$select.includes(d)){f.$select.push(d);c=true}delete f.$apply;delete f.$count;delete f.$filter;delete f.$orderby;delete f.$search;p+=l.oRequestor.buildQueryString(l.sMetaPath,f,false,l.bSortExpandSelect);l.bSentRequest=true;return r.all([l.oRequestor.request("GET",p,i,undefined,undefined,h),l.fetchTypes()]).then(function(t){var i=t[0];l.replaceElement(e,s,o,i,t[1],n,c)})})};g.prototype.refreshSingleWithRemove=function(i,n,s,o,a,u,h){var c=this;this.checkSharedRequest();return r.all([this.fetchValue(e.$cached,n),this.fetchTypes()]).then(function(e){var l=e[0],d,f,p={},g,P,y=t.clone(t.getQueryOptionsForPath(c.mQueryOptions,n)),m,v=t.buildPath(c.sResourcePath,n),$=[],R=e[1];if(s!==undefined){d=l[s];o=t.getPrivateAnnotation(d,"predicate");if(!o){throw new Error("No key predicate known")}}else{d=l.$byPredicate[o]}P=t.getKeyFilter(d,c.sMetaPath,R);f=(y.$filter?"("+y.$filter+") and ":"")+P;delete y.$count;delete y.$orderby;c.bSentRequest=true;if(a){if(c.mLateQueryOptions){t.aggregateExpandSelect(y,c.mLateQueryOptions)}p=Object.assign({},y);p.$filter=f;y.$filter=P;delete y.$search;m=v+c.oRequestor.buildQueryString(c.sMetaPath,y,false,c.bSortExpandSelect);$.push(c.oRequestor.request("GET",m,i,undefined,undefined,u));if(s!==undefined&&(P!==f||p.$search)){delete p.$select;delete p.$expand;p.$count=true;p.$top=0;g=v+c.oRequestor.buildQueryString(c.sMetaPath,p);$.push(c.oRequestor.request("GET",g,i.getUnlockedCopy()))}}else{y.$filter=f;m=v+c.oRequestor.buildQueryString(c.sMetaPath,y,false,c.bSortExpandSelect);$.push(c.oRequestor.request("GET",m,i,undefined,undefined,u))}return r.all($).then(function(e){var t=e[0].value,i=e[1]&&e[1]["@odata.count"]==="0";if(t.length>1){throw new Error("Unexpected server response, more than one entity returned.")}else if(t.length===0){c.removeElement(l,s,o,n);c.oRequestor.getModelInterface().reportStateMessages(c.sResourcePath,{},[n+o]);h(false)}else if(i){c.removeElement(l,s,o,n);c.replaceElement(l,undefined,o,t[0],R,n);h(true)}else{c.replaceElement(l,s,o,t[0],R,n)}})})};g.prototype.registerChangeListener=function(e,i){if(!(this.bSharedRequest&&e)){t.addByPath(this.mChangeListeners,e,i)}};g.prototype.removeElement=function(e,i,n,r){var s=e.$byPredicate[n],o=s["@$ui5.context.isDeleted"],a=t.getPrivateAnnotation(s,"transientPredicate");if(i!==undefined){i=g.getElementIndex(e,n,i)}if(!o){delete e.$byPredicate[n]}if(i>=0){e.splice(i,1);d(this.mChangeListeners,r,e,-1);if(a){e.$created-=1;if(!r){this.iActiveElements-=1}if(!o){delete e.$byPredicate[a]}}this.adjustIndexes(r,e,i,-1);if(!r&&!a){this.iLimit-=1}}return i};g.prototype.removeMessages=function(){if(this.sReportedMessagesPath){this.oRequestor.getModelInterface().reportStateMessages(this.sReportedMessagesPath,{});this.sReportedMessagesPath=undefined}};g.prototype.removePendingRequest=function(){if(this.oPendingRequestsPromise){this.oPendingRequestsPromise.$count-=1;if(!this.oPendingRequestsPromise.$count){this.oPendingRequestsPromise.$resolve();this.oPendingRequestsPromise=null}}};g.prototype.replaceElement=function(e,i,n,r,s,o,a){var u,h;if(i===undefined){u=e.$byPredicate[n];e.$byPredicate[n]=r}else{i=g.getElementIndex(e,n,i);u=e[i];e[i]=e.$byPredicate[n]=r;h=t.getPrivateAnnotation(u,"transientPredicate");if(h){r["@$ui5.context.isTransient"]=false;e.$byPredicate[h]=r;t.setPrivateAnnotation(r,"transientPredicate",h)}}t.restoreUpdatingProperties(u,r);this.visitResponse(r,s,t.getMetaPath(t.buildPath(this.sMetaPath,o)),o+n,undefined,a)};g.prototype.requestCount=function(e){var t,i,n,r=this;if(this.mQueryOptions&&this.mQueryOptions.$count){i=Object.assign({},this.mQueryOptions);delete i.$expand;delete i.$orderby;delete i.$select;t=this.getExclusiveFilter();if(t){i.$filter=i.$filter?"("+i.$filter+") and "+t:t}i.$top=0;n=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,i);return this.oRequestor.request("GET",n,e.getUnlockedCopy()).catch(function(t){if(t.cause&&t.cause.status===404){return r.oRequestor.request("GET",n,e.getUnlockedCopy())}throw t}).then(function(e){var t=parseInt(e["@odata.count"])+r.iActiveElements;p(r.mChangeListeners,"",r.aElements,t);r.iLimit=t;return t})}return Promise.resolve(r.iLimit)};g.prototype.resetChangesForPath=function(e){var i=this;this.checkSharedRequest();Object.keys(this.mChangeRequests).reverse().forEach(function(n){var r,s;if(t.hasPathPrefix(n,e)){r=i.mChangeRequests[n];for(s=r.length-1;s>=0;s-=1){i.oRequestor.removeChangeRequest(r[s])}delete i.mChangeRequests[n]}});Object.keys(this.mPostRequests).forEach(function(n){var r=i.mPostRequests[n],s,o,a;if(e.startsWith("($uid=")){r.forEach(function(n){o=t.getPrivateAnnotation(n,"transientPredicate");if(o===e&&n["@$ui5.context.isInactive"]===1){t.resetInactiveEntity(i.mChangeListeners,o,n)}})}else if(f(n,e)){for(a=r.length-1;a>=0;a-=1){s=t.getPrivateAnnotation(r[a],"transient");if(s.startsWith("$inactive.")){t.resetInactiveEntity(i.mChangeListeners,t.getPrivateAnnotation(r[a],"transientPredicate"),r[a])}else{i.oRequestor.removePost(s,r[a])}}}})};g.prototype.setActive=function(e){if(e){this.iActiveUsages+=1;this.iInactiveSince=Infinity}else{this.iActiveUsages-=1;if(!this.iActiveUsages){this.iInactiveSince=Date.now();this.mChangeListeners={}}}};g.prototype.setLateQueryOptions=function(e){if(e){this.mLateQueryOptions={$select:e.$select,$expand:e.$expand}}else{this.mLateQueryOptions=null}};g.prototype.setProperty=function(i,n,r,s){var o=this;this.checkSharedRequest();return this.fetchValue(e.$cached,r,null,null,true).then(function(e){t.updateAll(o.mChangeListeners,r,e,g.makeUpdateData(i.split("/"),n,s))})};g.prototype.setQueryOptions=function(e,t){this.checkSharedRequest();if(this.bSentRequest&&!t){throw new Error("Cannot set query options: Cache has already sent a request")}this.mQueryOptions=e;this.sQueryString=this.oRequestor.buildQueryString(this.sMetaPath,e,false,this.bSortExpandSelect)};g.prototype.setResourcePath=function(e){this.checkSharedRequest();this.sResourcePath=e;this.sMetaPath=t.getMetaPath("/"+e);this.oTypePromise=undefined;this.mLateQueryOptions=null;this.mPropertyRequestByPath={}};g.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.sQueryString};g.prototype.update=function(i,s,a,u,h,c,l,f,p,P,y){var m,v=s.split("/"),$,R=this;this.checkSharedRequest();try{m=this.fetchValue(e.$cached,c)}catch(e){if(!e.$cached||this.oPromise!==null){throw e}m=this.oPromise=r.resolve({"@odata.etag":"*"})}return m.then(function(e){var m=t.buildPath(c,s),E=i.getGroupId(),b,q,S,A,C,O,k,w=g.makeUpdateData(v,a);function x(){t.removeByPath(R.mChangeRequests,m,q);t.updateExisting(R.mChangeListeners,c,e,b)}function M(e){if(arguments.length===0){C=true;return b}t.updateNonExisting(b,e)}function Q(i,n){var s={"If-Match":e},o;function a(){o=R.oRequestor.lockGroup(E,R,true);p()}if(f){s.Prefer="return=minimal"}q=R.oRequestor.request("PATCH",h,i,s,w,a,x,undefined,t.buildPath(R.sOriginalResourcePath,c),n,undefined,undefined,M);q.$isKeepAlive=P;t.addByPath(R.mChangeRequests,m,q);return r.all([q,R.fetchTypes()]).then(function(i){var n=i[0];t.removeByPath(R.mChangeRequests,m,q);if(C){return}if(!f){R.visitResponse(n,i[1],t.getMetaPath(t.buildPath(R.sMetaPath,c)),c)}t.updateExisting(R.mChangeListeners,c,e,f?{"@odata.etag":n["@odata.etag"]}:n)},function(i){var n=E;if(!u&&!i.canceled){x();throw i}t.removeByPath(R.mChangeRequests,m,q);if(i.canceled){throw i}o.unlock();o=undefined;u(i);if(C){return R.mEditUrl2PatchPromise[h]}switch(R.oRequestor.getGroupSubmitMode(E)){case"API":break;case"Auto":if(!R.oRequestor.hasChanges(E,e)){n="$parked."+E}break;default:throw i}R.mEditUrl2PatchPromise[h]=Q(R.oRequestor.lockGroup(n,R,true,true),true);return R.mEditUrl2PatchPromise[h]}).finally(function(){if(o){o.unlock()}delete R.mEditUrl2PatchPromise[h]})}if(!e){throw new Error("Cannot update '"+s+"': '"+c+"' does not exist")}t.deleteUpdating(s,e);O=t.getPrivateAnnotation(e,"transient");if(O){if(typeof O!=="string"){throw new Error("No 'update' allowed while waiting for server response")}if(O.startsWith("$parked.")||O.startsWith("$inactive.")){A=O;O=O.slice(O.indexOf(".")+1)}if(O!==E){throw new Error("The entity will be created via group '"+O+"'. Cannot patch via group '"+E+"'")}}b=g.makeUpdateData(v,t.drillDown(e,v));S=t.getPrivateAnnotation(e,"postBody");if(S){t.updateAll({},c,S,w);if(e["@$ui5.context.isInactive"]&&!y){w["@$ui5.context.isInactive"]=false;t.deletePrivateAnnotation(e,"initialData");R.iActiveElements+=1;d(R.mChangeListeners,"",R.aElements,1)}}t.updateAll(R.mChangeListeners,c,e,w);if(l){l=t.buildPath(v.slice(0,-1).join("/"),l);$=l.split("/");l=t.buildPath(c,l);k=R.getValue(l);if(k===undefined){n.debug("Missing value for unit of measure "+l+" when updating "+m,R.toString(),o)}else{t.merge(O?S:w,g.makeUpdateData($,k))}}if(O){if(y){t.updateAll(R.mChangeListeners,c,e,{"@$ui5.context.isInactive":1})}else if(A){t.setPrivateAnnotation(e,"transient",O);R.oRequestor.relocate(A,S,O)}i.unlock();return Promise.resolve()}R.oRequestor.relocateAll("$parked."+E,E,e);h+=R.oRequestor.buildQueryString(R.sMetaPath,R.mQueryOptions,true);return Q(i)})};g.prototype.updateNestedCreates=function(e,i,n,r){var s=false,o=this;if(!r){return false}Object.keys(r).filter(function(e){return!e.includes("/")}).forEach(function(a){var u=e+"/"+a,h,c=n[a],l=a+"/",d,f={};if(!c){delete i[a];return}d=r[a]||t.getQueryOptionsForPath(o.mQueryOptions,u).$select;i[a]=h=new Array(c.length);h.$count=undefined;h.$created=0;h.$byPredicate={};p(o.mChangeListeners,u,h,c.length);Object.keys(r).forEach(function(e){if(e.startsWith(l)){f[e.slice(l.length)]=r[e]}});c.forEach(function(e,i){var n=t.getPrivateAnnotation(e,"predicate");h.$byPredicate[n]=h[i]={};t.updateSelected({},u+n,h[i],e,d,undefined,true);o.updateNestedCreates(u+n,h[i],e,f)});s=true});return s};g.prototype.visitResponse=function(e,i,n,r,s,o){var u,c=false,l={},d=this.oRequestor.getServiceUrl()+this.sResourcePath,f=this;function g(e,i,n){c=true;if(e&&e.length){f.checkSharedRequest();l[i]=e;e.forEach(function(e){if(e.longtextUrl){e.longtextUrl=t.makeAbsolute(e.longtextUrl,n)}})}}function P(e,i){return i?t.makeAbsolute(i,e):e}function y(e,i,n,r){var o={},a,h,c,l;for(l=0;l<e.length;l+=1){h=e[l];a=n===""?s+l:l;if(h&&typeof h==="object"){m(h,i,n,r,a);c=t.getPrivateAnnotation(h,"predicate");if(!n){u.push(c||a.toString())}if(c){o[c]=h;e.$byPredicate=o}}}}function m(e,n,s,o,c){var l,d,v=i[n],$=v&&v[h]&&v[h].$Path,R;o=P(o,e["@odata.context"]);d=f.calculateKeyPredicate(e,i,n);if(c!==undefined){s=t.buildPath(s,d||c)}else if(d){l=a.exec(s);if(l){s=s.slice(0,-l[0].length)+d}}if(r&&!u){u=[s]}if($){R=t.drillDown(e,$.split("/"));if(R!==undefined){g(R,s,o)}}Object.keys(e).forEach(function(i){var r,a=n+"/"+i,u=e[i],h=t.buildPath(s,i);if(i.endsWith("@odata.mediaReadLink")||i.endsWith("@mediaReadLink")){e[i]=t.makeAbsolute(u,o)}if(i===$||i.includes("@")){return}if(Array.isArray(u)){u.$created=0;u.$count=undefined;r=e[i+"@odata.count"];if(r){p({},"",u,r)}else if(!e[i+"@odata.nextLink"]){p({},"",u,u.length)}y(u,a,h,P(o,e[i+"@odata.context"]))}else if(u&&typeof u==="object"){m(u,a,h,o)}})}if(s!==undefined){u=[];y(e.value,n||this.sMetaPath,"",P(d,e["@odata.context"]))}else if(e&&typeof e==="object"){m(e,n||this.sMetaPath,r||"",d)}if(c&&!this.bSharedRequest){if(!o){this.sReportedMessagesPath=this.sOriginalResourcePath}this.oRequestor.getModelInterface().reportStateMessages(this.sOriginalResourcePath,l,u)}};function P(e,t,i,n,r,s){g.call(this,e,t,i,n,r,s);this.iActiveElements=0;this.oBackup=null;this.sContext=undefined;this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;this.aElements.$tail=undefined;this.iLimit=Infinity;this.aReadRequests=[];this.bServerDrivenPaging=false;this.oSyncPromiseAll=undefined}P.prototype=Object.create(g.prototype);P.prototype.addKeptElement=function(e){this.checkSharedRequest();this.aElements.$byPredicate[t.getPrivateAnnotation(e,"predicate")]=e};P.prototype.checkRange=function(e,t,i){var n;if(e!==this.aElements.$tail){i=Math.min(i,this.aElements.length);for(n=t;n<i;n+=1){if(this.aElements[n]!==e){throw new Error("Found data at an index being read from the back end")}}}};P.prototype.doReplaceWith=function(e,i){var n=this.aElements[e];this.checkSharedRequest();if(n&&t.hasPrivateAnnotation(n,"transientPredicate")&&!t.hasPrivateAnnotation(i,"transientPredicate")){t.setPrivateAnnotation(i,"transientPredicate",t.getPrivateAnnotation(i,"predicate"))}this.aElements[e]=i;this.addKeptElement(i)};P.prototype.drop=function(e,t){delete this.aElements[e];delete this.aElements.$byPredicate[t]};P.prototype.fetchValue=function(t,i,n,s,o){var a,u=i.split("/")[0],h,c=this;t.unlock();if(this.aElements.$byPredicate[u]){h=r.resolve()}else if((t===e.$cached||u!=="$count")&&this.aElements[u]!==undefined){h=r.resolve(this.aElements[u])}else{if(!this.oSyncPromiseAll){a=this.aElements.$tail?this.aElements.concat(this.aElements.$tail):this.aElements;this.oSyncPromiseAll=r.all(a)}h=this.oSyncPromiseAll}return h.then(function(){c.registerChangeListener(i,s);return c.drillDown(c.aElements,i,t,o)})};P.prototype.fill=function(e,t,i){var n;if(i>this.aElements.length&&i-t>1024){if(this.aElements.$tail&&e){throw new Error("Cannot fill from "+t+" to "+i+", $tail already in use, # of elements is "+this.aElements.length)}this.aElements.$tail=e;i=this.aElements.length}for(n=t;n<i;n+=1){this.aElements[n]=e}this.oSyncPromiseAll=undefined};P.prototype.getExclusiveFilter=function(){var e,i=[],n,r,s=this;function o(e){var r;n=n||s.fetchTypes().getResult();r=t.getKeyFilter(e,s.sMetaPath,n);if(r){i.push(r)}}for(r=0;r<this.aElements.$created;r+=1){e=this.aElements[r];if(!e["@$ui5.context.isTransient"]){o(e)}}(this.aElements.$deleted||[]).forEach(function(e){o(s.aElements.$byPredicate[e.predicate])});return i.length?"not ("+i.sort().join(" or ")+")":undefined};P.prototype.getQueryString=function(){var e=this.getExclusiveFilter(),i=Object.assign({},this.mQueryOptions),n=i.$filter,r=this.sQueryString;if(e){if(n){i.$filter="("+n+") and "+e;r=this.oRequestor.buildQueryString(this.sMetaPath,i,false,this.bSortExpandSelect)}else{r+=(r?"&":"?")+"$filter="+t.encode(e,false)}}return r};P.prototype.getResourcePathWithQuery=function(e,t){var i=this.aElements.$created,n=this.getQueryString(),r=n?"&":"?",s=t-e,o=this.sResourcePath+n;if(e<i){throw new Error("Must not request created element")}e-=i;if(e>0||s<Infinity){o+=r+"$skip="+e}if(s<Infinity){o+="&$top="+s}return o};P.prototype.getValue=function(t){var i;if(!t){return this.aElements}i=this.fetchValue(e.$cached,t);if(i.isFulfilled()){return i.getResult()}i.caught()};P.prototype.handleCount=function(e,t,i,n,r,s){var o=r["@odata.count"],a=this.aElements.$created,u,h=-1,c=this.aElements.$count,l,d=r.value.length,f;n-=s;d-=s;if(o){u=parseInt(o)-s;if(s===t||i===a&&d===u){this.iLimit=h=u}else{l=this.requestCount(this.oRequestor.getUnlockedAutoCopy(e))}}if(r["@odata.nextLink"]){this.bServerDrivenPaging=true;if(n<this.aElements.length){for(f=i+d;f<n;f+=1){delete this.aElements[f]}}else{this.aElements.length=i+d}}else if(d<n-i){if(h===-1){h=c&&c-this.iActiveElements}h=Math.min(h!==undefined?h:Infinity,i-a+d);this.aElements.length=a+h;this.iLimit=h;if(!o&&h>0&&!this.aElements[h-1]){h=undefined}}if(h!==-1){p(this.mChangeListeners,"",this.aElements,h!==undefined?h+this.iActiveElements:undefined)}return l};P.prototype.handleResponse=function(e,i,n){var r,s=this.aElements,o=s.$created,a,u=0,h,c=e.value.length,l;this.sContext=e["@odata.context"];this.visitResponse(e,n,undefined,undefined,i);for(l=0;l<c;l+=1){r=e.value[l];h=t.getPrivateAnnotation(r,"predicate");if(h){a=s.$byPredicate[h];if(a){if(!a["@odata.etag"]||r["@odata.etag"]===a["@odata.etag"]){if(o&&s.lastIndexOf(a,o-1)>=0){u+=1;s[i+c-u]=undefined;continue}t.updateNonExisting(a,r);r=a}else if(this.hasPendingChangesForPath(h)){throw new Error("Modified on client and on server: "+this.sResourcePath+h)}}s.$byPredicate[h]=r}s[i+l-u]=r}return u};P.prototype.isDeletingInOtherGroup=function(e){return Object.values(this.aElements.$deleted||{}).some(function(t){return t.groupId!==e})};P.prototype.keepOnlyGivenElements=function(e){var i,n=-1,r={},s=this;e.forEach(function(e){r[e]=true});i=this.aElements.filter(function(e,i){var o;if(!e){return false}if(t.hasPrivateAnnotation(e,"transient")){n=i;return false}o=t.getPrivateAnnotation(e,"predicate");if(r[o]){n=i;delete r[o];return true}s.drop(i,o);return false});this.aElements.length=n+1;Object.keys(r).forEach(function(e){i.push(s.aElements.$byPredicate[e])});return i};P.prototype.read=function(e,i,n,o,a){var u=0,h,c,l,d=this.oPendingRequestsPromise||this.aElements.$tail,f,p=0,g,P=this;if(e<0){throw new Error("Illegal index "+e+", must be >= 0")}if(i<0){throw new Error("Illegal length "+i+", must be >= 0")}if(d){return d.then(function(){return P.read(e,i,n,o,a)})}for(g=0;g<this.aElements.$created;g+=1){h=this.aElements[g];if(t.getPrivateAnnotation(h,"transient")===o.getGroupId()){p+=1}if(P.oBackup&&!h["@$ui5.context.isTransient"]){u+=1}}f=s._getReadIntervals(this.aElements,e,i,this.bServerDrivenPaging?0:Math.max(n,p,u),this.aElements.$created+this.iLimit);if(p&&(f.length>1||f.length&&f[0].start>this.aElements.$created)){o.unlock();return this.oRequestor.waitForBatchResponseReceived(o.getGroupId()).then(function(){return P.read(e,i,n,P.oRequestor.getUnlockedAutoCopy(o),a)})}f.forEach(function(e){P.requestElements(e.start,e.end,o.getUnlockedCopy(),p,a);a=undefined});o.unlock();l=e+i+n;c=this.aElements.slice(e,l);if(this.aElements.$tail&&l>this.aElements.length){c.push(this.aElements.$tail)}return r.all(c).then(function(){var t=P.aElements.slice(e,e+i);t.$count=P.aElements.$count;return{"@odata.context":P.sContext,value:t}})};P.prototype.refreshKeptElements=function(e,i,n){var r=this,s=Object.keys(this.aElements.$byPredicate).filter(u).sort(),o;function a(){var e,i=t.clone(r.mQueryOptions);if(r.mLateQueryOptions){t.aggregateExpandSelect(i,r.mLateQueryOptions)}if(n){delete i.$apply}delete i.$count;delete i.$orderby;delete i.$search;e=s.map(function(e){return t.getKeyFilter(r.aElements.$byPredicate[e],r.sMetaPath,o)});i.$filter=e.join(" or ");if(e.length>1){i.$top=e.length}return r.sResourcePath+r.oRequestor.buildQueryString(r.sMetaPath,i,false,true)}function u(e){var i=r.aElements.$byPredicate[e];return t.getPrivateAnnotation(i,"predicate")===e&&Object.keys(i).length>1&&!r.hasPendingChangesForPath(e)}this.checkSharedRequest();if(s.length===0){return undefined}o=this.fetchTypes().getResult();return this.oRequestor.request("GET",a(),e).then(function(e){var n;r.visitResponse(e,o,undefined,undefined,0);n=e.value.$byPredicate||{};s.forEach(function(e){var s,o;if(e in n){t.updateAll(r.mChangeListeners,e,r.aElements.$byPredicate[e],n[e])}else{s=r.aElements.$byPredicate[e];if(t.hasPrivateAnnotation(s,"transientPredicate")){o=r.removeElement(r.aElements,-1,e,"")}else{delete r.aElements.$byPredicate[e]}i(e,o)}})})};P.prototype.removeKeptElement=function(e){this.checkSharedRequest();delete this.aElements.$byPredicate[e]};P.prototype.requestElements=function(e,t,i,n,s){var o,a={iEnd:t,iStart:e},u=this;this.aReadRequests.push(a);this.bSentRequest=true;o=r.all([this.oRequestor.request("GET",this.getResourcePathWithQuery(e,t),i,undefined,undefined,s),this.fetchTypes()]).then(function(e){var t;u.checkRange(o,a.iStart,a.iEnd);if(u.aElements.$tail===o){u.aElements.$tail=undefined}t=u.handleResponse(e[0],a.iStart,e[1]);return u.handleCount(i,n,a.iStart,a.iEnd,e[0],t)}).catch(function(e){u.checkRange(o,a.iStart,a.iEnd);u.fill(undefined,a.iStart,a.iEnd);throw e}).finally(function(){u.aReadRequests.splice(u.aReadRequests.indexOf(a),1)});this.fill(o,e,t);return o};P.prototype.requestSideEffects=function(e,i,n,s,o){var a,u,h,c,l,d=this.fetchTypes().getResult(),f=this;this.checkSharedRequest();h=t.intersectQueryOptions(Object.assign({},this.mQueryOptions,this.mLateQueryOptions),i,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath,"",o);if(!h){return r.resolve()}if(this.beforeRequestSideEffects){this.beforeRequestSideEffects(h)}if(s){a=[this.aElements.$byPredicate[n[0]]]}else{a=this.keepOnlyGivenElements(n);if(!a.length){return r.resolve()}}h.$filter=a.map(function(e){return t.getKeyFilter(e,f.sMetaPath,d)}).join(" or ");if(a.length>1){h.$top=a.length}t.selectKeyProperties(h,d[this.sMetaPath]);delete h.$count;delete h.$orderby;delete h.$search;u=t.extractMergeableQueryOptions(h);c=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,h,false,true);return this.oRequestor.request("GET",c,e,undefined,undefined,undefined,undefined,this.sMetaPath,undefined,false,u,this,function(e){if(arguments.length){i=i.concat(e)}else{l=true;return i}}).then(function(e){var n,r,s,o;function u(e){e=e.slice(r.length+1);return!i.some(function(i){return t.getRelativePath(e,i)!==undefined})}if(l){return}if(e.value.length!==a.length){throw new Error("Expected "+a.length+" row(s), but instead saw "+e.value.length)}f.visitResponse(e,d,undefined,"",NaN,true);for(s=0,o=e.value.length;s<o;s+=1){n=e.value[s];r=t.getPrivateAnnotation(n,"predicate");if(f.beforeUpdateSelected){f.beforeUpdateSelected(r,n)}t.updateSelected(f.mChangeListeners,r,f.aElements.$byPredicate[r],n,i,u)}})};P.prototype.reset=function(e,i,n,r,s){var o=this.aElements.$byPredicate,a=this.mChangeListeners,u=0,h,c,l,d=this;if(i){this.checkSharedRequest();this.oBackup={iActiveElements:this.iActiveElements,mChangeListeners:this.mChangeListeners,sContext:this.sContext,aElements:this.aElements.slice(),$byPredicate:o,$count:this.aElements.$count,$created:this.aElements.$created,iLimit:this.iLimit}}if(n){this.setQueryOptions(n,true)}for(l=0;l<this.aElements.$created;l+=1){h=this.aElements[l];c=t.getPrivateAnnotation(h,"transient");if(i?"@$ui5.context.isInactive"in h||c&&c!==i:c){e.push(t.getPrivateAnnotation(h,"predicate")||t.getPrivateAnnotation(h,"transientPredicate"));this.aElements[u]=h;u+=1}else{this.iActiveElements-=1}}Object.keys(o).forEach(function(t){if("@$ui5.context.isDeleted"in o[t]){e.push(t)}});this.mChangeListeners={};this.sContext=undefined;this.aElements.length=this.aElements.$created=u;this.aElements.$byPredicate={};this.aElements.$count=undefined;this.iLimit=Infinity;Object.keys(a).forEach(function(t){if(t==="$count"||e.includes(t.split("/")[0])){d.mChangeListeners[t]=a[t]}});e.forEach(function(e){d.aElements.$byPredicate[e]=o[e]});if(a[""]){this.mChangeListeners[""]=a[""];t.fireChange(this.mChangeListeners,"")}Object.values(this.aElements.$deleted||{}).forEach(function(e){e.index=undefined})};P.prototype.restore=function(e){if(e){this.checkSharedRequest();this.iActiveElements=this.oBackup.iActiveElements;this.mChangeListeners=this.oBackup.mChangeListeners;this.sContext=this.oBackup.sContext;this.aElements.length=this.oBackup.aElements.length;this.oBackup.aElements.forEach(function(e,t){this[t]=e},this.aElements);this.aElements.$byPredicate=this.oBackup.$byPredicate;this.aElements.$count=this.oBackup.$count;this.aElements.$created=this.oBackup.$created;this.iLimit=this.oBackup.iLimit}this.oBackup=null};P.prototype.setPersistedCollection=function(e){this.aElements=e;this.iActiveElements=e.$created;this.iLimit=e.length};function y(e,t,i){g.call(this,e,t,i);this.oPromise=null}y.prototype=Object.create(g.prototype);y.prototype._delete=function(){throw new Error("Unsupported")};y.prototype.create=function(){throw new Error("Unsupported")};y.prototype.fetchValue=function(e,t,i,n,s){var o=this;if(s){throw new Error("Unsupported argument: bCreateOnDemand")}if(this.oPromise){e.unlock()}else{this.bSentRequest=true;this.oPromise=r.resolve(this.oRequestor.request("GET",this.sResourcePath+this.sQueryString,e,undefined,undefined,i,undefined,this.sMetaPath))}return this.oPromise.then(function(e){o.registerChangeListener("",n);return e&&typeof e==="object"?e.value:e})};y.prototype.update=function(){throw new Error("Unsupported")};function m(e,t,i,n,s,o,a,u,h){g.call(this,e,t,i,n,o,s);this.sMetaPath=u||this.sMetaPath;this.bPost=a;this.bPosting=false;if(h){this.oPromise=r.resolve({})}else{this.oPromise=null}}m.prototype=Object.create(g.prototype);m.prototype.buildOriginalResourcePath=function(e,t,i){if(i){this.calculateKeyPredicate(e,t,this.sMetaPath);this.sOriginalResourcePath=i(e)}};m.prototype.fetchValue=function(e,t,i,n,s,o){var a=this.sResourcePath+this.sQueryString,u=this;if(this.oPromise){e.unlock()}else{if(this.bPost){throw new Error("Cannot fetch a value before the POST request")}this.oPromise=r.all([this.oRequestor.request("GET",a,e,undefined,undefined,i,undefined,this.sMetaPath),this.fetchTypes()]).then(function(e){u.buildOriginalResourcePath(e[0],e[1],o);u.visitResponse(e[0],e[1]);return e[0]});this.bSentRequest=true}return this.oPromise.then(function(i){if(i&&i["$ui5.deleted"]){throw new Error("Cannot read a deleted entity")}u.registerChangeListener(t,n);return u.drillDown(i,t,e,s)})};m.prototype.getValue=function(t){var i;if(this.oPromise&&this.oPromise.isFulfilled()){i=this.drillDown(this.oPromise.getResult(),t,e.$cached);if(i.isFulfilled()){return i.getResult()}i.caught()}};m.prototype.post=function(e,i,n,s,o,a){var u,h=n?{"If-Match":s&&"@odata.etag"in n?"*":n}:{},c="POST",l,d=this;function f(){l=d.oRequestor.lockGroup(e.getGroupId(),d,true)}function p(e){d.bPosting=true;return r.all([d.oRequestor.request(c,d.sResourcePath+d.sQueryString,e,h,i,n&&f),d.fetchTypes()]).then(function(e){d.buildOriginalResourcePath(e[0],e[1],a);d.visitResponse(e[0],e[1]);if(d.mQueryOptions&&d.mQueryOptions.$select){t.updateSelected({},"",e[0],e[0],d.mQueryOptions.$select)}d.bPosting=false;if(l){l.unlock()}return e[0]},function(t){d.bPosting=false;if(l){l.unlock();l=undefined}if(o&&t.strictHandlingFailed){return o(t).then(function(t){var i;if(t){delete h["Prefer"];return p(e.getUnlockedCopy())}i=Error("Action canceled due to strict handling");i.canceled=true;throw i})}throw t})}this.checkSharedRequest();if(!this.bPost){throw new Error("POST request not allowed")}if(this.bPosting){throw new Error("Parallel POST requests not allowed")}if(n){u=e.getGroupId();this.oRequestor.relocateAll("$parked."+u,u,n)}if(i){c=i["X-HTTP-Method"]||c;delete i["X-HTTP-Method"];if(this.oRequestor.isActionBodyOptional()&&t.isEmptyObject(i)){i=undefined}}this.bSentRequest=true;if(o){h["Prefer"]="handling=strict"}this.oPromise=p(e);return this.oPromise};m.prototype.requestSideEffects=function(i,n,s){var o,a,u,h,c=this;this.checkSharedRequest();a=this.oPromise&&t.intersectQueryOptions(Object.assign({},this.mQueryOptions,this.mLateQueryOptions),n,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath);if(!a){return r.resolve()}if(this.oPromise.isRejected()){throw new Error(this+": Cannot call requestSideEffects, cache is broken: "+this.oPromise.getResult().message)}o=t.extractMergeableQueryOptions(a);s=(s||this.sResourcePath)+this.oRequestor.buildQueryString(this.sMetaPath,a,false,true);u=r.all([this.oRequestor.request("GET",s,i,undefined,undefined,undefined,undefined,this.sMetaPath,undefined,false,o,this,function(e){if(arguments.length){n=n.concat(e)}else{h=true;return n}}),this.fetchTypes(),this.fetchValue(e.$cached,"")]).then(function(e){return e}).then(function(e){var i=e[0],r=e[2];if(h){return}t.setPrivateAnnotation(i,"predicate",t.getPrivateAnnotation(r,"predicate"));c.visitResponse(i,e[1]);t.updateSelected(c.mChangeListeners,"",r,i,n,function(e){return!n.some(function(i){return t.getRelativePath(e,i)!==undefined})})});return u};m.prototype.resetProperty=function(e){var t=this.oPromise.getResult();if(t){e.split("/").some(function(e){delete t["@odata.etag"];if(typeof t[e]==="object"){t=t[e];return false}delete t[e];return true})}};function v(e,t,i){var n=t.split("/"),r=n[0],s=r+JSON.stringify(i),o=e.$mSingletonCacheByPath;y.call(this,e,t,{});if(!o){o=e.$mSingletonCacheByPath={}}this.oSingleton=o[s];if(!this.oSingleton){this.oSingleton=o[s]=new m(e,r,i,undefined,undefined,undefined,undefined,undefined,true)}this.sRelativePath=t.split(r+"/")[1]}v.prototype=Object.create(y.prototype);v.prototype.fetchValue=function(e,i,n,r,s){var o=this.oSingleton.sResourcePath+"/"+this.sRelativePath,a,u=this.oMetadataPromise||this.oRequestor.getModelInterface().fetchMetadata("/"+t.getMetaPath(o)),h=this;return u.then(function(){if(!h.oMetadataPromise){a=h.oSingleton.getLateQueryOptions()||{};t.aggregateExpandSelect(a,t.wrapChildQueryOptions("/"+h.oSingleton.sResourcePath,h.sRelativePath,{},h.oRequestor.getModelInterface().fetchMetadata));h.oSingleton.setLateQueryOptions(a)}h.oMetadataPromise=u;return h.oSingleton.fetchValue(e,h.sRelativePath,n,r,s)})};v.prototype.reset=function(){this.oSingleton.resetProperty(this.sRelativePath)};g.create=function(e,i,n,r,s,o){var a,u,h,c,l;if(o){h=i+e.buildQueryString(t.getMetaPath("/"+i),n,false,r);l=e.$mSharedCollectionCacheByPath;if(!l){l=e.$mSharedCollectionCacheByPath={}}c=l[h];if(c){c.setActive(true)}else{u=Object.keys(l);a=u.length;if(a>100){u.filter(function(e){return!l[e].iActiveUsages}).sort(function(e,t){return l[e].iInactiveSince-l[t].iInactiveSince}).every(function(e){delete l[e];a-=1;return a>100})}c=l[h]=new P(e,i,n,r,s,o)}return c}return new P(e,i,n,r,s)};g.createProperty=function(e,t,i){if(t.includes("(")||t.endsWith("/$count")){return new y(e,t,i)}return new v(e,t,i)};g.createSingle=function(e,t,i,n,r,s,o,a){return new m(e,t,i,n,r,s,o,a)};g.from$skip=function(e,t){return c.test(e)?(t.$created||0)+Number(e):e};g.getElementIndex=function(e,i,n){var r=e[n];if(!r||t.getPrivateAnnotation(r,"predicate")!==i){n=e.indexOf(e.$byPredicate[i])}return n};g.makeUpdateData=function(e,t,i){return e.reduceRight(function(e,t){var n={};n[t]=e;if(i){n[t+"@$ui5.updating"]=true;i=false}return n},t)};return g},false);
//# sourceMappingURL=_Cache.js.map